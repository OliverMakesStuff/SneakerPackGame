<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sneaker Pack Tycoon</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #2c3e50; color: white; text-align: center; }
    h1 { margin-top: 20px; }
    .container { margin: 20px; }
    .coins { font-size: 24px; margin-bottom: 20px; }
    .pack-select, .pack-button { padding: 10px 20px; font-size: 18px; margin: 10px; }
    .pack-button { cursor: pointer; background-color: #2980b9; color: white; border: none; border-radius: 5px; }
    .inventory, .market, .settings, .daily, .trading { margin-top: 20px; }
    .inventory div, .market div, .trading div { background: #34495e; margin: 10px; padding: 10px; border-radius: 8px; }
    .sneaker-card { margin-bottom: 10px; }
    .rarity-common { color: #7f8c8d; }
    .rarity-uncommon { color: #27ae60; }
    .rarity-rare { color: #2980b9; }
    .rarity-ultra-rare { color: #16a085; }
    .rarity-epic { color: #8e44ad; }
    .rarity-mythic { color: #e67e22; }
    .rarity-legendary { color: #f39c12; font-weight: bold; }
    .rarity-grail { color: #e74c3c; font-weight: bold; text-shadow: 0 0 8px #fff; }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      background: #222;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
      z-index: 1000;
      pointer-events: none;
    }
    .modal.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 999;
      pointer-events: none;
    }
    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .card-container {
      margin: 20px auto;
      display: flex;
      flex-direction: row;
      align-items: center;
      position: relative;
      height: 200px;
      width: 600px;
      overflow: hidden;
      background: #222;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .casino-roll-track {
      display: flex;
      flex-direction: row;
      align-items: center;
      transition: transform 2s cubic-bezier(0.23, 1, 0.32, 1);
      will-change: transform;
      height: 100%;
    }
    .casino-roll-card {
      background-color: #34495e;
      color: white;
      padding: 20px;
      border-radius: 8px;
      width: 180px;
      height: 150px;
      margin: 0 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 1em;
      transition: box-shadow 0.2s, transform 0.2s;
      }
    .casino-roll-card.selected {
      /* No border, no color change, no highlight */
      /* Just use normal card style */
    }
    select.pack-select { background: #34495e; color: white; border: 1px solid #2980b9; border-radius: 5px; }
    .inventory-list-flex {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .sneaker-card {
      background: #34495e;
      margin: 5px;
      padding: 8px;
      border-radius: 8px;
      min-width: 100px;
      max-width: 140px;
      flex: 1 1 120px;
      font-size: 14px;
      transition: font-size 0.2s, min-width 0.2s, max-width 0.2s;
      width: calc(100% / 5 - 16px);
    }
    @media (max-width: 700px) {
      .inventory-list-flex .sneaker-card {
        width: calc(100% / 2 - 16px);
      }
    }
    @media (max-width: 500px) {
      .inventory-list-flex .sneaker-card {
        width: 100%;
      }
    }
    #trade-dropdown {
      margin: 10px 0;
      padding: 6px 12px;
      font-size: 16px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
      width: 90%;
      max-width: 300px;
    }
    .trade-offer { margin-top: 15px; }
    .close-btn { background: #c0392b; color: white; border: none; border-radius: 5px; padding: 6px 14px; cursor: pointer; margin-top: 10px;}
    .settings {
      margin-top: 20px;
      background: #34495e;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      text-align: left;
      margin-top: 15px;
    }
    .settings-item {
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
    }
    .settings-item label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .settings input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }
    .settings select {
      width: 100%;
      padding: 5px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
    }
    .volume-value {
      font-size: 14px;
      color: #bdc3c7;
    }
    .no-animations * {
      animation: none !important;
      transition: none !important;
    }
    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .inventory-list .sneaker-card { max-width: 100%; width: 100%; }
    .inventory-compact .sneaker-card { font-size: 12px; padding: 5px; }
    .top-right-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .history-btn, .settings-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: transform 0.2s, background-color 0.2s;
    }
    .history-btn:hover, .settings-btn:hover {
      background: #3498db;
      transform: scale(1.1);
    }
    .purchase-history {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .purchase-item {
      background: #2c3e50;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
    }
    .purchase-time {
      color: #7f8c8d;
      font-size: 0.9em;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
    }
    .limited-offer {
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 20px;
      border-radius: 8px;
      margin: 15px auto;
      max-width: 600px;
      position: relative;
      overflow: hidden;
    }
    .limited-offer::before {
      content: "Limited Time!";
      position: absolute;
      top: 10px;
      right: -30px;
      background: #e74c3c;
      color: white;
      padding: 5px 40px;
      transform: rotate(45deg);
      font-size: 12px;
    }
    .offer-timer {
      color: #ecf0f1;
      font-size: 1.2em;
      margin: 10px 0;
    }
    .offer-content {
      display: flex;
      align-items: center;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .offer-sneaker {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
    }
    .roll-animation {
      animation: rollEffect 1s ease-out;
    }
    @keyframes rollEffect {
      0% { transform: translateY(-100px) rotate(-180deg); opacity: 0; }
      70% { transform: translateY(20px) rotate(20deg); opacity: 0.7; }
      100% { transform: translateY(0) rotate(0deg); opacity: 1; }
    }
    .roll-container {
      position: relative;
      height: 150px;
      width: 200px;
      overflow: hidden;
      background: #2c3e50;
      border-radius: 8px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .roll-item {
      position: absolute;
      width: 180px;
      height: 130px;
      padding: 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #34495e;
      box-sizing: border-box;
      border-radius: 5px;
      transition: all 0.05s;
      opacity: 0;
      transform: scale(0.9);
      left: 50%;
      margin-left: -90px;
    }
    .roll-item.active {
      opacity: 1;
      transform: scale(1);
    }
    .roll-item.final {
      animation: popIn 0.3s ease-out forwards !important;
      opacity: 1;
    }
    @keyframes popIn {
      0% { transform: scale(0.8); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .roll-flash {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 2;
    }
    .roll-item strong {
      display: block;
      margin-bottom: 5px;
    }
    .roll-item span {
      display: block;
      margin: 2px 0;
    }
    @keyframes flashEffect {
      0% { opacity: 0; }
      50% { opacity: 0.5; }
      100% { opacity: 0; }
    }
    .trade-comparison {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 20px 0;
      gap: 20px;
    }
    .trade-side {
      flex: 1;
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      max-width: 300px;
    }
    .trade-arrow {
      font-size: 24px;
      color: #3498db;
    }
    .value-comparison {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      font-size: 0.9em;
    }
    .better-value { color: #2ecc71; }
    .worse-value { color: #e74c3c; }
    .equal-value { color: #f1c40f; }
    .trade-selection {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .selected-sneakers {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .selected-sneaker {
      background: #2c3e50;
      padding: 8px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .remove-sneaker {
      background: #c0392b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .ai-trader-info {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .ai-avatar {
      width: 50px;
      height: 50px;
      background: #34495e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .ai-details {
      flex-grow: 1;
    }
    .ai-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    .ai-preference {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .negotiation-options {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .negotiation-btn {
      background: #34495e;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .negotiation-btn:hover {
      background: #2c3e50;
    }
    .ai-response {
      margin: 10px 0;
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
      font-style: italic;
    }
    .purchase-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .resell-agent {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .agent-level {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .level-indicator {
      display: flex;
      gap: 3px;
    }
    .level-star {
      color: #f1c40f;
    }
    .agent-bonus {
      color: #2ecc71;
    }
    .staff-section {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .staff-member {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .staff-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .staff-status {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .staff-stats {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 0.9em;
    }
    .staff-cost {
      color: #f1c40f;
    }
    .agent-types {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .agent-card {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      min-width: 200px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .agent-card:hover {
      transform: translateY(-5px);
    }
    .agent-card.selected {
      border: 2px solid #3498db;
    }
    .breaking-news {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      animation: slideDown 0.5s ease-out, glow 2s infinite;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      text-align: center;
      min-width: 300px;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
      100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
    }
    .news-header {
      font-size: 1.5em;
      margin-bottom: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .news-content {
      font-size: 1.2em;
      line-height: 1.4;
      margin: 10px 0;
    }
    .news-timer {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
      width: 100%;
    }
    .news-timer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.8);
      transform-origin: left;
    }
    .news-timer.animate::after {
      animation: newsTimer 5s linear forwards;
    }
    @keyframes newsTimer {
      0% { transform: scaleX(1); }
      100% { transform: scaleX(0); }
    }
    .trader-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .trader-card {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      text-align: left;
    }
    .trader-card:hover {
      transform: translateY(-5px);
    }
    .trader-card.selected {
      border: 2px solid #3498db;
    }
    .trader-avatar {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .trader-info {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .limited-offers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .limited-offer {
      position: relative;
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .offer-timer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9em;
    }

    .staff-hire-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .staff-hire-modal.show {
      display: block;
    }
    .staff-hire-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .staff-hire-item {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .staff-hire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .staff-hire-cost {
      color: #f1c40f;
      font-weight: bold;
    }
    .test-buttons {
      position: fixed;
      left: -9999px;
      visibility: hidden;
    }
    .test-button {
      background: #8e44ad;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .test-button:hover {
      background: #9b59b6;
    }
    
    /* New styles for clicker, used market, and cleaning game */
    .clicker-button {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 50%;
      width: 320px;
      height: 320px;
      font-size: 48px;
      cursor: pointer;
      transition: transform 0.1s;
      margin: 48px auto 0 auto;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 40px rgba(39,174,96,0.18), 0 2px 8px rgba(0,0,0,0.10);
      position: relative;
      outline: none;
      border: 4px solid #2ecc71;
      box-sizing: border-box;
    }
    .clicker-button:active {
      transform: scale(0.95);
    }
    .clicker-button:hover, .clicker-button:focus {
      box-shadow: 0 12px 60px rgba(39,174,96,0.25), 0 2px 8px rgba(0,0,0,0.12);
      background: #2ecc71;
      border-color: #27ae60;
    }
    .clicker-sneaker {
      font-size: 100px;
      margin-bottom: 12px;
      display: block;
      pointer-events: none;
      user-select: none;
    }
    @media (max-width: 900px) {
      .main-layout {
        flex-direction: column;
      }
      .left-panel {
        width: 100%;
        max-width: none;
        border-right: none;
        border-bottom: 2px solid #34495e;
        flex-direction: row;
        justify-content: space-around;
        align-items: flex-start;
        padding: 16px 0 8px 0;
        height: auto;
      }
      .clicker-button {
        width: 180px;
        height: 180px;
        font-size: 28px;
      }
      .clicker-sneaker {
        font-size: 56px;
      }
    }
    
    .used-market {
      margin: 20px 0;
    }
    
    .used-sneaker {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      transition: width 0.3s;
    }
    
    .cleaning-game {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      width: 90%;
      max-width: 500px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .cleaning-game.show {
      display: block;
    }
    
    .cleaning-info {
      margin: 15px 0;
      padding: 10px;
      background: #34495e;
      border-radius: 8px;
    }
    
    .sneaker-canvas {
      background: #34495e;
      border-radius: 8px;
      margin: 10px auto;
      cursor: pointer;
      display: block;
      max-width: 100%;
      height: auto;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      width: 0;
      transition: width 0.3s;
    }
    
    #used-market-modal {
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #34495e;
      border-radius: 8px 8px 0 0;
      margin: -20px -20px 20px -20px;
    }
    
    .modal-header h2 {
      margin: 0;
      color: white;
    }
    
    .click-count {
      font-size: 18px;
      color: #3498db;
      margin: 10px 0;
    }
    
    .used-market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
      max-height: 70vh;
      overflow-y: auto;
      padding: 15px;
    }

    /* Comprehensive light mode styles */
    .light-mode {
      background-color: #f5f6fa;
      color: #2c3e50;
    }
    
    .light-mode .sneaker-card,
    .light-mode .modal,
    .light-mode .settings-item,
    .light-mode .trade-side,
    .light-mode .ai-trader-info,
    .light-mode .ai-response,
    .light-mode .selected-sneaker,
    .light-mode .purchase-item {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .light-mode .modal-overlay {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .light-mode .pack-button,
    .light-mode .negotiation-btn,
    .light-mode .close-btn {
      background-color: #3498db;
      color: white;
    }
    
    .light-mode .pack-button:hover,
    .light-mode .negotiation-btn:hover {
      background-color: #2980b9;
    }
    
    .light-mode .modal-header {
      background-color: #f8f9fa;
      color: #2c3e50;
    }
    
    .light-mode select {
      background-color: #ffffff;
      color: #2c3e50;
      border-color: #bdc3c7;
    }

    /* Fix sneaker positioning in popups */
    .card {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
    }

    .roll-item {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
      width: 180px;
      height: 130px;
    }

    /* Update animations */
    @keyframes rollAndReveal {
      0% { transform: translate(-50%, -150%) rotate(-180deg); opacity: 0; }
      70% { transform: translate(-50%, -30%) rotate(20deg); opacity: 0.7; }
      90% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
    }

    /* Rarity-specific reveal animations */
    .reveal-common {
      animation: rollAndReveal 0.8s ease-out, fadeIn 0.3s ease-out 0.8s !important;
    }
    
    .reveal-uncommon {
      animation: rollAndReveal 0.8s ease-out, glowGreen 0.3s ease-out 0.8s !important;
    }
    
    .reveal-rare {
      animation: rollAndReveal 0.8s ease-out, glowBlue 0.3s ease-out 0.8s !important;
    }
    
    .reveal-epic {
      animation: rollAndReveal 0.8s ease-out, glowPurple 0.3s ease-out 0.8s !important;
    }
    
    .reveal-legendary {
      animation: rollAndReveal 0.8s ease-out, explodeGold 0.3s ease-out 0.8s !important;
    }

    @keyframes glowGreen {
      0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(46, 204, 113, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
    }

    @keyframes glowBlue {
      0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(52, 152, 219, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
    }

    @keyframes glowPurple {
      0% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(155, 89, 182, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
    }

    @keyframes explodeGold {
      0% { transform: translate(-50%, -50%) scale(0.8); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); }
      50% { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 30px 15px rgba(241, 196, 15, 0.4); }
      100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
    }

    /* Additional light mode styles */
    .light-mode .cleaning-game {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .light-mode .cleaning-game .modal-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .light-mode .cleaning-game .modal-header h2 {
      color: #2c3e50;
    }

    .light-mode .limited-offer {
      background: linear-gradient(45deg, #3498db, #9b59b6);
      color: white;
    }

    .light-mode .offer-sneaker {
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50;
    }

    .light-mode .rarity-common { color: #7f8c8d; }
    .light-mode .rarity-uncommon { color: #27ae60; }
    .light-mode .rarity-rare { color: #2980b9; }
    .light-mode .rarity-ultra-rare { color: #16a085; }
    .light-mode .rarity-epic { color: #8e44ad; }
    .light-mode .rarity-mythic { color: #e67e22; }
    .light-mode .rarity-legendary { color: #f39c12; }
    .light-mode .rarity-grail { color: #e74c3c; }

    .light-mode .better-value { color: #27ae60; }
    .light-mode .worse-value { color: #e74c3c; }
    .light-mode .equal-value { color: #f1c40f; }

    .light-mode .purchase-notification {
      background: #27ae60;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Market buyer upgrade system */
    .market-buyers-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }

    .market-buyer-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #34495e;
      border-radius: 5px;
      gap: 10px;
    }

    .market-buyer-option.active {
      background: #2ecc71;
    }

    .light-mode .market-buyer-option {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
    }

    .light-mode .market-buyer-option.active {
      background: #d4edda;
      border-color: #c3e6cb;
    }

    /* Chat area styles */
    .trade-chat { max-height: 180px; overflow-y: auto; background: #222; border-radius: 6px; padding: 8px; margin-bottom: 10px; text-align: left; }
    .trade-chat-msg { margin: 4px 0; padding: 4px 8px; border-radius: 4px; }
    .trade-chat-msg.ai-msg { background: #34495e; color: #f1c40f; }
    .trade-chat-msg.player-msg { background: #2980b9; color: #fff; text-align: right; }
    /* Trade chat: hacker font */
    .trade-chat, .trade-chat-msg { font-family: 'Fira Mono', 'Consolas', 'monospace'; letter-spacing: 0.5px; }

    html, body {
      overflow-x: hidden;
      width: 100%;
      margin: 0;
      padding: 0;
    }
    .main-layout {
      display: flex;
      flex-direction: row;
      height: 100vh;
      width: 100%;
      min-height: 600px;
      overflow-x: hidden;
    }
    .left-panel {
      width: 40%;
      min-width: 260px;
      max-width: 600px;
      background: #232b38;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 32px 12px 12px 12px;
      border-right: 2px solid #34495e;
      box-sizing: border-box;
      height: 100vh;
    }
    .right-panel {
      flex: 1;
      background: #2c3e50;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 24px 16px 16px 16px;
      box-sizing: border-box;
    }
    @media (max-width: 900px) {
      .main-layout {
        flex-direction: column;
      }
      .left-panel {
        width: 100%;
        max-width: none;
        border-right: none;
        border-bottom: 2px solid #34495e;
        flex-direction: row;
        justify-content: space-around;
        align-items: flex-start;
        padding: 16px 0 8px 0;
        height: auto;
      }
      .right-panel {
        padding: 12px 4px 4px 4px;
      }
      .clicker-button {
        width: 120px;
        height: 120px;
        font-size: 18px;
      }
      .clicker-sneaker {
        font-size: 36px;
      }
    }
    .clicker-sneaker-img {
      display: block;
      margin: 0 auto 12px auto;
      pointer-events: none;
      user-select: none;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.12));
    }
    .clicker-plusone {
      position: absolute;
      left: 50%;
      top: 50%;
      font-size: 0.8em;
      color: #fff;
      font-weight: 400;
      opacity: 0;
      pointer-events: none;
      z-index: 2;
      text-shadow: 0 2px 8px #27ae60, 0 0 2px #000;
      transition: none;
      will-change: transform, opacity;
      user-select: none;
    }
    .clicker-plusone.animate {
      animation: plusOneFloat 0.7s cubic-bezier(0.4,1.4,0.6,1) forwards;
    }
    @keyframes plusOneFloat {
      0% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      60% { opacity: 1; transform: translate(-50%, -90%) scale(1.2); }
      100% { opacity: 0; transform: translate(-50%, -180%) scale(0.8); }
    }
  </style>
</head>
<body>
  <div id="breaking-news" class="breaking-news"></div>
  <div class="modal-overlay" id="modal-overlay" onclick="closeAllModals()"></div>
  <div class="top-right-buttons">
    <button class="history-btn" onclick="openHistory()" title="Purchase History">📜</button>
  </div>
  <div class="main-layout">
    <div class="left-panel">
      <h1>Sneaker Pack Tycoon</h1>
      <div class="coins">Coins: <span id="coin-count">0</span></div>
      <div class="prestige-bar">
        Prestige: <span id="prestige-level">0</span>
        <button id="prestige-btn" class="pack-button" style="margin-left:10px;" onclick="prestigeNow()">Prestige!</button>
        <div class="prestige-progress-container" style="display:inline-block;vertical-align:middle;width:200px;height:16px;margin-left:16px;background:#444;border-radius:8px;overflow:hidden;">
          <div id="prestige-progress-bar" style="height:100%;background:#f39c12;width:0%;transition:width 0.5s;"></div>
        </div>
        <span id="prestige-next-info" style="margin-left:12px;font-size:14px;color:#f1c40f;"></span>
      </div>
      <button class="clicker-button" onclick="handleClick(); showClickerPlusOne(event);">
        <img class="clicker-sneaker-img" src="https://robohash.org/rare-sneaker-clicker.png?set=set4" alt="Sneaker" style="width:110px;height:110px;object-fit:contain;margin-bottom:12px;user-select:none;pointer-events:none;" />
        Click!
        <div class="click-count">Clicks: 0</div>
      </button>
      <button class="pack-button" onclick="openInventoryModal()" style="margin:24px 0 0 0;">Inventory</button>
    </div>
    <div class="right-panel">
      <div class="container">
        <div>
          <select id="pack-type" class="pack-select">
            <option value="standard">Standard Pack (100 Coins)</option>
            <option value="premium">Premium Pack (300 Coins)</option>
            <option value="colorway">Colorway Pack (200 Coins)</option>
            <option value="rare">Rare Pack (400 Coins)</option>
            <option value="epic">Epic Pack (700 Coins)</option>
            <option value="legendary">Legendary Pack (2500 Coins)</option>
            <option value="mystery">Mystery Pack (500 Coins)</option>
            <option value="ultra">Ultra Pack (1200 Coins)</option>
            <option value="hype">Hype Pack (900 Coins)</option>
            <option value="classic">Classic Pack (250 Coins)</option>
            <option value="collab">Collab Pack (1500 Coins)</option>
            <option value="seasonal">Seasonal Pack (600 Coins)</option>
            <option value="newrarity">New Rarity Pack (3000 Coins)</option>
          </select>
          <select id="pack-multiplier" class="pack-select" style="width:auto;">
            <option value="1">Open 1x</option>
            <option value="3">Open 3x</option>
            <option value="5">Open 5x</option>
            <option value="10">Open 10x</option>
          </select>
          <button class="pack-button" onclick="openPackDropdown()">Open Pack</button>
          <button class="pack-button" style="margin-left:8px;" onclick="previewPack()">Pack Preview</button>
        </div>
        <div class="upgrades">
          <h2>Store Upgrades</h2>
          <button class="pack-button" onclick="openUsedMarket()">Browse Used Sneakers</button>
          <div class="resell-agent">
            <h3>Resell Agents</h3>
            <div class="agent-types" id="agent-types">
              <!-- Agent types will be inserted here -->
            </div>
            <div class="agent-level">
              Level: <div class="level-indicator" id="agent-level"></div>
            </div>
            <div class="agent-bonus" id="agent-bonus"></div>
            <button class="pack-button" id="upgrade-agent-btn" onclick="upgradeResellAgent()">Upgrade Agent</button>
          </div>
          <div class="staff-section">
            <h3>Automated Staff</h3>
            <button class="pack-button" onclick="openHireStaff()">Hire Staff</button>
            <div class="staff-grid" id="staff-grid">
              <!-- Staff members will be inserted here -->
            </div>
          </div>
        </div>
        <div class="trading">
          <h2>AI Trading System (Sneaker-for-Sneaker)</h2>
          <button class="pack-button" onclick="openTradeUI()">Enter Trade</button>
        </div>
      </div>
    </div>
  </div>
  <div class="modal" id="used-market-modal">
    <div class="modal-header">
      <h2>Used Sneaker Market</h2>
      <button class="close-btn" onclick="closeUsedMarket()">Close</button>
    </div>
    <div class="used-market-grid" id="used-market-grid">
      <!-- Used sneakers will be inserted here -->
    </div>
  </div>
  <div class="cleaning-game" id="cleaning-game">
    <div class="modal-header">
      <h2>Clean Your New Sneaker</h2>
      <button class="close-btn" onclick="finishCleaning()">✕</button>
    </div>
    <div class="cleaning-info">
      <p>Click on the dirt spots to clean them!</p>
      <div class="condition-bar">
        <div class="condition-fill" id="cleaning-progress"></div>
      </div>
    </div>
    <canvas id="sneaker-canvas" class="sneaker-canvas" width="400" height="300"></canvas>
    <button class="pack-button" onclick="finishCleaning()">Finish Cleaning</button>
  </div>
  <div class="modal" id="pack-modal">
    <div id="modal-content">
      <h2>Opening Pack...</h2>
      <div id="card-container" class="card-container"></div>
      <button id="next-sneaker-btn" onclick="revealNextSneaker()">Next Sneaker</button>
    </div>
  </div>
  <div class="modal" id="trade-modal">
    <div>
      <h2>Select Trader</h2>
      <div class="trader-selection" id="trader-selection">
        <!-- Trader cards will be inserted here -->
      </div>
      <div id="ai-trader" class="ai-trader-info" style="display: none;">
        <!-- AI trader info will be inserted here -->
      </div>
      <div class="trade-selection">
        <div><b>Select sneakers to offer:</b></div>
      <select id="trade-dropdown"></select>
        <button class="pack-button" onclick="addToTrade()">Add to Trade</button>
        <div id="selected-sneakers" class="selected-sneakers"></div>
      </div>
      <div class="trade-comparison">
        <div class="trade-side" id="your-offer">
          <h3>Your Offer</h3>
          <div class="offer-details"></div>
        </div>
        <div class="trade-arrow">↔️</div>
        <div class="trade-side" id="ai-offer">
          <h3>AI's Offer</h3>
          <div class="offer-details"></div>
        </div>
      </div>
      <div id="ai-response" class="ai-response"></div>
      <div class="negotiation-options" id="negotiation-options"></div>
      <div id="trade-offer" class="trade-offer"></div>
      <div id="trade-chat" class="trade-chat"></div>
      <button class="close-btn" onclick="closeTradeUI()">Close</button>
    </div>
  </div>
  <div class="modal" id="history-modal">
    <div class="modal-header">
      <h2>Purchase History</h2>
      <button class="close-btn" onclick="closeHistory()">Close</button>
    </div>
    <div class="purchase-history" id="purchase-history">
      <!-- Purchase history items will be added here -->
    </div>
  </div>
  <div class="staff-hire-modal" id="staff-hire-modal">
    <div class="modal-header">
      <h2>Hire Staff</h2>
      <button class="close-btn" onclick="closeHireStaff()">Close</button>
    </div>
    <div class="staff-hire-list" id="staff-hire-list">
      <!-- Staff hire options will be inserted here -->
    </div>
  </div>
  <div class="test-buttons">
    <button class="test-button" onclick="showBreakingNews(true)">Test Breaking News</button>
  </div>
  <div class="modal" id="inventory-modal">
    <div class="modal-header">
      <h2>Your Inventory</h2>
      <button class="close-btn" onclick="closeInventoryModal()">Close</button>
    </div>
    <div id="inventory-total-value" style="font-size:18px;margin-bottom:8px;color:#f1c40f;"></div>
    <div id="inventory-list" class="inventory-list-flex"></div>
  </div>
  <script>
    // Initialize game state
    let coins = 0;
    let inventory = [];
    let purchaseHistory = [];
    let settings = {
      soundEnabled: true,
      musicEnabled: true,
      soundVolume: 0.5,
      musicVolume: 0.3,
      notifications: true,
      animations: true,
      autoSell: false,
      currencyDisplay: 'full',
      displayMode: 'grid',
      defaultSort: 'rarity',
      rollAnimation: true,
      volume: 50,
      lightMode: false,
      skipPackAnimation: false
    };
    // Prestige system state
    let prestigeLevel = 0;
    let prestigeUpgrades = {
      packDiscount: 0,      // % discount on packs
      coinMultiplier: 0,    // % more coins from all sources
      rareOdds: 0,          // % better rare odds
      autoClickerBoost: 0   // % faster auto clicker
    };

    // Initialize game state from save or defaults
    function initializeGame() {
      const savedState = localStorage.getItem('sneakerHustleGameState');
      console.log('[initializeGame] Loaded state from localStorage:', savedState);
      if (savedState) {
        try {
          const gameState = JSON.parse(savedState);
          coins = gameState.coins ?? 10000;
          inventory = gameState.inventory || [];
          purchaseHistory = gameState.purchaseHistory || [];
          if (gameState.settings) settings = { ...settings, ...gameState.settings };
          if (gameState.currentMarketBuyer) currentMarketBuyer = gameState.currentMarketBuyer;
          if (gameState.limitedOffers) limitedOffers = new Map(gameState.limitedOffers);
          if (gameState.activeMultipliers) {
            window.globalMultiplier = gameState.activeMultipliers.global;
            window.brandMultipliers = gameState.activeMultipliers.brand;
            window.coinMultiplier = gameState.activeMultipliers.coin;
          }
          if (gameState.currentTrader) {
            window.currentTrader = gameState.currentTrader;
            window.lastTraderResponse = gameState.lastTraderResponse;
          }
          if (gameState.hiredStaff) hiredStaff = gameState.hiredStaff;
          // --- FIX: Only restore resellAgent.level if not already reset (i.e., not after prestige) ---
          if (typeof resellAgent.level === 'number' && resellAgent.level === 0 && gameState.prestigeLevel !== undefined && prestigeLevel === gameState.prestigeLevel) {
            if (gameState.resellAgentLevel !== undefined) resellAgent.level = gameState.resellAgentLevel;
          }
          if (gameState.storageUpgrades !== undefined) storageUpgrades = gameState.storageUpgrades;
          if (gameState.storageCost !== undefined) storageCost = gameState.storageCost;
          if (gameState.prestigeLevel !== undefined) prestigeLevel = gameState.prestigeLevel;
        } catch (error) {
          console.error('Error loading game state:', error);
          setDefaultState();
        }
      } else {
        setDefaultState();
      }
      updateAllDisplays();
      updateStorageDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Set default state for new games
    function setDefaultState() {
      coins = 1000
      inventory = [];
      purchaseHistory = [];
      settings = {
        soundEnabled: true,
        musicEnabled: true,
        soundVolume: 0.5,
        musicVolume: 0.3,
        notifications: true,
        animations: true,
        autoSell: false,
        currencyDisplay: 'full',
        displayMode: 'grid',
        defaultSort: 'rarity',
        rollAnimation: true,
        volume: 50,
        lightMode: false,
        skipPackAnimation: false
      };
      hiredStaff = [];
      resellAgent.level = 0;
      resellAgent.baseUpgradeCost = 500;
      resellAgent.bonusPerLevel = 0.2;
      resellAgent.maxLevel = 5;
      storageUpgrades = 0;
      storageCost = 300;
      if (document.getElementById('storage-cost')) document.getElementById('storage-cost').textContent = storageCost;
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Update all UI displays
    function updateAllDisplays() {
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      updateLimitedOffers();
      updateMarketBuyerDisplay();
      applySettings();
      updatePrestigeDisplay();
    }

    function updatePrestigeDisplay() {
      document.getElementById('prestige-level').textContent = prestigeLevel;
      const nextCost = getNextPrestigeCost();
      const canPrestige = coins >= nextCost;
      document.getElementById('prestige-btn').style.display = 'inline-block';
      document.getElementById('prestige-btn').disabled = !canPrestige;
      // Update progress bar
      const bar = document.getElementById('prestige-progress-bar');
      if (bar) {
        const percent = Math.min(100, (coins / nextCost) * 100);
        bar.style.width = percent + '%';
      }
      // Update info text with clear numbers
      const info = document.getElementById('prestige-next-info');
      if (info) {
        info.textContent = `Prestige: ${prestigeLevel} | Coins: ${formatCurrency(coins)} / ${formatCurrency(nextCost)} for next prestige`;
      }
    }

    function getNextPrestigeCost() {
      return 100000 * (prestigeLevel + 1);
    }

    function prestigeNow() {
      const nextCost = getNextPrestigeCost();
      if (coins < nextCost) return;
      prestigeLevel++;
      // Reset all progress in-memory (do not rely on localStorage)
      coins = 0;
      inventory = [];
      purchaseHistory = [];
      hiredStaff = [];
      resellAgent.level = 0;
      resellAgent.baseUpgradeCost = 500;
      resellAgent.bonusPerLevel = 0.2;
      resellAgent.maxLevel = 5;
      storageUpgrades = 0;
      storageCost = 300;
      clickCount = 0;
      prestigeUpgrades = {
        packDiscount: 0,
        coinMultiplier: 0,
        rareOdds: 0,
        autoClickerBoost: 0
      };
      // --- FIX: Remove saved resellAgentLevel from localStorage on prestige ---
      const savedState = localStorage.getItem('sneakerHustleGameState');
      if (savedState) {
        try {
          const gameState = JSON.parse(savedState);
          delete gameState.resellAgentLevel;
          localStorage.setItem('sneakerHustleGameState', JSON.stringify(gameState));
        } catch (e) {}
      }
      // --- FIX: Clear all staff effects and timers after prestige ---
      applyStaffBonuses();
      // Defensive: clear any lastTradeTime on autoBuyer if it exists
      if (window.autoBuyer && window.autoBuyer.lastTradeTime) window.autoBuyer.lastTradeTime = 0;
      // Force-clear UI for inventory, staff, and agent
      if (document.getElementById('inventory-list')) document.getElementById('inventory-list').innerHTML = '';
      if (document.getElementById('inventory-total-value')) document.getElementById('inventory-total-value').textContent = '';
      if (document.getElementById('staff-grid')) document.getElementById('staff-grid').innerHTML = '';
      if (document.getElementById('agent-level')) document.getElementById('agent-level').innerHTML = '';
      saveGameState();
      updateAllDisplays();
      updatePackDropdown();
      updateResellAgentDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
      showPurchaseNotification('Prestiged! All bonuses increased.');
      if (document.getElementById('agent-bonus')) document.getElementById('agent-bonus').textContent = '';
      const upgradeBtn = document.getElementById('upgrade-agent-btn');
      if (upgradeBtn) {
        const nextCost = resellAgent.baseUpgradeCost; // Level 0 after prestige
        upgradeBtn.textContent = `Upgrade Agent (${formatCurrency(nextCost)} coins)`;
        upgradeBtn.disabled = false;
      }
      updateResellAgentDisplay();
    }

    // Save game state
    function saveGameState() {
      const gameState = {
        coins,
        inventory,
        purchaseHistory,
        settings,
        currentMarketBuyer,
        limitedOffers: Array.from(limitedOffers.entries()),
        activeMultipliers: {
          global: window.globalMultiplier || 1,
          brand: window.brandMultipliers || {},
          coin: window.coinMultiplier || 1
        },
        currentTrader: window.currentTrader,
        lastTraderResponse: window.lastTraderResponse,
        hiredStaff,
        resellAgentLevel: resellAgent.level,
        storageUpgrades,
        storageCost,
        prestigeLevel,
        prestigeUpgrades
      };
      
      localStorage.setItem('sneakerHustleGameState', JSON.stringify(gameState));
    }

    // Initialize when the page loads
    window.addEventListener('load', () => {
      initializeGame();
      generateNewsEvent();
      
      // Set up auto-save
      setInterval(saveGameState, 300000); // Every 5 minutes
    });

    // Save before unloading
    window.addEventListener('beforeunload', saveGameState);

    // Initialize game variables
    let upgrades = { betterOdds: false, storageExpand: false };
    let totalProfit = 0;
    let currentSneakers = [];
    let currentSneakerIndex = 0;
    let currentOffer = null;
    let offerInterval = null;
    let selectedTradeItems = [];
    let activeEvents = new Map();
    let clickCount = 0;
    let currentCleaningSneaker = null;
    let dirtSpots = [];
    let cleaningInProgress = false;

    // News Events Data
    const newsEvents = [
      {
        type: "celebrity",
        templates: [
          "{celebrity} spotted wearing {sneaker}! Prices {direction}!",
          "Breaking: {celebrity} signs deal with {sneaker} brand!",
          "{celebrity}'s {sneaker} collection causing market frenzy!"
        ],
        valueEffect: [0.2, 0.5], // 20-50% increase
        duration: 300000 // 5 minutes
      },
      {
        type: "market",
        templates: [
          "Market Alert: {sneaker} prices {direction} rapidly!",
          "Unexpected demand surge for {sneaker}!",
          "Rare {sneaker} batch discovered! Market adjusting!"
        ],
        valueEffect: [-0.3, 0.3], // -30% to +30%
        duration: 600000 // 10 minutes
      },
      {
        type: "trend",
        templates: [
          "TikTok trend featuring {sneaker} goes viral!",
          "Fashion influencers can't get enough of {sneaker}!",
          "Street style: {sneaker} becomes must-have item!"
        ],
        valueEffect: [0.1, 0.4], // 10-40% increase
        duration: 450000 // 7.5 minutes
      }
    ];

    // Add more celebrities and events
    const celebrities = [
      // Musicians
      "Drake", "Travis Scott", "Kanye West", "Bad Bunny", "The Weeknd",
      "Taylor Swift", "Billie Eilish", "Post Malone", "J Balvin", "BTS",
      "Rihanna", "Jay-Z", "Eminem", "Lil Baby", "Tyler, The Creator",
      
      // Athletes
      "LeBron James", "Cristiano Ronaldo", "Lionel Messi", "Kevin Durant",
      "Stephen Curry", "Neymar Jr", "Kylian Mbappé", "Giannis Antetokounmpo",
      "Zion Williamson", "Ja Morant", "Erling Haaland", "Luka Dončić",
      
      // Entertainers
      "Zendaya", "Tom Holland", "Michael B. Jordan", "Ryan Reynolds",
      "Donald Glover", "Kevin Hart", "Margot Robbie", "Timothée Chalamet",
      
      // Fashion/Social
      "Kylie Jenner", "Bella Hadid", "A$AP Rocky", "Virgil Abloh",
      "Kim Kardashian", "Kendall Jenner", "Pharrell Williams", "Jerry Lorenzo"
    ];

    // Special Events with Coin Multipliers
    const specialEvents = [
      {
        type: "market_surge",
        templates: [
          "🌟 MARKET SURGE: All sales give {multiplier}x coins for {duration} minutes!",
          "💫 GOLDEN HOUR: {multiplier}x coins from all transactions for {duration} minutes!",
          "🎯 HOT MARKET: Earn {multiplier}x coins from sales for {duration} minutes!"
        ],
        rarity: 0.05, // 5% chance
        multipliers: [2, 3, 5, 10],
        durations: [2, 3, 5] // minutes
      },
      {
        type: "lucky_find",
        templates: [
          "🍀 LUCKY FIND: Next pack has {multiplier}x better odds!",
          "✨ BLESSED PACK: Your next opening has {multiplier}x rarity chance!",
          "🎲 FORTUNE FAVORS: {multiplier}x rarity boost on your next pack!"
        ],
        rarity: 0.08, // 8% chance
        multipliers: [2, 3, 5]
      },
      {
        type: "market_crash",
        templates: [
          "📉 MARKET CRASH: All sneakers {direction} in value by {percentage}%!",
          "💥 ECONOMIC SHOCK: Global sneaker values {direction} {percentage}%!",
          "🌪 MARKET CHAOS: Sudden {percentage}% {direction} in all values!"
        ],
        rarity: 0.03, // 3% chance
        effects: [-0.5, -0.3, 0.3, 0.5]
      }
    ];

    // Card reveal effects based on rarity
    const cardEffects = {
      common: {
        animation: "fade",
        color: "#7f8c8d",
        sound: "whoosh"
      },
      rare: {
        animation: "flip",
        color: "#2980b9",
        particles: "sparkle"
      },
      epic: {
        animation: "spin",
        color: "#8e44ad",
        particles: "burst"
      },
      legendary: {
        animation: "explosion",
        color: "#f39c12",
        particles: "fireworks"
      }
    };

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function finishPackOpening() {
      inventory.push(...currentSneakers);
      updateInventory();
      
      // Close the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.remove('show');
      modalOverlay.classList.remove('show');
      
      // Reset state
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      currentSneakerIndex = 0;
      currentSneakers = [];
      
      // Re-enable all buttons
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = false;
      });
    }

    // --- 100+ Sneaker Database ---
    const brands = [
      "Nike", "Adidas", "Jordan", "Puma", "Reebok", "New Balance", "Asics", 
      "Converse", "Vans", "Saucony", "Under Armour", "Yeezy", "Off-White",
      "Balenciaga", "Gucci", "Louis Vuitton", "Alexander McQueen", "Dior"
    ];
    
    const models = [
      // Nike Models
      "Air Max 90", "Dunk Low", "Air Force 1", "SB Dunk", "Air Max 95", 
      "Air Max 97", "Air Max 1", "Air Jordan 1", "Air Jordan 4", "Air Jordan 11",
      "Air Presto", "React Element", "Blazer Mid", "Cortez", "Waffle One",
      
      // Adidas Models
      "Yeezy Boost 350", "Superstar", "Ultra Boost", "NMD R1", "Forum Low",
      "Stan Smith", "Samba", "ZX 750", "Ozweego", "Campus",
      
      // Jordan Models
      "Retro 1", "Retro 3", "Retro 4", "Retro 5", "Retro 6",
      "Retro 11", "Retro 12", "Retro 13", "Legacy 312", "XXXV",
      
      // Luxury Models
      "Triple S", "Speed Trainer", "Rhyton", "Ace", "Run Away",
      "B23 High", "Chain Reaction", "Oversized", "Wave", "Track",
      
      // Classic Models
      "Chuck Taylor", "Old Skool", "Sk8-Hi", "Era", "Authentic",
      "Club C 85", "Classic Leather", "Workout Plus", "550", "992",
      
      // Running/Athletic
      "Gel Lyte III", "Kayano 5", "Jazz Original", "Triumph", "HOVR",
      "Fresh Foam", "Kinvara", "Endorphin", "Zoom Fly", "Pegasus"
    ];
    
    const colorways = [
      // Basic Colors
      "White/Black", "Black/White", "Triple Black", "Triple White", "Navy/White",
      "Red/White", "Green/White", "Blue/White", "Grey/White", "Cream/White",
      
      // Popular Nicknames
      "Bred", "Chicago", "Royal", "Shadow", "Mocha",
      "University Blue", "Volt", "Infrared", "Cement", "Pine Green",
      
      // Special Editions
      "Travis Scott", "Off-White", "Fragment", "Union LA", "A Ma Maniere",
      "Sean Wotherspoon", "Virgil Abloh", "Sacai", "Cactus Jack", "Fear of God",
      
      // Patterns
      "Zebra", "Tiger Stripe", "Safari Print", "Snake Skin", "Tie Dye",
      "Splatter", "Gradient", "Camo", "Animal Print", "Paisley",
      
      // Materials
      "Patent Leather", "Suede", "Canvas", "Mesh", "Knit",
      "Premium Leather", "Nubuck", "Corduroy", "Denim", "Velvet",
      
      // Seasonal
      "Summer Pack", "Winter Camo", "Fall Tones", "Spring Pastels", "Holiday",
      "Valentine's Day", "Halloween", "Christmas", "Easter", "New Year",
      
      // Collaborations
      "Supreme", "Undefeated", "Concepts", "Atmos", "Patta",
      "Stussy", "Diamond Supply", "Kith", "Bodega", "SNS",
      
      // Limited Editions
      "Friends & Family", "Sample", "Prototype", "Region Exclusive", "Store Exclusive",
      "Anniversary", "Retro+", "OG", "Vintage", "Player Exclusive"
    ];

    const rarities = [
      { rarity: "common", weight: 50, value: [10, 30] },
      { rarity: "uncommon", weight: 30, value: [25, 60] },
      { rarity: "rare", weight: 15, value: [50, 120] },
      { rarity: "ultra-rare", weight: 7, value: [100, 250] },
      { rarity: "epic", weight: 3, value: [200, 500] },
      { rarity: "mythic", weight: 1, value: [400, 1200] },
      { rarity: "legendary", weight: 0.4, value: [1000, 3000] },
      { rarity: "grail", weight: 0.1, value: [2500, 7000] }
    ];

    // Instead of generating a fixed database, generate a random sneaker on demand
    function getRandomSneaker(rarity) {
      const brand = brands[Math.floor(Math.random() * brands.length)];
      const model = models[Math.floor(Math.random() * models.length)];
      const colorway = colorways[Math.floor(Math.random() * colorways.length)];
      let baseValue = 50;
      for (let r of rarities) {
        if (r.rarity === rarity) {
          baseValue = Math.floor(r.value[0] + Math.random() * (r.value[1] - r.value[0]));
          break;
        }
      }
      return {
        id: Date.now() + Math.random(),
        brand,
        model,
        colorway,
        rarity,
        baseValue,
        image: `https://robohash.org/${encodeURIComponent(brand + '-' + model + '-' + colorway)}.png?set=set4`
      };
    }

    // --- Pack Definitions ---
    const packTypes = {
      standard: {
        cost: 100,
        odds: { common: 0.60, uncommon: 0.22, rare: 0.10, 'ultra-rare': 0.04, epic: 0.025, mythic: 0.009, legendary: 0.005, grail: 0.001 },
        bg: '#222'
      },
      premium: {
        cost: 300,
        odds: { common: 0.30, uncommon: 0.25, rare: 0.18, 'ultra-rare': 0.10, epic: 0.07, mythic: 0.025, legendary: 0.015, grail: 0.005 },
        bg: '#2980b9'
      },
      colorway: {
        cost: 200,
        odds: { common: 0.40, uncommon: 0.25, rare: 0.15, 'ultra-rare': 0.08, epic: 0.06, mythic: 0.02, legendary: 0.009, grail: 0.001 },
        colorway: true,
        bg: '#8e44ad'
      },
      rare: {
        cost: 400,
        odds: { rare: 0.40, 'ultra-rare': 0.22, epic: 0.18, mythic: 0.08, legendary: 0.06, grail: 0.01, uncommon: 0.03, common: 0.02 },
        bg: '#16a085'
      },
      epic: {
        cost: 700,
        odds: { epic: 0.40, mythic: 0.22, legendary: 0.18, grail: 0.04, 'ultra-rare': 0.10, rare: 0.04, uncommon: 0.01, common: 0.01 },
        bg: '#8e44ad'
      },
      legendary: {
        cost: 2500,
        odds: { legendary: 0.60, grail: 0.20, mythic: 0.10, epic: 0.07, 'ultra-rare': 0.02, rare: 0.01, uncommon: 0, common: 0 },
        bg: '#f39c12'
      },
      mystery: {
        cost: 500,
        odds: { common: 0.20, uncommon: 0.18, rare: 0.18, 'ultra-rare': 0.12, epic: 0.10, mythic: 0.07, legendary: 0.04, grail: 0.01 },
        bg: '#34495e'
      },
      ultra: {
        cost: 1200,
        odds: { 'ultra-rare': 0.30, epic: 0.25, mythic: 0.18, legendary: 0.15, grail: 0.07, rare: 0.03, uncommon: 0.01, common: 0.01 },
        bg: '#e74c3c'
      },
      hype: {
        cost: 900,
        odds: { uncommon: 0.10, rare: 0.18, 'ultra-rare': 0.20, epic: 0.20, mythic: 0.12, legendary: 0.10, grail: 0.04, common: 0.06 },
        bg: '#27ae60'
      },
      classic: {
        cost: 250,
        odds: { common: 0.50, uncommon: 0.25, rare: 0.15, 'ultra-rare': 0.05, epic: 0.03, mythic: 0.01, legendary: 0.005, grail: 0.0005 },
        bg: '#bdc3c7'
      },
      collab: {
        cost: 1500,
        odds: { rare: 0.10, 'ultra-rare': 0.18, epic: 0.25, mythic: 0.18, legendary: 0.18, grail: 0.08, uncommon: 0.01, common: 0.01 },
        colorway: true,
        bg: '#9b59b6'
      },
      seasonal: {
        cost: 600,
        odds: { common: 0.20, uncommon: 0.20, rare: 0.18, 'ultra-rare': 0.12, epic: 0.10, mythic: 0.08, legendary: 0.06, grail: 0.02 },
        bg: '#f1c40f'
      },
      newrarity: {
        cost: 3000,
        odds: { 'ultra-rare': 0.20, epic: 0.20, mythic: 0.20, legendary: 0.20, grail: 0.15, rare: 0.03, uncommon: 0.01, common: 0.01 },
        bg: 'linear-gradient(90deg, #e67e22, #e74c3c, #8e44ad, #f39c12)'
      }
    };

    function showNotification(message) {
      if (!settings.notificationsEnabled) return;
      alert(message);
    }

    function updateInventory() {
      const inventoryDiv = document.getElementById("inventory-list");
      const totalValueDiv = document.getElementById("inventory-total-value");
      inventoryDiv.innerHTML = '';
      if (inventory.length === 0) {
        inventoryDiv.innerHTML = "<em>No sneakers in inventory.</em>";
        if (totalValueDiv) totalValueDiv.textContent = '';
        return;
      }

      // Calculate total value
      let totalValue = 0;
      inventory.forEach(sneaker => {
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) ? sneaker.dynamicValue : sneaker.baseValue;
        totalValue += value;
      });
      if (totalValueDiv) totalValueDiv.textContent = `Total Inventory Value: ${formatCurrency(Math.floor(totalValue))} coins`;

      // Sort inventory based on settings
      const sortedInventory = [...inventory].sort((a, b) => {
        switch (settings.defaultSort) {
          case 'rarity':
            return rarities.findIndex(r => r.rarity === b.rarity) - 
                   rarities.findIndex(r => r.rarity === a.rarity);
          case 'value':
            return (b.dynamicValue || b.baseValue) - (a.dynamicValue || a.baseValue);
          case 'brand':
            return a.brand.localeCompare(b.brand);
          case 'newest':
            return inventory.indexOf(b) - inventory.indexOf(a);
          default:
            return 0;
        }
      });

      sortedInventory.forEach((sneaker, index) => {
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) 
          ? sneaker.dynamicValue 
          : sneaker.baseValue;
        
        const event = activeEvents.get(sneaker.id);
        const valueChangeClass = event ? 
          (event.effect > 0 ? 'value-increase' : 'value-decrease') : '';

        inventoryDiv.innerHTML += `
          <div class="sneaker-card" data-sneaker-id="${sneaker.id}">
            <img src="${sneaker.image}" alt="${sneaker.brand} ${sneaker.model}" style="width:80px;height:80px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
            <strong>${sneaker.brand} ${sneaker.model}</strong>
            <span>${sneaker.colorway}</span>
            <span class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</span><br>
            <span class="sneaker-value ${valueChangeClass}">
              Value: ${formatCurrency(Math.floor(value))} coins
            </span>
            <br><button onclick="sellSneakerById('${sneaker.id}')" style="margin-top:8px;padding:5px 10px;">Sell</button>
          </div>
        `;
      });

      // Update trade dropdown if it exists
      if (document.getElementById("trade-dropdown")) {
        renderTradeDropdown();
      }
    }
    function updateCoins() {
      const coinDisplay = document.getElementById('coin-count');
      if (coinDisplay) {
        let displayValue = coins;
        if (settings.currencyDisplay === 'k') {
          displayValue = coins >= 1000 ? (coins/1000).toFixed(1) + 'K' : coins;
        }
        coinDisplay.textContent = formatCurrency(displayValue);
      }
      updatePrestigeDisplay();
    }

    function formatCurrency(amount) {
      if (settings.currencyDisplay === 'k' && amount >= 1000) {
        return (amount/1000).toFixed(1) + 'K';
      } else if (settings.currencyDisplay === 'full') {
        return amount.toLocaleString();
      }
      return amount.toString();
    }

    function loadSettings() {
      const savedSettings = localStorage.getItem('gameSettings');
      if (savedSettings) {
        settings = JSON.parse(savedSettings);
        document.getElementById('auto-sell-toggle').checked = settings.autoSell;
        document.getElementById('sound-toggle').checked = settings.soundEnabled;
        document.getElementById('animation-toggle').checked = settings.animationEnabled;
        document.getElementById('notification-toggle').checked = settings.notificationsEnabled;
        document.getElementById('volume-control').value = settings.volume;
        document.getElementById('volume-value').textContent = settings.volume + '%';
        document.getElementById('display-mode').value = settings.displayMode;
        document.getElementById('currency-display').value = settings.currencyDisplay;
        document.getElementById('sort-inventory').value = settings.defaultSort;
        document.getElementById('roll-animation-toggle').checked = settings.rollAnimation;
        document.getElementById('light-mode-toggle').checked = settings.lightMode;
        document.getElementById('skip-animation-toggle').checked = settings.skipPackAnimation;
        if (settings.lightMode) {
          document.body.classList.add('light-mode');
        } else {
          document.body.classList.remove('light-mode');
        }
        if (!settings.animationEnabled) {
          document.body.classList.add('no-animations');
        }
        updateInventory();
        updateCoins();
      }
    }

    function saveSettings() {
      localStorage.setItem('gameSettings', JSON.stringify(settings));
    }

    function toggleAutoSell() {
      settings.autoSell = document.getElementById('auto-sell-toggle').checked;
      saveSettings();
    }

    function toggleSound() {
      settings.soundEnabled = document.getElementById('sound-toggle').checked;
      saveSettings();
    }

    function toggleAnimation() {
      settings.animationEnabled = document.getElementById('animation-toggle').checked;
      document.body.classList.toggle('no-animations', !settings.animationEnabled);
      saveSettings();
    }

    function toggleNotifications() {
      settings.notificationsEnabled = document.getElementById('notification-toggle').checked;
      saveSettings();
    }

    function updateVolume() {
      settings.volume = document.getElementById('volume-control').value;
      document.getElementById('volume-value').textContent = settings.volume + '%';
      saveSettings();
    }

    function updateDisplayMode() {
      settings.displayMode = document.getElementById('display-mode').value;
      const inventoryList = document.getElementById('inventory-list');
      inventoryList.className = 'inventory-' + settings.displayMode;
      saveSettings();
      updateInventory();
    }

    function updateCurrencyDisplay() {
      settings.currencyDisplay = document.getElementById('currency-display').value;
      saveSettings();
      updateCoins();
      updateInventory();
    }

    function updateDefaultSort() {
      settings.defaultSort = document.getElementById('sort-inventory').value;
      saveSettings();
      updateInventory();
    }

    function toggleRollAnimation() {
      settings.rollAnimation = document.getElementById('roll-animation-toggle').checked;
      saveSettings();
    }

    function openPack() {
      const type = document.getElementById("pack-type").value;
      let pack = {...packTypes[type]};
      pack.cost = getDiscountedPackPrice(type);
      if (coins < pack.cost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      coins -= pack.cost;
      updateCoins();

      // Disable buttons during pack opening
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = true;
      });

      // Show the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.add('show');
      modalOverlay.classList.add('show');

      // Generate sneakers
      currentSneakers = [];
      for (let i = 0; i < 3; i++) {
        let sneaker = rollSneaker(type);
        currentSneakers.push(sneaker);
      }

      // Record the purchase
      addPurchaseToHistory('Pack Opening', pack.cost, currentSneakers);
      
      // Reset state and start reveal
      currentSneakerIndex = 0;
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      revealNextSneaker();

      // Apply authenticator staff bonus to odds
      let odds = {...pack.odds};
      let totalRarityBonus = rarityBonus + 0.01 * (prestigeUpgrades.rareOdds || 0) + (prestigeLevel * 0.02);
      if (odds.rare) odds.rare += totalRarityBonus;
      if (odds.epic) odds.epic += totalRarityBonus;
      if (odds.legendary) odds.legendary += totalRarityBonus;
      // Normalize odds if they exceed 1
      let total = Object.values(odds).reduce((a, b) => a + b, 0);
      if (total > 1) {
        Object.keys(odds).forEach(k => odds[k] /= total);
      }
    }

    // Patch rollSneaker to use getRandomSneaker and allow all brands
    function rollSneaker(type) {
      const pack = packTypes[type];
      let roll = Math.random();
      if (upgrades.betterOdds) roll += 0.05;
      let odds = {...pack.odds};
      if (prestigeLevel > 0) {
        let bonus = 0.05 * prestigeLevel;
        // Apply bonus to all rarities except common
        Object.keys(odds).forEach(key => {
          if (key !== 'common') odds[key] += bonus;
        });
        if (odds.common) odds.common = Math.max(0, odds.common - bonus * (Object.keys(odds).length - 1));
        // Normalize if total > 1
        let total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      let rarity = "common";
      let sum = 0;
      // Use all rarity keys in odds, in the order of the rarities array for consistency
      for (let r of rarities) {
        const key = r.rarity;
        if (odds[key]) {
          sum += odds[key];
          if (roll < sum) {
            rarity = key;
            break;
          }
        }
      }
      return getRandomSneaker(rarity);
    }

    function createRollItem(sneaker) {
      return `
        <strong>${sneaker.brand} ${sneaker.model}</strong>
        <span>${sneaker.colorway}</span>
        <span class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</span>
      `;
    }

    function sellSneaker(index) {
      if (index < 0 || index >= inventory.length) return;
      
      let sneaker = inventory[index];
      let value = sneaker.baseValue;
      
      // Apply any active event effects
      activeEvents.forEach(event => {
        if (event.sneaker === `${sneaker.brand} ${sneaker.model}`) {
          value *= (1 + event.effect);
        }
      });
      
      // Apply resell agent bonus
      const bonus = 1 + (resellAgent.level * resellAgent.bonusPerLevel);
      value = Math.floor(value * bonus);
      
      coins += Math.floor(value * (1 + 0.10 * prestigeLevel));
      inventory.splice(index, 1); // Remove the sneaker from inventory
      updateCoins();
      updateInventory();
      showPurchaseNotification(`Sold ${sneaker.brand} ${sneaker.model} for ${formatCurrency(value)} coins!`);
    }

    function claimDaily() {
      const lastClaim = localStorage.getItem('dailyReward');
      const now = Date.now();
      if (!lastClaim || now - lastClaim > 86400000) {
        coins += 300;
        localStorage.setItem('dailyReward', now);
        updateCoins();
        showNotification("Daily reward claimed!");
      } else {
        showNotification("Already claimed today!");
      }
    }

    function buyUpgrade(type) {
      if (type === 'storageExpand') {
        if (storageUpgrades >= 10) {
          showPurchaseNotification('Maximum storage reached!', 'error');
          return;
        }
        if (coins >= storageCost) {
          coins -= storageCost;
          storageUpgrades++;
          storageCost = Math.floor(storageCost * 1.5); // 50% increase each time
          document.getElementById('storage-cost').textContent = storageCost;
          showPurchaseNotification('Storage expanded!');
          updateCoins();
        } else {
          showPurchaseNotification('Not enough coins!', 'error');
        }
      }
    }

    // --- TRADE UI ---
    let aiTradeOffer = [];

    // AI Trader System
    const aiTraders = [
      { name: "Sneaker Steve", emoji: "👟", preferences: ["Nike", "Jordan", "Yeezy", "Adidas", "SB Dunk", "Ultra Boost"], style: "hype", valuePreference: "high", traits: ["Loves limited editions", "Prefers hyped releases"] },
      { name: "Vintage Vicky", emoji: "👠", preferences: ["Converse", "Vans", "Chuck Taylor", "Old Skool", "Classic Leather", "Retro+"], style: "classic", valuePreference: "low", traits: ["Collects retro models", "Values original colorways"] },
      { name: "Luxury Larry", emoji: "💎", preferences: ["Balenciaga", "Gucci", "Louis Vuitton", "Dior", "legendary", "epic"], style: "luxury", valuePreference: "ultra", traits: ["Only wants premium items", "Focuses on rare finds"] },
      { name: "Budget Bob", emoji: "💰", preferences: ["common", "rare", "Puma", "Reebok", "Saucony", "Under Armour"], style: "budget", valuePreference: "low", traits: ["Looks for deals", "Prefers common models"] },
      { name: "Collector Charlie", emoji: "🏆", preferences: ["rare", "epic", "550", "992", "Sample", "OG"], style: "collector", valuePreference: "medium", traits: ["Completes sets", "Values condition"] },
      { name: "Reseller Rachel", emoji: "📈", preferences: ["Jordan", "Yeezy", "SB Dunk", "Ultra Boost", "Forum Low"], style: "hype", valuePreference: "high", traits: ["Watches market trends", "Knows resale values"] },
      { name: "Designer Dan", emoji: "✨", preferences: ["Off-White", "Travis Scott", "Fragment", "Union LA", "limited", "colorway"], style: "luxury", valuePreference: "high", traits: ["Loves unique designs", "Prefers collaborations"] },
      { name: "Athletic Amy", emoji: "🏃‍♀️", preferences: ["Nike", "Asics", "Gel Lyte III", "Kayano 5", "Zoom Fly", "Pegasus"], style: "classic", valuePreference: "medium", traits: ["Values performance", "Likes durability"] },
      { name: "Trendy Tom", emoji: "🌟", preferences: ["New Balance", "Adidas", "Fresh Foam", "Stan Smith", "Campus", "Samba"], style: "hype", valuePreference: "medium", traits: ["Follows social media", "Loves new releases"] },
      { name: "Casual Casey", emoji: "😊", preferences: ["Vans", "Converse", "Era", "Authentic", "Club C 85", "Workout Plus"], style: "budget", valuePreference: "low", traits: ["Practical choices", "Daily wear focus"] }
    ];

    const aiPersonalities = [
      "Always looking for the best deal",
      "Loves rare colorways",
      "Interested in limited editions only",
      "Collects specific brands",
      "Values condition over brand",
      "Prefers matching sets",
      "Focuses on resale value",
      "Interested in vintage models",
      "Loves exclusive releases",
      "Only trades for premium items"
    ];

    let currentTrader = null;

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function generateRandomTrader() {
      const baseTrader = aiTraders[Math.floor(Math.random() * aiTraders.length)];
      const personality = aiPersonalities[Math.floor(Math.random() * aiPersonalities.length)];
      
      // Add some randomization to preferences
      const randomBrands = [...brands].sort(() => Math.random() - 0.5).slice(0, 2);
      const randomRarities = ["common", "rare", "epic", "legendary"].sort(() => Math.random() - 0.5).slice(0, 2);
      
      return {
        ...baseTrader,
        personality,
        additionalPreferences: {
          brands: randomBrands,
          rarities: randomRarities,
          minValue: Math.floor(Math.random() * 300) + 100,
          maxValue: Math.floor(Math.random() * 1000) + 500,
          prefersSets: Math.random() > 0.5,
          prefersColorways: Math.random() > 0.5
        }
      };
    }

    function updateAITraderDisplay() {
      const traderDiv = document.getElementById('ai-trader');
      if (!traderDiv) return;

      const styleDisplay = currentTrader.style.charAt(0).toUpperCase() + currentTrader.style.slice(1);
      const valueDisplay = currentTrader.valuePreference.charAt(0).toUpperCase() + currentTrader.valuePreference.slice(1);
      
      traderDiv.innerHTML = `
        <div class="ai-avatar">${currentTrader.emoji}</div>
        <div class="ai-details">
          <div class="ai-name">${currentTrader.name}</div>
          <div class="ai-preference">Style: ${styleDisplay}</div>
          <div class="ai-preference">Value: ${valueDisplay}</div>
          <div class="ai-preference">Prefers: ${currentTrader.preferences.join(', ')}</div>
          <div class="ai-preference">Traits: ${currentTrader.traits.join(', ')}</div>
        </div>
      `;
    }

    function openTradeUI() {
      selectedTradeItems = [];
      aiTradeOffer = [];
      currentTrader = null;
      
      const tradeModal = document.getElementById("trade-modal");
      const overlay = document.getElementById("modal-overlay");
      const aiTrader = document.getElementById("ai-trader");
      const traderSelection = document.getElementById("trader-selection");
      
      tradeModal.classList.add("show");
      overlay.classList.add("show");
      
      aiTrader.style.display = "none";
      traderSelection.style.display = "block";
      
      document.getElementById("selected-sneakers").innerHTML = "";
      document.getElementById("trade-offer").innerHTML = "";
      document.querySelector('#your-offer .offer-details').innerHTML = "";
      document.querySelector('#ai-offer .offer-details').innerHTML = "";
      document.getElementById('trade-chat').innerHTML = '';
      
      renderTraderSelection();
    }

    function closeTradeUI() {
      document.getElementById("trade-modal").classList.remove("show");
    }

    function renderTraderSelection() {
      const container = document.getElementById("trader-selection");
      container.innerHTML = aiTraders.map(trader => `
        <div class="trader-card" onclick="selectTrader('${trader.name}')">
          <div class="trader-avatar">${trader.emoji}</div>
          <div class="trader-name">${trader.name}</div>
          <div class="trader-info">
            <div>Style: ${trader.style.charAt(0).toUpperCase() + trader.style.slice(1)}</div>
            <div>Prefers: ${trader.preferences.join(', ')}</div>
            <div>Value: ${trader.valuePreference.charAt(0).toUpperCase() + trader.valuePreference.slice(1)}</div>
          </div>
        </div>
      `).join('');
    }

    function selectTrader(name) {
      currentTrader = aiTraders.find(t => t.name === name);
      if (!currentTrader) return;

      document.getElementById("trader-selection").style.display = "none";
      document.getElementById("ai-trader").style.display = "block";
      updateAITraderDisplay();
      renderTradeDropdown();
    }

    function renderTradeDropdown() {
      const dropdown = document.getElementById("trade-dropdown");
      dropdown.innerHTML = "";
      if (inventory.length === 0) {
        dropdown.innerHTML = "<option>No sneakers to trade</option>";
        dropdown.disabled = true;
        return;
      }
      dropdown.disabled = false;
      
      // Only show sneakers that aren't already selected
      const availableSneakers = inventory.filter((_, idx) => !selectedTradeItems.includes(idx));
      
      if (availableSneakers.length === 0) {
        dropdown.innerHTML = "<option>No more sneakers available</option>";
        dropdown.disabled = true;
        return;
      }

      availableSneakers.forEach((sneaker, idx) => {
        const originalIndex = inventory.indexOf(sneaker);
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) ? 
          sneaker.dynamicValue : sneaker.baseValue;
        let text = `${sneaker.brand} ${sneaker.model} (${sneaker.colorway}) [${sneaker.rarity.toUpperCase()}] - ${formatCurrency(Math.floor(value))}c`;
        let option = document.createElement("option");
        option.value = originalIndex;
        option.textContent = text;
        dropdown.appendChild(option);
      });
    }

    function addToTrade() {
      const dropdown = document.getElementById("trade-dropdown");
      const selectedIndex = parseInt(dropdown.value);
      
      if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= inventory.length) {
        showPurchaseNotification("Invalid selection!", "error");
        return;
      }

      if (selectedTradeItems.includes(selectedIndex)) {
        showPurchaseNotification("This sneaker is already in the trade!", "error");
        return;
      }

      selectedTradeItems.push(selectedIndex);
      updateSelectedSneakers();
      renderTradeDropdown();
        generateAITradeOffer();
      appendTradeChatMessage('player', `Let me see... You're offering ${selectedTradeItems.map(index => inventory[index].brand+' '+inventory[index].model).join(', ')}. Here's what I think...`);
    }

    function updateSelectedSneakers() {
      const container = document.getElementById("selected-sneakers");
      if (!container) return;

      container.innerHTML = selectedTradeItems.map(index => {
        if (index < 0 || index >= inventory.length) return '';
        
        const sneaker = inventory[index];
        return `
          <div class="selected-sneaker">
            <span>${sneaker.brand} ${sneaker.model} [${sneaker.rarity.toUpperCase()}]</span>
            <button class="remove-sneaker" onclick="removeFromTrade(${index})">×</button>
          </div>
        `;
      }).join('');

      updateTradeComparison();
    }

    function removeFromTrade(index) {
      selectedTradeItems = selectedTradeItems.filter(i => i !== index);
      updateSelectedSneakers();
      renderTradeDropdown();
      generateAITradeOffer();
    }

    function updateTradeComparison() {
      if (selectedTradeItems.length === 0) {
        document.querySelector('#your-offer .offer-details').innerHTML = "<em>Select sneakers to trade</em>";
        document.querySelector('#ai-offer .offer-details').innerHTML = "";
        return;
      }

      const yourSneakers = selectedTradeItems.map(index => inventory[index]);
      const yourTotalValue = yourSneakers.reduce((sum, s) => {
        const value = (typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue;
        return sum + value;
      }, 0);

      const aiTotalValue = aiTradeOffer.reduce((sum, s) => {
        const value = (typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue;
        return sum + value;
      }, 0);

      const valueDiff = aiTotalValue - yourTotalValue;
      let valueClass = 'equal-value';
      if (valueDiff > 50) valueClass = 'better-value';
      if (valueDiff < -50) valueClass = 'worse-value';

      document.querySelector('#your-offer .offer-details').innerHTML = `
        ${yourSneakers.map(s => `
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class="rarity-${s.rarity}">[${s.rarity.toUpperCase()}]</span><br>
        `).join('<br>')}
        <div class="value-comparison">Total Value: ${formatCurrency(Math.floor(yourTotalValue))} coins</div>
      `;

      document.querySelector('#ai-offer .offer-details').innerHTML = `
        ${aiTradeOffer.map(s => `
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class="rarity-${s.rarity}">[${s.rarity.toUpperCase()}]</span><br>
        `).join('<br>')}
        <div class="value-comparison ${valueClass}">
          Total Value: ${formatCurrency(Math.floor(aiTotalValue))} coins
          ${valueDiff !== 0 ? `(${valueDiff > 0 ? '+' : ''}${formatCurrency(Math.floor(valueDiff))})` : ''}
        </div>
      `;
    }

    function generateAITradeOffer(adjustment = 1.0) {
      if (!currentTrader || selectedTradeItems.length === 0) {
        updateTradeComparison();
        return;
      }

      const yourSneakers = selectedTradeItems.map(index => inventory[index]);
      const yourTotalValue = yourSneakers.reduce((sum, s) => {
        return sum + ((typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? s.dynamicValue : s.baseValue);
      }, 0);

      // Determine desired rarity and price range for this trader
      let desiredRarities = [];
      switch(currentTrader.valuePreference) {
        case 'high':
          desiredRarities = ['legendary', 'grail', 'mythic'];
          break;
        case 'ultra':
          desiredRarities = ['legendary', 'epic', 'grail', 'mythic'];
          break;
        case 'medium':
          desiredRarities = ['epic', 'rare', 'ultra-rare'];
          break;
        case 'low':
        default:
          desiredRarities = ['common', 'uncommon'];
          break;
      }
      const minValue = currentTrader.additionalPreferences?.minValue ?? 0;
      const maxValue = currentTrader.additionalPreferences?.maxValue ?? Infinity;

      // Check for strong match: rarity/value AND brand/model
      let hasRarityMatch = false;
      let hasPriceMatch = false;
      let hasBrandMatch = false;
      yourSneakers.forEach(s => {
        if (desiredRarities.includes(s.rarity)) hasRarityMatch = true;
        if (s.baseValue >= minValue && s.baseValue <= maxValue) hasPriceMatch = true;
        if (currentTrader.preferences.some(pref => s.brand.includes(pref) || s.model?.includes(pref))) hasBrandMatch = true;
      });

      // Decide multiplier
      let aiMultiplier = 0.6; // Default to underpay
      let overpay = 0;
      if (hasRarityMatch) {
        overpay = 0.10 + Math.random() * 0.20; // 10-30% overpay
        if (hasBrandMatch) overpay += 0.10; // +10% if brand/model matches
        aiMultiplier = 1 + overpay;
      } else if (hasPriceMatch) {
        aiMultiplier = 1.0; // Fair if any price match
      }

      let targetTotalValue = yourTotalValue * adjustment * aiMultiplier;

      // Generate AI offer pool based on multiplier
      aiTradeOffer = [];
      let offerPool = [];
      if (aiMultiplier > 1.01) {
        // Overpay: offer sneakers matching rarity and/or brand/model
        offerPool = sneakersDatabase.filter(s => desiredRarities.includes(s.rarity) || currentTrader.preferences.some(pref => s.brand.includes(pref) || s.model?.includes(pref)));
      } else if (aiMultiplier === 1.0) {
        // Fair: offer sneakers matching only price
        offerPool = sneakersDatabase.filter(s => s.baseValue >= minValue && s.baseValue <= maxValue);
      } else {
        // Underpay: offer anything affordable
        offerPool = sneakersDatabase;
      }
      // Sort offerPool by value descending for more realistic overpay
      offerPool = offerPool.sort((a, b) => b.baseValue - a.baseValue);
      while (aiTradeOffer.length < 3 && offerPool.length > 0 && targetTotalValue > 0) {
        const index = Math.floor(Math.random() * Math.min(offerPool.length, 10)); // bias toward higher value
        const sneaker = offerPool[index];
        if (sneaker.baseValue <= targetTotalValue) {
          aiTradeOffer.push({...sneaker, id: Date.now() + Math.random()});
          targetTotalValue -= sneaker.baseValue;
          offerPool.splice(index, 1);
        } else {
          offerPool.splice(index, 1);
        }
      }
      // Fill remaining slots with any affordable sneakers
      while (aiTradeOffer.length < 3 && targetTotalValue > 0) {
        const affordable = sneakersDatabase.filter(s => s.baseValue <= targetTotalValue);
        if (affordable.length === 0) break;
        const sneaker = affordable[Math.floor(Math.random() * affordable.length)];
        aiTradeOffer.push({...sneaker, id: Date.now() + Math.random()});
        targetTotalValue -= sneaker.baseValue;
      }
      updateTradeComparison();
      updateNegotiationOptions();
      const tradeOffer = document.getElementById("trade-offer");
      if (tradeOffer) {
        if (aiTradeOffer.length > 0) {
          tradeOffer.innerHTML = '<button class="pack-button" onclick="acceptTrade()">Accept Trade</button>';
        } else {
          tradeOffer.innerHTML = '<em>No suitable trade found</em>';
        }
      }
    }

    function getPreferenceScore(sneaker) {
      let score = 0;
      
      // Brand preference
      if (currentTrader.preferences.some(pref => sneaker.brand.includes(pref))) {
        score += 3;
      }
      
      // Rarity preference
      if (currentTrader.additionalPreferences.rarities.includes(sneaker.rarity)) {
        score += 2;
      }
      
      // Value preference
      const value = sneaker.baseValue;
      if (value >= currentTrader.additionalPreferences.minValue && 
          value <= currentTrader.additionalPreferences.maxValue) {
        score += 2;
      }
      
      return score;
    }

    function acceptTrade() {
      if (!currentTrader || selectedTradeItems.length === 0 || aiTradeOffer.length === 0) {
        showPurchaseNotification("Invalid trade!", "error");
        return;
      }

      // Remove traded sneakers from inventory (in reverse order to maintain correct indices)
      const tradedIndices = [...selectedTradeItems].sort((a, b) => b - a);
      tradedIndices.forEach(index => {
        if (index >= 0 && index < inventory.length) {
          inventory.splice(index, 1);
        }
      });

      // Add AI's sneakers to inventory with unique IDs
      aiTradeOffer.forEach(s => {
        const newSneaker = {
          ...s,
          id: Date.now() + Math.random(),
          dynamicValue: s.baseValue
        };
        inventory.push(newSneaker);
      });

      updateInventory();
      showPurchaseNotification("Trade completed successfully!");
      
      // Reset trade state
      selectedTradeItems = [];
      aiTradeOffer = [];
      currentTrader = null;
      
      // Close trade modal
      closeTradeUI();
      appendTradeChatMessage('ai', 'Deal! Pleasure trading with you.');
    }

    // Load purchase history from localStorage
    function loadPurchaseHistory() {
      const savedHistory = localStorage.getItem('purchaseHistory');
      if (savedHistory) {
        purchaseHistory = JSON.parse(savedHistory);
      }
    }

    // Save purchase history to localStorage
    function savePurchaseHistory() {
      saveGameState();
    }

    // Add purchase to history
    function addPurchaseToHistory(type, cost, items) {
      const purchase = {
        type: type,
        cost: cost,
        items: items,
        timestamp: new Date().toISOString()
      };
      purchaseHistory.unshift(purchase);
      if (purchaseHistory.length > 50) { // Keep only last 50 purchases
        purchaseHistory.pop();
      }
      savePurchaseHistory();
      updatePurchaseHistory();
    }

    // Update purchase history display
    function updatePurchaseHistory() {
      const historyDiv = document.getElementById('purchase-history');
      historyDiv.innerHTML = '';
      
      purchaseHistory.forEach(purchase => {
        const date = new Date(purchase.timestamp);
        const formattedDate = date.toLocaleString();
        const itemsList = purchase.items.map(item => 
          `${item.brand} ${item.model} (${item.rarity})`
        ).join(', ');
        
        historyDiv.innerHTML += `
          <div class="purchase-item">
            <div><strong>${purchase.type}</strong> - ${formatCurrency(purchase.cost)} coins</div>
            <div>Items: ${itemsList}</div>
            <div class="purchase-time">${formattedDate}</div>
          </div>
        `;
      });
    }

    function openHistory() {
      document.getElementById('history-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
      updatePurchaseHistory();
    }

    function closeHistory() {
      document.getElementById('history-modal').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
    }

    function closeAllModals() {
      const modals = ['history-modal', 'settings-modal', 'pack-modal', 'trade-modal', 'inventory-modal'];
      modals.forEach(modalId => {
        document.getElementById(modalId).classList.remove('show');
      });
      document.getElementById('modal-overlay').classList.remove('show');
      if (cleaningInProgress) {
        finishCleaning(); // Auto-finish cleaning if in progress
      }
    }

    // Add event listener for escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeAllModals();
      }
    });

    function generateLimitedOffers() {
      const maxOffers = 3;
      limitedOffers.clear();
      let offerBonus = 1;
      // Apply networker staff bonus
      const networker = hiredStaff.find(s => s.id === 'networker');
      if (networker) {
        offerBonus -= networker.baseBonus + (networker.level - 1) * networker.bonusPerLevel;
      }
      while (limitedOffers.size < maxOffers) {
        const sneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        if (!limitedOffers.has(sneaker.id)) {
          const duration = 300000 + Math.random() * 300000;
          const discount = (0.6 + Math.random() * 0.2) * offerBonus;
          limitedOffers.set(sneaker.id, {
            sneaker,
            discountedPrice: Math.floor(sneaker.baseValue * discount),
            endTime: Date.now() + duration,
            startTime: Date.now()
          });
        }
      }
      updateLimitedOffers();
    }

    function updateLimitedOffers() {
      const container = document.getElementById('limited-offers');
      if (!container) return;
      
      container.innerHTML = '';
      const now = Date.now();
      let needsNewOffers = false;

      limitedOffers.forEach((offer, id) => {
        const timeLeft = offer.endTime - now;
        if (timeLeft <= 0) {
          limitedOffers.delete(id);
          needsNewOffers = true;
          return;
        }

        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        const savings = offer.sneaker.baseValue - offer.discountedPrice;

        container.innerHTML += `
          <div class="limited-offer">
            <div class="offer-timer">${timeString}</div>
            <div class="offer-sneaker">
              <img src="${offer.sneaker.image}" alt="${offer.sneaker.brand} ${offer.sneaker.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
              <strong>${offer.sneaker.brand} ${offer.sneaker.model}</strong>
              <div>${offer.sneaker.colorway}</div>
              <div class="rarity-${offer.sneaker.rarity}">[${offer.sneaker.rarity.toUpperCase()}]</div>
              <div style="margin: 10px 0;">
                <span style="text-decoration: line-through;">${formatCurrency(offer.sneaker.baseValue)} coins</span>
                <br>
                <strong style="color: #2ecc71; font-size: 1.2em;">
                  ${formatCurrency(offer.discountedPrice)} coins
                </strong>
                <br>
                <span style="color: #e74c3c;">Save ${formatCurrency(savings)} coins!</span>
              </div>
              <button class="pack-button" onclick="purchaseOffer('${id}')">Purchase</button>
            </div>
        </div>
      `;
      });

      if (needsNewOffers || limitedOffers.size < 3) {
        generateLimitedOffers();
      }
    }

    // Update limited offers every second
    setInterval(updateLimitedOffers, 1000);

    // Generate news events every minute
    setInterval(generateNewsEvent, 60000);

    // Initialize on load
    window.addEventListener('load', () => {
      loadSettings();
      loadPurchaseHistory();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      
      // Start news event generation immediately
      generateNewsEvent();

      // Add unique IDs to existing inventory
      inventory.forEach(s => {
        if (!s.id) s.id = Date.now() + Math.random();
      });
    });

    function purchaseOffer(id) {
      const offer = limitedOffers.get(id);
      if (!offer) {
        showNotification("This offer has expired!");
        return;
      }

      if (coins < offer.discountedPrice) {
        showNotification("Not enough coins!");
        return;
      }

      coins -= offer.discountedPrice;
      inventory.push({
        ...offer.sneaker,
        dynamicValue: offer.sneaker.baseValue
      });

      limitedOffers.delete(id);
      updateLimitedOffers();
    updateCoins();
    updateInventory();
      showPurchaseNotification("Limited offer purchased successfully!");
    }

    function updateResellAgentDisplay() {
      const levelDiv = document.getElementById('agent-level');
      const bonusDiv = document.getElementById('agent-bonus');
      const upgradeBtn = document.getElementById('upgrade-agent-btn');
      if (levelDiv) {
        levelDiv.innerHTML = Array(resellAgent.level)
          .fill('⭐')
          .concat(Array(resellAgent.maxLevel - resellAgent.level).fill('☆'))
          .join('');
      }
      if (bonusDiv) {
        const bonus = (resellAgent.level * resellAgent.bonusPerLevel * 100).toFixed(0);
        bonusDiv.textContent = `Current Bonus: +${bonus}% sale value`;
      }
      if (upgradeBtn) {
        if (resellAgent.level >= resellAgent.maxLevel) {
          upgradeBtn.textContent = 'Max Level Reached!';
          upgradeBtn.disabled = false; // Keep clickable
        } else {
          const nextCost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
          upgradeBtn.textContent = `Upgrade Agent (${formatCurrency(nextCost)} coins)`;
          upgradeBtn.disabled = false;
        }
      }
      // --- DEFENSIVE FIX: Always enable the button after prestige if level is 0 ---
      if (upgradeBtn && resellAgent.level === 0) {
        upgradeBtn.disabled = false;
        const nextCost = resellAgent.baseUpgradeCost;
        upgradeBtn.textContent = `Upgrade Agent (${formatCurrency(nextCost)} coins)`;
      }
    }

    // Negotiation messages based on trader personality
    const negotiationOptions = {
      standard: [
        "How about we adjust the trade a bit?",
        "Can you add something more?",
        "I'm interested, but the value seems off",
        "This is a good start, but...",
      ],
      counter: [
        "Let me offer something different",
        "What if we modified the trade?",
        "I can adjust my offer",
        "Perhaps we can find middle ground"
      ]
    };

    function updateNegotiationOptions(showCounter = true) {
      const container = document.getElementById('negotiation-options');
      container.innerHTML = '';
      
      if (showCounter) {
        negotiationOptions.standard.forEach(msg => {
          const btn = document.createElement('button');
          btn.className = 'negotiation-btn';
          btn.textContent = msg;
          btn.onclick = () => negotiate(msg);
          container.appendChild(btn);
        });
      }
    }

    function negotiate(message) {
      const response = document.getElementById('ai-response');
      if (!currentTrader || !response) return;

      const yourValue = selectedTradeItems.reduce((sum, idx) => {
        const sneaker = inventory[idx];
        return sum + (sneaker.dynamicValue || sneaker.baseValue);
      }, 0);
      
      const aiValue = aiTradeOffer.reduce((sum, s) => sum + s.baseValue, 0);
      const valueDiff = Math.abs(yourValue - aiValue);
      const valueRatio = Math.min(yourValue, aiValue) / Math.max(yourValue, aiValue);

      let responseText;
      let willing = false;

      // Personality-based responses
      const responses = {
        hype: [
          "This trade isn't hype enough for me.",
          "Now we're talking! Let me adjust my offer.",
          "These are straight fire! Let's make this happen!"
        ],
        classic: [
          "I prefer the timeless classics. Let me reconsider.",
          "These have potential. Here's my counter-offer.",
          "A classic trade! I can work with this."
        ],
        luxury: [
          "I only deal in premium items. Let me see what else you have.",
          "Getting closer to what I'm looking for.",
          "Now this is the luxury I expect!"
        ],
        budget: [
          "A bit out of my price range. Got anything cheaper?",
          "This could work with some adjustments.",
          "Perfect for my budget collection!"
        ]
      };

      if (valueRatio > 0.9) {
        willing = Math.random() < 0.8;
        responseText = willing ? responses[currentTrader.style][2] : "I think this is already a fair offer.";
      } else if (valueRatio > 0.7) {
        willing = Math.random() < 0.6;
        responseText = willing ? responses[currentTrader.style][1] : "The value gap is a bit too wide for me.";
      } else {
        willing = Math.random() < 0.3;
        responseText = responses[currentTrader.style][0];
      }

      response.innerHTML = `${currentTrader.emoji} ${currentTrader.name}: "${responseText}"`;

      if (willing) {
        const adjustment = valueRatio > 0.8 ? 0.95 : 0.9;
        generateAITradeOffer(adjustment);
      }

      updateNegotiationOptions();
      appendTradeChatMessage('player', message);
      appendTradeChatMessage('ai', getAIResponse(message));
    }

    function updateNegotiationOptions() {
      const container = document.getElementById('negotiation-options');
      if (!container || !currentTrader) return;

      const options = [
        { text: "How about we adjust the trade a bit?", style: "standard" },
        { text: `Can you add something more ${currentTrader.style === 'luxury' ? 'exclusive' : 'valuable'}?`, style: "request" },
        { text: "Would you consider a different combination?", style: "counter" },
        { text: `I have some ${currentTrader.preferences[0]} items you might like...`, style: "specific" }
      ];

      container.innerHTML = options.map(opt => `
        <button class="negotiation-btn" onclick="negotiate('${opt.text}')">
          ${opt.text}
        </button>
      `).join('');
    }

    function generateNewsEvent() {
      if (Math.random() > 0.3) return; // 30% chance of news event

      const eventTypes = ["celebrity", "market", "trend"];
      const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];

      // Select random sneaker from inventory or database
      const sneaker = inventory.length > 0 && Math.random() > 0.5 
        ? inventory[Math.floor(Math.random() * inventory.length)]
        : sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
      
      let effect, percentage, direction, message;
      if (eventType === "celebrity" || eventType === "trend") {
        // Always positive effect
        effect = Math.random() * 0.5 + 0.1;
        percentage = Math.abs(Math.round(effect * 100));
        direction = "increased";
      if (eventType === "celebrity") {
        const celebrity = celebrities[Math.floor(Math.random() * celebrities.length)];
        const action = celebrityActions[Math.floor(Math.random() * celebrityActions.length)];
          message = `🔥 ${celebrity} ${action} ${sneaker.brand} ${sneaker.model}! Value increased by ${percentage}%!`;
        } else {
          const reason = trendReasons[Math.floor(Math.random() * trendReasons.length)];
          message = `🌟 ${sneaker.brand} ${sneaker.model} is trending ${reason}! Value increased by ${percentage}%!`;
        }
      } else if (eventType === "market") {
        // 50% chance for positive or negative market event
        const isPositive = Math.random() > 0.5;
        effect = (isPositive ? 1 : -1) * (Math.random() * 0.5 + 0.1);
        percentage = Math.abs(Math.round(effect * 100));
        direction = isPositive ? "increased" : "decreased";
        const reason = marketReasons[isPositive ? "increase" : "decrease"][Math.floor(Math.random() * marketReasons[isPositive ? "increase" : "decrease"].length)];
        message = `📈 Market Alert: ${sneaker.brand} ${sneaker.model} value has ${direction} by ${percentage}% ${reason}!`;
      }

      // Apply effect to matching sneakers
      const eventId = Date.now();
      activeEvents.set(eventId, {
        sneaker: `${sneaker.brand} ${sneaker.model}`,
        effect: effect,
        endTime: Date.now() + 300000 // 5 minutes
      });

      showBreakingNews(message);
      updateInventoryValues();

      setTimeout(() => {
        activeEvents.delete(eventId);
        updateInventoryValues();
      }, 300000);
    }

    function showBreakingNews(message, duration = 5000) {
      const newsElement = document.getElementById('breaking-news');
      if (!newsElement) return;

      // If called from test button, generate a test event
      if (message === true) {
        const testSneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        // Always positive effect for test
        const effect = Math.random() * 0.5 + 0.1;
        const percentage = Math.abs(Math.round(effect * 100));
        const direction = "increased";
        const reason = marketReasons.increase[Math.floor(Math.random() * marketReasons.increase.length)];
        message = `📈 Market Alert: ${testSneaker.brand} ${testSneaker.model} value has ${direction} by ${percentage}% ${reason}`;
        // Apply test effect
        const eventId = Date.now();
        activeEvents.set(eventId, {
          sneaker: `${testSneaker.brand} ${testSneaker.model}`,
          effect: effect,
          endTime: Date.now() + 300000 // 5 minutes
        });
        updateInventoryValues();
        setTimeout(() => {
          activeEvents.delete(eventId);
          updateInventoryValues();
        }, 300000);
      }

      // Clear any existing timeouts
      if (newsElement.timeout) {
        clearTimeout(newsElement.timeout);
      }

      newsElement.textContent = message;
      newsElement.style.display = 'block';
      
      // Force a reflow to restart animation
      void newsElement.offsetWidth;
      newsElement.style.animation = 'none';
      requestAnimationFrame(() => {
        newsElement.style.animation = 'slideDown 0.5s ease-out, glow 2s infinite';
      });

      newsElement.timeout = setTimeout(() => {
        newsElement.style.animation = 'none';
        newsElement.style.display = 'none';
      }, duration);
    }

    function updateInventoryValues() {
      inventory.forEach(sneaker => {
        let totalEffect = 1;
        activeEvents.forEach(event => {
          if (event.sneaker === `${sneaker.brand} ${sneaker.model}`) {
            totalEffect *= (1 + event.effect);
          }
        });
        sneaker.dynamicValue = Math.round(sneaker.baseValue * totalEffect);
      });
      updateInventory();
      updateTradeComparison(); // Update trade values if in a trade
    }

    // Start news generation immediately and run every minute
    generateNewsEvent(); // Initial news
    setInterval(generateNewsEvent, 60000); // Every minute

    // Add event listener for test button
    document.querySelector('.test-button').addEventListener('click', () => {
      console.log("Test button clicked"); // Debug log
      showBreakingNews(true);
    });

    let resellAgent = {
      level: 0, // Start at level 0
      maxLevel: 5,
      baseUpgradeCost: 500,
      bonusPerLevel: 0.2
    };

    let storageUpgrades = 0;
    let storageCost = 300;
    let limitedOffers = new Map();

    function upgradeResellAgent() {
      const cost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
      
      if (coins >= cost && resellAgent.level < resellAgent.maxLevel) {
        coins -= cost;
        resellAgent.level++;
        updateResellAgentDisplay();
        updateCoins();
        showPurchaseNotification(`Resell Agent upgraded to Level ${resellAgent.level}!`);
        
        // Update the upgrade button text with new cost
        const nextCost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
        const upgradeBtn = document.getElementById('upgrade-agent-btn');
        if (upgradeBtn) {
          upgradeBtn.textContent = resellAgent.level < resellAgent.maxLevel ? 
            `Upgrade Agent (${formatCurrency(nextCost)} coins)` : 
            'Max Level Reached!';
        }
      } else if (resellAgent.level >= resellAgent.maxLevel) {
        showPurchaseNotification('Already at maximum level!', 'error');
      } else {
        showPurchaseNotification('Not enough coins!', 'error');
      }
    }

    // Breaking News System
    const marketReasons = {
      increase: [
        "due to limited stock availability",
        "after successful collaboration announcement",
        "following positive reviews",
        "due to seasonal demand",
        "after viral social media coverage",
        "due to collector interest",
        "following successful restock",
        "after design award recognition"
      ],
      decrease: [
        "due to increased market supply",
        "following new competitor release",
        "due to changing trends",
        "after negative publicity",
        "due to overstock situation",
        "following retail price adjustments",
        "due to newer model announcement",
        "after market saturation"
      ]
    };

    const celebrityActions = [
      "spotted wearing",
      "featured on Instagram with",
      "performed wearing",
      "endorsed",
      "showcased in new video wearing",
      "spotted shopping for",
      "praised in interview about",
      "wore to major event"
    ];

    const trendReasons = [
      "after going viral on TikTok",
      "due to streetwear influence",
      "following fashion week appearance",
      "after celebrity collaboration announcement",
      "due to retro style comeback",
      "following cultural moment",
      "after music video feature",
      "due to movie appearance"
    ];

    // Staff System
    const staffTypes = [
      {
        id: 'buyer',
        name: 'Market Buyer',
        description: 'Finds rare sneakers at better prices',
        baseCost: 1000,
        baseBonus: 0.10,
        bonusPerLevel: 0.05,
        maxLevel: 5,
        icon: '🔍',
        getBonusText: (level) => `Reduces pack costs by ${Math.round((level * 0.05 + 0.10) * 100)}%`
      },
      {
        id: 'authenticator',
        name: 'Authenticator',
        description: 'Increases chance of rare finds',
        baseCost: 1500,
        baseBonus: 0.15,
        bonusPerLevel: 0.05,
        maxLevel: 5,
        icon: '✨',
        getBonusText: (level) => `Increases rare sneaker odds by ${Math.round((level * 0.05 + 0.15) * 100)}%`
      },
      {
        id: 'autoBuyer',
        name: 'Auto Buyer',
        description: 'Automatically buys packs and trades to clients every minute. Gets smarter and makes better trades when upgraded.',
        baseCost: 2000,
        baseBonus: 1,
        bonusPerLevel: 1,
        maxLevel: 5,
        icon: '🤖',
        getBonusText: (level) => `Buys and trades ${level + 1} pack${level > 0 ? 's' : ''} per minute with improved trade value`
      },
      {
        id: 'autoClicker',
        name: 'Auto Clicker',
        description: 'Automatically clicks for coins. Upgradable for faster coin gain.',
        baseCost: 1200,
        baseBonus: 1, // 1 click per second
        bonusPerLevel: 1, // +1 click per second per level
        maxLevel: 5,
        icon: '🖱️',
        getBonusText: (level) => `Clicks ${level} time${level === 1 ? '' : 's'} per second for coins`
      }
    ];

    let hiredStaff = [];

    function showBreakingNews(message, duration = 5000) {
      const newsElement = document.getElementById('breaking-news');
      if (!newsElement) return;

      // If called from test button, generate a test event
      if (message === true) {
        const testSneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        // Always positive effect for test
        const effect = Math.random() * 0.5 + 0.1;
        const percentage = Math.abs(Math.round(effect * 100));
        const direction = "increased";
        const reason = marketReasons.increase[Math.floor(Math.random() * marketReasons.increase.length)];
        message = `📈 Market Alert: ${testSneaker.brand} ${testSneaker.model} value has ${direction} by ${percentage}% ${reason}`;
        // Apply test effect
        const eventId = Date.now();
        activeEvents.set(eventId, {
          sneaker: `${testSneaker.brand} ${testSneaker.model}`,
          effect: effect,
          endTime: Date.now() + 300000 // 5 minutes
        });
        updateInventoryValues();
        setTimeout(() => {
          activeEvents.delete(eventId);
          updateInventoryValues();
        }, 300000);
      }

      // Clear any existing timeouts and animations
      if (newsElement.timeout) {
        clearTimeout(newsElement.timeout);
      }
      newsElement.style.animation = 'none';

      // Update content and show
      newsElement.textContent = message;
      newsElement.style.display = 'block';
      
      // Force a reflow and restart animation
      void newsElement.offsetWidth;
      newsElement.style.animation = 'slideDown 0.5s ease-out, glow 2s infinite';

      // Set timeout to hide
      newsElement.timeout = setTimeout(() => {
        newsElement.style.animation = 'none';
        newsElement.style.display = 'none';
      }, duration);
    }

    function generateNewsEvent() {
      if (Math.random() > 0.3) return; // 30% chance of news event

      const eventTypes = ["celebrity", "market", "trend"];
      const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];

      // Select random sneaker from inventory or database
      const sneaker = inventory.length > 0 && Math.random() > 0.5 
        ? inventory[Math.floor(Math.random() * inventory.length)]
        : sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
      
      // Generate effect and format percentage
      const effect = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * 0.5 + 0.1);
      const percentage = Math.abs(Math.round(effect * 100));
      const direction = effect > 0 ? "increased" : "decreased";
      
      // Format message based on event type
      let message;
      if (eventType === "celebrity") {
        const celebrity = celebrities[Math.floor(Math.random() * celebrities.length)];
        const action = celebrityActions[Math.floor(Math.random() * celebrityActions.length)];
        message = `🔥 ${celebrity} ${action} ${sneaker.brand} ${sneaker.model}! Value ${direction} by ${percentage}%!`;
      } else if (eventType === "market") {
        const reason = marketReasons[effect > 0 ? "increase" : "decrease"][Math.floor(Math.random() * marketReasons[effect > 0 ? "increase" : "decrease"].length)];
        message = `📈 Market Alert: ${sneaker.brand} ${sneaker.model} value has ${direction} by ${percentage}% ${reason}!`;
      } else { // trend
        const reason = trendReasons[Math.floor(Math.random() * trendReasons.length)];
        message = `🌟 ${sneaker.brand} ${sneaker.model} is trending ${reason}! Value ${direction} by ${percentage}%!`;
      }

      // Apply effect to matching sneakers
      const eventId = Date.now();
      activeEvents.set(eventId, {
        sneaker: `${sneaker.brand} ${sneaker.model}`,
        effect: effect,
        endTime: Date.now() + 300000 // 5 minutes
      });

      showBreakingNews(message);
      updateInventoryValues();

      setTimeout(() => {
        activeEvents.delete(eventId);
        updateInventoryValues();
      }, 300000);
    }

    function openHireStaff() {
      const modal = document.getElementById('staff-hire-modal');
      const overlay = document.getElementById('modal-overlay');
      const staffList = document.getElementById('staff-hire-list');
      
      staffList.innerHTML = staffTypes.map(staff => {
        const hired = hiredStaff.find(h => h.id === staff.id);
        const level = hired ? hired.level : 0;
        const upgradeCost = hired ? Math.round(staff.baseCost * Math.pow(1.5, level)) : staff.baseCost;
        
        return `
          <div class="staff-hire-item">
            <div class="staff-hire-header">
              <span>${staff.icon} ${staff.name}</span>
              ${hired ? 
                `<div class="staff-level">
                  Level ${level}/${staff.maxLevel}
                  ${[...Array(level)].map(() => '⭐').join('')}
                  ${[...Array(staff.maxLevel - level)].map(() => '☆').join('')}
                </div>` : 
                `<span class="staff-hire-cost">${formatCurrency(staff.baseCost)} coins</span>`
              }
            </div>
            <p>${staff.description}</p>
            <p><strong>Current Bonus:</strong> <span class="staff-bonus-value">${staff.getBonusText(level)}</span></p>
            ${hired ? 
              level < staff.maxLevel ?
                `<div class="staff-upgrade-cost">Upgrade Cost: ${formatCurrency(upgradeCost)} coins</div>
                 <button class="pack-button" onclick="upgradeStaff('${staff.id}')">Upgrade</button>` :
                '<button class="pack-button" disabled>Max Level</button>' :
              `<button class="pack-button" onclick="hireStaff('${staff.id}')">Hire</button>`
            }
          </div>
        `;
      }).join('');
      
      modal.classList.add('show');
      overlay.classList.add('show');
    }

    function closeHireStaff() {
      const modal = document.getElementById('staff-hire-modal');
      const overlay = document.getElementById('modal-overlay');
      if (modal) modal.classList.remove('show');
      if (overlay) overlay.classList.remove('show');
    }

    function hireStaff(staffId) {
      const staff = staffTypes.find(s => s.id === staffId);
      if (!staff) return;
      
      if (coins < staff.baseCost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      
      coins -= staff.baseCost;
      hiredStaff.push({
        ...staff,
        level: 1,
        lastTradeTime: Date.now() // for auto trader
      });
      updateCoins();
      
      applyStaffBonuses();
      showPurchaseNotification(`Hired ${staff.name}!`);
      openHireStaff(); // Refresh the modal
      updateStaffDisplay();
    }

    function upgradeStaff(staffId) {
      const staffIndex = hiredStaff.findIndex(s => s.id === staffId);
      if (staffIndex === -1) return;
      
      const staff = hiredStaff[staffIndex];
      const staffType = staffTypes.find(s => s.id === staffId);
      const upgradeCost = Math.round(staffType.baseCost * Math.pow(1.5, staff.level));
      
      if (coins < upgradeCost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      
      if (staff.level >= staffType.maxLevel) {
        showPurchaseNotification("Already at max level!", "error");
        return;
      }
      
      coins -= upgradeCost;
      staff.level++;
      updateCoins();
      
      applyStaffBonuses();
      showPurchaseNotification(`Upgraded ${staff.name} to level ${staff.level}!`);
      openHireStaff(); // Refresh the modal
      updateStaffDisplay();
    }

    function applyStaffBonuses() {
      packPriceMultiplier = 1;
      rarityBonus = 0;
      sellPriceMultiplier = 1;
      autoClickerRate = 0;
      
      hiredStaff.forEach(staff => {
        const bonus = staff.baseBonus + (staff.level - 1) * staff.bonusPerLevel;
        switch(staff.id) {
          case 'buyer':
            packPriceMultiplier *= (1 - bonus);
            break;
          case 'authenticator':
            rarityBonus += bonus;
            break;
          case 'autoBuyer':
            // Handled by autoBuyerTick
            break;
          case 'autoClicker':
            autoClickerRate += staff.level; // clicks per second
            break;
        }
      });
    }

    function autoBuyerTick() {
      const autoBuyer = hiredStaff.find(s => s.id === 'autoBuyer');
      if (!autoBuyer) return;
      const now = Date.now();
      if (!autoBuyer.lastTradeTime || now - autoBuyer.lastTradeTime >= 60000) {
        const tradesPerMinute = autoBuyer.level + 1;
      for (let i = 0; i < tradesPerMinute; i++) {
        // Try to buy a pack if we have enough coins
        if (coins >= packTypes.standard.cost) {
          const packKeys = Object.keys(packTypes);
          const randomPack = packKeys[Math.floor(Math.random() * packKeys.length)];
          const pack = packTypes[randomPack];
          if (coins >= pack.cost) {
            coins -= pack.cost;
            const sneaker = rollSneaker(randomPack);
            inventory.push(sneaker);
            }
          }
        }
        // After buying, try to trade to a random AI trader for coins (simulate a trade)
        for (let i = 0; i < tradesPerMinute; i++) {
          if (inventory.length > 0) {
            const sneakerIdx = Math.floor(Math.random() * inventory.length);
            const sneaker = inventory[sneakerIdx];
            // Trade value improves with level
            let tradeValue = sneaker.baseValue * (1 + 0.1 * autoBuyer.level);
            coins += Math.floor(tradeValue * (1 + 0.10 * prestigeLevel));
            inventory.splice(sneakerIdx, 1);
          }
        }
      updateCoins();
      updateInventory();
        autoBuyer.lastTradeTime = now;
    }
    }
    setInterval(autoBuyerTick, 1000);

    // Update closeHireStaff to work properly
    function closeHireStaff() {
      const modal = document.getElementById('staff-hire-modal');
      const overlay = document.getElementById('modal-overlay');
      if (modal) modal.classList.remove('show');
      if (overlay) overlay.classList.remove('show');
    }

    function updateStaffDisplay() {
      const staffGrid = document.getElementById('staff-grid');
      if (!staffGrid) return;
      
      staffGrid.innerHTML = hiredStaff.map(staff => {
        const staffType = staffTypes.find(s => s.id === staff.id);
        if (!staffType) return ''; // Should not happen, but good practice

        const starRating = Array(staff.level).fill('⭐')
          .concat(Array(staffType.maxLevel - staff.level).fill('☆'))
          .join('');
        
        return `
          <div class="staff-member">
            <div class="staff-header">
              <span>${staffType.icon} ${staffType.name}</span>
              <span class="staff-status">Level ${staff.level}/${staffType.maxLevel}</span>
            </div>
            <div class="staff-level">${starRating}</div>
            <div class="staff-stats">
              <div>Bonus: ${staffType.getBonusText(staff.level)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Initialize variables for staff bonuses
    let packPriceMultiplier = 1;
    let rarityBonus = 0;
    let sellPriceMultiplier = 1;
    let autoClickerRate = 0;

    // Add event listeners for breaking news test button
    document.addEventListener('DOMContentLoaded', function() {
      const testButton = document.querySelector('.test-button');
      if (testButton) {
        testButton.onclick = () => showBreakingNews(true);
      }
      
      // Start news generationa
      setInterval(generateNewsEvent, 60000);
      
      // Generate initial news event
      setTimeout(generateNewsEvent, 5000);
    });
    // Clicker functionality
    let clicksPerCoin = 2;
    let clickProgress = 0;
    function handleClick() {
      clickCount++;
      document.querySelector('.click-count').textContent = `Clicks: ${clickCount}`;
      if (prestigeLevel > 0) {
        coins += prestigeLevel;
        updateCoins();
        showPurchaseNotification(`+${prestigeLevel} coin${prestigeLevel > 1 ? 's' : ''}!`);
      } else {
        // Before first prestige, 1 coin every 2 clicks
        if (!window.clickProgress) window.clickProgress = 0;
        window.clickProgress++;
        if (window.clickProgress >= 2) {
          coins += 1;
          window.clickProgress = 0;
          updateCoins();
          showPurchaseNotification("+1 coin!");
        } else {
          updateCoins();
        }
      }
    }

    // Used Market functionality
    const conditions = ["Poor", "Fair", "Good", "Excellent"];
    const conditionValues = {
      "Poor": 0.15,    // 85% discount
      "Fair": 0.25,    // 75% discount
      "Good": 0.4,     // 60% discount
      "Excellent": 0.6 // 40% discount
    };

    function generateUsedSneakers() {
      const usedMarket = document.getElementById('used-market-grid');
      usedMarket.innerHTML = '';
      
      for (let i = 0; i < 6; i++) {
        const sneaker = {...sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)]};
        const condition = conditions[Math.floor(Math.random() * conditions.length)];
        const conditionValue = conditionValues[condition];
        const price = Math.floor(sneaker.baseValue * conditionValue);
        
        usedMarket.innerHTML += `
          <div class="used-sneaker">
            <img src="${sneaker.image}" alt="${sneaker.brand} ${sneaker.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
            <strong>${sneaker.brand} ${sneaker.model}</strong>
            <div>${sneaker.colorway}</div>
            <div class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</div>
            <div>Condition: ${condition}</div>
            <div class="condition-bar">
              <div class="condition-fill" style="width: ${conditionValue * 100}%"></div>
            </div>
            <div>Price: ${formatCurrency(price)} coins</div>
            <button class="pack-button" onclick="buyUsedSneaker(${JSON.stringify(sneaker).replace(/"/g, '&quot;')}, '${condition}', ${price})">Buy & Clean</button>
          </div>
        `;
      }
    }

    function openUsedMarket() {
      const modal = document.getElementById('used-market-modal');
      const overlay = document.getElementById('modal-overlay');
      modal.classList.add('show');
      overlay.classList.add('show');
      generateUsedSneakers();
    }

    function closeUsedMarket() {
      const modal = document.getElementById('used-market-modal');
      const overlay = document.getElementById('modal-overlay');
      modal.classList.remove('show');
      overlay.classList.remove('show');
    }

    function buyUsedSneaker(sneaker, condition, price) {
      if (coins < price) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      
      coins -= price;
      updateCoins();
      
      const boughtSneaker = {
        ...sneaker,
        id: Date.now() + Math.random(),
        condition: condition,
        conditionValue: conditionValues[condition],
        baseValue: Math.floor(sneaker.baseValue * conditionValues[condition])
      };
      
      currentCleaningSneaker = boughtSneaker;
      closeUsedMarket();
      startCleaning();
    }

    function startCleaning() {
      if (!currentCleaningSneaker || cleaningInProgress) return;
      
      cleaningInProgress = true;
      const game = document.getElementById('cleaning-game');
      const overlay = document.getElementById('modal-overlay');
      game.classList.add('show');
      overlay.classList.add('show');
      
      // Draw sneaker outline
      const canvas = document.getElementById('sneaker-canvas');
      const ctx = canvas.getContext('2d');
      
      // Clear canvas and set background
      ctx.fillStyle = '#34495e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw basic sneaker outline
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(50, 200);
      ctx.bezierCurveTo(100, 100, 300, 100, 350, 200);
      ctx.bezierCurveTo(300, 250, 100, 250, 50, 200);
      ctx.stroke();
      
      // Generate dirt spots
      generateDirtSpots();
      updateCleaningProgress();
    }

    // Initialize
    window.addEventListener('load', () => {
      loadSettings();
      loadPurchaseHistory();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      
      // Add click handlers for modals
      document.getElementById('modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
          closeAllModals();
        }
      });
    });

    function closeAllModals() {
      const modals = document.querySelectorAll('.modal, .cleaning-game');
      const overlay = document.getElementById('modal-overlay');
      modals.forEach(modal => modal.classList.remove('show'));
      overlay.classList.remove('show');
      
      if (cleaningInProgress) {
        finishCleaning(); // Auto-finish cleaning if in progress
      }
    }

    function generateDirtSpots() {
      const canvas = document.getElementById('sneaker-canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      dirtSpots = [];
      const numSpots = Math.floor(Math.random() * 10) + 10;
      
      for (let i = 0; i < numSpots; i++) {
        const spot = {
          x: Math.random() * (canvas.width - 40) + 20,
          y: Math.random() * (canvas.height - 40) + 20,
          radius: Math.random() * 10 + 10,
          cleaned: false
        };
        dirtSpots.push(spot);
        
        ctx.beginPath();
        ctx.arc(spot.x, spot.y, spot.radius, 0, Math.PI * 2);
        ctx.fillStyle = '#795548';
        ctx.fill();
      }
      
      // Add click handler for cleaning
      canvas.onclick = handleCleaningClick;
    }

    function handleCleaningClick(e) {
      const canvas = document.getElementById('sneaker-canvas');
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      dirtSpots.forEach(spot => {
        const distance = Math.sqrt(Math.pow(x - spot.x, 2) + Math.pow(y - spot.y, 2));
        if (distance < spot.radius + 10 && !spot.cleaned) {
          spot.cleaned = true;
          
          // Clear the spot
          const ctx = canvas.getContext('2d');
          ctx.clearRect(spot.x - spot.radius - 1, spot.y - spot.radius - 1, 
                       spot.radius * 2 + 2, spot.radius * 2 + 2);
        }
      });
      
      updateCleaningProgress();
    }

    function updateCleaningProgress() {
      const cleanedSpots = dirtSpots.filter(spot => spot.cleaned).length;
      const progress = (cleanedSpots / dirtSpots.length) * 100;
      document.getElementById('cleaning-progress').style.width = `${progress}%`;
    }

    function finishCleaning() {
      if (!currentCleaningSneaker || !cleaningInProgress) return;
      
      const cleanedSpots = dirtSpots.filter(spot => spot.cleaned).length;
      const totalSpots = dirtSpots.length;
      const cleaningQuality = cleanedSpots / totalSpots;
      
      // Require at least 80% of spots to be cleaned
      if (cleaningQuality < 0.8) {
        showPurchaseNotification("Clean more spots before finishing! (" + Math.floor(cleaningQuality * 100) + "% done)", "error");
        return;
      }
      
      // Improve condition based on cleaning quality
      let newCondition = currentCleaningSneaker.condition;
      if (cleaningQuality > 0.95) {
        const currentIndex = conditions.indexOf(currentCleaningSneaker.condition);
        if (currentIndex < conditions.length - 1) {
          newCondition = conditions[currentIndex + 1];
          showPurchaseNotification("Perfect cleaning! Condition improved!", "success");
        }
      }
      
      // Update sneaker with new condition and values
      currentCleaningSneaker.condition = newCondition;
      currentCleaningSneaker.conditionValue = conditionValues[newCondition];

      // Set value to what it's worth new (full base value for its model/rarity)
      const newSneaker = sneakersDatabase.find(s =>
        s.brand === currentCleaningSneaker.brand &&
        s.model === currentCleaningSneaker.model &&
        s.colorway === currentCleaningSneaker.colorway &&
        s.rarity === currentCleaningSneaker.rarity
      );
      if (newSneaker) {
        currentCleaningSneaker.baseValue = newSneaker.baseValue;
      }
      
      // Add to inventory
      inventory.push(currentCleaningSneaker);
      
      // Clean up
      cleaningInProgress = false;
      document.getElementById('cleaning-game').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
      
      // Update display
      updateInventory();
      showPurchaseNotification(`${currentCleaningSneaker.brand} ${currentCleaningSneaker.model} added to inventory!`);
      
      // Reset cleaning game state
      currentCleaningSneaker = null;
      dirtSpots = [];
    }

    // Fix for limited time offers
    function purchaseOffer(id) {
      const offer = limitedOffers.get(id);
      if (!offer) {
        showPurchaseNotification("Offer has expired!", "error");
        generateLimitedOffers(); // Regenerate offers when one expires
        return;
      }

      if (coins < offer.discountedPrice) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }

      coins -= offer.discountedPrice;
      inventory.push({
        ...offer.sneaker,
        id: Date.now() + Math.random(),
        dynamicValue: offer.sneaker.baseValue
      });

      limitedOffers.delete(id);
      updateLimitedOffers();
      updateCoins();
      updateInventory();
      showPurchaseNotification("Limited offer purchased successfully!");
    }

    // Initialize used market
    window.addEventListener('load', () => {
      const loaded = loadGameState();
      if (!loaded) {
        // If no saved state, initialize with defaults
      loadSettings();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      generateLimitedOffers();
        generateUsedSneakers();
      } else {
        // Update all displays with loaded state
        updateCoins();
        updateInventory();
        updateResellAgentDisplay();
        updateLimitedOffers();
        updateMarketBuyerDisplay();
    }

      // Start news event generation immediately
      generateNewsEvent();
    });

    // Add this new function to sell by sneaker id
    function sellSneakerById(sneakerId) {
      const idx = inventory.findIndex(s => String(s.id) === String(sneakerId));
      if (idx === -1) return;
      sellSneaker(idx);
    }

    function toggleLightMode() {
      settings.lightMode = document.getElementById('light-mode-toggle').checked;
      if (settings.lightMode) {
        document.body.classList.add('light-mode');
      } else {
        document.body.classList.remove('light-mode');
      }
      saveSettings();
    }

    // Implement auto clicker interval
    setInterval(() => {
      if (autoClickerRate > 0) {
        let effectiveAutoClickerRate = autoClickerRate;
        coins += effectiveAutoClickerRate * (1 + 0.10 * prestigeLevel);
        clickCount += effectiveAutoClickerRate;
        updateCoins();
        document.querySelector('.click-count').textContent = `Clicks: ${clickCount}`;
      }
    }, 1000);

    function appendTradeChatMessage(sender, message) {
      const chat = document.getElementById('trade-chat');
      if (!chat) return;
      const msgDiv = document.createElement('div');
      msgDiv.className = 'trade-chat-msg ' + (sender === 'ai' ? 'ai-msg' : 'player-msg');
      msgDiv.innerHTML = `<b>${sender === 'ai' ? currentTrader.emoji + ' ' + currentTrader.name : 'You'}:</b> ${message}`;
      chat.appendChild(msgDiv);
      chat.scrollTop = chat.scrollHeight;
    }

    function getAIResponse(playerMsg) {
      const msg = playerMsg.toLowerCase();
      if (msg.includes('hello') || msg.includes('hi') || msg.includes('hey')) {
        return [
          "Hey there! Ready to make a deal?",
          "Hello! What are you looking to trade today?",
          "Hi! Let's see what you've got."
        ][Math.floor(Math.random()*3)];
      }
      if (msg.includes('value') || msg.includes('worth')) {
        return [
          "I'm always looking for value. That one is pretty nice!",
          "Value is subjective, but I know a good deal when I see one.",
          "Depends on the market, but that's a solid sneaker."
        ][Math.floor(Math.random()*3)];
      }
      if (msg.includes('add') || msg.includes('more')) {
        return [
          "Maybe if you add something extra, I'll consider it.",
          "Sweeten the deal and we might have a trade.",
          "What else can you offer?"
        ][Math.floor(Math.random()*3)];
      }
      if (msg.includes('rare') || msg.includes('legendary')) {
        return [
          "Rare kicks always catch my eye!",
          "Legendary? Now you're talking!",
          "Those are hard to come by."
        ][Math.floor(Math.random()*3)];
      }
      if (msg.includes('deal') || msg.includes('accept')) {
        return [
          "Deal! Pleasure doing business.",
          "Accepted! Let's trade.",
          "You've got yourself a deal!"
        ][Math.floor(Math.random()*3)];
      }
      if (msg.includes('bye') || msg.includes('later')) {
        return [
          "See you next time!",
          "Catch you later!",
          "Goodbye!"
        ][Math.floor(Math.random()*3)];
      }
      // Default fallback: personality-based
      if (currentTrader && currentTrader.style === 'hype') {
        return [
          "That's fire! But is it enough?",
          "I'm all about the hype, show me something exclusive.",
          "Not bad, but I want the latest drops."
        ][Math.floor(Math.random()*3)];
      }
      if (currentTrader && currentTrader.style === 'classic') {
        return [
          "Classic taste! But let's see if it's worth it.",
          "I respect the classics, but I need more.",
          "Old school, but is it gold?"
        ][Math.floor(Math.random()*3)];
      }
      if (currentTrader && currentTrader.style === 'luxury') {
        return [
          "Luxury is my game. Impress me!",
          "Only the finest for me.",
          "Is that premium enough?"
        ][Math.floor(Math.random()*3)];
      }
      if (currentTrader && currentTrader.style === 'budget') {
        return [
          "I'm on a budget, but I like a good deal.",
          "Can you make it cheaper?",
          "Looking for bargains!"
        ][Math.floor(Math.random()*3)];
      }
      // Otherwise, generic
      return [
        "Interesting offer!",
        "Let me think about that...",
        "Hmm, that's something to consider."
      ][Math.floor(Math.random()*3)];
    }

    // Sort pack select dropdown by ascending price on page load
    window.addEventListener('DOMContentLoaded', function() {
      const packSelect = document.getElementById('pack-type');
      if (packSelect) {
        // Get packTypes and sort by cost
        const packEntries = Object.entries(packTypes)
          .map(([key, val]) => ({ key, ...val }));
        packEntries.sort((a, b) => a.cost - b.cost);
        // Save current selection
        const currentValue = packSelect.value;
        // Clear and repopulate
        packSelect.innerHTML = '';
        packEntries.forEach(pack => {
          const label = pack.key.charAt(0).toUpperCase() + pack.key.slice(1) + ' Pack';
          const option = document.createElement('option');
          option.value = pack.key;
          option.textContent = `${label} (${pack.cost} Coins)`;
          packSelect.appendChild(option);
        });
        // Restore selection if possible
        if ([...packSelect.options].some(opt => opt.value === currentValue)) {
          packSelect.value = currentValue;
        }
      }
    });

    function sendTradeChatMessage() {
      const select = document.getElementById('trade-chat-preset');
      if (!select) return;
      const msg = select.value;
      if (!msg) return;
      appendTradeChatMessage('player', msg);
      appendTradeChatMessage('ai', getAIResponse(msg));
    }

    // 1. Update previewPack to block inventory addition after preview
    let isPreviewingPack = false;
    function previewPack() {
      isPreviewingPack = true;
      // Simulate pack opening but do not spend coins or add to inventory/history
      const type = document.getElementById("pack-type").value;
      let pack = {...packTypes[type]};
      // Generate sneakers
      currentSneakers = [];
      for (let i = 0; i < 3; i++) {
        let sneaker = rollSneaker(type);
        currentSneakers.push(sneaker);
      }
      // Reset state and start reveal
      currentSneakerIndex = 0;
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      // Show the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.add('show');
      modalOverlay.classList.add('show');
      revealNextSneaker();
    }
    // Patch finishPackOpening to block inventory addition if previewing
    const originalFinishPackOpening = finishPackOpening;
    finishPackOpening = function() {
      if (isPreviewingPack) {
        // Just close modal, do not add to inventory
        const packModal = document.getElementById("pack-modal");
        const modalOverlay = document.getElementById("modal-overlay");
        packModal.classList.remove('show');
        modalOverlay.classList.remove('show');
        document.getElementById("card-container").innerHTML = "";
        document.getElementById("next-sneaker-btn").disabled = false;
        currentSneakerIndex = 0;
        currentSneakers = [];
        isPreviewingPack = false;
        document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
          btn.disabled = false;
        });
        return;
      }
      originalFinishPackOpening();
    }

    // --- Sneakers Database for AI Trades and Market ---
    let sneakersDatabase = [];
    (function generateSneakersDatabase() {
      const rarityPool = [];
      rarities.forEach(r => {
        for (let i = 0; i < r.weight * 2; i++) rarityPool.push(r.rarity);
      });
      for (let i = 0; i < 200; i++) {
        const rarity = rarityPool[Math.floor(Math.random() * rarityPool.length)];
        sneakersDatabase.push(getRandomSneaker(rarity));
      }
    })();

    function updateStorageDisplay() {
      if (document.getElementById('storage-cost')) {
        document.getElementById('storage-cost').textContent = storageCost;
      }
    }

    // --- CONSOLIDATED INITIALIZATION ---
    function mainInit() {
      console.log('[mainInit] Starting initialization');
      initializeGame(); // Loads state or sets default
      loadSettings();
      loadPurchaseHistory();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      updateLimitedOffers();
      updateStorageDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
      // Add unique IDs to existing inventory
      inventory.forEach(s => { if (!s.id) s.id = Date.now() + Math.random(); });
      // Set up auto-save
      setInterval(saveGameState, 300000); // Every 5 minutes
      // Set up intervals
      setInterval(updateLimitedOffers, 1000);
      setInterval(generateNewsEvent, 60000);
      setInterval(autoBuyerTick, 1000);
      setInterval(() => {
        if (autoClickerRate > 0) {
          clickCount += autoClickerRate;
          coins += autoClickerRate;
          updateCoins();
          document.querySelector('.click-count').textContent = `Clicks: ${clickCount}`;
        }
      }, 1000);
      // Modal overlay click handler
      const overlay = document.getElementById('modal-overlay');
      if (overlay) {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) closeAllModals();
        });
      }
      // Sort pack select dropdown by ascending price
      const packSelect = document.getElementById('pack-type');
      if (packSelect) {
        const packEntries = Object.entries(packTypes).map(([key, val]) => ({ key, ...val }));
        packEntries.sort((a, b) => a.cost - b.cost);
        const currentValue = packSelect.value;
        packSelect.innerHTML = '';
        packEntries.forEach(pack => {
          const label = pack.key.charAt(0).toUpperCase() + pack.key.slice(1) + ' Pack';
          const option = document.createElement('option');
          option.value = pack.key;
          option.textContent = `${label} (${pack.cost} Coins)`;
          packSelect.appendChild(option);
        });
        if ([...packSelect.options].some(opt => opt.value === currentValue)) {
          packSelect.value = currentValue;
        }
      }
      // Start news event generation immediately
      generateNewsEvent();
      setTimeout(generateNewsEvent, 5000);
    }

    // Add debug logging to saveGameState and initializeGame
    function saveGameState() {
      const gameState = {
        coins,
        inventory,
        purchaseHistory,
        settings,
        currentMarketBuyer,
        limitedOffers: Array.from(limitedOffers.entries()),
        activeMultipliers: {
          global: window.globalMultiplier || 1,
          brand: window.brandMultipliers || {},
          coin: window.coinMultiplier || 1
        },
        currentTrader: window.currentTrader,
        lastTraderResponse: window.lastTraderResponse,
        hiredStaff,
        resellAgentLevel: resellAgent.level,
        storageUpgrades,
        storageCost,
        prestigeLevel,
        prestigeUpgrades
      };
      localStorage.setItem('sneakerHustleGameState', JSON.stringify(gameState));
      console.log('[saveGameState] Game state saved:', gameState);
    }

    function initializeGame() {
      const savedState = localStorage.getItem('sneakerHustleGameState');
      console.log('[initializeGame] Loaded state from localStorage:', savedState);
      if (savedState) {
        try {
          const gameState = JSON.parse(savedState);
          coins = gameState.coins ?? 10000;
          inventory = gameState.inventory || [];
          purchaseHistory = gameState.purchaseHistory || [];
          if (gameState.settings) settings = { ...settings, ...gameState.settings };
          if (gameState.currentMarketBuyer) currentMarketBuyer = gameState.currentMarketBuyer;
          if (gameState.limitedOffers) limitedOffers = new Map(gameState.limitedOffers);
          if (gameState.activeMultipliers) {
            window.globalMultiplier = gameState.activeMultipliers.global;
            window.brandMultipliers = gameState.activeMultipliers.brand;
            window.coinMultiplier = gameState.activeMultipliers.coin;
          }
          if (gameState.currentTrader) {
            window.currentTrader = gameState.currentTrader;
            window.lastTraderResponse = gameState.lastTraderResponse;
          }
          if (gameState.hiredStaff) hiredStaff = gameState.hiredStaff;
          if (gameState.resellAgentLevel !== undefined) resellAgent.level = gameState.resellAgentLevel;
          if (gameState.storageUpgrades !== undefined) storageUpgrades = gameState.storageUpgrades;
          if (gameState.storageCost !== undefined) storageCost = gameState.storageCost;
          if (gameState.prestigeLevel !== undefined) prestigeLevel = gameState.prestigeLevel;
        } catch (error) {
          console.error('Error loading game state:', error);
          setDefaultState();
        }
      } else {
        setDefaultState();
      }
      updateAllDisplays();
      updateStorageDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Remove all other window.addEventListener('load', ...) blocks and replace with:
    window.addEventListener('load', mainInit);

    // 3. Add getDiscountedPackPrice function
    function getDiscountedPackPrice(packKey) {
      const base = packTypes[packKey].cost;
      let discount = packPriceMultiplier;
      discount *= (1 - 0.10 * prestigeLevel); // 10% per prestige
      return Math.floor(base * discount);
    }

    // 4. Update pack dropdown to show discounted prices
    function updatePackDropdown() {
      const packSelect = document.getElementById('pack-type');
      if (packSelect) {
        const packEntries = Object.entries(packTypes)
          .map(([key, val]) => ({ key, ...val }));
        packEntries.sort((a, b) => a.cost - b.cost);
        const currentValue = packSelect.value;
        packSelect.innerHTML = '';
        packEntries.forEach(pack => {
          const label = pack.key.charAt(0).toUpperCase() + pack.key.slice(1) + ' Pack';
          const discounted = getDiscountedPackPrice(pack.key);
          const option = document.createElement('option');
          option.value = pack.key;
          option.textContent = `${label} (${discounted} Coins)`;
          packSelect.appendChild(option);
        });
        if ([...packSelect.options].some(opt => opt.value === currentValue)) {
          packSelect.value = currentValue;
        }
      }
    }

    // Call updatePackDropdown() whenever staff or prestige upgrades change
    // Add to applyStaffBonuses and buyPrestigeUpgrade
    const originalApplyStaffBonuses = applyStaffBonuses;
    applyStaffBonuses = function() {
      originalApplyStaffBonuses();
      updatePackDropdown();
    };
    const originalBuyPrestigeUpgrade = buyPrestigeUpgrade;
    buyPrestigeUpgrade = function(key) {
      originalBuyPrestigeUpgrade(key);
      updatePackDropdown();
    };

    // Also call updatePackDropdown on load
    window.addEventListener('DOMContentLoaded', updatePackDropdown);

    // 2. Set the prestige button's onclick to prestigeNow (in case it is not set)
    window.addEventListener('DOMContentLoaded', function() {
      var prestigeBtn = document.getElementById('prestige-btn');
      if (prestigeBtn) prestigeBtn.onclick = prestigeNow;
    });

    const allRarities = ["common", "uncommon", "rare", "ultra-rare", "epic", "mythic", "legendary", "grail"];
    Object.keys(packTypes).forEach(packKey => {
      const odds = packTypes[packKey].odds;
      // Ensure all rarities are present
      let total = 0;
      allRarities.forEach(r => {
        if (!odds[r]) odds[r] = 0.0001; // Give a tiny chance if missing
        total += odds[r];
      });
      // Normalize odds to sum to 1
      allRarities.forEach(r => {
        odds[r] = odds[r] / total;
      });
      // Reorder odds keys to match allRarities order (for display/debug)
      const newOdds = {};
      allRarities.forEaca(r => { newOdds[r] = odds[r]; });
      packTypes[packKey].odds = newOdds;
    });

    // --- Add openMultiplePacks function ---
    function openMultiplePacks(count) {
      const type = document.getElementById("pack-type").value;
      let pack = { ...packTypes[type] };
      pack.cost = getDiscountedPackPrice(type);
      const totalCost = pack.cost * count;
      if (coins < totalCost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      coins -= totalCost;
      updateCoins();
      // Disable buttons during pack opening
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = true;
      });
      // Show the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.add('show');
      modalOverlay.classList.add('show');
      // Generate sneakers
      let allSneakers = [];
      for (let i = 0; i < count; i++) {
        for (let j = 0; j < 3; j++) {
          let sneaker = rollSneaker(type);
          allSneakers.push(sneaker);
        }
      }
      // Record the purchase
      addPurchaseToHistory(`${count}x Pack Opening`, totalCost, allSneakers);
      // Show all sneakers in the modal as a grid
      const cardContainer = document.getElementById("card-container");
      cardContainer.innerHTML = `<div style='display:flex;flex-wrap:wrap;justify-content:center;gap:12px;'>${allSneakers.map(s => `
        <div class='sneaker-card' style='background:#34495e;padding:10px;border-radius:8px;min-width:120px;max-width:140px;'>
          <img src='${s.image}' alt='${s.brand} ${s.model}' style='width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;' />
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>
        </div>
      `).join('')}</div>`;
      // Hide next sneaker button
      document.getElementById("next-sneaker-btn").style.display = 'none';
      // Add all sneakers to inventory after a short delay
      setTimeout(() => {
        inventory.push(...allSneakers);
        updateInventory();
        // Close the modal after a few seconds
        setTimeout(() => {
          packModal.classList.remove('show');
          modalOverlay.classList.remove('show');
          cardContainer.innerHTML = "";
          document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
            btn.disabled = false;
          });
          document.getElementById("next-sneaker-btn").style.display = '';
        }, 2500 + Math.min(2000, allSneakers.length * 100));
      }, 800);
    }

    // --- Add openPackDropdown function ---
    function openPackDropdown() {
      const count = parseInt(document.getElementById('pack-multiplier').value, 10);
      const type = document.getElementById("pack-type").value;
      let pack = { ...packTypes[type] };
      pack.cost = getDiscountedPackPrice(type);
      const totalCost = pack.cost * count;
      if (coins < totalCost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      coins -= totalCost;
      updateCoins();
      // Disable buttons during pack opening
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = true;
      });
      // Show the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.add('show');
      modalOverlay.classList.add('show');
      // Generate sneakers (3 per pack)
      currentSneakers = [];
      for (let i = 0; i < count * 3; i++) {
        let sneaker = rollSneaker(type);
        currentSneakers.push(sneaker);
      }
      // Record the purchase (will be added to inventory at the end)
      addPurchaseToHistory(`${count}x Pack Opening`, totalCost, currentSneakers);
      // Reset state and start reveal
      currentSneakerIndex = 0;
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      document.getElementById("next-sneaker-btn").style.display = '';
      revealNextSneaker();
    }

    function showClickerPlusOne(e) {
      var btn = document.querySelector('.clicker-button');
      if (!btn) return;
      // Get button size
      var btnRect = btn.getBoundingClientRect();
      var btnW = btn.offsetWidth;
      var btnH = btn.offsetHeight;
      // Random angle and distance for effect
      var angle = Math.random() * 2 * Math.PI;
      var radius = 40 + Math.random() * 40; // 40-80px from center
      var offsetX = Math.cos(angle) * radius;
      var offsetY = Math.sin(angle) * radius;
      // Create the floating +1
      var plusOne = document.createElement('div');
      plusOne.className = 'clicker-plusone animate';
      plusOne.textContent = '+1';
      // Position relative to button center, using px offset
      plusOne.style.left = '50%';
      plusOne.style.top = '50%';
      plusOne.style.transform = `translate(-50%, -50%) translate(${offsetX}px, ${offsetY}px)`;
      btn.appendChild(plusOne);
      setTimeout(function() {
        plusOne.remove();
      }, 700);
    }

    function openInventoryModal() {
      document.getElementById('inventory-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
      updateInventory();
    }
    function closeInventoryModal() {
      document.getElementById('inventory-modal').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
    }
  </script>
</body>
</html>
