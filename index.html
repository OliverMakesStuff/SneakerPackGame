<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sneaker Pack Tycoon</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #2c3e50; color: white; text-align: center; }
    h1 { margin-top: 20px; }
    .container { margin: 20px; }
    .coins { font-size: 24px; margin-bottom: 20px; }
    .pack-select, .pack-button { padding: 10px 20px; font-size: 18px; margin: 10px; }
    .pack-button { cursor: pointer; background-color: #2980b9; color: white; border: none; border-radius: 5px; }
    .inventory, .market, .settings, .daily, .trading { margin-top: 20px; }
    .inventory div, .market div, .trading div { background: #34495e; margin: 10px; padding: 10px; border-radius: 8px; }
    .sneaker-card { margin-bottom: 10px; }
    .rarity-common { color: #7f8c8d; }
    .rarity-rare { color: #2980b9; }
    .rarity-epic { color: #8e44ad; }
    .rarity-legendary { color: #f39c12; font-weight: bold; }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      background: #222;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
      z-index: 1000;
      pointer-events: none;
    }
    .modal.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 999;
      pointer-events: none;
    }
    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .card-container {
      margin: 20px auto;
      display: flex;
      flex-direction: row;
      align-items: center;
      position: relative;
      height: 200px;
      width: 600px;
      overflow: hidden;
      background: #222;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .casino-roll-track {
      display: flex;
      flex-direction: row;
      align-items: center;
      transition: transform 2s cubic-bezier(0.23, 1, 0.32, 1);
      will-change: transform;
      height: 100%;
    }
    .casino-roll-card {
      background-color: #34495e;
      color: white;
      padding: 20px;
      border-radius: 8px;
      width: 180px;
      height: 150px;
      margin: 0 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 1em;
      transition: box-shadow 0.2s, transform 0.2s;
      }
    .casino-roll-card.selected {
      /* No border, no color change, no highlight */
      /* Just use normal card style */
    }
    select.pack-select { background: #34495e; color: white; border: 1px solid #2980b9; border-radius: 5px; }
    .inventory-list-flex {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .sneaker-card {
      background: #34495e;
      margin: 5px;
      padding: 8px;
      border-radius: 8px;
      min-width: 100px;
      max-width: 140px;
      flex: 1 1 120px;
      font-size: 14px;
      transition: font-size 0.2s, min-width 0.2s, max-width 0.2s;
      width: calc(100% / 5 - 16px);
    }
    @media (max-width: 700px) {
      .inventory-list-flex .sneaker-card {
        width: calc(100% / 2 - 16px);
      }
    }
    @media (max-width: 500px) {
      .inventory-list-flex .sneaker-card {
        width: 100%;
      }
    }
    #trade-dropdown {
      margin: 10px 0;
      padding: 6px 12px;
      font-size: 16px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
      width: 90%;
      max-width: 300px;
    }
    .trade-offer { margin-top: 15px; }
    .close-btn { background: #c0392b; color: white; border: none; border-radius: 5px; padding: 6px 14px; cursor: pointer; margin-top: 10px;}
    .settings {
      margin-top: 20px;
      background: #34495e;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      text-align: left;
      margin-top: 15px;
    }
    .settings-item {
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
    }
    .settings-item label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .settings input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }
    .settings select {
      width: 100%;
      padding: 5px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
    }
    .volume-value {
      font-size: 14px;
      color: #bdc3c7;
    }
    .no-animations * {
      animation: none !important;
      transition: none !important;
    }
    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .inventory-list .sneaker-card { max-width: 100%; width: 100%; }
    .inventory-compact .sneaker-card { font-size: 12px; padding: 5px; }
    .top-right-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .history-btn, .settings-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: transform 0.2s, background-color 0.2s;
    }
    .history-btn:hover, .settings-btn:hover {
      background: #3498db;
      transform: scale(1.1);
    }
    .purchase-history {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .purchase-item {
      background: #2c3e50;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
    }
    .purchase-time {
      color: #7f8c8d;
      font-size: 0.9em;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
    }
    .limited-offer {
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 20px;
      border-radius: 8px;
      margin: 15px auto;
      max-width: 600px;
      position: relative;
      overflow: hidden;
    }
    .limited-offer::before {
      content: "Limited Time!";
      position: absolute;
      top: 10px;
      right: -30px;
      background: #e74c3c;
      color: white;
      padding: 5px 40px;
      transform: rotate(45deg);
      font-size: 12px;
    }
    .offer-timer {
      color: #ecf0f1;
      font-size: 1.2em;
      margin: 10px 0;
    }
    .offer-content {
      display: flex;
      align-items: center;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .offer-sneaker {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
    }
    .roll-animation {
      animation: rollEffect 1s ease-out;
    }
    @keyframes rollEffect {
      0% { transform: translateY(-100px) rotate(-180deg); opacity: 0; }
      70% { transform: translateY(20px) rotate(20deg); opacity: 0.7; }
      100% { transform: translateY(0) rotate(0deg); opacity: 1; }
    }
    .roll-container {
      position: relative;
      height: 150px;
      width: 200px;
      overflow: hidden;
      background: #2c3e50;
      border-radius: 8px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .roll-item {
      position: absolute;
      width: 180px;
      height: 130px;
      padding: 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #34495e;
      box-sizing: border-box;
      border-radius: 5px;
      transition: all 0.05s;
      opacity: 0;
      transform: scale(0.9);
      left: 50%;
      margin-left: -90px;
    }
    .roll-item.active {
      opacity: 1;
      transform: scale(1);
    }
    .roll-item.final {
      animation: popIn 0.3s ease-out forwards !important;
      opacity: 1;
    }
    @keyframes popIn {
      0% { transform: scale(0.8); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .roll-flash {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 2;
    }
    .roll-item strong {
      display: block;
      margin-bottom: 5px;
    }
    .roll-item span {
      display: block;
      margin: 2px 0;
    }
    @keyframes flashEffect {
      0% { opacity: 0; }
      50% { opacity: 0.5; }
      100% { opacity: 0; }
    }
    .trade-comparison {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 20px 0;
      gap: 20px;
    }
    .trade-side {
      flex: 1;
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      max-width: 300px;
    }
    .trade-arrow {
      font-size: 24px;
      color: #3498db;
    }
    .value-comparison {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      font-size: 0.9em;
    }
    .better-value { color: #2ecc71; }
    .worse-value { color: #e74c3c; }
    .equal-value { color: #f1c40f; }
    .trade-selection {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .selected-sneakers {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .selected-sneaker {
      background: #2c3e50;
      padding: 8px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .remove-sneaker {
      background: #c0392b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .ai-trader-info {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .ai-avatar {
      width: 50px;
      height: 50px;
      background: #34495e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .ai-details {
      flex-grow: 1;
    }
    .ai-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    .ai-preference {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .negotiation-options {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .negotiation-btn {
      background: #34495e;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .negotiation-btn:hover {
      background: #2c3e50;
    }
    .ai-response {
      margin: 10px 0;
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
      font-style: italic;
    }
    .purchase-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .resell-agent {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .agent-level {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .level-indicator {
      display: flex;
      gap: 3px;
    }
    .level-star {
      color: #f1c40f;
    }
    .agent-bonus {
      color: #2ecc71;
    }
    .staff-section {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .staff-member {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .staff-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .staff-status {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .staff-stats {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 0.9em;
    }
    .staff-cost {
      color: #f1c40f;
    }
    .agent-types {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .agent-card {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      min-width: 200px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .agent-card:hover {
      transform: translateY(-5px);
    }
    .agent-card.selected {
      border: 2px solid #3498db;
    }
    .breaking-news {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      animation: slideDown 0.5s ease-out, glow 2s infinite;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      text-align: center;
      min-width: 300px;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
      100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
    }
    .news-header {
      font-size: 1.5em;
      margin-bottom: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .news-content {
      font-size: 1.2em;
      line-height: 1.4;
      margin: 10px 0;
    }
    .news-timer {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
      width: 100%;
    }
    .news-timer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.8);
      transform-origin: left;
    }
    .news-timer.animate::after {
      animation: newsTimer 5s linear forwards;
    }
    @keyframes newsTimer {
      0% { transform: scaleX(1); }
      100% { transform: scaleX(0); }
    }
    .trader-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .trader-card {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      text-align: left;
    }
    .trader-card:hover {
      transform: translateY(-5px);
    }
    .trader-card.selected {
      border: 2px solid #3498db;
    }
    .trader-avatar {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .trader-info {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .limited-offers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .limited-offer {
      position: relative;
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .offer-timer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9em;
    }

    .staff-hire-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .staff-hire-modal.show {
      display: block;
    }
    .staff-hire-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .staff-hire-item {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .staff-hire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .staff-hire-cost {
      color: #f1c40f;
      font-weight: bold;
    }
    .test-buttons {
      position: fixed;
      left: -9999px;
      visibility: hidden;
    }
    .test-button {
      background: #8e44ad;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .test-button:hover {
      background: #9b59b6;
    }
    
    /* New styles for clicker, used market, and cleaning game */
    .clicker-button {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.1s;
      margin: 20px auto;
      display: block;
    }
    
    .clicker-button:active {
      transform: scale(0.95);
    }
    
    .used-market {
      margin: 20px 0;
    }
    
    .used-sneaker {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sneaker Pack Tycoon</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #2c3e50; color: white; text-align: center; }
    h1 { margin-top: 20px; }
    .container { margin: 20px; }
    .coins { font-size: 24px; margin-bottom: 20px; }
    .pack-select, .pack-button { padding: 10px 20px; font-size: 18px; margin: 10px; }
    .pack-button { cursor: pointer; background-color: #2980b9; color: white; border: none; border-radius: 5px; }
    .inventory, .market, .settings, .daily, .trading { margin-top: 20px; }
    .inventory div, .market div, .trading div { background: #34495e; margin: 10px; padding: 10px; border-radius: 8px; }
    .sneaker-card { margin-bottom: 10px; }
    .rarity-common { color: #7f8c8d; }
    .rarity-rare { color: #2980b9; }
    .rarity-epic { color: #8e44ad; }
    .rarity-legendary { color: #f39c12; font-weight: bold; }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      background: #222;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
      z-index: 1000;
      pointer-events: none;
    }
    .modal.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 999;
      pointer-events: none;
    }
    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .card-container {
      margin: 20px auto;
      display: flex;
      flex-direction: row;
      align-items: center;
      position: relative;
      height: 200px;
      width: 600px;
      overflow: hidden;
      background: #222;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .casino-roll-track {
      display: flex;
      flex-direction: row;
      align-items: center;
      transition: transform 2s cubic-bezier(0.23, 1, 0.32, 1);
      will-change: transform;
      height: 100%;
    }
    .casino-roll-card {
      background-color: #34495e;
      color: white;
      padding: 20px;
      border-radius: 8px;
      width: 180px;
      height: 150px;
      margin: 0 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 1em;
      transition: box-shadow 0.2s, transform 0.2s;
      }
    .casino-roll-card.selected {
      /* No border, no color change, no highlight */
      /* Just use normal card style */
    }
    select.pack-select { background: #34495e; color: white; border: 1px solid #2980b9; border-radius: 5px; }
    .inventory-list-flex {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .sneaker-card {
      background: #34495e;
      margin: 5px;
      padding: 8px;
      border-radius: 8px;
      min-width: 100px;
      max-width: 140px;
      flex: 1 1 120px;
      font-size: 14px;
      transition: font-size 0.2s, min-width 0.2s, max-width 0.2s;
      width: calc(100% / 5 - 16px);
    }
    @media (max-width: 700px) {
      .inventory-list-flex .sneaker-card {
        width: calc(100% / 2 - 16px);
      }
    }
    @media (max-width: 500px) {
      .inventory-list-flex .sneaker-card {
        width: 100%;
      }
    }
    #trade-dropdown {
      margin: 10px 0;
      padding: 6px 12px;
      font-size: 16px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
      width: 90%;
      max-width: 300px;
    }
    .trade-offer { margin-top: 15px; }
    .close-btn { background: #c0392b; color: white; border: none; border-radius: 5px; padding: 6px 14px; cursor: pointer; margin-top: 10px;}
    .settings {
      margin-top: 20px;
      background: #34495e;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      text-align: left;
      margin-top: 15px;
    }
    .settings-item {
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
    }
    .settings-item label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .settings input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }
    .settings select {
      width: 100%;
      padding: 5px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
    }
    .volume-value {
      font-size: 14px;
      color: #bdc3c7;
    }
    .no-animations * {
      animation: none !important;
      transition: none !important;
    }
    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .inventory-list .sneaker-card { max-width: 100%; width: 100%; }
    .inventory-compact .sneaker-card { font-size: 12px; padding: 5px; }
    .top-right-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .history-btn, .settings-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: transform 0.2s, background-color 0.2s;
    }
    .history-btn:hover, .settings-btn:hover {
      background: #3498db;
      transform: scale(1.1);
    }
    .purchase-history {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .purchase-item {
      background: #2c3e50;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
    }
    .purchase-time {
      color: #7f8c8d;
      font-size: 0.9em;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
    }
    .limited-offer {
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 20px;
      border-radius: 8px;
      margin: 15px auto;
      max-width: 600px;
      position: relative;
      overflow: hidden;
    }
    .limited-offer::before {
      content: "Limited Time!";
      position: absolute;
      top: 10px;
      right: -30px;
      background: #e74c3c;
      color: white;
      padding: 5px 40px;
      transform: rotate(45deg);
      font-size: 12px;
    }
    .offer-timer {
      color: #ecf0f1;
      font-size: 1.2em;
      margin: 10px 0;
    }
    .offer-content {
      display: flex;
      align-items: center;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .offer-sneaker {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
    }
    .roll-animation {
      animation: rollEffect 1s ease-out;
    }
    @keyframes rollEffect {
      0% { transform: translateY(-100px) rotate(-180deg); opacity: 0; }
      70% { transform: translateY(20px) rotate(20deg); opacity: 0.7; }
      100% { transform: translateY(0) rotate(0deg); opacity: 1; }
    }
    .roll-container {
      position: relative;
      height: 150px;
      width: 200px;
      overflow: hidden;
      background: #2c3e50;
      border-radius: 8px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .roll-item {
      position: absolute;
      width: 180px;
      height: 130px;
      padding: 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #34495e;
      box-sizing: border-box;
      border-radius: 5px;
      transition: all 0.05s;
      opacity: 0;
      transform: scale(0.9);
      left: 50%;
      margin-left: -90px;
    }
    .roll-item.active {
      opacity: 1;
      transform: scale(1);
    }
    .roll-item.final {
      animation: popIn 0.3s ease-out forwards !important;
      opacity: 1;
    }
    @keyframes popIn {
      0% { transform: scale(0.8); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .roll-flash {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 2;
    }
    .roll-item strong {
      display: block;
      margin-bottom: 5px;
    }
    .roll-item span {
      display: block;
      margin: 2px 0;
    }
    @keyframes flashEffect {
      0% { opacity: 0; }
      50% { opacity: 0.5; }
      100% { opacity: 0; }
    }
    .trade-comparison {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 20px 0;
      gap: 20px;
    }
    .trade-side {
      flex: 1;
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      max-width: 300px;
    }
    .trade-arrow {
      font-size: 24px;
      color: #3498db;
    }
    .value-comparison {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      font-size: 0.9em;
    }
    .better-value { color: #2ecc71; }
    .worse-value { color: #e74c3c; }
    .equal-value { color: #f1c40f; }
    .trade-selection {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .selected-sneakers {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .selected-sneaker {
      background: #2c3e50;
      padding: 8px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .remove-sneaker {
      background: #c0392b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .ai-trader-info {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .ai-avatar {
      width: 50px;
      height: 50px;
      background: #34495e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .ai-details {
      flex-grow: 1;
    }
    .ai-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    .ai-preference {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .negotiation-options {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .negotiation-btn {
      background: #34495e;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .negotiation-btn:hover {
      background: #2c3e50;
    }
    .ai-response {
      margin: 10px 0;
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
      font-style: italic;
    }
    .purchase-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .resell-agent {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .agent-level {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .level-indicator {
      display: flex;
      gap: 3px;
    }
    .level-star {
      color: #f1c40f;
    }
    .agent-bonus {
      color: #2ecc71;
    }
    .staff-section {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .staff-member {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .staff-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .staff-status {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .staff-stats {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 0.9em;
    }
    .staff-cost {
      color: #f1c40f;
    }
    .agent-types {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .agent-card {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      min-width: 200px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .agent-card:hover {
      transform: translateY(-5px);
    }
    .agent-card.selected {
      border: 2px solid #3498db;
    }
    .breaking-news {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      animation: slideDown 0.5s ease-out, glow 2s infinite;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      text-align: center;
      min-width: 300px;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
      100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
    }
    .news-header {
      font-size: 1.5em;
      margin-bottom: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .news-content {
      font-size: 1.2em;
      line-height: 1.4;
      margin: 10px 0;
    }
    .news-timer {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
      width: 100%;
    }
    .news-timer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.8);
      transform-origin: left;
    }
    .news-timer.animate::after {
      animation: newsTimer 5s linear forwards;
    }
    @keyframes newsTimer {
      0% { transform: scaleX(1); }
      100% { transform: scaleX(0); }
    }
    .trader-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .trader-card {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      text-align: left;
    }
    .trader-card:hover {
      transform: translateY(-5px);
    }
    .trader-card.selected {
      border: 2px solid #3498db;
    }
    .trader-avatar {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .trader-info {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .limited-offers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .limited-offer {
      position: relative;
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .offer-timer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9em;
    }

    .staff-hire-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .staff-hire-modal.show {
      display: block;
    }
    .staff-hire-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .staff-hire-item {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .staff-hire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .staff-hire-cost {
      color: #f1c40f;
      font-weight: bold;
    }
    .test-buttons {
      position: fixed;
      left: -9999px;
      visibility: hidden;
    }
    .test-button {
      background: #8e44ad;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .test-button:hover {
      background: #9b59b6;
    }
    
    /* New styles for clicker, used market, and cleaning game */
    .clicker-button {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.1s;
      margin: 20px auto;
      display: block;
    }
    
    .clicker-button:active {
      transform: scale(0.95);
    }
    
    .used-market {
      margin: 20px 0;
    }
    
    .used-sneaker {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      transition: width 0.3s;
    }
    
    .cleaning-game {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      width: 90%;
      max-width: 500px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .cleaning-game.show {
      display: block;
    }
    
    .cleaning-info {
      margin: 15px 0;
      padding: 10px;
      background: #34495e;
      border-radius: 8px;
    }
    
    .sneaker-canvas {
      background: #34495e;
      border-radius: 8px;
      margin: 10px auto;
      cursor: pointer;
      display: block;
      max-width: 100%;
      height: auto;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      width: 0;
      transition: width 0.3s;
    }
    
    #used-market-modal {
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #34495e;
      border-radius: 8px 8px 0 0;
      margin: -20px -20px 20px -20px;
    }
    
    .modal-header h2 {
      margin: 0;
      color: white;
    }
    
    .click-count {
      font-size: 18px;
      color: #3498db;
      margin: 10px 0;
    }
    
    .used-market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
      max-height: 70vh;
      overflow-y: auto;
      padding: 15px;
    }

    /* Comprehensive light mode styles */
    .light-mode {
      background-color: #f5f6fa;
      color: #2c3e50;
    }
    
    .light-mode .sneaker-card,
    .light-mode .modal,
    .light-mode .settings-item,
    .light-mode .trade-side,
    .light-mode .ai-trader-info,
    .light-mode .ai-response,
    .light-mode .selected-sneaker,
    .light-mode .purchase-item {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .light-mode .modal-overlay {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .light-mode .pack-button,
    .light-mode .negotiation-btn,
    .light-mode .close-btn {
      background-color: #3498db;
      color: white;
    }
    
    .light-mode .pack-button:hover,
    .light-mode .negotiation-btn:hover {
      background-color: #2980b9;
    }
    
    .light-mode .modal-header {
      background-color: #f8f9fa;
      color: #2c3e50;
    }
    
    .light-mode select {
      background-color: #ffffff;
      color: #2c3e50;
      border-color: #bdc3c7;
    }

    /* Fix sneaker positioning in popups */
    .card {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
    }

    .roll-item {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
      width: 180px;
      height: 130px;
    }

    /* Update animations */
    @keyframes rollAndReveal {
      0% { transform: translate(-50%, -150%) rotate(-180deg); opacity: 0; }
      70% { transform: translate(-50%, -30%) rotate(20deg); opacity: 0.7; }
      90% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
    }

    /* Rarity-specific reveal animations */
    .reveal-common {
      animation: rollAndReveal 0.8s ease-out, fadeIn 0.3s ease-out 0.8s !important;
    }
    
    .reveal-uncommon {
      animation: rollAndReveal 0.8s ease-out, glowGreen 0.3s ease-out 0.8s !important;
    }
    
    .reveal-rare {
      animation: rollAndReveal 0.8s ease-out, glowBlue 0.3s ease-out 0.8s !important;
    }
    
    .reveal-epic {
      animation: rollAndReveal 0.8s ease-out, glowPurple 0.3s ease-out 0.8s !important;
    }
    
    .reveal-legendary {
      animation: rollAndReveal 0.8s ease-out, explodeGold 0.3s ease-out 0.8s !important;
    }

    @keyframes glowGreen {
      0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(46, 204, 113, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
    }

    @keyframes glowBlue {
      0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(52, 152, 219, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
    }

    @keyframes glowPurple {
      0% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(155, 89, 182, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
    }

    @keyframes explodeGold {
      0% { transform: translate(-50%, -50%) scale(0.8); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); }
      50% { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 30px 15px rgba(241, 196, 15, 0.4); }
      100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
    }

    /* Additional light mode styles */
    .light-mode .cleaning-game {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .light-mode .cleaning-game .modal-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .light-mode .cleaning-game .modal-header h2 {
      color: #2c3e50;
    }

    .light-mode .limited-offer {
      background: linear-gradient(45deg, #3498db, #9b59b6);
      color: white;
    }

    .light-mode .offer-sneaker {
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50;
    }

    .light-mode .rarity-common { color: #7f8c8d; }
    .light-mode .rarity-uncommon { color: #27ae60; }
    .light-mode .rarity-rare { color: #2980b9; }
    .light-mode .rarity-epic { color: #8e44ad; }
    .light-mode .rarity-legendary { color: #f39c12; }

    .light-mode .better-value { color: #27ae60; }
    .light-mode .worse-value { color: #e74c3c; }
    .light-mode .equal-value { color: #f1c40f; }

    .light-mode .purchase-notification {
      background: #27ae60;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Market buyer upgrade system */
    .market-buyers-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }

    .market-buyer-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #34495e;
      border-radius: 5px;
      gap: 10px;
    }

    .market-buyer-option.active {
      background: #2ecc71;
    }

    .light-mode .market-buyer-option {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
    }

    .light-mode .market-buyer-option.active {
      background: #d4edda;
      border-color: #c3e6cb;
    }

    /* Chat area styles */
    .trade-chat { max-height: 180px; overflow-y: auto; background: #222; border-radius: 6px; padding: 8px; margin-bottom: 10px; text-align: left; }
    .trade-chat-msg { margin: 4px 0; padding: 4px 8px; border-radius: 4px; }
    .trade-chat-msg.ai-msg { background: #34495e; color: #f1c40f; }
    .trade-chat-msg.player-msg { background: #2980b9; color: #fff; text-align: right; }
    /* Trade chat: hacker font */
    .trade-chat, .trade-chat-msg { font-family: 'Fira Mono', 'Consolas', 'monospace'; letter-spacing: 0.5px; }

    /* Prestige system styles */
    .prestige-button {
      background: linear-gradient(45deg, #f39c12, #e74c3c);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .prestige-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.3);
    }
    
    .prestige-button:disabled {
      background: linear-gradient(45deg, #95a5a6, #7f8c8d);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .prestige-info {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    
    .prestige-level {
      font-size: 24px;
      color: #f39c12;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .prestige-bonus {
      font-size: 16px;
      color: #3498db;
      margin: 5px 0;
    }
    
    .prestige-progress {
      background: #2c3e50;
      height: 20px;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .prestige-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #f39c12);
      width: 0%;
      transition: width 0.5s;
    }
    
    .prestige-modal {
      text-align: center;
    }
    
    .prestige-benefits {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }
    
    .prestige-modal h3 {
      color: #f39c12;
      margin: 10px 0;
    }
    
    .prestige-confirm-btn {
      background: #e74c3c;
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
    }
    
    .prestige-stars {
      font-size: 28px;
      color: #f39c12;
      letter-spacing: 5px;
      margin: 10px 0;
    }

    .prestige-milestone {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .prestige-milestone.achieved {
      background: rgba(46, 204, 113, 0.2);
    }
    
    .prestige-milestone.next {
      background: rgba(52, 152, 219, 0.2);
      border: 1px dashed #3498db;
    }
    
    .milestone-level {
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    
    .milestone-emoji {
      font-size: 20px;
      min-width: 30px;
      text-align: center;
    }
    
    .prestige-milestone-summary {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }

    /* Save code system styles */
    .save-code-container {
      margin: 15px 0;
      text-align: center;
    }
    
    .save-code-textarea {
      width: 90%;
      height: 80px;
      background: #2c3e50;
      border: 1px solid #34495e;
      border-radius: 5px;
      color: #ecf0f1;
      padding: 10px;
      margin: 10px 0;
      font-family: monospace;
      resize: none;
    }
    
    .save-code-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    .save-code-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
    }
    
    .save-code-btn:hover {
      background: #3498db;
    }
    
    .save-code-info {
      font-size: 0.9em;
      color: #95a5a6;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div id="breaking-news" class="breaking-news"></div>
  <div class="modal-overlay" id="modal-overlay" onclick="closeAllModals()"></div>
  <div class="top-right-buttons">
    <button class="history-btn" onclick="openHistory()" title="Purchase History">üìú</button>
    <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
  </div>
  <header>
    <h1>Sneaker Pack Tycoon</h1>
    <div class="coins">Coins: <span id="coin-count">0</span></div>
  </header>
  <div class="container">
    <button class="clicker-button" onclick="handleClick()">
      Click!
      <div class="click-count">Clicks: 0</div>
    </button>
    <div class="prestige-info">
      <div class="prestige-level">Prestige Level: <span id="prestige-level">0</span></div>
      <div class="prestige-bonus" id="prestige-bonuses"></div>
      <div class="prestige-progress">
        <div class="prestige-progress-fill" id="prestige-progress-fill"></div>
      </div>
      <button class="prestige-button" id="prestige-button" onclick="openPrestigeModal()">PRESTIGE</button>
    </div>
    <div>
      <select id="pack-type" class="pack-select">
        <option value="standard">Standard Pack (100 Coins)</option>
        <option value="premium">Premium Pack (300 Coins)</option>
        <option value="colorway">Colorway Pack (200 Coins)</option>
        <option value="rare">Rare Pack (400 Coins)</option>
        <option value="epic">Epic Pack (700 Coins)</option>
        <option value="legendary">Legendary Pack (2500 Coins)</option>
        <option value="mystery">Mystery Pack (500 Coins)</option>
        <option value="ultra">Ultra Pack (1200 Coins)</option>
        <option value="hype">Hype Pack (900 Coins)</option>
        <option value="classic">Classic Pack (250 Coins)</option>
        <option value="collab">Collab Pack (1500 Coins)</option>
        <option value="seasonal">Seasonal Pack (600 Coins)</option>
      </select>
      <button class="pack-button" onclick="openPack()">Open Pack</button>
      <button class="pack-button" style="margin-left:8px;" onclick="previewPack()">Pack Preview</button>
    </div>
    <div class="daily">
      <h2>Daily Rewards</h2>
      <button class="pack-button" onclick="claimDaily()">Claim Daily Coins</button>
    </div>
    <div class="upgrades">
      <h2>Store Upgrades</h2>
      <button class="pack-button" onclick="openUsedMarket()">Browse Used Sneakers</button>
      <div class="resell-agent">
        <h3>Resell Agents</h3>
        <div class="agent-types" id="agent-types">
          <!-- Agent types will be inserted here -->
        </div>
        <div class="agent-level">
          Level: <div class="level-indicator" id="agent-level"></div>
        </div>
        <div class="agent-bonus" id="agent-bonus"></div>
        <button class="pack-button" id="upgrade-agent-btn" onclick="upgradeResellAgent()">Upgrade Agent</button>
      </div>
      <div class="staff-section">
        <h3>Automated Staff</h3>
        <button class="pack-button" onclick="openHireStaff()">Hire Staff</button>
        <div class="staff-grid" id="staff-grid">
          <!-- Staff members will be inserted here -->
        </div>
      </div>
    </div>
    <div class="inventory">
      <h2>Your Inventory</h2>
      <div id="inventory-list" class="inventory-list-flex"></div>
    </div>
    <div class="trading">
      <h2>AI Trading System (Sneaker-for-Sneaker)</h2>
      <button class="pack-button" onclick="openTradeUI()">Enter Trade</button>
    </div>
  <div class="modal" id="used-market-modal">
    <div class="modal-header">
      <h2>Used Sneaker Market</h2>
      <button class="close-btn" onclick="closeUsedMarket()">Close</button>
    </div>
    <div class="used-market-grid" id="used-market-grid">
      <!-- Used sneakers will be inserted here -->
    </div>
  </div>
  <div class="cleaning-game" id="cleaning-game">
    <div class="modal-header">
      <h2>Clean Your New Sneaker</h2>
      <button class="close-btn" onclick="finishCleaning()">‚úï</button>
    </div>
    <div class="cleaning-info">
      <p>Click on the dirt spots to clean them!</p>
      <div class="condition-bar">
        <div class="condition-fill" id="cleaning-progress"></div>
      </div>
    </div>
    <canvas id="sneaker-canvas" class="sneaker-canvas" width="400" height="300"></canvas>
    <button class="pack-button" onclick="finishCleaning()">Finish Cleaning</button>
  </div>
  <div class="modal" id="pack-modal">
    <div id="modal-content">
      <h2>Opening Pack...</h2>
      <div id="card-container" class="card-container"></div>
      <button id="next-sneaker-btn" onclick="revealNextSneaker()">Next Sneaker</button>
    </div>
  </div>
  <div class="modal" id="trade-modal">
    <div>
      <h2>Select Trader</h2>
      <div class="trader-selection" id="trader-selection">
        <!-- Trader cards will be inserted here -->
      </div>
      <div id="ai-trader" class="ai-trader-info" style="display: none;">
        <!-- AI trader info will be inserted here -->
      </div>
      <div class="trade-selection">
        <div><b>Select sneakers to offer:</b></div>
      <select id="trade-dropdown"></select>
        <button class="pack-button" onclick="addToTrade()">Add to Trade</button>
        <div id="selected-sneakers" class="selected-sneakers"></div>
      </div>
      <div class="trade-comparison">
        <div class="trade-side" id="your-offer">
          <h3>Your Offer</h3>
          <div class="offer-details"></div>
        </div>
        <div class="trade-arrow">‚ÜîÔ∏è</div>
        <div class="trade-side" id="ai-offer">
          <h3>AI's Offer</h3>
          <div class="offer-details"></div>
        </div>
      </div>
      <div id="ai-response" class="ai-response"></div>
      <div class="negotiation-options" id="negotiation-options"></div>
      <div id="trade-offer" class="trade-offer"></div>
      <div id="trade-chat" class="trade-chat"></div>
      <button class="close-btn" onclick="closeTradeUI()">Close</button>
    </div>
  </div>
  <div class="modal" id="settings-modal">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="close-btn" onclick="closeSettings()">Close</button>
    </div>
    <div class="settings-grid">
      <div class="settings-item">
        <label>
          <input type="checkbox" id="animation-toggle" onclick="toggleAnimation()">
          Show Animations
        </label>
      </div>
      <div class="settings-item">
        <label>
          <input type="checkbox" id="notification-toggle" onclick="toggleNotifications()">
          Show Notifications
        </label>
      </div>
      <div class="settings-item">
        <label for="display-mode">Display Mode</label>
        <select id="display-mode" onchange="updateDisplayMode()">
          <option value="grid">Grid View</option>
          <option value="list">List View</option>
          <option value="compact">Compact View</option>
        </select>
      </div>
      <div class="settings-item">
        <label for="currency-display">Currency Display</label>
        <select id="currency-display" onchange="updateCurrencyDisplay()">
          <option value="coins">Coins</option>
          <option value="k">K Format (1K, 2K)</option>
          <option value="full">Full Number</option>
        </select>
      </div>
      <div class="settings-item">
        <label for="sort-inventory">Default Sort</label>
        <select id="sort-inventory" onchange="updateDefaultSort()">
          <option value="rarity">By Rarity</option>
          <option value="value">By Value</option>
          <option value="brand">By Brand</option>
          <option value="newest">Newest First</option>
        </select>
      </div>
      <div class="settings-item">
        <label>
          <input type="checkbox" id="light-mode-toggle" onclick="toggleLightMode()">
          Light Mode
        </label>
      </div>
      <div class="settings-item">
        <label><input type="checkbox" id="skip-animation-toggle" onclick="toggleSkipAnimation()"> Skip Pack Animation</label>
      </div>
    </div>
    
    <div class="save-code-container">
      <!-- Save import/export removed -->
    </div>
  </div>
  <div class="modal" id="history-modal">
    <div class="modal-header">
      <h2>Purchase History</h2>
      <button class="close-btn" onclick="closeHistory()">Close</button>
    </div>
    <div class="purchase-history" id="purchase-history">
      <!-- Purchase history items will be added here -->
    </div>
  </div>
  <div class="staff-hire-modal" id="staff-hire-modal">
    <div class="modal-header">
      <h2>Hire Staff</h2>
      <button class="close-btn" onclick="closeHireStaff()">Close</button>
    </div>
    <div class="staff-hire-list" id="staff-hire-list">
      <!-- Staff hire options will be inserted here -->
    </div>
  </div>
  <div class="test-buttons">
    <button class="test-button" onclick="showBreakingNews(true)">Test Breaking News</button>
  </div>
  <div class="modal" id="prestige-modal">
    <div class="modal-header">
      <h2>Prestige System</h2>
      <button class="close-btn" onclick="closePrestigeModal()">Close</button>
    </div>
    <div class="prestige-modal">
      <div class="prestige-stars" id="prestige-stars">‚òÖ</div>
      <p>You've reached <span id="prestige-coins-display">100,000</span> coins!</p>
      <p>Are you ready to prestige and reset your progress for permanent bonuses?</p>
      
      <div class="prestige-benefits">
        <h3>Benefits of Prestige Level <span id="next-prestige-level">1</span>:</h3>
        <ul id="prestige-benefits-list">
          <li>Reduced base pack costs (90 coins)</li>
          <li>Increased click value (1 coin per click)</li>
          <li>Keep your prestige bonuses forever</li>
        </ul>
      </div>
      
      <h3>Prestige Milestones:</h3>
      <div id="prestige-milestones">
        <!-- Milestone list will be added here -->
      </div>
      
      <p><strong>Warning:</strong> You will lose all your coins, inventory items, and staff!</p>
      
      <button class="pack-button prestige-confirm-btn" onclick="confirmPrestige()">PRESTIGE NOW</button>
    </div>
  </div>
  <script>
    // Initialize game state
    let gameState = {
      coins: 0,
      inventory: [],
      purchaseHistory: [],
      prestigeLevel: 0,
      clickValue: 1, // 1 coin per click at base (modified by prestige)
      clicksNeeded: 2, // Number of clicks needed for 1 coin (modified by prestige)
      clickCounter: 0, // Counter for current clicks
      inventoryCapacityBonus: 0, // Additional inventory slots from prestige
      rarityMultiplier: 1, // Multiplier for rarity chances
      extraSneakerChance: 0, // Chance for extra sneaker in packs
      passiveIncomeRate: 0, // Passive income per second
      passiveIncomeInterval: null, // Interval for passive income
      autoSellCommon: false, // Auto-sell common items
      freePackChance: 0, // Chance for free packs
      legendaryBoost: 0, // Boost to legendary chances
      doubleSaleChance: 0, // Chance for double sale value
      settings: {
        soundEnabled: true,
        musicEnabled: true,
        soundVolume: 0.5,
        musicVolume: 0.3,
        notifications: true,
        animations: true,
        autoSell: false,
        currencyDisplay: 'full',
        displayMode: 'grid',
        defaultSort: 'rarity',
        rollAnimation: true,
        volume: 50,
        lightMode: false,
        skipPackAnimation: false
      },
      hiredStaff: [],
      resellAgent: {
        level: 0
      },
      storageUpgrades: 0,
      storageCost: 300
    };

    // Initialize game state from save or defaults
    function initializeGame() {
      const savedState = localStorage.getItem('sneakerHustleGameState');
      
      if (savedState) {
        try {
          const gameState = JSON.parse(savedState);
          
          // Restore basic values
          gameState.coins = gameState.coins ?? 10000;
          gameState.inventory = gameState.inventory || [];
          gameState.purchaseHistory = gameState.purchaseHistory || [];
          
          // Restore prestige level
          gameState.prestigeLevel = gameState.prestigeLevel || 0;
          
          // Apply prestige bonuses
          applyPrestigeBonuses();
          
          // Restore settings
          if (gameState.settings) {
            gameState.settings = {...gameState.settings, ...gameState.settings};
          }
          
          // Restore market buyer
          if (gameState.currentMarketBuyer) {
            currentMarketBuyer = gameState.currentMarketBuyer;
          }
          
          // Restore limited offers
          if (gameState.limitedOffers) {
            limitedOffers = new Map(gameState.limitedOffers);
        }
          
          // Restore multipliers
          if (gameState.activeMultipliers) {
            window.globalMultiplier = gameState.activeMultipliers.global;
            window.brandMultipliers = gameState.activeMultipliers.brand;
            window.coinMultiplier = gameState.activeMultipliers.coin;
          }
          
          // Restore trader state
          if (gameState.currentTrader) {
            window.currentTrader = gameState.currentTrader;
            window.lastTraderResponse = gameState.lastTraderResponse;
          }
          if (gameState.hiredStaff) {
            gameState.hiredStaff = gameState.hiredStaff;
          }
          if (gameState.resellAgentLevel !== undefined) {
            gameState.resellAgent.level = gameState.resellAgentLevel;
          }
          if (gameState.storageUpgrades !== undefined) {
            gameState.storageUpgrades = gameState.storageUpgrades;
          }
          if (gameState.storageCost !== undefined) {
            gameState.storageCost = gameState.storageCost;
          }
        } catch (error) {
          console.error('Error loading game state:', error);
          setDefaultState();
        }
        } else {
        setDefaultState();
      }
      
      // Update all UI elements
      updateAllDisplays();
      updateStorageDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Set default state for new games
    function setDefaultState() {
      gameState.coins = 1000;
      gameState.inventory = [];
      gameState.purchaseHistory = [];
      gameState.prestigeLevel = 0;
      gameState.clickValue = 0.5; // Default click value
      gameState.settings = {
        soundEnabled: true,
        musicEnabled: true,
        soundVolume: 0.5,
        musicVolume: 0.3,
        notifications: true,
        animations: true,
        autoSell: false,
        currencyDisplay: 'full',
        displayMode: 'grid',
        defaultSort: 'rarity',
        rollAnimation: true,
        volume: 50,
        lightMode: false,
        skipPackAnimation: false
      };
      gameState.hiredStaff = [];
      gameState.resellAgent.level = 0;
      gameState.storageUpgrades = 0;
      gameState.storageCost = 300;
      if (document.getElementById('storage-cost')) document.getElementById('storage-cost').textContent = gameState.storageCost;
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Update all UI displays
    function updateAllDisplays() {
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      updateLimitedOffers();
      updateMarketBuyerDisplay();
      updatePrestigeDisplay();
      applySettings();
    }

    // Save game state
    function saveGameState() {
      localStorage.setItem('sneakerHustleGameState', JSON.stringify(gameState));
    }

    // Initialize when the page loads
    window.addEventListener('load', () => {
      initializeGame();
      generateNewsEvent();
    });

    // Save before unloading
    window.addEventListener('beforeunload', saveGameState);

    // Initialize game variables
    let upgrades = { betterOdds: false, storageExpand: false };
    let totalProfit = 0;
    let currentSneakers = [];
    let currentSneakerIndex = 0;
    let currentOffer = null;
    let offerInterval = null;
    let selectedTradeItems = [];
    let activeEvents = new Map();
    let clickCount = 0;
    let currentCleaningSneaker = null;
    let dirtSpots = [];
    let cleaningInProgress = false;

    // News Events Data
    const newsEvents = [
      {
        type: "celebrity",
        templates: [
          "{celebrity} spotted wearing {sneaker}! Prices {direction}!",
          "Breaking: {celebrity} signs deal with {sneaker} brand!",
          "{celebrity}'s {sneaker} collection causing market frenzy!"
        ],
        valueEffect: [0.2, 0.5], // 20-50% increase
        duration: 300000 // 5 minutes
      },
      {
        type: "market",
        templates: [
          "Market Alert: {sneaker} prices {direction} rapidly!",
          "Unexpected demand surge for {sneaker}!",
          "Rare {sneaker} batch discovered! Market adjusting!"
        ],
        valueEffect: [-0.3, 0.3], // -30% to +30%
        duration: 600000 // 10 minutes
      },
      {
        type: "trend",
        templates: [
          "TikTok trend featuring {sneaker} goes viral!",
          "Fashion influencers can't get enough of {sneaker}!",
          "Street style: {sneaker} becomes must-have item!"
        ],
        valueEffect: [0.1, 0.4], // 10-40% increase
        duration: 450000 // 7.5 minutes
      }
    ];

    // Add more celebrities and events
    const celebrities = [
      // Musicians
      "Drake", "Travis Scott", "Kanye West", "Bad Bunny", "The Weeknd",
      "Taylor Swift", "Billie Eilish", "Post Malone", "J Balvin", "BTS",
      "Rihanna", "Jay-Z", "Eminem", "Lil Baby", "Tyler, The Creator",
      
      // Athletes
      "LeBron James", "Cristiano Ronaldo", "Lionel Messi", "Kevin Durant",
      "Stephen Curry", "Neymar Jr", "Kylian Mbapp√©", "Giannis Antetokounmpo",
      "Zion Williamson", "Ja Morant", "Erling Haaland", "Luka Donƒçiƒá",
      
      // Entertainers
      "Zendaya", "Tom Holland", "Michael B. Jordan", "Ryan Reynolds",
      "Donald Glover", "Kevin Hart", "Margot Robbie", "Timoth√©e Chalamet",
      
      // Fashion/Social
      "Kylie Jenner", "Bella Hadid", "A$AP Rocky", "Virgil Abloh",
      "Kim Kardashian", "Kendall Jenner", "Pharrell Williams", "Jerry Lorenzo"
    ];

    // Special Events with Coin Multipliers
    const specialEvents = [
      {
        type: "market_surge",
        templates: [
          "üåü MARKET SURGE: All sales give {multiplier}x coins for {duration} minutes!",
          "üí´ GOLDEN HOUR: {multiplier}x coins from all transactions for {duration} minutes!",
          "üéØ HOT MARKET: Earn {multiplier}x coins from sales for {duration} minutes!"
        ],
        rarity: 0.05, // 5% chance
        multipliers: [2, 3, 5, 10],
        durations: [2, 3, 5] // minutes
      },
      {
        type: "lucky_find",
        templates: [
          "üçÄ LUCKY FIND: Next pack has {multiplier}x better odds!",
          "‚ú® BLESSED PACK: Your next opening has {multiplier}x rarity chance!",
          "üé≤ FORTUNE FAVORS: {multiplier}x rarity boost on your next pack!"
        ],
        rarity: 0.08, // 8% chance
        multipliers: [2, 3, 5]
      },
      {
        type: "market_crash",
        templates: [
          "üìâ MARKET CRASH: All sneakers {direction} in value by {percentage}%!",
          "üí• ECONOMIC SHOCK: Global sneaker values {direction} {percentage}%!",
          "üå™ MARKET CHAOS: Sudden {percentage}% {direction} in all values!"
        ],
        rarity: 0.03, // 3% chance
        effects: [-0.5, -0.3, 0.3, 0.5]
      }
    ];

    // Card reveal effects based on rarity
    const cardEffects = {
      common: {
        animation: "fade",
        color: "#7f8c8d",
        sound: "whoosh"
      },
      rare: {
        animation: "flip",
        color: "#2980b9",
        particles: "sparkle"
      },
      epic: {
        animation: "spin",
        color: "#8e44ad",
        particles: "burst"
      },
      legendary: {
        animation: "explosion",
        color: "#f39c12",
        particles: "fireworks"
      }
    };

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function finishPackOpening() {
      gameState.inventory.push(...currentSneakers);
      updateInventory();
      
      // Close the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.remove('show');
      modalOverlay.classList.remove('show');
      
      // Reset state
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      currentSneakerIndex = 0;
      currentSneakers = [];
      
      // Re-enable all buttons
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = false;
      });
      saveGameState();
    }

    // --- 100+ Sneaker Database ---
    const brands = [
      "Nike", "Adidas", "Jordan", "Puma", "Reebok", "New Balance", "Asics", 
      "Converse", "Vans", "Saucony", "Under Armour", "Yeezy", "Off-White",
      "Balenciaga", "Gucci", "Louis Vuitton", "Alexander McQueen", "Dior"
    ];
    
    const models = [
      // Nike Models
      "Air Max 90", "Dunk Low", "Air Force 1", "SB Dunk", "Air Max 95", 
      "Air Max 97", "Air Max 1", "Air Jordan 1", "Air Jordan 4", "Air Jordan 11",
      "Air Presto", "React Element", "Blazer Mid", "Cortez", "Waffle One",
      
      // Adidas Models
      "Yeezy Boost 350", "Superstar", "Ultra Boost", "NMD R1", "Forum Low",
      "Stan Smith", "Samba", "ZX 750", "Ozweego", "Campus",
      
      // Jordan Models
      "Retro 1", "Retro 3", "Retro 4", "Retro 5", "Retro 6",
      "Retro 11", "Retro 12", "Retro 13", "Legacy 312", "XXXV",
      
      // Luxury Models
      "Triple S", "Speed Trainer", "Rhyton", "Ace", "Run Away",
      "B23 High", "Chain Reaction", "Oversized", "Wave", "Track",
      
      // Classic Models
      "Chuck Taylor", "Old Skool", "Sk8-Hi", "Era", "Authentic",
      "Club C 85", "Classic Leather", "Workout Plus", "550", "992",
      
      // Running/Athletic
      "Gel Lyte III", "Kayano 5", "Jazz Original", "Triumph", "HOVR",
      "Fresh Foam", "Kinvara", "Endorphin", "Zoom Fly", "Pegasus"
    ];
    
    const colorways = [
      // Basic Colors
      "White/Black", "Black/White", "Triple Black", "Triple White", "Navy/White",
      "Red/White", "Green/White", "Blue/White", "Grey/White", "Cream/White",
      
      // Popular Nicknames
      "Bred", "Chicago", "Royal", "Shadow", "Mocha",
      "University Blue", "Volt", "Infrared", "Cement", "Pine Green",
      
      // Special Editions
      "Travis Scott", "Off-White", "Fragment", "Union LA", "A Ma Maniere",
      "Sean Wotherspoon", "Virgil Abloh", "Sacai", "Cactus Jack", "Fear of God",
      
      // Patterns
      "Zebra", "Tiger Stripe", "Safari Print", "Snake Skin", "Tie Dye",
      "Splatter", "Gradient", "Camo", "Animal Print", "Paisley",
      
      // Materials
      "Patent Leather", "Suede", "Canvas", "Mesh", "Knit",
      "Premium Leather", "Nubuck", "Corduroy", "Denim", "Velvet",
      
      // Seasonal
      "Summer Pack", "Winter Camo", "Fall Tones", "Spring Pastels", "Holiday",
      "Valentine's Day", "Halloween", "Christmas", "Easter", "New Year",
      
      // Collaborations
      "Supreme", "Undefeated", "Concepts", "Atmos", "Patta",
      "Stussy", "Diamond Supply", "Kith", "Bodega", "SNS",
      
      // Limited Editions
      "Friends & Family", "Sample", "Prototype", "Region Exclusive", "Store Exclusive",
      "Anniversary", "Retro+", "OG", "Vintage", "Player Exclusive"
    ];

    const rarities = [
      { rarity: "common", weight: 60, value: [20, 50] },
      { rarity: "rare", weight: 25, value: [60, 150] },
      { rarity: "epic", weight: 12, value: [200, 400] },
      { rarity: "legendary", weight: 3, value: [500, 2000] }
    ];

    // Instead of generating a fixed database, generate a random sneaker on demand
    function getRandomSneaker(rarity) {
      const brand = brands[Math.floor(Math.random() * brands.length)];
      const model = models[Math.floor(Math.random() * models.length)];
      const colorway = colorways[Math.floor(Math.random() * colorways.length)];
      let baseValue = 50;
      for (let r of rarities) {
        if (r.rarity === rarity) {
          baseValue = Math.floor(r.value[0] + Math.random() * (r.value[1] - r.value[0]));
          break;
        }
      }
      return {
        id: Date.now() + Math.random(),
        brand,
        model,
        colorway,
        rarity,
        baseValue,
        image: `https://robohash.org/${encodeURIComponent(brand + '-' + model + '-' + colorway)}.png?set=set4`
      };
    }

    // --- Pack Definitions ---
    const packTypes = {
      standard: { 
        cost: 100,
        odds: { common: 0.75, rare: 0.20, epic: 0.04, legendary: 0.01 },
        bg: '#222'
      },
      premium: { 
        cost: 300,
        odds: { common: 0.45, rare: 0.35, epic: 0.15, legendary: 0.05 },
        bg: '#2980b9'
      },
      colorway: { 
        cost: 200,
        odds: { common: 0.55, rare: 0.30, epic: 0.12, legendary: 0.03 }, 
        colorway: true,
        bg: '#8e44ad'
      },
      rare: { 
        cost: 400,
        odds: { rare: 0.70, epic: 0.25, legendary: 0.05 },
        bg: '#16a085'
      },
      epic: { 
        cost: 700,
        odds: { rare: 0.25, epic: 0.60, legendary: 0.15 },
        bg: '#8e44ad'
      },
      legendary: { 
        cost: 2500,
        odds: { epic: 0.70, legendary: 0.10 },
        bg: '#f39c12'
      },
      mystery: { 
        cost: 500,
        odds: { common: 0.25, rare: 0.35, epic: 0.30, legendary: 0.10 },
        bg: '#34495e'
      },
      ultra: { 
        cost: 1200,
        odds: { rare: 0.10, epic: 0.60, legendary: 0.30 },
        bg: '#e74c3c'
      },
      hype: { 
        cost: 900,
        odds: { common: 0.10, rare: 0.30, epic: 0.40, legendary: 0.20 },
        bg: '#27ae60'
      },
      classic: { 
        cost: 250,
        odds: { common: 0.60, rare: 0.30, epic: 0.08, legendary: 0.02 },
        bg: '#bdc3c7'
      },
      collab: { 
        cost: 1500,
        odds: { rare: 0.20, epic: 0.40, legendary: 0.40 },
        colorway: true,
        bg: '#9b59b6'
      },
      seasonal: { 
        cost: 600,
        odds: { common: 0.30, rare: 0.40, epic: 0.25, legendary: 0.05 },
        bg: '#f1c40f'
      }
    };

    function showNotification(message) {
      if (!gameState.settings.notificationsEnabled) return;
      alert(message);
    }

    function updateInventory() {
      const inventoryDiv = document.getElementById("inventory-list");
      inventoryDiv.innerHTML = '';
      if (gameState.inventory.length === 0) {
        inventoryDiv.innerHTML = "<em>No sneakers in inventory.</em>";
        return;
      }

      // Sort inventory based on settings
      const sortedInventory = [...gameState.inventory].sort((a, b) => {
        switch (gameState.settings.defaultSort) {
          case 'rarity':
            return rarities.findIndex(r => r.rarity === b.rarity) - 
                   rarities.findIndex(r => r.rarity === a.rarity);
          case 'value':
            return (b.dynamicValue || b.baseValue) - (a.dynamicValue || a.baseValue);
          case 'brand':
            return a.brand.localeCompare(b.brand);
          case 'newest':
            return gameState.inventory.indexOf(b) - gameState.inventory.indexOf(a);
          default:
            return 0;
        }
      });

      sortedInventory.forEach((sneaker, index) => {
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) 
          ? sneaker.dynamicValue 
          : sneaker.baseValue;
        
        const event = activeEvents.get(sneaker.id);
        const valueChangeClass = event ? 
          (event.effect > 0 ? 'value-increase' : 'value-decrease') : '';

        inventoryDiv.innerHTML += `
          <div class="sneaker-card" data-sneaker-id="${sneaker.id}">
            <img src="${sneaker.image}" alt="${sneaker.brand} ${sneaker.model}" style="width:80px;height:80px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
            <strong>${sneaker.brand} ${sneaker.model}</strong>
            <span>${sneaker.colorway}</span>
            <span class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</span><br>
            <span class="sneaker-value ${valueChangeClass}">
              Value: ${formatCurrency(Math.floor(value))} coins
            </span>
            <br><button onclick="sellSneakerById('${sneaker.id}')" style="margin-top:8px;padding:5px 10px;">Sell</button>
          </div>
        `;
      });

      // Update trade dropdown if it exists
      if (document.getElementById("trade-dropdown")) {
        renderTradeDropdown();
      }
    }
    function updateCoins() {
      const coinDisplay = document.getElementById('coin-count');
      if (coinDisplay) {
        let displayValue = gameState.coins;
        if (gameState.settings.currencyDisplay === 'k') {
          displayValue = gameState.coins >= 1000 ? (gameState.coins/1000).toFixed(1) + 'K' : gameState.coins;
        }
        coinDisplay.textContent = formatCurrency(displayValue);
      }
    }

    function formatCurrency(amount) {
      if (gameState.settings.currencyDisplay === 'k' && amount >= 1000) {
        return (amount/1000).toFixed(1) + 'K';
      } else if (gameState.settings.currencyDisplay === 'full') {
        return amount.toLocaleString();
      }
      return amount.toString();
    }

    function loadSettings() {
      const savedSettings = localStorage.getItem('gameSettings');
      if (savedSettings) {
        gameState.settings = JSON.parse(savedSettings);
        document.getElementById('auto-sell-toggle').checked = gameState.settings.autoSell;
        document.getElementById('sound-toggle').checked = gameState.settings.soundEnabled;
        document.getElementById('animation-toggle').checked = gameState.settings.animationEnabled;
        document.getElementById('notification-toggle').checked = gameState.settings.notificationsEnabled;
        document.getElementById('volume-control').value = gameState.settings.volume;
        document.getElementById('volume-value').textContent = gameState.settings.volume + '%';
        document.getElementById('display-mode').value = gameState.settings.displayMode;
        document.getElementById('currency-display').value = gameState.settings.currencyDisplay;
        document.getElementById('sort-inventory').value = gameState.settings.defaultSort;
        document.getElementById('roll-animation-toggle').checked = gameState.settings.rollAnimation;
        document.getElementById('light-mode-toggle').checked = gameState.settings.lightMode;
        document.getElementById('skip-animation-toggle').checked = gameState.settings.skipPackAnimation;
        if (gameState.settings.lightMode) {
          document.body.classList.add('light-mode');
        } else {
          document.body.classList.remove('light-mode');
        }
        if (!gameState.settings.animationEnabled) {
          document.body.classList.add('no-animations');
        }
        updateInventory();
        updateCoins();
      }
    }

    function saveSettings() {
      localStorage.setItem('gameSettings', JSON.stringify(gameState.settings));
    }

    function applySettings() {
      // Apply settings to UI and game state
      document.body.classList.toggle('light-mode', !!gameState.settings.lightMode);
      document.body.classList.toggle('no-animations', gameState.settings.animationEnabled === false);

      // Update toggles if they exist
      if (document.getElementById('animation-toggle')) {
        document.getElementById('animation-toggle').checked = !!gameState.settings.animationEnabled;
      }
      if (document.getElementById('notification-toggle')) {
        document.getElementById('notification-toggle').checked = !!gameState.settings.notificationsEnabled;
      }
      if (document.getElementById('light-mode-toggle')) {
        document.getElementById('light-mode-toggle').checked = !!gameState.settings.lightMode;
      }
      if (document.getElementById('skip-animation-toggle')) {
        document.getElementById('skip-animation-toggle').checked = !!gameState.settings.skipPackAnimation;
      }
      if (document.getElementById('display-mode')) {
        document.getElementById('display-mode').value = gameState.settings.displayMode;
      }
      if (document.getElementById('currency-display')) {
        document.getElementById('currency-display').value = gameState.settings.currencyDisplay;
      }
      if (document.getElementById('sort-inventory')) {
        document.getElementById('sort-inventory').value = gameState.settings.defaultSort;
      }
      // Update inventory and coins display
      updateInventory();
      updateCoins();
    }

    function toggleAutoSell() {
      gameState.settings.autoSell = document.getElementById('auto-sell-toggle').checked;
      saveSettings();
    }

    function toggleSound() {
      gameState.settings.soundEnabled = document.getElementById('sound-toggle').checked;
      saveSettings();
    }

    function toggleAnimation() {
      gameState.settings.animationEnabled = document.getElementById('animation-toggle').checked;
      document.body.classList.toggle('no-animations', !gameState.settings.animationEnabled);
      saveSettings();
    }

    function toggleNotifications() {
      gameState.settings.notificationsEnabled = document.getElementById('notification-toggle').checked;
      saveSettings();
    }

    function updateVolume() {
      gameState.settings.volume = document.getElementById('volume-control').value;
      document.getElementById('volume-value').textContent = gameState.settings.volume + '%';
      saveSettings();
    }

    function updateDisplayMode() {
      gameState.settings.displayMode = document.getElementById('display-mode').value;
      const inventoryList = document.getElementById('inventory-list');
      inventoryList.className = 'inventory-' + gameState.settings.displayMode;
      saveSettings();
      updateInventory();
    }

    function updateCurrencyDisplay() {
      gameState.settings.currencyDisplay = document.getElementById('currency-display').value;
      saveSettings();
      updateCoins();
      updateInventory();
    }

    function updateDefaultSort() {
      gameState.settings.defaultSort = document.getElementById('sort-inventory').value;
      saveSettings();
      updateInventory();
    }

    function toggleRollAnimation() {
      gameState.settings.rollAnimation = document.getElementById('roll-animation-toggle').checked;
      saveSettings();
    }

    function openPack() {
      const type = document.getElementById("pack-type").value;
      let pack = {...packTypes[type]};
      
      // --- Always apply staff bonuses before opening pack ---
      applyStaffBonuses();
      
      // Check for free pack chance from prestige
      let isFree = false;
      if (gameState.freePackChance > 0 && Math.random() < gameState.freePackChance) {
        isFree = true;
        showPurchaseNotification("üéÅ Free pack from prestige bonus!", "success");
      }
      
      // Apply prestige effect on pack cost if applicable
      if (gameState.prestigeLevel > 0) {
        pack.cost = Math.max(90, Math.floor(pack.cost * Math.pow(0.9, gameState.prestigeLevel)));
      }
      
      // Apply buyer staff discount
      if (type !== 'legendary' && packPriceMultiplier < 1) {
        pack.cost = Math.floor(pack.cost * packPriceMultiplier);
      }
      
      if (!isFree && gameState.coins < pack.cost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      
      // Only deduct coins if not a free pack
      if (!isFree) {
        gameState.coins -= pack.cost;
        updateCoins();
      }

      // Disable buttons during pack opening
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = true;
      });

      // Show the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.add('show');
      modalOverlay.classList.add('show');

      // Generate sneakers
      currentSneakers = [];
      
      // Determine how many sneakers - check for extra sneaker chance
      let sneakerCount = 3;
      if (gameState.extraSneakerChance > 0 && Math.random() < gameState.extraSneakerChance) {
        sneakerCount = 4;
        showPurchaseNotification("üéÅ Extra sneaker from prestige bonus!", "success");
      }
      
      for (let i = 0; i < sneakerCount; i++) {
        let sneaker = rollSneaker(type);
        currentSneakers.push(sneaker);
      }

      // Record the purchase
      addPurchaseToHistory('Pack Opening', isFree ? 0 : pack.cost, currentSneakers);
      
      // Reset state and start reveal
      currentSneakerIndex = 0;
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      revealNextSneaker();

      // Apply authenticator staff bonus to odds
      let odds = {...pack.odds};
      if (rarityBonus > 0) {
        if (odds.rare) odds.rare += rarityBonus;
        if (odds.epic) odds.epic += rarityBonus;
        if (odds.legendary) odds.legendary += rarityBonus;
        // Normalize odds if they exceed 1
        let total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      saveGameState();
    }

    // Patch rollSneaker to use getRandomSneaker and allow all brands
    function rollSneaker(type) {
      // --- Always apply staff bonuses before rolling sneaker ---
      applyStaffBonuses();
      const pack = packTypes[type];
      let roll = Math.random();
      
      // Apply prestige rarity multiplier
      if (gameState.rarityMultiplier > 1) {
        // Shift the roll toward better rarities
        roll = Math.pow(roll, 1 / gameState.rarityMultiplier);
      }
      
      // Apply legendary boost if applicable
      let odds = {...pack.odds};
      if (gameState.legendaryBoost > 0 && odds.legendary) {
        // Increase legendary odds
        odds.legendary += gameState.legendaryBoost;
        
        // Normalize odds
        const total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      
      if (upgrades.betterOdds) roll += 0.05;
      // --- Apply authenticator staff bonus to odds ---
      if (rarityBonus > 0) {
        if (odds.rare) odds.rare += rarityBonus;
        if (odds.epic) odds.epic += rarityBonus;
        if (odds.legendary) odds.legendary += rarityBonus;
        // Normalize odds if they exceed 1
        let total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      let rarity = "common";
      let sum = 0;
      for (let key of ["common", "rare", "epic", "legendary"]) {
        if (odds[key]) {
          sum += odds[key];
          if (roll < sum) {
            rarity = key;
            break;
          }
        }
      }
      // If colorway pack, just use random colorway
      return getRandomSneaker(rarity);
    }

    function createRollItem(sneaker) {
      return `
        <strong>${sneaker.brand} ${sneaker.model}</strong>
        <span>${sneaker.colorway}</span>
        <span class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</span>
      `;
    }

    function sellSneaker(index) {
      if (index < 0 || index >= gameState.inventory.length) return;
      
      let sneaker = gameState.inventory[index];
      let value = sneaker.baseValue;
      
      // Apply any active event effects
      activeEvents.forEach(event => {
        if (event.sneaker === `${sneaker.brand} ${sneaker.model}`) {
          value *= (1 + event.effect);
        }
      });
      
      // Apply resell agent bonus
      const bonus = 1 + (gameState.resellAgent.level * resellAgent.bonusPerLevel);
      value = Math.floor(value * bonus);
      
      // Apply double sale chance from prestige
      let isDoubleSale = false;
      if (gameState.doubleSaleChance > 0 && Math.random() < gameState.doubleSaleChance) {
        value *= 2;
        isDoubleSale = true;
      }
      
      gameState.coins += value;
      gameState.inventory.splice(index, 1); // Remove the sneaker from inventory
      updateCoins();
      updateInventory();
      
      // Show different notification based on if it was a double sale
      if (isDoubleSale) {
        showPurchaseNotification(`üí∞ DOUBLE SALE! Sold ${sneaker.brand} ${sneaker.model} for ${formatCurrency(value)} coins!`);
      } else {
        showPurchaseNotification(`Sold ${sneaker.brand} ${sneaker.model} for ${formatCurrency(value)} coins!`);
      }
      saveGameState();
    }

    function claimDaily() {
      const lastClaim = localStorage.getItem('dailyReward');
      const now = Date.now();
      if (!lastClaim || now - lastClaim > 86400000) {
        gameState.coins += 300;
        localStorage.setItem('dailyReward', now);
        updateCoins();
        showNotification("Daily reward claimed!");
      } else {
        showNotification("Already claimed today!");
      }
      saveGameState();
    }

    function buyUpgrade(type) {
      if (type === 'storageExpand') {
        if (gameState.storageUpgrades >= 10) {
          showPurchaseNotification('Maximum storage reached!', 'error');
          return;
        }
        if (gameState.coins >= gameState.storageCost) {
          gameState.coins -= gameState.storageCost;
          gameState.storageUpgrades++;
          gameState.storageCost = Math.floor(gameState.storageCost * 1.5); // 50% increase each time
          document.getElementById('storage-cost').textContent = gameState.storageCost;
          showPurchaseNotification('Storage expanded!');
          updateCoins();
        } else {
          showPurchaseNotification('Not enough coins!', 'error');
        }
      }
      saveGameState();
    }

    // --- TRADE UI ---
    let aiTradeOffer = [];

    // AI Trader System
    const aiTraders = [
      { name: "Sneaker Steve", emoji: "üëü", preferences: ["Nike", "Jordan", "Yeezy", "Adidas", "SB Dunk", "Ultra Boost"], style: "hype", valuePreference: "high", traits: ["Loves limited editions", "Prefers hyped releases"] },
      { name: "Vintage Vicky", emoji: "üë†", preferences: ["Converse", "Vans", "Chuck Taylor", "Old Skool", "Classic Leather", "Retro+"], style: "classic", valuePreference: "low", traits: ["Collects retro models", "Values original colorways"] },
      { name: "Luxury Larry", emoji: "üíé", preferences: ["Balenciaga", "Gucci", "Louis Vuitton", "Dior", "legendary", "epic"], style: "luxury", valuePreference: "ultra", traits: ["Only wants premium items", "Focuses on rare finds"] },
      { name: "Budget Bob", emoji: "üí∞", preferences: ["common", "rare", "Puma", "Reebok", "Saucony", "Under Armour"], style: "budget", valuePreference: "low", traits: ["Looks for deals", "Prefers common models"] },
      { name: "Collector Charlie", emoji: "üèÜ", preferences: ["rare", "epic", "550", "992", "Sample", "OG"], style: "collector", valuePreference: "medium", traits: ["Completes sets", "Values condition"] },
      { name: "Reseller Rachel", emoji: "üìà", preferences: ["Jordan", "Yeezy", "SB Dunk", "Ultra Boost", "Forum Low"], style: "hype", valuePreference: "high", traits: ["Watches market trends", "Knows resale values"] },
      { name: "Designer Dan", emoji: "‚ú®", preferences: ["Off-White", "Travis Scott", "Fragment", "Union LA", "limited", "colorway"], style: "luxury", valuePreference: "high", traits: ["Loves unique designs", "Prefers collaborations"] },
      { name: "Athletic Amy", emoji: "üèÉ‚Äç‚ôÄÔ∏è", preferences: ["Nike", "Asics", "Gel Lyte III", "Kayano 5", "Zoom Fly", "Pegasus"], style: "classic", valuePreference: "medium", traits: ["Values performance", "Likes durability"] },
      { name: "Trendy Tom", emoji: "üåü", preferences: ["New Balance", "Adidas", "Fresh Foam", "Stan Smith", "Campus", "Samba"], style: "hype", valuePreference: "medium", traits: ["Follows social media", "Loves new releases"] },
      { name: "Casual Casey", emoji: "üòä", preferences: ["Vans", "Converse", "Era", "Authentic", "Club C 85", "Workout Plus"], style: "budget", valuePreference: "low", traits: ["Practical choices", "Daily wear focus"] }
    ];

    const aiPersonalities = [
      "Always looking for the best deal",
      "Loves rare colorways",
      "Interested in limited editions only",
      "Collects specific brands",
      "Values condition over brand",
      "Prefers matching sets",
      "Focuses on resale value",
      "Interested in vintage models",
      "Loves exclusive releases",
      "Only trades for premium items"
    ];

    let currentTrader = null;

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function generateRandomTrader() {
      const baseTrader = aiTraders[Math.floor(Math.random() * aiTraders.length)];
      const personality = aiPersonalities[Math.floor(Math.random() * aiPersonalities.length)];
      
      // Add some randomization to preferences
      const randomBrands = [...brands].sort(() => Math.random() - 0.5).slice(0, 2);
      const randomRarities = ["common", "rare", "epic", "legendary"].sort(() => Math.random() - 0.5).slice(0, 2);
      
      return {
        ...baseTrader,
        personality,
        additionalPreferences: {
          brands: randomBrands,
          rarities: randomRarities,
          minValue: Math.floor(Math.random() * 300) + 100,
          maxValue: Math.floor(Math.random() * 1000) + 500,
          prefersSets: Math.random() > 0.5,
          prefersColorways: Math.random() > 0.5
        }
      };
    }

    function updateAITraderDisplay() {
      const traderDiv = document.getElementById('ai-trader');
      if (!traderDiv) return;

      const styleDisplay = currentTrader.style.charAt(0).toUpperCase() + currentTrader.style.slice(1);
      const valueDisplay = currentTrader.valuePreference.charAt(0).toUpperCase() + currentTrader.valuePreference.slice(1);
      
      traderDiv.innerHTML = `
        <div class="ai-avatar">${currentTrader.emoji}</div>
        <div class="ai-details">
          <div class="ai-name">${currentTrader.name}</div>
          <div class="ai-preference">Style: ${styleDisplay}</div>
          <div class="ai-preference">Value: ${valueDisplay}</div>
          <div class="ai-preference">Prefers: ${currentTrader.preferences.join(', ')}</div>
          <div class="ai-preference">Traits: ${currentTrader.traits.join(', ')}</div>
        </div>
      `;
    }

    function openTradeUI() {
      selectedTradeItems = [];
      aiTradeOffer = [];
      currentTrader = null;
      
      const tradeModal = document.getElementById("trade-modal");
      const overlay = document.getElementById("modal-overlay");
      const aiTrader = document.getElementById("ai-trader");
      const traderSelection = document.getElementById("trader-selection");
      
      tradeModal.classList.add("show");
      overlay.classList.add("show");
      
      aiTrader.style.display = "none";
      traderSelection.style.display = "block";
      
      document.getElementById("selected-sneakers").innerHTML = "";
      document.getElementById("trade-offer").innerHTML = "";
      document.querySelector('#your-offer .offer-details').innerHTML = "";
      document.querySelector('#ai-offer .offer-details').innerHTML = "";
      document.getElementById('trade-chat').innerHTML = '';
      
      renderTraderSelection();
    }

    function closeTradeUI() {
      document.getElementById("trade-modal").classList.remove("show");
    }

    function renderTraderSelection() {
      const container = document.getElementById("trader-selection");
      container.innerHTML = aiTraders.map(trader => `
        <div class="trader-card" onclick="selectTrader('${trader.name}')">
          <div class="trader-avatar">${trader.emoji}</div>
          <div class="trader-name">${trader.name}</div>
          <div class="trader-info">
            <div>Style: ${trader.style.charAt(0).toUpperCase() + trader.style.slice(1)}</div>
            <div>Prefers: ${trader.preferences.join(', ')}</div>
            <div>Value: ${trader.valuePreference.charAt(0).toUpperCase() + trader.valuePreference.slice(1)}</div>
          </div>
        </div>
      `).join('');
    }

    function selectTrader(name) {
      currentTrader = aiTraders.find(t => t.name === name);
      if (!currentTrader) return;

      document.getElementById("trader-selection").style.display = "none";
      document.getElementById("ai-trader").style.display = "block";
      updateAITraderDisplay();
      renderTradeDropdown();
    }

    function renderTradeDropdown() {
      const dropdown = document.getElementById("trade-dropdown");
      dropdown.innerHTML = "";
      if (gameState.inventory.length === 0) {
        dropdown.innerHTML = "<option>No sneakers to trade</option>";
        dropdown.disabled = true;
        return;
      }
      dropdown.disabled = false;
      
      // Only show sneakers that aren't already selected
      const availableSneakers = gameState.inventory.filter((_, idx) => !selectedTradeItems.includes(idx));
      
      if (availableSneakers.length === 0) {
        dropdown.innerHTML = "<option>No more sneakers available</option>";
        dropdown.disabled = true;
        return;
      }

      availableSneakers.forEach((sneaker, idx) => {
        const originalIndex = gameState.inventory.indexOf(sneaker);
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) ? 
          sneaker.dynamicValue : sneaker.baseValue;
        let text = `${sneaker.brand} ${sneaker.model} (${sneaker.colorway}) [${sneaker.rarity.toUpperCase()}] - ${formatCurrency(Math.floor(value))}c`;
        let option = document.createElement("option");
        option.value = originalIndex;
        option.textContent = text;
        dropdown.appendChild(option);
      });
    }

    function addToTrade() {
      const dropdown = document.getElementById("trade-dropdown");
      const selectedIndex = parseInt(dropdown.value);
      
      if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= gameState.inventory.length) {
        showPurchaseNotification("Invalid selection!", "error");
        return;
      }

      if (selectedTradeItems.includes(selectedIndex)) {
        showPurchaseNotification("This sneaker is already in the trade!", "error");
        return;
      }

      selectedTradeItems.push(selectedIndex);
      updateSelectedSneakers();
      renderTradeDropdown();
        generateAITradeOffer();
      appendTradeChatMessage('player', `Let me see... You're offering ${selectedTradeItems.map(index => gameState.inventory[index].brand+' '+gameState.inventory[index].model).join(', ')}. Here's what I think...`);
    }

    function updateSelectedSneakers() {
      const container = document.getElementById("selected-sneakers");
      if (!container) return;

      container.innerHTML = selectedTradeItems.map(index => {
        if (index < 0 || index >= gameState.inventory.length) return '';
        
        const sneaker = gameState.inventory[index];
        return `
          <div class="selected-sneaker">
            <span>${sneaker.brand} ${sneaker.model} [${sneaker.rarity.toUpperCase()}]</span>
            <button class="remove-sneaker" onclick="removeFromTrade(${index})">√ó</button>
          </div>
        `;
      }).join('');

      updateTradeComparison();
    }

    function removeFromTrade(index) {
      selectedTradeItems = selectedTradeItems.filter(i => i !== index);
      updateSelectedSneakers();
      renderTradeDropdown();
      generateAITradeOffer();
    }

    function updateTradeComparison() {
      if (selectedTradeItems.length === 0) {
        document.querySelector('#your-offer .offer-details').innerHTML = "<em>Select sneakers to trade</em>";
        document.querySelector('#ai-offer .offer-details').innerHTML = "";
        return;
      }

      const yourSneakers = selectedTradeItems.map(index => gameState.inventory[index]);
      const yourTotalValue = yourSneakers.reduce((sum, s) => {
        const value = (typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue;
        return sum + value;
      }, 0);

      const aiTotalValue = aiTradeOffer.reduce((sum, s) => {
        const value = (typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue;
        return sum + value;
      }, 0);

      const valueDiff = aiTotalValue - yourTotalValue;
      let valueClass = 'equal-value';
      if (valueDiff > 50) valueClass = 'better-value';
      if (valueDiff < -50) valueClass = 'worse-value';

      document.querySelector('#your-offer .offer-details').innerHTML = `
        ${yourSneakers.map(s => `
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class="rarity-${s.rarity}">[${s.rarity.toUpperCase()}]</span><br>
        `).join('<br>')}
        <div class="value-comparison">Total Value: ${formatCurrency(Math.floor(yourTotalValue))} coins</div>
      `;

      document.querySelector('#ai-offer .offer-details').innerHTML = `
        ${aiTradeOffer.map(s => `
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class="rarity-${s.rarity}">[${s.rarity.toUpperCase()}]</span><br>
        `).join('<br>')}
        <div class="value-comparison ${valueClass}">
          Total Value: ${formatCurrency(Math.floor(aiTotalValue))} coins
          ${valueDiff !== 0 ? `(${valueDiff > 0 ? '+' : ''}${formatCurrency(Math.floor(valueDiff))})` : ''}
        </div>
      `;
    }

    function generateAITradeOffer(adjustment = 1.0) {
      if (!currentTrader || selectedTradeItems.length === 0) {
        updateTradeComparison();
        return;
      }

      const yourSneakers = selectedTradeItems.map(index => gameState.inventory[index]);
      const yourTotalValue = yourSneakers.reduce((sum, s) => {
        return sum + ((typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue);
      }, 0);

      // Calculate preference score for the offered sneakers
      let preferenceBonus = 0;
      yourSneakers.forEach(sneaker => {
        // Brand preference check
        if (currentTrader.preferences.some(pref => 
          sneaker.brand.includes(pref) || 
          sneaker.model.includes(pref)
        )) {
          preferenceBonus += 0.15; // 15% bonus per preferred brand/model
        }
        
        // Rarity preference check
        if (currentTrader.preferences.some(pref => 
          sneaker.rarity.toLowerCase() === pref.toLowerCase()
        )) {
          preferenceBonus += 0.2; // 20% bonus for preferred rarity
        }
        
        // Style match check
        if ((currentTrader.style === 'hype' && (sneaker.rarity === 'legendary' || sneaker.rarity === 'epic')) ||
            (currentTrader.style === 'budget' && (sneaker.rarity === 'common' || sneaker.rarity === 'rare')) ||
            (currentTrader.style === 'luxury' && sneaker.rarity === 'legendary') ||
            (currentTrader.style === 'classic' && (sneaker.brand === 'Nike' || sneaker.brand === 'Jordan' || sneaker.brand === 'Converse'))) {
          preferenceBonus += 0.1; // 10% bonus for style match
        }
      });

      // Calculate target value based on trader preferences
      let targetTotalValue = yourTotalValue * adjustment;
      
      // Apply preference bonus
      targetTotalValue *= (1 + preferenceBonus);
      
      // Apply trader value preference
      switch(currentTrader.valuePreference) {
        case 'low':
          targetTotalValue *= 0.8;
          break;
        case 'medium':
          targetTotalValue *= 1.0;
          break;
        case 'high':
          targetTotalValue *= 1.2;
          break;
        case 'ultra':
          targetTotalValue *= 1.5;
          break;
      }
      
      // Check for specific negotiation messages in the chat
      const chatMsgs = document.querySelectorAll('.trade-chat-msg.player-msg');
      let chatBonus = 0;
      
      chatMsgs.forEach(msgElement => {
        const msgText = msgElement.textContent.toLowerCase();
        
        // Negotiations that improve the offer
        if (msgText.includes('rare') || msgText.includes('legendary') || msgText.includes('limited')) {
          if (currentTrader.style === 'hype' || currentTrader.style === 'luxury') {
            chatBonus += 0.05;
          }
        }
        
        if (msgText.includes('classic') || msgText.includes('vintage') || msgText.includes('retro')) {
          if (currentTrader.style === 'classic') {
            chatBonus += 0.07;
          }
        }
        
        if (msgText.includes('deal') || msgText.includes('fair')) {
          chatBonus += 0.03;
        }
        
        // Negotiations that may reduce the offer
        if (msgText.includes('cheap') || msgText.includes('low')) {
          if (currentTrader.style === 'luxury') {
            chatBonus -= 0.1;
          } else if (currentTrader.style === 'budget') {
            chatBonus += 0.05;
          }
        }
      });
      
      // Apply chat negotiation bonus
      targetTotalValue *= (1 + chatBonus);

      // Generate AI offer
      aiTradeOffer = [];
      
      // Create a pool of preferred sneakers that match trader's style and preferences
      const preferredSneakers = sneakersDatabase.filter(s => {
        // Check brand & model preferences
        const matchesPreference = currentTrader.preferences.some(pref => 
          s.brand.includes(pref) || 
          s.model.includes(pref) ||
          s.rarity.toLowerCase() === pref.toLowerCase()
        );
        
        // Style matching
        const matchesStyle = (
          (currentTrader.style === 'hype' && (s.rarity === 'legendary' || s.rarity === 'epic')) ||
          (currentTrader.style === 'budget' && (s.rarity === 'common' || s.rarity === 'rare')) ||
          (currentTrader.style === 'luxury' && s.rarity === 'legendary') ||
          (currentTrader.style === 'classic' && (s.brand === 'Nike' || s.brand === 'Jordan' || s.brand === 'Converse'))
        );
        
        return matchesPreference || matchesStyle;
      });
      
      // Sort the preferred sneakers by how well they match the trader's preferences
      preferredSneakers.sort((a, b) => {
        const scoreA = getPreferenceScore(a);
        const scoreB = getPreferenceScore(b);
        return scoreB - scoreA;  // Higher score first
      });

      // Try to offer preferred sneakers first (heavily favoring preferences)
      while (aiTradeOffer.length < 3 && preferredSneakers.length > 0 && targetTotalValue > 0) {
        // Take sneakers from the front of the sorted array (highest preference)
        const sneaker = preferredSneakers.shift();
        
        if (sneaker.baseValue <= targetTotalValue * 1.5) { // Allow slightly higher values for preferred items
          aiTradeOffer.push({...sneaker, id: Date.now() + Math.random()});
          targetTotalValue -= sneaker.baseValue;
        }
      }

      // Fill remaining slots with affordable sneakers that somewhat match preferences
      if (aiTradeOffer.length < 3 && targetTotalValue > 0) {
        const remainingSneakers = sneakersDatabase.filter(s => 
          !aiTradeOffer.some(offered => 
            offered.brand === s.brand && offered.model === s.model && offered.rarity === s.rarity
          ) && s.baseValue <= targetTotalValue
        );
        
        // Sort by preference but to a lesser degree
        remainingSneakers.sort((a, b) => {
          const scoreA = getPreferenceScore(a) / 2; // Lower weight on preference
          const scoreB = getPreferenceScore(b) / 2;
          return scoreB - scoreA;
        });
        
        // Add remaining sneakers
        for (let i = 0; i < remainingSneakers.length && aiTradeOffer.length < 3 && targetTotalValue > 0; i++) {
          const sneaker = remainingSneakers[i];
          if (sneaker.baseValue <= targetTotalValue) {
            aiTradeOffer.push({...sneaker, id: Date.now() + Math.random()});
            targetTotalValue -= sneaker.baseValue;
          }
        }
      }
      
      // If we still don't have 3 items, add some lower value items
      if (aiTradeOffer.length < 3) {
        const budgetSneakers = sneakersDatabase.filter(s => 
          !aiTradeOffer.some(offered => 
            offered.brand === s.brand && offered.model === s.model && offered.rarity === s.rarity
          ) && s.rarity === 'common'
        ).sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < budgetSneakers.length && aiTradeOffer.length < 3; i++) {
          aiTradeOffer.push({...budgetSneakers[i], id: Date.now() + Math.random()});
        }
      }

      updateTradeComparison();
      updateNegotiationOptions();
      
      // Add accept trade button if there's an offer
      const tradeOffer = document.getElementById("trade-offer");
      if (tradeOffer) {
        if (aiTradeOffer.length > 0) {
          tradeOffer.innerHTML = '<button class="pack-button" onclick="acceptTrade()">Accept Trade</button>';
        } else {
          tradeOffer.innerHTML = '<em>No suitable trade found</em>';
        }
      }
    }

    function getPreferenceScore(sneaker) {
      if (!currentTrader) return 0;
      
      let score = 0;
      
      // Brand & model preference
      currentTrader.preferences.forEach(pref => {
        if (sneaker.brand.includes(pref) || sneaker.model.includes(pref)) {
          score += 3;
        }
      });
      
      // Rarity preference
      currentTrader.preferences.forEach(pref => {
        if (sneaker.rarity.toLowerCase() === pref.toLowerCase()) {
          score += 2;
        }
      });
      
      // Style match
      if (currentTrader.style === 'hype' && (sneaker.rarity === 'legendary' || sneaker.rarity === 'epic')) {
        score += 3;
      } else if (currentTrader.style === 'budget' && (sneaker.rarity === 'common' || sneaker.rarity === 'rare')) {
        score += 3;
      } else if (currentTrader.style === 'luxury' && sneaker.rarity === 'legendary') {
        score += 4;
      } else if (currentTrader.style === 'classic' && 
                (sneaker.brand === 'Nike' || sneaker.brand === 'Jordan' || sneaker.brand === 'Converse')) {
        score += 3;
      }
      
      return score;
    }

    function acceptTrade() {
      if (!currentTrader || selectedTradeItems.length === 0 || aiTradeOffer.length === 0) {
        showPurchaseNotification("Invalid trade!", "error");
        return;
      }

      // Remove traded sneakers from inventory (in reverse order to maintain correct indices)
      const tradedIndices = [...selectedTradeItems].sort((a, b) => b - a);
      tradedIndices.forEach(index => {
        if (index >= 0 && index < gameState.inventory.length) {
          gameState.inventory.splice(index, 1);
        }
      });

      // Add AI's sneakers to inventory with unique IDs
      aiTradeOffer.forEach(s => {
        const newSneaker = {
          ...s,
          id: Date.now() + Math.random(),
          dynamicValue: s.baseValue
        };
        gameState.inventory.push(newSneaker);
      });

      updateInventory();
      showPurchaseNotification("Trade completed successfully!");
      
      // Reset trade state
      selectedTradeItems = [];
      aiTradeOffer = [];
      currentTrader = null;
      
      // Close trade modal
      closeTradeUI();
      appendTradeChatMessage('ai', 'Deal! Pleasure trading with you.');
    }

    // Load purchase history from localStorage
    function loadPurchaseHistory() {
      const savedHistory = localStorage.getItem('purchaseHistory');
      if (savedHistory) {
        gameState.purchaseHistory = JSON.parse(savedHistory);
      }
    }

    // Save purchase history to localStorage
    function savePurchaseHistory() {
      saveGameState();
    }

    // Add purchase to history
    function addPurchaseToHistory(type, cost, items) {
      const purchase = {
        type: type,
        cost: cost,
        items: items,
        timestamp: new Date().toISOString()
      };
      gameState.purchaseHistory.unshift(purchase);
      if (gameState.purchaseHistory.length > 50) { // Keep only last 50 purchases
        gameState.purchaseHistory.pop();
      }
      savePurchaseHistory();
      updatePurchaseHistory();
    }

    // Update purchase history display
    function updatePurchaseHistory() {
      const historyDiv = document.getElementById('purchase-history');
      historyDiv.innerHTML = '';
      
      gameState.purchaseHistory.forEach(purchase => {
        const date = new Date(purchase.timestamp);
        const formattedDate = date.toLocaleString();
        const itemsList = purchase.items.map(item => 
          `${item.brand} ${item.model} (${item.rarity})`
        ).join(', ');
        
        historyDiv.innerHTML += `
          <div class="purchase-item">
            <div><strong>${purchase.type}</strong> - ${formatCurrency(purchase.cost)} coins</div>
            <div>Items: ${itemsList}</div>
            <div class="purchase-time">${formattedDate}</div>
          </div>
        `;
      });
    }

    function openHistory() {
      document.getElementById('history-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
      updatePurchaseHistory();
    }

    function closeHistory() {
      document.getElementById('history-modal').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
    }

    function openSettings() {
      document.getElementById('settings-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
    }

    function closeAllModals() {
      const modals = ['history-modal', 'settings-modal', 'pack-modal', 'trade-modal'];
      modals.forEach(modalId => {
        document.getElementById(modalId).classList.remove('show');
      });
      document.getElementById('modal-overlay').classList.remove('show');
    }

    // Add event listener for escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeAllModals();
      }
    });

    function generateLimitedOffers() {
      const maxOffers = 3;
      limitedOffers.clear();
      let offerBonus = 1;
      // Apply networker staff bonus
      const networker = gameState.hiredStaff.find(s => s.id === 'networker');
      if (networker) {
        offerBonus -= networker.baseBonus + (networker.level - 1) * networker.bonusPerLevel;
      }
      while (limitedOffers.size < maxOffers) {
        const sneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        if (!limitedOffers.has(sneaker.id)) {
          const duration = 300000 + Math.random() * 300000;
          const discount = (0.6 + Math.random() * 0.2) * offerBonus;
          limitedOffers.set(sneaker.id, {
            sneaker,
            discountedPrice: Math.floor(sneaker.baseValue * discount),
            endTime: Date.now() + duration,
            startTime: Date.now()
          });
        }
      }
      updateLimitedOffers();
    }

    function updateLimitedOffers() {
      const container = document.getElementById('limited-offers');
      if (!container) return;
      
      container.innerHTML = '';
      const now = Date.now();
      let needsNewOffers = false;

      limitedOffers.forEach((offer, id) => {
        const timeLeft = offer.endTime - now;
        if (timeLeft <= 0) {
          limitedOffers.delete(id);
          needsNewOffers = true;
          return;
        }

        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        const savings = offer.sneaker.baseValue - offer.discountedPrice;

        container.innerHTML += `
          <div class="limited-offer">
            <div class="offer-timer">${timeString}</div>
            <div class="offer-sneaker">
              <img src="${offer.sneaker.image}" alt="${offer.sneaker.brand} ${offer.sneaker.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
              <strong>${offer.sneaker.brand} ${offer.sneaker.model}</strong>
              <div>${offer.sneaker.colorway}</div>
              <div class="rarity-${offer.sneaker.rarity}">[${offer.sneaker.rarity.toUpperCase()}]</div>
              <div style="margin: 10px 0;">
                <span style="text-decoration: line-through;">${formatCurrency(offer.sneaker.baseValue)} coins</span>
                <br>
                <strong style="color: #2ecc71; font-size: 1.2em;">
                  ${formatCurrency(offer.discountedPrice)} coins
                </strong>
                <br>
                <span style="color: #e74c3c;">Save ${formatCurrency(savings)} coins!</span>
              </div>
              <button class="pack-button" onclick="purchaseOffer('${id}')">Purchase</button>
            </div>
        </div>
      `;
      });

      if (needsNewOffers || limitedOffers.size < 3) {
        generateLimitedOffers();
      }
    }

    // Update limited offers every second
    setInterval(updateLimitedOffers, 1000);

    // Generate news events every minute
    setInterval(generateNewsEvent, 60000);

    // Initialize on load
    window.addEventListener('load', () => {
      loadSettings();
      loadPurchaseHistory();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      
      // Start news event generation immediately
      generateNewsEvent();

      // Add unique IDs to existing inventory
      gameState.inventory.forEach(s => {
        if (!s.id) s.id = Date.now() + Math.random();
      });
    });

    function purchaseOffer(id) {
      const offer = limitedOffers.get(id);
      if (!offer) {
        showNotification("This offer has expired!");
        return;
      }

      if (gameState.coins < offer.discountedPrice) {
        showNotification("Not enough coins!");
        return;
      }

      gameState.coins -= offer.discountedPrice;
      gameState.inventory.push({
        ...offer.sneaker,
        dynamicValue: offer.sneaker.baseValue
      });

      limitedOffers.delete(id);
      updateLimitedOffers();
      updateCoins();
      updateInventory();
      showPurchaseNotification("Limited offer purchased successfully!");
      saveGameState();
    }

    function showPurchaseNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = 'purchase-notification';
      notification.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
        <span>${message}</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    function updateResellAgentDisplay() {
      const levelDiv = document.getElementById('agent-level');
      const bonusDiv = document.getElementById('agent-bonus');
      const upgradeBtn = document.getElementById('upgrade-agent-btn');
      
      if (levelDiv) {
        levelDiv.innerHTML = Array(gameState.resellAgent.level)
          .fill('‚≠ê')
          .concat(Array(resellAgent.maxLevel - gameState.resellAgent.level).fill('‚òÜ'))
          .join('');
      }
      
      if (bonusDiv) {
        const bonus = (gameState.resellAgent.level * resellAgent.bonusPerLevel * 100).toFixed(0);
        bonusDiv.textContent = `Current Bonus: +${bonus}% sale value`;
      }
      
      if (upgradeBtn) {
        if (gameState.resellAgent.level >= resellAgent.maxLevel) {
          upgradeBtn.textContent = 'Max Level Reached!';
          upgradeBtn.disabled = true;
        } else {
          const nextCost = resellAgent.baseUpgradeCost * Math.pow(2, gameState.resellAgent.level - 1);
          upgradeBtn.textContent = `Upgrade Agent (${formatCurrency(nextCost)} coins)`;
          upgradeBtn.disabled = false;
        }
      }
    }

    function updateMarketBuyerDisplay() {
      // Dummy function: Market Buyer UI not implemented yet
    }

    // Negotiation messages based on trader personality
    const negotiationOptions = {
      standard: [
        "How about we adjust the trade a bit?",
        "Can you add something more?",
        "I'm interested, but the value seems off",
        "This is a good start, but...",
      ],
      counter: [
        "Let me offer something different",
        "What if we modified the trade?",
        "I can adjust my offer",
        "Perhaps we can find middle ground"
      ]
    };

    function updateNegotiationOptions(showCounter = true) {
      const container = document.getElementById('negotiation-options');
      container.innerHTML = '';
      
      if (showCounter) {
        negotiationOptions.standard.forEach(msg => {
          const btn = document.createElement('button');
          btn.className = 'negotiation-btn';
          btn.textContent = msg;
          btn.onclick = () => negotiate(msg);
          container.appendChild(btn);
        });
      }
    }

    function negotiate(message) {
      const response = document.getElementById('ai-response');
      if (!currentTrader || !response) return;

      const yourValue = selectedTradeItems.reduce((sum, idx) => {
        const sneaker = gameState.inventory[idx];
        return sum + (sneaker.dynamicValue || sneaker.baseValue);
      }, 0);
      
      const aiValue = aiTradeOffer.reduce((sum, s) => sum + s.baseValue, 0);
      const valueDiff = Math.abs(yourValue - aiValue);
      const valueRatio = Math.min(yourValue, aiValue) / Math.max(yourValue, aiValue);

      let responseText;
      let willing = false;
      let adjustment = 1.0;

      // Check message keywords
      const msgLower = message.toLowerCase();
      let preferenceMatched = false;
      
      // Check if message mentions any of the trader's preferences
      currentTrader.preferences.forEach(pref => {
        if (msgLower.includes(pref.toLowerCase())) {
          preferenceMatched = true;
        }
      });
      
      // Personality-based responses
      if (preferenceMatched) {
        // More likely to adjust if you mention their preferences
        willing = Math.random() < 0.8;
        adjustment = 1.05; // Better offer when you mention their preferences
        
        if (currentTrader.style === 'hype') {
          responseText = "You know what I like! Let me see what I can offer.";
        } else if (currentTrader.style === 'luxury') {
          responseText = "I see you understand quality. I might have something special for you.";
        } else if (currentTrader.style === 'classic') {
          responseText = "A fellow enthusiast! I'll reconsider my offer.";
        } else {
          responseText = "That's exactly what I'm looking for! Let me adjust my offer.";
        }
      } else if (msgLower.includes("deal") || msgLower.includes("fair")) {
        // Checking for deal-closing terms
        if (valueRatio > 0.9) {
          willing = true;
          responseText = "You're right, this is a fair deal. Let's do it!";
        } else {
          willing = false;
          responseText = "I don't think we're quite there yet. The values don't match up.";
        }
      } else if (msgLower.includes("add") || msgLower.includes("more") || msgLower.includes("better")) {
        // Asking for more
        willing = Math.random() < 0.6;
        adjustment = 1.1; // Offer more
        responseText = willing ? 
          "I can sweeten the deal a bit. Check this out." : 
          "I'm already offering the best I can right now.";
      } else {
        // Standard value-based response
        if (valueRatio > 0.9) {
          willing = Math.random() < 0.8;
          adjustment = 1.0;
          responseText = willing ? 
            "I think we're close to a deal." : 
            "I think this is already a fair offer.";
        } else if (valueRatio > 0.7) {
          willing = Math.random() < 0.6;
          adjustment = 0.95;
          responseText = willing ? 
            "Let me adjust my offer a bit." : 
            "The value gap is a bit too wide for me.";
        } else {
          willing = Math.random() < 0.3;
          adjustment = 0.9;
          responseText = "I'm not sure about this trade value.";
        }
      }

      response.innerHTML = `${currentTrader.emoji} ${currentTrader.name}: "${responseText}"`;

      if (willing) {
        generateAITradeOffer(adjustment);
      }

      appendTradeChatMessage('player', message);
      appendTradeChatMessage('ai', responseText);
    }

    function updateNegotiationOptions() {
      const container = document.getElementById('negotiation-options');
      if (!container || !currentTrader) return;

      const options = [
        { text: "How about we adjust the trade a bit?", style: "standard" },
        { text: `Can you add something more ${currentTrader.style === 'luxury' ? 'exclusive' : 'valuable'}?`, style: "request" },
        { text: "Would you consider a different combination?", style: "counter" },
        { text: `I have some ${currentTrader.preferences[0]} items you might like...`, style: "specific" }
      ];

      container.innerHTML = options.map(opt => `
        <button class="negotiation-btn" onclick="negotiate('${opt.text}')">
          ${opt.text}
        </button>
      `).join('');
    }

    function generateNewsEvent() {
      if (Math.random() > 0.3) return; // 30% chance of news event

      const eventTypes = ["celebrity", "market", "trend"];
      const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];

      // Select random sneaker from inventory or database
      const sneaker = gameState.inventory.length > 0 && Math.random() > 0.5 
        ? gameState.inventory[Math.floor(Math.random() * gameState.inventory.length)]
        : sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
      
      let effect, percentage, direction, message;
      if (eventType === "celebrity" || eventType === "trend") {
        // Always positive effect
        effect = Math.random() * 0.5 + 0.1;
        percentage = Math.abs(Math.round(effect * 100));
        direction = "increased";
      if (eventType === "celebrity") {
        const celebrity = celebrities[Math.floor(Math.random() * celebrities.length)];
        const action = celebrityActions[Math.floor(Math.random() * celebrityActions.length)];
          message = `üî• ${celebrity} ${action} ${sneaker.brand} ${sneaker.model}! Value increased by ${percentage}%!`;
        } else {
          const reason = trendReasons[Math.floor(Math.random() * trendReasons.length)];
          message = `üåü ${sneaker.brand} ${sneaker.model} is trending ${reason}! Value increased by ${percentage}%!`;
        }
      } else if (eventType === "market") {
        // 50% chance for positive or negative market event
        const isPositive = Math.random() > 0.5;
        effect = (isPositive ? 1 : -1) * (Math.random() * 0.5 + 0.1);
        percentage = Math.abs(Math.round(effect * 100));
        direction = isPositive ? "increased" : "decreased";
        const reason = marketReasons[isPositive ? "increase" : "decrease"][Math.floor(Math.random() * marketReasons[isPositive ? "increase" : "decrease"].length)];
        message = `üìà Market Alert: ${sneaker.brand} ${sneaker.model} value has ${direction} by ${percentage}% ${reason}!`;
      }

      // Apply effect to matching sneakers
      const eventId = Date.now();
      activeEvents.set(eventId, {
        sneaker: `${sneaker.brand} ${sneaker.model}`,
        effect: effect,
        endTime: Date.now() + 300000 // 5 minutes
      });

      showBreakingNews(message);
      updateInventoryValues();

      setTimeout(() => {
        activeEvents.delete(eventId);
        updateInventoryValues();
      }, 300000);
    }

    function showBreakingNews(message, duration = 5000) {
      const newsElement = document.getElementById('breaking-news');
      if (!newsElement) return;

      // If called from test button, generate a test event
      if (message === true) {
        const testSneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        // Always positive effect for test
        const effect = Math.random() * 0.5 + 0.1;
        const percentage = Math.abs(Math.round(effect * 100));
        const direction = "increased";
        const reason = marketReasons.increase[Math.floor(Math.random() * marketReasons.increase.length)];
        message = `üìà Market Alert: ${testSneaker.brand} ${testSneaker.model} value has ${direction} by ${percentage}% ${reason}`;
        // Apply test effect
        const eventId = Date.now();
        activeEvents.set(eventId, {
          sneaker: `${testSneaker.brand} ${testSneaker.model}`,
          effect: effect,
          endTime: Date.now() + 300000 // 5 minutes
        });
        updateInventoryValues();
        setTimeout(() => {
          activeEvents.delete(eventId);
          updateInventoryValues();
        }, 300000);
      }

      // Clear any existing timeouts
      if (newsElement.timeout) {
        clearTimeout(newsElement.timeout);
      }

      newsElement.textContent = message;
      newsElement.style.display = 'block';
      
      // Force a reflow to restart animation
      void newsElement.offsetWidth;
      newsElement.style.animation = 'none';
      requestAnimationFrame(() => {
        newsElement.style.animation = 'slideDown 0.5s ease-out, glow 2s infinite';
      });

      newsElement.timeout = setTimeout(() => {
        newsElement.style.animation = 'none';
        newsElement.style.display = 'none';
      }, duration);
    }

    function updateInventoryValues() {
      gameState.inventory.forEach(sneaker => {
        let totalEffect = 1;
        activeEvents.forEach(event => {
          if (event.sneaker === `${sneaker.brand} ${sneaker.model}`) {
            totalEffect *= (1 + event.effect);
          }
        });
        sneaker.dynamicValue = Math.round(sneaker.baseValue * totalEffect);
      });
      updateInventory();
      updateTradeComparison(); // Update trade values if in a trade
    }

    // Start news generation immediately and run every minute
    generateNewsEvent(); // Initial news
    setInterval(generateNewsEvent, 60000); // Every minute

    // Add event listener for test button
    document.querySelector('.test-button').addEventListener('click', () => {
      console.log("Test button clicked"); // Debug log
      showBreakingNews(true);
    });

    let resellAgent = {
      level: 0, // Start at level 0
      maxLevel: 5,
      baseUpgradeCost: 500,
      bonusPerLevel: 0.2
    };

    let gameState = {
      coins: 0,
      inventory: [],
      purchaseHistory: [],
      prestigeLevel: 0,
      clickValue: 1, // 1 coin per click at base (modified by prestige)
      clicksNeeded: 2, // Number of clicks needed for 1 coin (modified by prestige)
      clickCounter: 0, // Counter for current clicks
      inventoryCapacityBonus: 0, // Additional inventory slots from prestige
      rarityMultiplier: 1, // Multiplier for rarity chances
      extraSneakerChance: 0, // Chance for extra sneaker in packs
      passiveIncomeRate: 0, // Passive income per second
      passiveIncomeInterval: null, // Interval for passive income
      autoSellCommon: false, // Auto-sell common items
      freePackChance: 0, // Chance for free packs
      legendaryBoost: 0, // Boost to legendary chances
      doubleSaleChance: 0, // Chance for double sale value
      settings: {
        soundEnabled: true,
        musicEnabled: true,
        soundVolume: 0.5,
        musicVolume: 0.3,
        notifications: true,
        animations: true,
        autoSell: false,
        currencyDisplay: 'full',
        displayMode: 'grid',
        defaultSort: 'rarity',
        rollAnimation: true,
        volume: 50,
        lightMode: false,
        skipPackAnimation: false
      },
      hiredStaff: [],
      resellAgent: {
        level: 0
      },
      storageUpgrades: 0,
      storageCost: 300
    };

    // Wrap gameState in a Proxy for autosave
    const gameStateProxy = new Proxy(gameState, {
      set(target, prop, value) {
        target[prop] = value;
        saveGameState();
        return true;
      }
    });

    // Initialize game state from save or defaults
    function initializeGame() {
      const savedState = localStorage.getItem('sneakerHustleGameState');
      if (savedState) {
        try {
          const gameState = JSON.parse(savedState);
          
          // Restore basic values
          gameStateProxy.coins = gameState.coins ?? 10000;
          gameStateProxy.inventory = gameState.inventory || [];
          gameStateProxy.purchaseHistory = gameState.purchaseHistory || [];
          
          // Restore prestige level
          gameStateProxy.prestigeLevel = gameState.prestigeLevel || 0;
          
          // Apply prestige bonuses
          applyPrestigeBonuses();
          
          // Restore settings
          if (gameState.settings) {
            gameStateProxy.settings = {...gameStateProxy.settings, ...gameState.settings};
          }
          
          // Restore market buyer
          if (gameState.currentMarketBuyer) {
            window.currentMarketBuyer = gameState.currentMarketBuyer;
          }
          
          // Restore active multipliers
          if (gameState.activeMultipliers) {
            window.globalMultiplier = gameState.activeMultipliers.global || 1;
            window.brandMultipliers = gameState.activeMultipliers.brand || {};
            window.coinMultiplier = gameState.activeMultipliers.coin || 1;
          }
          
          // Restore current trader
          if (gameState.currentTrader) {
            window.currentTrader = gameState.currentTrader;
            window.lastTraderResponse = gameState.lastTraderResponse;
          }
          
          // Restore hired staff
          if (gameState.hiredStaff) {
            gameStateProxy.hiredStaff = gameState.hiredStaff;
          }
          
          // Restore resell agent level
          if (gameState.resellAgentLevel !== undefined) {
            gameStateProxy.resellAgent.level = gameState.resellAgentLevel;
          }
          
          // Restore storage upgrades
          if (gameState.storageUpgrades !== undefined) {
            gameStateProxy.storageUpgrades = gameState.storageUpgrades;
          }
          
          // Restore storage cost
          if (gameState.storageCost !== undefined) {
            gameStateProxy.storageCost = gameState.storageCost;
          }
        } catch (error) {
          console.error('Error loading game state:', error);
          setDefaultState();
        }
      } else {
        setDefaultState();
      }
    }

    // Set default state for new games
    function setDefaultState() {
      gameStateProxy.coins = 1000;
      gameStateProxy.inventory = [];
      gameStateProxy.purchaseHistory = [];
      gameStateProxy.prestigeLevel = 0;
      gameStateProxy.clickValue = 0.5; // Default click value
      gameStateProxy.settings = {
        soundEnabled: true,
        musicEnabled: true,
        soundVolume: 0.5,
        musicVolume: 0.3,
        notifications: true,
        animations: true,
        autoSell: false,
        currencyDisplay: 'full',
        displayMode: 'grid',
        defaultSort: 'rarity',
        rollAnimation: true,
        volume: 50,
        lightMode: false,
        skipPackAnimation: false
      };
      gameStateProxy.hiredStaff = [];
      gameStateProxy.resellAgent.level = 0;
      gameStateProxy.storageUpgrades = 0;
      gameStateProxy.storageCost = 300;
      if (document.getElementById('storage-cost')) document.getElementById('storage-cost').textContent = gameStateProxy.storageCost;
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Update all UI displays
    function updateAllDisplays() {
      updateInventory();
      updateCoins();
      updatePrestige();
      updateStaffDisplay();
      updateResellAgentDisplay();
      updateStorageDisplay();
      updateSettings();
    }

    // Save game state
    function saveGameState() {
      localStorage.setItem('sneakerHustleGameState', JSON.stringify(gameState));
    }

    // Initialize when the page loads
    window.addEventListener('load', () => {
      initializeGame();
      generateNewsEvent();
    });

    // Save before unloading
    window.addEventListener('beforeunload', saveGameState);

    // --- Pack Definitions ---
    const packTypes = {
      standard: { 
        cost: 100,
        odds: {
          common: 0.5,
          uncommon: 0.3,
          rare: 0.15,
          epic: 0.04,
          legendary: 0.01
        }
      },
      premium: { 
        cost: 200,
        odds: {
          common: 0.3,
          uncommon: 0.3,
          rare: 0.2,
          epic: 0.15,
          legendary: 0.05
        }
      },
      legendary: { 
        cost: 500,
        odds: {
          common: 0.1,
          uncommon: 0.1,
          rare: 0.1,
          epic: 0.1,
          legendary: 0.5
        }
      }
    };

    function showNotification(message) {
      if (!gameStateProxy.settings.notificationsEnabled) return;
      alert(message);
    }

    function updateInventory() {
      const inventoryDiv = document.getElementById("inventory-list");
      inventoryDiv.innerHTML = '';
      if (gameStateProxy.inventory.length === 0) {
        inventoryDiv.innerHTML = "<em>No sneakers in inventory.</em>";
        return;
      }

      // Sort inventory based on settings
      const sortedInventory = [...gameStateProxy.inventory].sort((a, b) => {
        switch (gameStateProxy.settings.defaultSort) {
          case 'rarity':
            return rarities.findIndex(r => r.rarity === b.rarity) - 
                   rarities.findIndex(r => r.rarity === a.rarity);
          case 'value':
            return (b.dynamicValue || b.baseValue) - (a.dynamicValue || a.baseValue);
          case 'brand':
            return a.brand.localeCompare(b.brand);
          case 'newest':
            return gameStateProxy.inventory.indexOf(b) - gameStateProxy.inventory.indexOf(a);
          default:
            return 0;
        }
      });

      sortedInventory.forEach((sneaker, index) => {
        const sneakerDiv = document.createElement("div");
        sneakerDiv.className = "sneaker-card";
        sneakerDiv.innerHTML = `
          <img src="${sneaker.image}" alt="${sneaker.brand} ${sneaker.model}" class="sneaker-image">
          <div class="sneaker-info">
            <span class="sneaker-brand">${sneaker.brand}</span>
            <span class="sneaker-model">${sneaker.model}</span>
            <span class="sneaker-colorway">${sneaker.colorway}</span>
            <span class="sneaker-rarity rarity-${sneaker.rarity}">${sneaker.rarity.toUpperCase()}</span>
            <span class="sneaker-value">${formatCurrency(Math.floor(sneaker.dynamicValue || sneaker.baseValue))}c</span>
          </div>
          <button class="sell-button" onclick="sellSneaker(${index})">Sell</button>
        `;
        inventoryDiv.appendChild(sneakerDiv);
      });
    }

    function updateCoins() {
      const coinDisplay = document.getElementById('coin-count');
      if (coinDisplay) {
        let displayValue = gameStateProxy.coins;
        if (gameStateProxy.settings.currencyDisplay === 'k') {
          displayValue = gameStateProxy.coins >= 1000 ? (gameStateProxy.coins/1000).toFixed(1) + 'K' : gameStateProxy.coins;
        }
        coinDisplay.textContent = formatCurrency(displayValue);
      }
    }

    function formatCurrency(amount) {
      if (gameStateProxy.settings.currencyDisplay === 'k' && amount >= 1000) {
        return (amount/1000).toFixed(1) + 'K';
      } else if (gameStateProxy.settings.currencyDisplay === 'full') {
        return amount.toLocaleString();
      }
      return amount.toString();
    }

    function loadSettings() {
      const savedSettings = localStorage.getItem('gameSettings');
      if (savedSettings) {
        gameStateProxy.settings = JSON.parse(savedSettings);
        document.getElementById('auto-sell-toggle').checked = gameStateProxy.settings.autoSell;
        document.getElementById('sound-toggle').checked = gameStateProxy.settings.soundEnabled;
        document.getElementById('animation-toggle').checked = gameStateProxy.settings.animationEnabled;
        document.getElementById('notification-toggle').checked = gameStateProxy.settings.notificationsEnabled;
        document.getElementById('volume-control').value = gameStateProxy.settings.volume;
        document.getElementById('volume-value').textContent = gameStateProxy.settings.volume + '%';
        document.getElementById('display-mode').value = gameStateProxy.settings.displayMode;
        document.getElementById('currency-display').value = gameStateProxy.settings.currencyDisplay;
        document.getElementById('sort-inventory').value = gameStateProxy.settings.defaultSort;
        document.getElementById('roll-animation-toggle').checked = gameStateProxy.settings.rollAnimation;
        document.getElementById('light-mode-toggle').checked = gameStateProxy.settings.lightMode;
        document.getElementById('skip-animation-toggle').checked = gameStateProxy.settings.skipPackAnimation;
        if (gameStateProxy.settings.lightMode) {
          document.body.classList.add('light-mode');
        } else {
          document.body.classList.remove('light-mode');
        }
        if (!gameStateProxy.settings.animationEnabled) {
          document.body.classList.add('no-animations');
        }
        updateInventory();
        updateCoins();
      }
    }

    function saveSettings() {
      localStorage.setItem('gameSettings', JSON.stringify(gameStateProxy.settings));
    }

    function applySettings() {
      // Apply settings to UI and game state
      document.body.classList.toggle('light-mode', !!gameStateProxy.settings.lightMode);
      document.body.classList.toggle('no-animations', gameStateProxy.settings.animationEnabled === false);

      // Update toggles if they exist
      if (document.getElementById('animation-toggle')) {
        document.getElementById('animation-toggle').checked = !!gameStateProxy.settings.animationEnabled;
      }
      if (document.getElementById('notification-toggle')) {
        document.getElementById('notification-toggle').checked = !!gameStateProxy.settings.notificationsEnabled;
      }
      if (document.getElementById('light-mode-toggle')) {
        document.getElementById('light-mode-toggle').checked = !!gameStateProxy.settings.lightMode;
      }
      if (document.getElementById('skip-animation-toggle')) {
        document.getElementById('skip-animation-toggle').checked = !!gameStateProxy.settings.skipPackAnimation;
      }
      if (document.getElementById('display-mode')) {
        document.getElementById('display-mode').value = gameStateProxy.settings.displayMode;
      }
      if (document.getElementById('currency-display')) {
        document.getElementById('currency-display').value = gameStateProxy.settings.currencyDisplay;
      }
      if (document.getElementById('sort-inventory')) {
        document.getElementById('sort-inventory').value = gameStateProxy.settings.defaultSort;
      }
      // Update inventory and coins display
      updateInventory();
      updateCoins();
    }

    function toggleAutoSell() {
      gameStateProxy.settings.autoSell = document.getElementById('auto-sell-toggle').checked;
      saveSettings();
    }

    function toggleSound() {
      gameStateProxy.settings.soundEnabled = document.getElementById('sound-toggle').checked;
      saveSettings();
    }

    function toggleAnimation() {
      gameStateProxy.settings.animationEnabled = document.getElementById('animation-toggle').checked;
      document.body.classList.toggle('no-animations', !gameStateProxy.settings.animationEnabled);
      saveSettings();
    }

    function toggleNotifications() {
      gameStateProxy.settings.notificationsEnabled = document.getElementById('notification-toggle').checked;
      saveSettings();
    }

    function updateVolume() {
      gameStateProxy.settings.volume = document.getElementById('volume-control').value;
      document.getElementById('volume-value').textContent = gameStateProxy.settings.volume + '%';
      saveSettings();
    }

    function updateDisplayMode() {
      gameStateProxy.settings.displayMode = document.getElementById('display-mode').value;
      const inventoryList = document.getElementById('inventory-list');
      inventoryList.className = 'inventory-' + gameStateProxy.settings.displayMode;
      saveSettings();
      updateInventory();
    }

    function updateCurrencyDisplay() {
      gameStateProxy.settings.currencyDisplay = document.getElementById('currency-display').value;
      saveSettings();
      updateCoins();
      updateInventory();
    }

    function updateDefaultSort() {
      gameStateProxy.settings.defaultSort = document.getElementById('sort-inventory').value;
      saveSettings();
      updateInventory();
    }

    function toggleRollAnimation() {
      gameStateProxy.settings.rollAnimation = document.getElementById('roll-animation-toggle').checked;
      saveSettings();
    }

    function openPack() {
      const packModal = document.getElementById("pack-modal");
      if (packModal) {
        packModal.style.display = "block";
      }
    }

    function closePack() {
      const packModal = document.getElementById("pack-modal");
      if (packModal) {
        packModal.style.display = "none";
      }
    }

    function buyPack(type) {
      const pack = packTypes[type];
      let roll = Math.random();

      // Apply prestige rarity multiplier
      if (gameStateProxy.rarityMultiplier > 1) {
        // Shift the roll toward better rarities
        roll = Math.pow(roll, 1 / gameStateProxy.rarityMultiplier);
      }

      // Apply legendary boost if applicable
      let odds = {...pack.odds};
      if (gameStateProxy.legendaryBoost > 0 && odds.legendary) {
        // Increase legendary odds
        odds.legendary += gameStateProxy.legendaryBoost;
        
        // Normalize odds
        const total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          for (const rarity in odds) {
            odds[rarity] /= total;
          }
        }
      }

      // Determine rarity based on odds
      let cumulativeOdds = 0;
      let rarity = 'common';
      for (const [r, chance] of Object.entries(odds)) {
        cumulativeOdds += chance;
        if (roll < cumulativeOdds) {
          rarity = r;
          break;
        }
      }

      // Generate sneaker based on rarity
      const sneaker = generateSneaker(rarity);

      // Check for free pack chance from prestige
      let isFree = false;
      if (gameStateProxy.freePackChance > 0 && Math.random() < gameStateProxy.freePackChance) {
        isFree = true;
        showPurchaseNotification("üéÅ Free pack from prestige bonus!", "success");
      }

      // Apply prestige effect on pack cost if applicable
      if (gameStateProxy.prestigeLevel > 0) {
        pack.cost = Math.max(90, Math.floor(pack.cost * Math.pow(0.9, gameStateProxy.prestigeLevel)));
      }

      // Apply buyer staff discount
      if (type !== 'legendary' && packPriceMultiplier < 1) {
        pack.cost = Math.floor(pack.cost * packPriceMultiplier);
      }

      if (!isFree && gameStateProxy.coins < pack.cost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }

      // Only deduct coins if not a free pack
      if (!isFree) {
        gameStateProxy.coins -= pack.cost;
        updateCoins();
      }

      // Disable buttons during pack opening
      const packButtons = document.querySelectorAll('.pack-button');
      packButtons.forEach(btn => btn.disabled = true);

      // Simulate pack opening animation
      const packModal = document.getElementById("pack-modal");
      if (packModal) {
        packModal.style.display = "block";
      }
      const packContent = document.getElementById("pack-content");
      if (packContent) {
        packContent.innerHTML = '';
      }
      const sneakerDiv = document.createElement("div");
      sneakerDiv.className = "sneaker-card";
      sneakerDiv.innerHTML = `
        <img src="${sneaker.image}" alt="${sneaker.brand} ${sneaker.model}" class="sneaker-image">
        <div class="sneaker-info">
          <span class="sneaker-brand">${sneaker.brand}</span>
          <span class="sneaker-model">${sneaker.model}</span>
          <span class="sneaker-colorway">${sneaker.colorway}</span>
          <span class="sneaker-rarity rarity-${sneaker.rarity}">${sneaker.rarity.toUpperCase()}</span>
          <span class="sneaker-value">${formatCurrency(Math.floor(sneaker.baseValue))}c</span>
        </div>
      `;
      if (packContent) {
        packContent.appendChild(sneakerDiv);
      }

      // Enable buttons after animation
      setTimeout(() => {
        packButtons.forEach(btn => btn.disabled = false);
        finishPackOpening([sneaker]);
      }, 2000);
    }

    function generateSneaker(rarity) {
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sneaker Pack Tycoon</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #2c3e50; color: white; text-align: center; }
    h1 { margin-top: 20px; }
    .container { margin: 20px; }
    .coins { font-size: 24px; margin-bottom: 20px; }
    .pack-select, .pack-button { padding: 10px 20px; font-size: 18px; margin: 10px; }
    .pack-button { cursor: pointer; background-color: #2980b9; color: white; border: none; border-radius: 5px; }
    .inventory, .market, .settings, .daily, .trading { margin-top: 20px; }
    .inventory div, .market div, .trading div { background: #34495e; margin: 10px; padding: 10px; border-radius: 8px; }
    .sneaker-card { margin-bottom: 10px; }
    .rarity-common { color: #7f8c8d; }
    .rarity-rare { color: #2980b9; }
    .rarity-epic { color: #8e44ad; }
    .rarity-legendary { color: #f39c12; font-weight: bold; }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      background: #222;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
      z-index: 1000;
      pointer-events: none;
    }
    .modal.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 999;
      pointer-events: none;
    }
    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .card-container {
      margin: 20px auto;
      display: flex;
      flex-direction: row;
      align-items: center;
      position: relative;
      height: 200px;
      width: 600px;
      overflow: hidden;
      background: #222;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .casino-roll-track {
      display: flex;
      flex-direction: row;
      align-items: center;
      transition: transform 2s cubic-bezier(0.23, 1, 0.32, 1);
      will-change: transform;
      height: 100%;
    }
    .casino-roll-card {
      background-color: #34495e;
      color: white;
      padding: 20px;
      border-radius: 8px;
      width: 180px;
      height: 150px;
      margin: 0 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 1em;
      transition: box-shadow 0.2s, transform 0.2s;
      }
    .casino-roll-card.selected {
      /* No border, no color change, no highlight */
      /* Just use normal card style */
    }
    select.pack-select { background: #34495e; color: white; border: 1px solid #2980b9; border-radius: 5px; }
    .inventory-list-flex {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .sneaker-card {
      background: #34495e;
      margin: 5px;
      padding: 8px;
      border-radius: 8px;
      min-width: 100px;
      max-width: 140px;
      flex: 1 1 120px;
      font-size: 14px;
      transition: font-size 0.2s, min-width 0.2s, max-width 0.2s;
      width: calc(100% / 5 - 16px);
    }
    @media (max-width: 700px) {
      .inventory-list-flex .sneaker-card {
        width: calc(100% / 2 - 16px);
      }
    }
    @media (max-width: 500px) {
      .inventory-list-flex .sneaker-card {
        width: 100%;
      }
    }
    #trade-dropdown {
      margin: 10px 0;
      padding: 6px 12px;
      font-size: 16px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
      width: 90%;
      max-width: 300px;
    }
    .trade-offer { margin-top: 15px; }
    .close-btn { background: #c0392b; color: white; border: none; border-radius: 5px; padding: 6px 14px; cursor: pointer; margin-top: 10px;}
    .settings {
      margin-top: 20px;
      background: #34495e;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      text-align: left;
      margin-top: 15px;
    }
    .settings-item {
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
    }
    .settings-item label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .settings input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }
    .settings select {
      width: 100%;
      padding: 5px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
    }
    .volume-value {
      font-size: 14px;
      color: #bdc3c7;
    }
    .no-animations * {
      animation: none !important;
      transition: none !important;
    }
    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .inventory-list .sneaker-card { max-width: 100%; width: 100%; }
    .inventory-compact .sneaker-card { font-size: 12px; padding: 5px; }
    .top-right-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .history-btn, .settings-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: transform 0.2s, background-color 0.2s;
    }
    .history-btn:hover, .settings-btn:hover {
      background: #3498db;
      transform: scale(1.1);
    }
    .purchase-history {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .purchase-item {
      background: #2c3e50;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
    }
    .purchase-time {
      color: #7f8c8d;
      font-size: 0.9em;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
    }
    .limited-offer {
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 20px;
      border-radius: 8px;
      margin: 15px auto;
      max-width: 600px;
      position: relative;
      overflow: hidden;
    }
    .limited-offer::before {
      content: "Limited Time!";
      position: absolute;
      top: 10px;
      right: -30px;
      background: #e74c3c;
      color: white;
      padding: 5px 40px;
      transform: rotate(45deg);
      font-size: 12px;
    }
    .offer-timer {
      color: #ecf0f1;
      font-size: 1.2em;
      margin: 10px 0;
    }
    .offer-content {
      display: flex;
      align-items: center;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .offer-sneaker {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
    }
    .roll-animation {
      animation: rollEffect 1s ease-out;
    }
    @keyframes rollEffect {
      0% { transform: translateY(-100px) rotate(-180deg); opacity: 0; }
      70% { transform: translateY(20px) rotate(20deg); opacity: 0.7; }
      100% { transform: translateY(0) rotate(0deg); opacity: 1; }
    }
    .roll-container {
      position: relative;
      height: 150px;
      width: 200px;
      overflow: hidden;
      background: #2c3e50;
      border-radius: 8px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .roll-item {
      position: absolute;
      width: 180px;
      height: 130px;
      padding: 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #34495e;
      box-sizing: border-box;
      border-radius: 5px;
      transition: all 0.05s;
      opacity: 0;
      transform: scale(0.9);
      left: 50%;
      margin-left: -90px;
    }
    .roll-item.active {
      opacity: 1;
      transform: scale(1);
    }
    .roll-item.final {
      animation: popIn 0.3s ease-out forwards !important;
      opacity: 1;
    }
    @keyframes popIn {
      0% { transform: scale(0.8); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .roll-flash {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 2;
    }
    .roll-item strong {
      display: block;
      margin-bottom: 5px;
    }
    .roll-item span {
      display: block;
      margin: 2px 0;
    }
    @keyframes flashEffect {
      0% { opacity: 0; }
      50% { opacity: 0.5; }
      100% { opacity: 0; }
    }
    .trade-comparison {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 20px 0;
      gap: 20px;
    }
    .trade-side {
      flex: 1;
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      max-width: 300px;
    }
    .trade-arrow {
      font-size: 24px;
      color: #3498db;
    }
    .value-comparison {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      font-size: 0.9em;
    }
    .better-value { color: #2ecc71; }
    .worse-value { color: #e74c3c; }
    .equal-value { color: #f1c40f; }
    .trade-selection {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .selected-sneakers {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .selected-sneaker {
      background: #2c3e50;
      padding: 8px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .remove-sneaker {
      background: #c0392b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .ai-trader-info {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .ai-avatar {
      width: 50px;
      height: 50px;
      background: #34495e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .ai-details {
      flex-grow: 1;
    }
    .ai-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    .ai-preference {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .negotiation-options {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .negotiation-btn {
      background: #34495e;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .negotiation-btn:hover {
      background: #2c3e50;
    }
    .ai-response {
      margin: 10px 0;
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
      font-style: italic;
    }
    .purchase-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .resell-agent {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .agent-level {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .level-indicator {
      display: flex;
      gap: 3px;
    }
    .level-star {
      color: #f1c40f;
    }
    .agent-bonus {
      color: #2ecc71;
    }
    .staff-section {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .staff-member {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .staff-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .staff-status {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .staff-stats {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 0.9em;
    }
    .staff-cost {
      color: #f1c40f;
    }
    .agent-types {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .agent-card {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      min-width: 200px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .agent-card:hover {
      transform: translateY(-5px);
    }
    .agent-card.selected {
      border: 2px solid #3498db;
    }
    .breaking-news {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      animation: slideDown 0.5s ease-out, glow 2s infinite;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      text-align: center;
      min-width: 300px;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
      100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
    }
    .news-header {
      font-size: 1.5em;
      margin-bottom: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .news-content {
      font-size: 1.2em;
      line-height: 1.4;
      margin: 10px 0;
    }
    .news-timer {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
      width: 100%;
    }
    .news-timer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.8);
      transform-origin: left;
    }
    .news-timer.animate::after {
      animation: newsTimer 5s linear forwards;
    }
    @keyframes newsTimer {
      0% { transform: scaleX(1); }
      100% { transform: scaleX(0); }
    }
    .trader-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .trader-card {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      text-align: left;
    }
    .trader-card:hover {
      transform: translateY(-5px);
    }
    .trader-card.selected {
      border: 2px solid #3498db;
    }
    .trader-avatar {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .trader-info {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .limited-offers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .limited-offer {
      position: relative;
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .offer-timer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9em;
    }

    .staff-hire-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .staff-hire-modal.show {
      display: block;
    }
    .staff-hire-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .staff-hire-item {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .staff-hire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .staff-hire-cost {
      color: #f1c40f;
      font-weight: bold;
    }
    .test-buttons {
      position: fixed;
      left: -9999px;
      visibility: hidden;
    }
    .test-button {
      background: #8e44ad;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .test-button:hover {
      background: #9b59b6;
    }
    
    /* New styles for clicker, used market, and cleaning game */
    .clicker-button {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.1s;
      margin: 20px auto;
      display: block;
    }
    
    .clicker-button:active {
      transform: scale(0.95);
    }
    
    .used-market {
      margin: 20px 0;
    }
    
    .used-sneaker {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sneaker Pack Tycoon</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #2c3e50; color: white; text-align: center; }
    h1 { margin-top: 20px; }
    .container { margin: 20px; }
    .coins { font-size: 24px; margin-bottom: 20px; }
    .pack-select, .pack-button { padding: 10px 20px; font-size: 18px; margin: 10px; }
    .pack-button { cursor: pointer; background-color: #2980b9; color: white; border: none; border-radius: 5px; }
    .inventory, .market, .settings, .daily, .trading { margin-top: 20px; }
    .inventory div, .market div, .trading div { background: #34495e; margin: 10px; padding: 10px; border-radius: 8px; }
    .sneaker-card { margin-bottom: 10px; }
    .rarity-common { color: #7f8c8d; }
    .rarity-rare { color: #2980b9; }
    .rarity-epic { color: #8e44ad; }
    .rarity-legendary { color: #f39c12; font-weight: bold; }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      background: #222;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
      z-index: 1000;
      pointer-events: none;
    }
    .modal.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 999;
      pointer-events: none;
    }
    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .card-container {
      margin: 20px auto;
      display: flex;
      flex-direction: row;
      align-items: center;
      position: relative;
      height: 200px;
      width: 600px;
      overflow: hidden;
      background: #222;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .casino-roll-track {
      display: flex;
      flex-direction: row;
      align-items: center;
      transition: transform 2s cubic-bezier(0.23, 1, 0.32, 1);
      will-change: transform;
      height: 100%;
    }
    .casino-roll-card {
      background-color: #34495e;
      color: white;
      padding: 20px;
      border-radius: 8px;
      width: 180px;
      height: 150px;
      margin: 0 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 1em;
      transition: box-shadow 0.2s, transform 0.2s;
      }
    .casino-roll-card.selected {
      /* No border, no color change, no highlight */
      /* Just use normal card style */
    }
    select.pack-select { background: #34495e; color: white; border: 1px solid #2980b9; border-radius: 5px; }
    .inventory-list-flex {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .sneaker-card {
      background: #34495e;
      margin: 5px;
      padding: 8px;
      border-radius: 8px;
      min-width: 100px;
      max-width: 140px;
      flex: 1 1 120px;
      font-size: 14px;
      transition: font-size 0.2s, min-width 0.2s, max-width 0.2s;
      width: calc(100% / 5 - 16px);
    }
    @media (max-width: 700px) {
      .inventory-list-flex .sneaker-card {
        width: calc(100% / 2 - 16px);
      }
    }
    @media (max-width: 500px) {
      .inventory-list-flex .sneaker-card {
        width: 100%;
      }
    }
    #trade-dropdown {
      margin: 10px 0;
      padding: 6px 12px;
      font-size: 16px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
      width: 90%;
      max-width: 300px;
    }
    .trade-offer { margin-top: 15px; }
    .close-btn { background: #c0392b; color: white; border: none; border-radius: 5px; padding: 6px 14px; cursor: pointer; margin-top: 10px;}
    .settings {
      margin-top: 20px;
      background: #34495e;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      text-align: left;
      margin-top: 15px;
    }
    .settings-item {
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
    }
    .settings-item label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .settings input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }
    .settings select {
      width: 100%;
      padding: 5px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
    }
    .volume-value {
      font-size: 14px;
      color: #bdc3c7;
    }
    .no-animations * {
      animation: none !important;
      transition: none !important;
    }
    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .inventory-list .sneaker-card { max-width: 100%; width: 100%; }
    .inventory-compact .sneaker-card { font-size: 12px; padding: 5px; }
    .top-right-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .history-btn, .settings-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: transform 0.2s, background-color 0.2s;
    }
    .history-btn:hover, .settings-btn:hover {
      background: #3498db;
      transform: scale(1.1);
    }
    .purchase-history {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .purchase-item {
      background: #2c3e50;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
    }
    .purchase-time {
      color: #7f8c8d;
      font-size: 0.9em;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
    }
    .limited-offer {
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 20px;
      border-radius: 8px;
      margin: 15px auto;
      max-width: 600px;
      position: relative;
      overflow: hidden;
    }
    .limited-offer::before {
      content: "Limited Time!";
      position: absolute;
      top: 10px;
      right: -30px;
      background: #e74c3c;
      color: white;
      padding: 5px 40px;
      transform: rotate(45deg);
      font-size: 12px;
    }
    .offer-timer {
      color: #ecf0f1;
      font-size: 1.2em;
      margin: 10px 0;
    }
    .offer-content {
      display: flex;
      align-items: center;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .offer-sneaker {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
    }
    .roll-animation {
      animation: rollEffect 1s ease-out;
    }
    @keyframes rollEffect {
      0% { transform: translateY(-100px) rotate(-180deg); opacity: 0; }
      70% { transform: translateY(20px) rotate(20deg); opacity: 0.7; }
      100% { transform: translateY(0) rotate(0deg); opacity: 1; }
    }
    .roll-container {
      position: relative;
      height: 150px;
      width: 200px;
      overflow: hidden;
      background: #2c3e50;
      border-radius: 8px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .roll-item {
      position: absolute;
      width: 180px;
      height: 130px;
      padding: 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #34495e;
      box-sizing: border-box;
      border-radius: 5px;
      transition: all 0.05s;
      opacity: 0;
      transform: scale(0.9);
      left: 50%;
      margin-left: -90px;
    }
    .roll-item.active {
      opacity: 1;
      transform: scale(1);
    }
    .roll-item.final {
      animation: popIn 0.3s ease-out forwards !important;
      opacity: 1;
    }
    @keyframes popIn {
      0% { transform: scale(0.8); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .roll-flash {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 2;
    }
    .roll-item strong {
      display: block;
      margin-bottom: 5px;
    }
    .roll-item span {
      display: block;
      margin: 2px 0;
    }
    @keyframes flashEffect {
      0% { opacity: 0; }
      50% { opacity: 0.5; }
      100% { opacity: 0; }
    }
    .trade-comparison {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 20px 0;
      gap: 20px;
    }
    .trade-side {
      flex: 1;
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      max-width: 300px;
    }
    .trade-arrow {
      font-size: 24px;
      color: #3498db;
    }
    .value-comparison {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      font-size: 0.9em;
    }
    .better-value { color: #2ecc71; }
    .worse-value { color: #e74c3c; }
    .equal-value { color: #f1c40f; }
    .trade-selection {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .selected-sneakers {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .selected-sneaker {
      background: #2c3e50;
      padding: 8px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .remove-sneaker {
      background: #c0392b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .ai-trader-info {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .ai-avatar {
      width: 50px;
      height: 50px;
      background: #34495e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .ai-details {
      flex-grow: 1;
    }
    .ai-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    .ai-preference {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .negotiation-options {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .negotiation-btn {
      background: #34495e;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .negotiation-btn:hover {
      background: #2c3e50;
    }
    .ai-response {
      margin: 10px 0;
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
      font-style: italic;
    }
    .purchase-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .resell-agent {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .agent-level {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .level-indicator {
      display: flex;
      gap: 3px;
    }
    .level-star {
      color: #f1c40f;
    }
    .agent-bonus {
      color: #2ecc71;
    }
    .staff-section {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .staff-member {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .staff-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .staff-status {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .staff-stats {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 0.9em;
    }
    .staff-cost {
      color: #f1c40f;
    }
    .agent-types {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .agent-card {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      min-width: 200px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .agent-card:hover {
      transform: translateY(-5px);
    }
    .agent-card.selected {
      border: 2px solid #3498db;
    }
    .breaking-news {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      animation: slideDown 0.5s ease-out, glow 2s infinite;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      text-align: center;
      min-width: 300px;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
      100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
    }
    .news-header {
      font-size: 1.5em;
      margin-bottom: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .news-content {
      font-size: 1.2em;
      line-height: 1.4;
      margin: 10px 0;
    }
    .news-timer {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
      width: 100%;
    }
    .news-timer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.8);
      transform-origin: left;
    }
    .news-timer.animate::after {
      animation: newsTimer 5s linear forwards;
    }
    @keyframes newsTimer {
      0% { transform: scaleX(1); }
      100% { transform: scaleX(0); }
    }
    .trader-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .trader-card {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      text-align: left;
    }
    .trader-card:hover {
      transform: translateY(-5px);
    }
    .trader-card.selected {
      border: 2px solid #3498db;
    }
    .trader-avatar {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .trader-info {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .limited-offers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .limited-offer {
      position: relative;
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .offer-timer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9em;
    }

    .staff-hire-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .staff-hire-modal.show {
      display: block;
    }
    .staff-hire-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .staff-hire-item {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .staff-hire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .staff-hire-cost {
      color: #f1c40f;
      font-weight: bold;
    }
    .test-buttons {
      position: fixed;
      left: -9999px;
      visibility: hidden;
    }
    .test-button {
      background: #8e44ad;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .test-button:hover {
      background: #9b59b6;
    }
    
    /* New styles for clicker, used market, and cleaning game */
    .clicker-button {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.1s;
      margin: 20px auto;
      display: block;
    }
    
    .clicker-button:active {
      transform: scale(0.95);
    }
    
    .used-market {
      margin: 20px 0;
    }
    
    .used-sneaker {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      transition: width 0.3s;
    }
    
    .cleaning-game {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      width: 90%;
      max-width: 500px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .cleaning-game.show {
      display: block;
    }
    
    .cleaning-info {
      margin: 15px 0;
      padding: 10px;
      background: #34495e;
      border-radius: 8px;
    }
    
    .sneaker-canvas {
      background: #34495e;
      border-radius: 8px;
      margin: 10px auto;
      cursor: pointer;
      display: block;
      max-width: 100%;
      height: auto;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      width: 0;
      transition: width 0.3s;
    }
    
    #used-market-modal {
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #34495e;
      border-radius: 8px 8px 0 0;
      margin: -20px -20px 20px -20px;
    }
    
    .modal-header h2 {
      margin: 0;
      color: white;
    }
    
    .click-count {
      font-size: 18px;
      color: #3498db;
      margin: 10px 0;
    }
    
    .used-market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
      max-height: 70vh;
      overflow-y: auto;
      padding: 15px;
    }

    /* Comprehensive light mode styles */
    .light-mode {
      background-color: #f5f6fa;
      color: #2c3e50;
    }
    
    .light-mode .sneaker-card,
    .light-mode .modal,
    .light-mode .settings-item,
    .light-mode .trade-side,
    .light-mode .ai-trader-info,
    .light-mode .ai-response,
    .light-mode .selected-sneaker,
    .light-mode .purchase-item {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .light-mode .modal-overlay {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .light-mode .pack-button,
    .light-mode .negotiation-btn,
    .light-mode .close-btn {
      background-color: #3498db;
      color: white;
    }
    
    .light-mode .pack-button:hover,
    .light-mode .negotiation-btn:hover {
      background-color: #2980b9;
    }
    
    .light-mode .modal-header {
      background-color: #f8f9fa;
      color: #2c3e50;
    }
    
    .light-mode select {
      background-color: #ffffff;
      color: #2c3e50;
      border-color: #bdc3c7;
    }

    /* Fix sneaker positioning in popups */
    .card {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
    }

    .roll-item {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
      width: 180px;
      height: 130px;
    }

    /* Update animations */
    @keyframes rollAndReveal {
      0% { transform: translate(-50%, -150%) rotate(-180deg); opacity: 0; }
      70% { transform: translate(-50%, -30%) rotate(20deg); opacity: 0.7; }
      90% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
    }

    /* Rarity-specific reveal animations */
    .reveal-common {
      animation: rollAndReveal 0.8s ease-out, fadeIn 0.3s ease-out 0.8s !important;
    }
    
    .reveal-uncommon {
      animation: rollAndReveal 0.8s ease-out, glowGreen 0.3s ease-out 0.8s !important;
    }
    
    .reveal-rare {
      animation: rollAndReveal 0.8s ease-out, glowBlue 0.3s ease-out 0.8s !important;
    }
    
    .reveal-epic {
      animation: rollAndReveal 0.8s ease-out, glowPurple 0.3s ease-out 0.8s !important;
    }
    
    .reveal-legendary {
      animation: rollAndReveal 0.8s ease-out, explodeGold 0.3s ease-out 0.8s !important;
    }

    @keyframes glowGreen {
      0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(46, 204, 113, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
    }

    @keyframes glowBlue {
      0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(52, 152, 219, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
    }

    @keyframes glowPurple {
      0% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(155, 89, 182, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
    }

    @keyframes explodeGold {
      0% { transform: translate(-50%, -50%) scale(0.8); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); }
      50% { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 30px 15px rgba(241, 196, 15, 0.4); }
      100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
    }

    /* Additional light mode styles */
    .light-mode .cleaning-game {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .light-mode .cleaning-game .modal-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .light-mode .cleaning-game .modal-header h2 {
      color: #2c3e50;
    }

    .light-mode .limited-offer {
      background: linear-gradient(45deg, #3498db, #9b59b6);
      color: white;
    }

    .light-mode .offer-sneaker {
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50;
    }

    .light-mode .rarity-common { color: #7f8c8d; }
    .light-mode .rarity-uncommon { color: #27ae60; }
    .light-mode .rarity-rare { color: #2980b9; }
    .light-mode .rarity-epic { color: #8e44ad; }
    .light-mode .rarity-legendary { color: #f39c12; }

    .light-mode .better-value { color: #27ae60; }
    .light-mode .worse-value { color: #e74c3c; }
    .light-mode .equal-value { color: #f1c40f; }

    .light-mode .purchase-notification {
      background: #27ae60;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Market buyer upgrade system */
    .market-buyers-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }

    .market-buyer-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #34495e;
      border-radius: 5px;
      gap: 10px;
    }

    .market-buyer-option.active {
      background: #2ecc71;
    }

    .light-mode .market-buyer-option {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
    }

    .light-mode .market-buyer-option.active {
      background: #d4edda;
      border-color: #c3e6cb;
    }

    /* Chat area styles */
    .trade-chat { max-height: 180px; overflow-y: auto; background: #222; border-radius: 6px; padding: 8px; margin-bottom: 10px; text-align: left; }
    .trade-chat-msg { margin: 4px 0; padding: 4px 8px; border-radius: 4px; }
    .trade-chat-msg.ai-msg { background: #34495e; color: #f1c40f; }
    .trade-chat-msg.player-msg { background: #2980b9; color: #fff; text-align: right; }
    /* Trade chat: hacker font */
    .trade-chat, .trade-chat-msg { font-family: 'Fira Mono', 'Consolas', 'monospace'; letter-spacing: 0.5px; }

    /* Prestige system styles */
    .prestige-button {
      background: linear-gradient(45deg, #f39c12, #e74c3c);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .prestige-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.3);
    }
    
    .prestige-button:disabled {
      background: linear-gradient(45deg, #95a5a6, #7f8c8d);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .prestige-info {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    
    .prestige-level {
      font-size: 24px;
      color: #f39c12;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .prestige-bonus {
      font-size: 16px;
      color: #3498db;
      margin: 5px 0;
    }
    
    .prestige-progress {
      background: #2c3e50;
      height: 20px;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .prestige-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #f39c12);
      width: 0%;
      transition: width 0.5s;
    }
    
    .prestige-modal {
      text-align: center;
    }
    
    .prestige-benefits {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }
    
    .prestige-modal h3 {
      color: #f39c12;
      margin: 10px 0;
    }
    
    .prestige-confirm-btn {
      background: #e74c3c;
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
    }
    
    .prestige-stars {
      font-size: 28px;
      color: #f39c12;
      letter-spacing: 5px;
      margin: 10px 0;
    }

    .prestige-milestone {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .prestige-milestone.achieved {
      background: rgba(46, 204, 113, 0.2);
    }
    
    .prestige-milestone.next {
      background: rgba(52, 152, 219, 0.2);
      border: 1px dashed #3498db;
    }
    
    .milestone-level {
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    
    .milestone-emoji {
      font-size: 20px;
      min-width: 30px;
      text-align: center;
    }
    
    .prestige-milestone-summary {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }

    /* Save code system styles */
    .save-code-container {
      margin: 15px 0;
      text-align: center;
    }
    
    .save-code-textarea {
      width: 90%;
      height: 80px;
      background: #2c3e50;
      border: 1px solid #34495e;
      border-radius: 5px;
      color: #ecf0f1;
      padding: 10px;
      margin: 10px 0;
      font-family: monospace;
      resize: none;
    }
    
    .save-code-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    .save-code-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
    }
    
    .save-code-btn:hover {
      background: #3498db;
    }
    
    .save-code-info {
      font-size: 0.9em;
      color: #95a5a6;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div id="breaking-news" class="breaking-news"></div>
  <div class="modal-overlay" id="modal-overlay" onclick="closeAllModals()"></div>
  <div class="top-right-buttons">
    <button class="history-btn" onclick="openHistory()" title="Purchase History">üìú</button>
    <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
  </div>
  <header>
    <h1>Sneaker Pack Tycoon</h1>
    <div class="coins">Coins: <span id="coin-count">0</span></div>
  </header>
  <div class="container">
    <button class="clicker-button" onclick="handleClick()">
      Click!
      <div class="click-count">Clicks: 0</div>
    </button>
    <div class="prestige-info">
      <div class="prestige-level">Prestige Level: <span id="prestige-level">0</span></div>
      <div class="prestige-bonus" id="prestige-bonuses"></div>
      <div class="prestige-progress">
        <div class="prestige-progress-fill" id="prestige-progress-fill"></div>
      </div>
      <button class="prestige-button" id="prestige-button" onclick="openPrestigeModal()">PRESTIGE</button>
    </div>
    <div>
      <select id="pack-type" class="pack-select">
        <option value="standard">Standard Pack (100 Coins)</option>
        <option value="premium">Premium Pack (300 Coins)</option>
        <option value="colorway">Colorway Pack (200 Coins)</option>
        <option value="rare">Rare Pack (400 Coins)</option>
        <option value="epic">Epic Pack (700 Coins)</option>
        <option value="legendary">Legendary Pack (2500 Coins)</option>
        <option value="mystery">Mystery Pack (500 Coins)</option>
        <option value="ultra">Ultra Pack (1200 Coins)</option>
        <option value="hype">Hype Pack (900 Coins)</option>
        <option value="classic">Classic Pack (250 Coins)</option>
        <option value="collab">Collab Pack (1500 Coins)</option>
        <option value="seasonal">Seasonal Pack (600 Coins)</option>
      </select>
      <button class="pack-button" onclick="openPack()">Open Pack</button>
      <button class="pack-button" style="margin-left:8px;" onclick="previewPack()">Pack Preview</button>
    </div>
    <div class="daily">
      <h2>Daily Rewards</h2>
      <button class="pack-button" onclick="claimDaily()">Claim Daily Coins</button>
    </div>
    <div class="upgrades">
      <h2>Store Upgrades</h2>
      <button class="pack-button" onclick="openUsedMarket()">Browse Used Sneakers</button>
      <div class="resell-agent">
        <h3>Resell Agents</h3>
        <div class="agent-types" id="agent-types">
          <!-- Agent types will be inserted here -->
        </div>
        <div class="agent-level">
          Level: <div class="level-indicator" id="agent-level"></div>
        </div>
        <div class="agent-bonus" id="agent-bonus"></div>
        <button class="pack-button" id="upgrade-agent-btn" onclick="upgradeResellAgent()">Upgrade Agent</button>
      </div>
      <div class="staff-section">
        <h3>Automated Staff</h3>
        <button class="pack-button" onclick="openHireStaff()">Hire Staff</button>
        <div class="staff-grid" id="staff-grid">
          <!-- Staff members will be inserted here -->
        </div>
      </div>
    </div>
    <div class="inventory">
      <h2>Your Inventory</h2>
      <div id="inventory-list" class="inventory-list-flex"></div>
    </div>
    <div class="trading">
      <h2>AI Trading System (Sneaker-for-Sneaker)</h2>
      <button class="pack-button" onclick="openTradeUI()">Enter Trade</button>
    </div>
  <div class="modal" id="used-market-modal">
    <div class="modal-header">
      <h2>Used Sneaker Market</h2>
      <button class="close-btn" onclick="closeUsedMarket()">Close</button>
    </div>
    <div class="used-market-grid" id="used-market-grid">
      <!-- Used sneakers will be inserted here -->
    </div>
  </div>
  <div class="cleaning-game" id="cleaning-game">
    <div class="modal-header">
      <h2>Clean Your New Sneaker</h2>
      <button class="close-btn" onclick="finishCleaning()">‚úï</button>
    </div>
    <div class="cleaning-info">
      <p>Click on the dirt spots to clean them!</p>
      <div class="condition-bar">
        <div class="condition-fill" id="cleaning-progress"></div>
      </div>
    </div>
    <canvas id="sneaker-canvas" class="sneaker-canvas" width="400" height="300"></canvas>
    <button class="pack-button" onclick="finishCleaning()">Finish Cleaning</button>
  </div>
  <div class="modal" id="pack-modal">
    <div id="modal-content">
      <h2>Opening Pack...</h2>
      <div id="card-container" class="card-container"></div>
      <button id="next-sneaker-btn" onclick="revealNextSneaker()">Next Sneaker</button>
    </div>
  </div>
  <div class="modal" id="trade-modal">
    <div>
      <h2>Select Trader</h2>
      <div class="trader-selection" id="trader-selection">
        <!-- Trader cards will be inserted here -->
      </div>
      <div id="ai-trader" class="ai-trader-info" style="display: none;">
        <!-- AI trader info will be inserted here -->
      </div>
      <div class="trade-selection">
        <div><b>Select sneakers to offer:</b></div>
      <select id="trade-dropdown"></select>
        <button class="pack-button" onclick="addToTrade()">Add to Trade</button>
        <div id="selected-sneakers" class="selected-sneakers"></div>
      </div>
      <div class="trade-comparison">
        <div class="trade-side" id="your-offer">
          <h3>Your Offer</h3>
          <div class="offer-details"></div>
        </div>
        <div class="trade-arrow">‚ÜîÔ∏è</div>
        <div class="trade-side" id="ai-offer">
          <h3>AI's Offer</h3>
          <div class="offer-details"></div>
        </div>
      </div>
      <div id="ai-response" class="ai-response"></div>
      <div class="negotiation-options" id="negotiation-options"></div>
      <div id="trade-offer" class="trade-offer"></div>
      <div id="trade-chat" class="trade-chat"></div>
      <button class="close-btn" onclick="closeTradeUI()">Close</button>
    </div>
  </div>
  <div class="modal" id="settings-modal">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="close-btn" onclick="closeSettings()">Close</button>
    </div>
    <div class="settings-grid">
      <div class="settings-item">
        <label>
          <input type="checkbox" id="animation-toggle" onclick="toggleAnimation()">
          Show Animations
        </label>
      </div>
      <div class="settings-item">
        <label>
          <input type="checkbox" id="notification-toggle" onclick="toggleNotifications()">
          Show Notifications
        </label>
      </div>
      <div class="settings-item">
        <label for="display-mode">Display Mode</label>
        <select id="display-mode" onchange="updateDisplayMode()">
          <option value="grid">Grid View</option>
          <option value="list">List View</option>
          <option value="compact">Compact View</option>
        </select>
      </div>
      <div class="settings-item">
        <label for="currency-display">Currency Display</label>
        <select id="currency-display" onchange="updateCurrencyDisplay()">
          <option value="coins">Coins</option>
          <option value="k">K Format (1K, 2K)</option>
          <option value="full">Full Number</option>
        </select>
      </div>
      <div class="settings-item">
        <label for="sort-inventory">Default Sort</label>
        <select id="sort-inventory" onchange="updateDefaultSort()">
          <option value="rarity">By Rarity</option>
          <option value="value">By Value</option>
          <option value="brand">By Brand</option>
          <option value="newest">Newest First</option>
        </select>
      </div>
      <div class="settings-item">
        <label>
          <input type="checkbox" id="light-mode-toggle" onclick="toggleLightMode()">
          Light Mode
        </label>
      </div>
      <div class="settings-item">
        <label><input type="checkbox" id="skip-animation-toggle" onclick="toggleSkipAnimation()"> Skip Pack Animation</label>
      </div>
    </div>
    
    <div class="save-code-container">
      <!-- Save import/export removed -->
    </div>
  </div>
  <div class="modal" id="history-modal">
    <div class="modal-header">
      <h2>Purchase History</h2>
      <button class="close-btn" onclick="closeHistory()">Close</button>
    </div>
    <div class="purchase-history" id="purchase-history">
      <!-- Purchase history items will be added here -->
    </div>
  </div>
  <div class="staff-hire-modal" id="staff-hire-modal">
    <div class="modal-header">
      <h2>Hire Staff</h2>
      <button class="close-btn" onclick="closeHireStaff()">Close</button>
    </div>
    <div class="staff-hire-list" id="staff-hire-list">
      <!-- Staff hire options will be inserted here -->
    </div>
  </div>
  <div class="test-buttons">
    <button class="test-button" onclick="showBreakingNews(true)">Test Breaking News</button>
  </div>
  <div class="modal" id="prestige-modal">
    <div class="modal-header">
      <h2>Prestige System</h2>
      <button class="close-btn" onclick="closePrestigeModal()">Close</button>
    </div>
    <div class="prestige-modal">
      <div class="prestige-stars" id="prestige-stars">‚òÖ</div>
      <p>You've reached <span id="prestige-coins-display">100,000</span> coins!</p>
      <p>Are you ready to prestige and reset your progress for permanent bonuses?</p>
      
      <div class="prestige-benefits">
        <h3>Benefits of Prestige Level <span id="next-prestige-level">1</span>:</h3>
        <ul id="prestige-benefits-list">
          <li>Reduced base pack costs (90 coins)</li>
          <li>Increased click value (1 coin per click)</li>
          <li>Keep your prestige bonuses forever</li>
        </ul>
      </div>
      
      <h3>Prestige Milestones:</h3>
      <div id="prestige-milestones">
        <!-- Milestone list will be added here -->
      </div>
      
      <p><strong>Warning:</strong> You will lose all your coins, inventory items, and staff!</p>
      
      <button class="pack-button prestige-confirm-btn" onclick="confirmPrestige()">PRESTIGE NOW</button>
    </div>
  </div>
  <script>
    // Initialize game state
    let coins = 0;
    let inventory = [];
    let purchaseHistory = [];
    let prestigeLevel = 0;
    let clickValue = 1; // 1 coin per click at base (modified by prestige)
    let clicksNeeded = 2; // Number of clicks needed for 1 coin (modified by prestige)
    let clickCounter = 0; // Counter for current clicks
    let inventoryCapacityBonus = 0; // Additional inventory slots from prestige
    let rarityMultiplier = 1; // Multiplier for rarity chances
    let extraSneakerChance = 0; // Chance for extra sneaker in packs
    let passiveIncomeRate = 0; // Passive income per second
    let passiveIncomeInterval = null; // Interval for passive income
    let autoSellCommon = false; // Auto-sell common items
    let freePackChance = 0; // Chance for free packs
    let legendaryBoost = 0; // Boost to legendary chances
    let doubleSaleChance = 0; // Chance for double sale value
    let settings = {
      soundEnabled: true,
      musicEnabled: true,
      soundVolume: 0.5,
      musicVolume: 0.3,
      notifications: true,
      animations: true,
      autoSell: false,
      currencyDisplay: 'full',
      displayMode: 'grid',
      defaultSort: 'rarity',
      rollAnimation: true,
      volume: 50,
      lightMode: false,
      skipPackAnimation: false
    };

    // Initialize game state from save or defaults
    function initializeGame() {
      const savedState = localStorage.getItem('sneakerHustleGameState');
      
      if (savedState) {
        try {
          const gameState = JSON.parse(savedState);
          
          // Restore basic values
          coins = gameState.coins ?? 10000;
          inventory = gameState.inventory || [];
          purchaseHistory = gameState.purchaseHistory || [];
          
          // Restore prestige level
          prestigeLevel = gameState.prestigeLevel || 0;
          
          // Apply prestige bonuses
          applyPrestigeBonuses();
          
          // Restore settings
          if (gameState.settings) {
            settings = {...settings, ...gameState.settings};
          }
          
          // Restore market buyer
          if (gameState.currentMarketBuyer) {
            currentMarketBuyer = gameState.currentMarketBuyer;
          }
          
          // Restore limited offers
          if (gameState.limitedOffers) {
            limitedOffers = new Map(gameState.limitedOffers);
        }
          
          // Restore multipliers
          if (gameState.activeMultipliers) {
            window.globalMultiplier = gameState.activeMultipliers.global;
            window.brandMultipliers = gameState.activeMultipliers.brand;
            window.coinMultiplier = gameState.activeMultipliers.coin;
          }
          
          // Restore trader state
          if (gameState.currentTrader) {
            window.currentTrader = gameState.currentTrader;
            window.lastTraderResponse = gameState.lastTraderResponse;
          }
          if (gameState.hiredStaff) {
            hiredStaff = gameState.hiredStaff;
          }
          if (gameState.resellAgentLevel !== undefined) {
            resellAgent.level = gameState.resellAgentLevel;
          }
          if (gameState.storageUpgrades !== undefined) {
            storageUpgrades = gameState.storageUpgrades;
          }
          if (gameState.storageCost !== undefined) {
            storageCost = gameState.storageCost;
          }
        } catch (error) {
          console.error('Error loading game state:', error);
          setDefaultState();
        }
        } else {
        setDefaultState();
      }
      
      // Update all UI elements
      updateAllDisplays();
      updateStorageDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Set default state for new games
    function setDefaultState() {
      coins = 1000;
      inventory = [];
      purchaseHistory = [];
      prestigeLevel = 0;
      clickValue = 0.5; // Default click value
      settings = {
        soundEnabled: true,
        musicEnabled: true,
        soundVolume: 0.5,
        musicVolume: 0.3,
        notifications: true,
        animations: true,
        autoSell: false,
        currencyDisplay: 'full',
        displayMode: 'grid',
        defaultSort: 'rarity',
        rollAnimation: true,
        volume: 50,
        lightMode: false,
        skipPackAnimation: false
      };
      hiredStaff = [];
      resellAgent.level = 0;
      storageUpgrades = 0;
      storageCost = 300;
      if (document.getElementById('storage-cost')) document.getElementById('storage-cost').textContent = storageCost;
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Update all UI displays
    function updateAllDisplays() {
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      updateLimitedOffers();
      updateMarketBuyerDisplay();
      updatePrestigeDisplay();
      applySettings();
    }

    // Save game state
    function saveGameState() {
      const gameState = {
        coins,
        inventory,
        purchaseHistory,
        settings,
        currentMarketBuyer,
        limitedOffers: Array.from(limitedOffers.entries()),
        activeMultipliers: {
          global: window.globalMultiplier || 1,
          brand: window.brandMultipliers || {},
          coin: window.coinMultiplier || 1
        },
        currentTrader: window.currentTrader,
        lastTraderResponse: window.lastTraderResponse,
        hiredStaff,
        resellAgentLevel: resellAgent.level,
        storageUpgrades,
        storageCost,
        prestigeLevel
      };
      
      localStorage.setItem('sneakerHustleGameState', JSON.stringify(gameState));
    }

    // Initialize when the page loads
    window.addEventListener('load', () => {
      initializeGame();
      generateNewsEvent();
      
      // Set up auto-save
      setInterval(saveGameState, 300000); // Every 5 minutes
    });

    // Save before unloading
    window.addEventListener('beforeunload', saveGameState);

    // Initialize game variables
    let upgrades = { betterOdds: false, storageExpand: false };
    let totalProfit = 0;
    let currentSneakers = [];
    let currentSneakerIndex = 0;
    let currentOffer = null;
    let offerInterval = null;
    let selectedTradeItems = [];
    let activeEvents = new Map();
    let clickCount = 0;
    let currentCleaningSneaker = null;
    let dirtSpots = [];
    let cleaningInProgress = false;

    // News Events Data
    const newsEvents = [
      {
        type: "celebrity",
        templates: [
          "{celebrity} spotted wearing {sneaker}! Prices {direction}!",
          "Breaking: {celebrity} signs deal with {sneaker} brand!",
          "{celebrity}'s {sneaker} collection causing market frenzy!"
        ],
        valueEffect: [0.2, 0.5], // 20-50% increase
        duration: 300000 // 5 minutes
      },
      {
        type: "market",
        templates: [
          "Market Alert: {sneaker} prices {direction} rapidly!",
          "Unexpected demand surge for {sneaker}!",
          "Rare {sneaker} batch discovered! Market adjusting!"
        ],
        valueEffect: [-0.3, 0.3], // -30% to +30%
        duration: 600000 // 10 minutes
      },
      {
        type: "trend",
        templates: [
          "TikTok trend featuring {sneaker} goes viral!",
          "Fashion influencers can't get enough of {sneaker}!",
          "Street style: {sneaker} becomes must-have item!"
        ],
        valueEffect: [0.1, 0.4], // 10-40% increase
        duration: 450000 // 7.5 minutes
      }
    ];

    // Add more celebrities and events
    const celebrities = [
      // Musicians
      "Drake", "Travis Scott", "Kanye West", "Bad Bunny", "The Weeknd",
      "Taylor Swift", "Billie Eilish", "Post Malone", "J Balvin", "BTS",
      "Rihanna", "Jay-Z", "Eminem", "Lil Baby", "Tyler, The Creator",
      
      // Athletes
      "LeBron James", "Cristiano Ronaldo", "Lionel Messi", "Kevin Durant",
      "Stephen Curry", "Neymar Jr", "Kylian Mbapp√©", "Giannis Antetokounmpo",
      "Zion Williamson", "Ja Morant", "Erling Haaland", "Luka Donƒçiƒá",
      
      // Entertainers
      "Zendaya", "Tom Holland", "Michael B. Jordan", "Ryan Reynolds",
      "Donald Glover", "Kevin Hart", "Margot Robbie", "Timoth√©e Chalamet",
      
      // Fashion/Social
      "Kylie Jenner", "Bella Hadid", "A$AP Rocky", "Virgil Abloh",
      "Kim Kardashian", "Kendall Jenner", "Pharrell Williams", "Jerry Lorenzo"
    ];

    // Special Events with Coin Multipliers
    const specialEvents = [
      {
        type: "market_surge",
        templates: [
          "üåü MARKET SURGE: All sales give {multiplier}x coins for {duration} minutes!",
          "üí´ GOLDEN HOUR: {multiplier}x coins from all transactions for {duration} minutes!",
          "üéØ HOT MARKET: Earn {multiplier}x coins from sales for {duration} minutes!"
        ],
        rarity: 0.05, // 5% chance
        multipliers: [2, 3, 5, 10],
        durations: [2, 3, 5] // minutes
      },
      {
        type: "lucky_find",
        templates: [
          "üçÄ LUCKY FIND: Next pack has {multiplier}x better odds!",
          "‚ú® BLESSED PACK: Your next opening has {multiplier}x rarity chance!",
          "üé≤ FORTUNE FAVORS: {multiplier}x rarity boost on your next pack!"
        ],
        rarity: 0.08, // 8% chance
        multipliers: [2, 3, 5]
      },
      {
        type: "market_crash",
        templates: [
          "üìâ MARKET CRASH: All sneakers {direction} in value by {percentage}%!",
          "üí• ECONOMIC SHOCK: Global sneaker values {direction} {percentage}%!",
          "üå™ MARKET CHAOS: Sudden {percentage}% {direction} in all values!"
        ],
        rarity: 0.03, // 3% chance
        effects: [-0.5, -0.3, 0.3, 0.5]
      }
    ];

    // Card reveal effects based on rarity
    const cardEffects = {
      common: {
        animation: "fade",
        color: "#7f8c8d",
        sound: "whoosh"
      },
      rare: {
        animation: "flip",
        color: "#2980b9",
        particles: "sparkle"
      },
      epic: {
        animation: "spin",
        color: "#8e44ad",
        particles: "burst"
      },
      legendary: {
        animation: "explosion",
        color: "#f39c12",
        particles: "fireworks"
      }
    };

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function finishPackOpening() {
      inventory.push(...currentSneakers);
      updateInventory();
      
      // Close the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.remove('show');
      modalOverlay.classList.remove('show');
      
      // Reset state
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      currentSneakerIndex = 0;
      currentSneakers = [];
      
      // Re-enable all buttons
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = false;
      });
      saveGameState();
    }

    // --- 100+ Sneaker Database ---
    const brands = [
      "Nike", "Adidas", "Jordan", "Puma", "Reebok", "New Balance", "Asics", 
      "Converse", "Vans", "Saucony", "Under Armour", "Yeezy", "Off-White",
      "Balenciaga", "Gucci", "Louis Vuitton", "Alexander McQueen", "Dior"
    ];
    
    const models = [
      // Nike Models
      "Air Max 90", "Dunk Low", "Air Force 1", "SB Dunk", "Air Max 95", 
      "Air Max 97", "Air Max 1", "Air Jordan 1", "Air Jordan 4", "Air Jordan 11",
      "Air Presto", "React Element", "Blazer Mid", "Cortez", "Waffle One",
      
      // Adidas Models
      "Yeezy Boost 350", "Superstar", "Ultra Boost", "NMD R1", "Forum Low",
      "Stan Smith", "Samba", "ZX 750", "Ozweego", "Campus",
      
      // Jordan Models
      "Retro 1", "Retro 3", "Retro 4", "Retro 5", "Retro 6",
      "Retro 11", "Retro 12", "Retro 13", "Legacy 312", "XXXV",
      
      // Luxury Models
      "Triple S", "Speed Trainer", "Rhyton", "Ace", "Run Away",
      "B23 High", "Chain Reaction", "Oversized", "Wave", "Track",
      
      // Classic Models
      "Chuck Taylor", "Old Skool", "Sk8-Hi", "Era", "Authentic",
      "Club C 85", "Classic Leather", "Workout Plus", "550", "992",
      
      // Running/Athletic
      "Gel Lyte III", "Kayano 5", "Jazz Original", "Triumph", "HOVR",
      "Fresh Foam", "Kinvara", "Endorphin", "Zoom Fly", "Pegasus"
    ];
    
    const colorways = [
      // Basic Colors
      "White/Black", "Black/White", "Triple Black", "Triple White", "Navy/White",
      "Red/White", "Green/White", "Blue/White", "Grey/White", "Cream/White",
      
      // Popular Nicknames
      "Bred", "Chicago", "Royal", "Shadow", "Mocha",
      "University Blue", "Volt", "Infrared", "Cement", "Pine Green",
      
      // Special Editions
      "Travis Scott", "Off-White", "Fragment", "Union LA", "A Ma Maniere",
      "Sean Wotherspoon", "Virgil Abloh", "Sacai", "Cactus Jack", "Fear of God",
      
      // Patterns
      "Zebra", "Tiger Stripe", "Safari Print", "Snake Skin", "Tie Dye",
      "Splatter", "Gradient", "Camo", "Animal Print", "Paisley",
      
      // Materials
      "Patent Leather", "Suede", "Canvas", "Mesh", "Knit",
      "Premium Leather", "Nubuck", "Corduroy", "Denim", "Velvet",
      
      // Seasonal
      "Summer Pack", "Winter Camo", "Fall Tones", "Spring Pastels", "Holiday",
      "Valentine's Day", "Halloween", "Christmas", "Easter", "New Year",
      
      // Collaborations
      "Supreme", "Undefeated", "Concepts", "Atmos", "Patta",
      "Stussy", "Diamond Supply", "Kith", "Bodega", "SNS",
      
      // Limited Editions
      "Friends & Family", "Sample", "Prototype", "Region Exclusive", "Store Exclusive",
      "Anniversary", "Retro+", "OG", "Vintage", "Player Exclusive"
    ];

    const rarities = [
      { rarity: "common", weight: 60, value: [20, 50] },
      { rarity: "rare", weight: 25, value: [60, 150] },
      { rarity: "epic", weight: 12, value: [200, 400] },
      { rarity: "legendary", weight: 3, value: [500, 2000] }
    ];

    // Instead of generating a fixed database, generate a random sneaker on demand
    function getRandomSneaker(rarity) {
      const brand = brands[Math.floor(Math.random() * brands.length)];
      const model = models[Math.floor(Math.random() * models.length)];
      const colorway = colorways[Math.floor(Math.random() * colorways.length)];
      let baseValue = 50;
      for (let r of rarities) {
        if (r.rarity === rarity) {
          baseValue = Math.floor(r.value[0] + Math.random() * (r.value[1] - r.value[0]));
          break;
        }
      }
      return {
        id: Date.now() + Math.random(),
        brand,
        model,
        colorway,
        rarity,
        baseValue,
        image: `https://robohash.org/${encodeURIComponent(brand + '-' + model + '-' + colorway)}.png?set=set4`
      };
    }

    // --- Pack Definitions ---
    const packTypes = {
      standard: { 
        cost: 100,
        odds: { common: 0.75, rare: 0.20, epic: 0.04, legendary: 0.01 },
        bg: '#222'
      },
      premium: { 
        cost: 300,
        odds: { common: 0.45, rare: 0.35, epic: 0.15, legendary: 0.05 },
        bg: '#2980b9'
      },
      colorway: { 
        cost: 200,
        odds: { common: 0.55, rare: 0.30, epic: 0.12, legendary: 0.03 }, 
        colorway: true,
        bg: '#8e44ad'
      },
      rare: { 
        cost: 400,
        odds: { rare: 0.70, epic: 0.25, legendary: 0.05 },
        bg: '#16a085'
      },
      epic: { 
        cost: 700,
        odds: { rare: 0.25, epic: 0.60, legendary: 0.15 },
        bg: '#8e44ad'
      },
      legendary: { 
        cost: 2500,
        odds: { epic: 0.70, legendary: 0.10 },
        bg: '#f39c12'
      },
      mystery: { 
        cost: 500,
        odds: { common: 0.25, rare: 0.35, epic: 0.30, legendary: 0.10 },
        bg: '#34495e'
      },
      ultra: { 
        cost: 1200,
        odds: { rare: 0.10, epic: 0.60, legendary: 0.30 },
        bg: '#e74c3c'
      },
      hype: { 
        cost: 900,
        odds: { common: 0.10, rare: 0.30, epic: 0.40, legendary: 0.20 },
        bg: '#27ae60'
      },
      classic: { 
        cost: 250,
        odds: { common: 0.60, rare: 0.30, epic: 0.08, legendary: 0.02 },
        bg: '#bdc3c7'
      },
      collab: { 
        cost: 1500,
        odds: { rare: 0.20, epic: 0.40, legendary: 0.40 },
        colorway: true,
        bg: '#9b59b6'
      },
      seasonal: { 
        cost: 600,
        odds: { common: 0.30, rare: 0.40, epic: 0.25, legendary: 0.05 },
        bg: '#f1c40f'
      }
    };

    function showNotification(message) {
      if (!settings.notificationsEnabled) return;
      alert(message);
    }

    function updateInventory() {
      const inventoryDiv = document.getElementById("inventory-list");
      inventoryDiv.innerHTML = '';
      if (inventory.length === 0) {
        inventoryDiv.innerHTML = "<em>No sneakers in inventory.</em>";
        return;
      }

      // Sort inventory based on settings
      const sortedInventory = [...inventory].sort((a, b) => {
        switch (settings.defaultSort) {
          case 'rarity':
            return rarities.findIndex(r => r.rarity === b.rarity) - 
                   rarities.findIndex(r => r.rarity === a.rarity);
          case 'value':
            return (b.dynamicValue || b.baseValue) - (a.dynamicValue || a.baseValue);
          case 'brand':
            return a.brand.localeCompare(b.brand);
          case 'newest':
            return inventory.indexOf(b) - inventory.indexOf(a);
          default:
            return 0;
        }
      });

      sortedInventory.forEach((sneaker, index) => {
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) 
          ? sneaker.dynamicValue 
          : sneaker.baseValue;
        
        const event = activeEvents.get(sneaker.id);
        const valueChangeClass = event ? 
          (event.effect > 0 ? 'value-increase' : 'value-decrease') : '';

        inventoryDiv.innerHTML += `
          <div class="sneaker-card" data-sneaker-id="${sneaker.id}">
            <img src="${sneaker.image}" alt="${sneaker.brand} ${sneaker.model}" style="width:80px;height:80px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
            <strong>${sneaker.brand} ${sneaker.model}</strong>
            <span>${sneaker.colorway}</span>
            <span class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</span><br>
            <span class="sneaker-value ${valueChangeClass}">
              Value: ${formatCurrency(Math.floor(value))} coins
            </span>
            <br><button onclick="sellSneakerById('${sneaker.id}')" style="margin-top:8px;padding:5px 10px;">Sell</button>
          </div>
        `;
      });

      // Update trade dropdown if it exists
      if (document.getElementById("trade-dropdown")) {
        renderTradeDropdown();
      }
    }
    function updateCoins() {
      const coinDisplay = document.getElementById('coin-count');
      if (coinDisplay) {
        let displayValue = coins;
        if (settings.currencyDisplay === 'k') {
          displayValue = coins >= 1000 ? (coins/1000).toFixed(1) + 'K' : coins;
        }
        coinDisplay.textContent = formatCurrency(displayValue);
      }
    }

    function formatCurrency(amount) {
      if (settings.currencyDisplay === 'k' && amount >= 1000) {
        return (amount/1000).toFixed(1) + 'K';
      } else if (settings.currencyDisplay === 'full') {
        return amount.toLocaleString();
      }
      return amount.toString();
    }

    function loadSettings() {
      const savedSettings = localStorage.getItem('gameSettings');
      if (savedSettings) {
        settings = JSON.parse(savedSettings);
        document.getElementById('auto-sell-toggle').checked = settings.autoSell;
        document.getElementById('sound-toggle').checked = settings.soundEnabled;
        document.getElementById('animation-toggle').checked = settings.animationEnabled;
        document.getElementById('notification-toggle').checked = settings.notificationsEnabled;
        document.getElementById('volume-control').value = settings.volume;
        document.getElementById('volume-value').textContent = settings.volume + '%';
        document.getElementById('display-mode').value = settings.displayMode;
        document.getElementById('currency-display').value = settings.currencyDisplay;
        document.getElementById('sort-inventory').value = settings.defaultSort;
        document.getElementById('roll-animation-toggle').checked = settings.rollAnimation;
        document.getElementById('light-mode-toggle').checked = settings.lightMode;
        document.getElementById('skip-animation-toggle').checked = settings.skipPackAnimation;
        if (settings.lightMode) {
          document.body.classList.add('light-mode');
        } else {
          document.body.classList.remove('light-mode');
        }
        if (!settings.animationEnabled) {
          document.body.classList.add('no-animations');
        }
        updateInventory();
        updateCoins();
      }
    }

    function saveSettings() {
      localStorage.setItem('gameSettings', JSON.stringify(settings));
    }

    function applySettings() {
      // Apply settings to UI and game state
      document.body.classList.toggle('light-mode', !!settings.lightMode);
      document.body.classList.toggle('no-animations', settings.animationEnabled === false);

      // Update toggles if they exist
      if (document.getElementById('animation-toggle')) {
        document.getElementById('animation-toggle').checked = !!settings.animationEnabled;
      }
      if (document.getElementById('notification-toggle')) {
        document.getElementById('notification-toggle').checked = !!settings.notificationsEnabled;
      }
      if (document.getElementById('light-mode-toggle')) {
        document.getElementById('light-mode-toggle').checked = !!settings.lightMode;
      }
      if (document.getElementById('skip-animation-toggle')) {
        document.getElementById('skip-animation-toggle').checked = !!settings.skipPackAnimation;
      }
      if (document.getElementById('display-mode')) {
        document.getElementById('display-mode').value = settings.displayMode;
      }
      if (document.getElementById('currency-display')) {
        document.getElementById('currency-display').value = settings.currencyDisplay;
      }
      if (document.getElementById('sort-inventory')) {
        document.getElementById('sort-inventory').value = settings.defaultSort;
      }
      // Update inventory and coins display
      updateInventory();
      updateCoins();
    }

    function toggleAutoSell() {
      settings.autoSell = document.getElementById('auto-sell-toggle').checked;
      saveSettings();
    }

    function toggleSound() {
      settings.soundEnabled = document.getElementById('sound-toggle').checked;
      saveSettings();
    }

    function toggleAnimation() {
      settings.animationEnabled = document.getElementById('animation-toggle').checked;
      document.body.classList.toggle('no-animations', !settings.animationEnabled);
      saveSettings();
    }

    function toggleNotifications() {
      settings.notificationsEnabled = document.getElementById('notification-toggle').checked;
      saveSettings();
    }

    function updateVolume() {
      settings.volume = document.getElementById('volume-control').value;
      document.getElementById('volume-value').textContent = settings.volume + '%';
      saveSettings();
    }

    function updateDisplayMode() {
      settings.displayMode = document.getElementById('display-mode').value;
      const inventoryList = document.getElementById('inventory-list');
      inventoryList.className = 'inventory-' + settings.displayMode;
      saveSettings();
      updateInventory();
    }

    function updateCurrencyDisplay() {
      settings.currencyDisplay = document.getElementById('currency-display').value;
      saveSettings();
      updateCoins();
      updateInventory();
    }

    function updateDefaultSort() {
      settings.defaultSort = document.getElementById('sort-inventory').value;
      saveSettings();
      updateInventory();
    }

    function toggleRollAnimation() {
      settings.rollAnimation = document.getElementById('roll-animation-toggle').checked;
      saveSettings();
    }

    function openPack() {
      const type = document.getElementById("pack-type").value;
      let pack = {...packTypes[type]};
      
      // --- Always apply staff bonuses before opening pack ---
      applyStaffBonuses();
      
      // Check for free pack chance from prestige
      let isFree = false;
      if (freePackChance > 0 && Math.random() < freePackChance) {
        isFree = true;
        showPurchaseNotification("üéÅ Free pack from prestige bonus!", "success");
      }
      
      // Apply prestige effect on pack cost if applicable
      if (prestigeLevel > 0) {
        pack.cost = Math.max(90, Math.floor(pack.cost * Math.pow(0.9, prestigeLevel)));
      }
      
      // Apply buyer staff discount
      if (type !== 'legendary' && packPriceMultiplier < 1) {
        pack.cost = Math.floor(pack.cost * packPriceMultiplier);
      }
      
      if (!isFree && coins < pack.cost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      
      // Only deduct coins if not a free pack
      if (!isFree) {
        coins -= pack.cost;
        updateCoins();
      }

      // Disable buttons during pack opening
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = true;
      });

      // Show the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.add('show');
      modalOverlay.classList.add('show');

      // Generate sneakers
      currentSneakers = [];
      
      // Determine how many sneakers - check for extra sneaker chance
      let sneakerCount = 3;
      if (extraSneakerChance > 0 && Math.random() < extraSneakerChance) {
        sneakerCount = 4;
        showPurchaseNotification("üéÅ Extra sneaker from prestige bonus!", "success");
      }
      
      for (let i = 0; i < sneakerCount; i++) {
        let sneaker = rollSneaker(type);
        currentSneakers.push(sneaker);
      }

      // Record the purchase
      addPurchaseToHistory('Pack Opening', isFree ? 0 : pack.cost, currentSneakers);
      
      // Reset state and start reveal
      currentSneakerIndex = 0;
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      revealNextSneaker();

      // Apply authenticator staff bonus to odds
      let odds = {...pack.odds};
      if (rarityBonus > 0) {
        if (odds.rare) odds.rare += rarityBonus;
        if (odds.epic) odds.epic += rarityBonus;
        if (odds.legendary) odds.legendary += rarityBonus;
        // Normalize odds if they exceed 1
        let total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      saveGameState();
    }

    // Patch rollSneaker to use getRandomSneaker and allow all brands
    function rollSneaker(type) {
      // --- Always apply staff bonuses before rolling sneaker ---
      applyStaffBonuses();
      const pack = packTypes[type];
      let roll = Math.random();
      
      // Apply prestige rarity multiplier
      if (rarityMultiplier > 1) {
        // Shift the roll toward better rarities
        roll = Math.pow(roll, 1 / rarityMultiplier);
      }
      
      // Apply legendary boost if applicable
      let odds = {...pack.odds};
      if (legendaryBoost > 0 && odds.legendary) {
        // Increase legendary odds
        odds.legendary += legendaryBoost;
        
        // Normalize odds
        const total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      
      if (upgrades.betterOdds) roll += 0.05;
      // --- Apply authenticator staff bonus to odds ---
      if (rarityBonus > 0) {
        if (odds.rare) odds.rare += rarityBonus;
        if (odds.epic) odds.epic += rarityBonus;
        if (odds.legendary) odds.legendary += rarityBonus;
        // Normalize odds if they exceed 1
        let total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      let rarity = "common";
      let sum = 0;
      for (let key of ["common", "rare", "epic", "legendary"]) {
        if (odds[key]) {
          sum += odds[key];
          if (roll < sum) {
            rarity = key;
            break;
          }
        }
      }
      // If colorway pack, just use random colorway
      return getRandomSneaker(rarity);
    }

    function createRollItem(sneaker) {
      return `
        <strong>${sneaker.brand} ${sneaker.model}</strong>
        <span>${sneaker.colorway}</span>
        <span class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</span>
      `;
    }

    function sellSneaker(index) {
      if (index < 0 || index >= inventory.length) return;
      
      let sneaker = inventory[index];
      let value = sneaker.baseValue;
      
      // Apply any active event effects
      activeEvents.forEach(event => {
        if (event.sneaker === `${sneaker.brand} ${sneaker.model}`) {
          value *= (1 + event.effect);
        }
      });
      
      // Apply resell agent bonus
      const bonus = 1 + (resellAgent.level * resellAgent.bonusPerLevel);
      value = Math.floor(value * bonus);
      
      // Apply double sale chance from prestige
      let isDoubleSale = false;
      if (doubleSaleChance > 0 && Math.random() < doubleSaleChance) {
        value *= 2;
        isDoubleSale = true;
      }
      
      coins += value;
      inventory.splice(index, 1); // Remove the sneaker from inventory
      updateCoins();
      updateInventory();
      
      // Show different notification based on if it was a double sale
      if (isDoubleSale) {
        showPurchaseNotification(`üí∞ DOUBLE SALE! Sold ${sneaker.brand} ${sneaker.model} for ${formatCurrency(value)} coins!`);
      } else {
        showPurchaseNotification(`Sold ${sneaker.brand} ${sneaker.model} for ${formatCurrency(value)} coins!`);
      }
      saveGameState();
    }

    function claimDaily() {
      const lastClaim = localStorage.getItem('dailyReward');
      const now = Date.now();
      if (!lastClaim || now - lastClaim > 86400000) {
        coins += 300;
        localStorage.setItem('dailyReward', now);
        updateCoins();
        showNotification("Daily reward claimed!");
      } else {
        showNotification("Already claimed today!");
      }
      saveGameState();
    }

    function buyUpgrade(type) {
      if (type === 'storageExpand') {
        if (storageUpgrades >= 10) {
          showPurchaseNotification('Maximum storage reached!', 'error');
          return;
        }
        if (coins >= storageCost) {
          coins -= storageCost;
          storageUpgrades++;
          storageCost = Math.floor(storageCost * 1.5); // 50% increase each time
          document.getElementById('storage-cost').textContent = storageCost;
          showPurchaseNotification('Storage expanded!');
          updateCoins();
        } else {
          showPurchaseNotification('Not enough coins!', 'error');
        }
      }
      saveGameState();
    }

    // --- TRADE UI ---
    let aiTradeOffer = [];

    // AI Trader System
    const aiTraders = [
      { name: "Sneaker Steve", emoji: "üëü", preferences: ["Nike", "Jordan", "Yeezy", "Adidas", "SB Dunk", "Ultra Boost"], style: "hype", valuePreference: "high", traits: ["Loves limited editions", "Prefers hyped releases"] },
      { name: "Vintage Vicky", emoji: "üë†", preferences: ["Converse", "Vans", "Chuck Taylor", "Old Skool", "Classic Leather", "Retro+"], style: "classic", valuePreference: "low", traits: ["Collects retro models", "Values original colorways"] },
      { name: "Luxury Larry", emoji: "üíé", preferences: ["Balenciaga", "Gucci", "Louis Vuitton", "Dior", "legendary", "epic"], style: "luxury", valuePreference: "ultra", traits: ["Only wants premium items", "Focuses on rare finds"] },
      { name: "Budget Bob", emoji: "üí∞", preferences: ["common", "rare", "Puma", "Reebok", "Saucony", "Under Armour"], style: "budget", valuePreference: "low", traits: ["Looks for deals", "Prefers common models"] },
      { name: "Collector Charlie", emoji: "üèÜ", preferences: ["rare", "epic", "550", "992", "Sample", "OG"], style: "collector", valuePreference: "medium", traits: ["Completes sets", "Values condition"] },
      { name: "Reseller Rachel", emoji: "üìà", preferences: ["Jordan", "Yeezy", "SB Dunk", "Ultra Boost", "Forum Low"], style: "hype", valuePreference: "high", traits: ["Watches market trends", "Knows resale values"] },
      { name: "Designer Dan", emoji: "‚ú®", preferences: ["Off-White", "Travis Scott", "Fragment", "Union LA", "limited", "colorway"], style: "luxury", valuePreference: "high", traits: ["Loves unique designs", "Prefers collaborations"] },
      { name: "Athletic Amy", emoji: "üèÉ‚Äç‚ôÄÔ∏è", preferences: ["Nike", "Asics", "Gel Lyte III", "Kayano 5", "Zoom Fly", "Pegasus"], style: "classic", valuePreference: "medium", traits: ["Values performance", "Likes durability"] },
      { name: "Trendy Tom", emoji: "üåü", preferences: ["New Balance", "Adidas", "Fresh Foam", "Stan Smith", "Campus", "Samba"], style: "hype", valuePreference: "medium", traits: ["Follows social media", "Loves new releases"] },
      { name: "Casual Casey", emoji: "üòä", preferences: ["Vans", "Converse", "Era", "Authentic", "Club C 85", "Workout Plus"], style: "budget", valuePreference: "low", traits: ["Practical choices", "Daily wear focus"] }
    ];

    const aiPersonalities = [
      "Always looking for the best deal",
      "Loves rare colorways",
      "Interested in limited editions only",
      "Collects specific brands",
      "Values condition over brand",
      "Prefers matching sets",
      "Focuses on resale value",
      "Interested in vintage models",
      "Loves exclusive releases",
      "Only trades for premium items"
    ];

    let currentTrader = null;

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function generateRandomTrader() {
      const baseTrader = aiTraders[Math.floor(Math.random() * aiTraders.length)];
      const personality = aiPersonalities[Math.floor(Math.random() * aiPersonalities.length)];
      
      // Add some randomization to preferences
      const randomBrands = [...brands].sort(() => Math.random() - 0.5).slice(0, 2);
      const randomRarities = ["common", "rare", "epic", "legendary"].sort(() => Math.random() - 0.5).slice(0, 2);
      
      return {
        ...baseTrader,
        personality,
        additionalPreferences: {
          brands: randomBrands,
          rarities: randomRarities,
          minValue: Math.floor(Math.random() * 300) + 100,
          maxValue: Math.floor(Math.random() * 1000) + 500,
          prefersSets: Math.random() > 0.5,
          prefersColorways: Math.random() > 0.5
        }
      };
    }

    function updateAITraderDisplay() {
      const traderDiv = document.getElementById('ai-trader');
      if (!traderDiv) return;

      const styleDisplay = currentTrader.style.charAt(0).toUpperCase() + currentTrader.style.slice(1);
      const valueDisplay = currentTrader.valuePreference.charAt(0).toUpperCase() + currentTrader.valuePreference.slice(1);
      
      traderDiv.innerHTML = `
        <div class="ai-avatar">${currentTrader.emoji}</div>
        <div class="ai-details">
          <div class="ai-name">${currentTrader.name}</div>
          <div class="ai-preference">Style: ${styleDisplay}</div>
          <div class="ai-preference">Value: ${valueDisplay}</div>
          <div class="ai-preference">Prefers: ${currentTrader.preferences.join(', ')}</div>
          <div class="ai-preference">Traits: ${currentTrader.traits.join(', ')}</div>
        </div>
      `;
    }

    function openTradeUI() {
      selectedTradeItems = [];
      aiTradeOffer = [];
      currentTrader = null;
      
      const tradeModal = document.getElementById("trade-modal");
      const overlay = document.getElementById("modal-overlay");
      const aiTrader = document.getElementById("ai-trader");
      const traderSelection = document.getElementById("trader-selection");
      
      tradeModal.classList.add("show");
      overlay.classList.add("show");
      
      aiTrader.style.display = "none";
      traderSelection.style.display = "block";
      
      document.getElementById("selected-sneakers").innerHTML = "";
      document.getElementById("trade-offer").innerHTML = "";
      document.querySelector('#your-offer .offer-details').innerHTML = "";
      document.querySelector('#ai-offer .offer-details').innerHTML = "";
      document.getElementById('trade-chat').innerHTML = '';
      
      renderTraderSelection();
    }

    function closeTradeUI() {
      document.getElementById("trade-modal").classList.remove("show");
    }

    function renderTraderSelection() {
      const container = document.getElementById("trader-selection");
      container.innerHTML = aiTraders.map(trader => `
        <div class="trader-card" onclick="selectTrader('${trader.name}')">
          <div class="trader-avatar">${trader.emoji}</div>
          <div class="trader-name">${trader.name}</div>
          <div class="trader-info">
            <div>Style: ${trader.style.charAt(0).toUpperCase() + trader.style.slice(1)}</div>
            <div>Prefers: ${trader.preferences.join(', ')}</div>
            <div>Value: ${trader.valuePreference.charAt(0).toUpperCase() + trader.valuePreference.slice(1)}</div>
          </div>
        </div>
      `).join('');
    }

    function selectTrader(name) {
      currentTrader = aiTraders.find(t => t.name === name);
      if (!currentTrader) return;

      document.getElementById("trader-selection").style.display = "none";
      document.getElementById("ai-trader").style.display = "block";
      updateAITraderDisplay();
      renderTradeDropdown();
    }

    function renderTradeDropdown() {
      const dropdown = document.getElementById("trade-dropdown");
      dropdown.innerHTML = "";
      if (inventory.length === 0) {
        dropdown.innerHTML = "<option>No sneakers to trade</option>";
        dropdown.disabled = true;
        return;
      }
      dropdown.disabled = false;
      
      // Only show sneakers that aren't already selected
      const availableSneakers = inventory.filter((_, idx) => !selectedTradeItems.includes(idx));
      
      if (availableSneakers.length === 0) {
        dropdown.innerHTML = "<option>No more sneakers available</option>";
        dropdown.disabled = true;
        return;
      }

      availableSneakers.forEach((sneaker, idx) => {
        const originalIndex = inventory.indexOf(sneaker);
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) ? 
          sneaker.dynamicValue : sneaker.baseValue;
        let text = `${sneaker.brand} ${sneaker.model} (${sneaker.colorway}) [${sneaker.rarity.toUpperCase()}] - ${formatCurrency(Math.floor(value))}c`;
        let option = document.createElement("option");
        option.value = originalIndex;
        option.textContent = text;
        dropdown.appendChild(option);
      });
    }

    function addToTrade() {
      const dropdown = document.getElementById("trade-dropdown");
      const selectedIndex = parseInt(dropdown.value);
      
      if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= inventory.length) {
        showPurchaseNotification("Invalid selection!", "error");
        return;
      }

      if (selectedTradeItems.includes(selectedIndex)) {
        showPurchaseNotification("This sneaker is already in the trade!", "error");
        return;
      }

      selectedTradeItems.push(selectedIndex);
      updateSelectedSneakers();
      renderTradeDropdown();
        generateAITradeOffer();
      appendTradeChatMessage('player', `Let me see... You're offering ${selectedTradeItems.map(index => inventory[index].brand+' '+inventory[index].model).join(', ')}. Here's what I think...`);
    }

    function updateSelectedSneakers() {
      const container = document.getElementById("selected-sneakers");
      if (!container) return;

      container.innerHTML = selectedTradeItems.map(index => {
        if (index < 0 || index >= inventory.length) return '';
        
        const sneaker = inventory[index];
        return `
          <div class="selected-sneaker">
            <span>${sneaker.brand} ${sneaker.model} [${sneaker.rarity.toUpperCase()}]</span>
            <button class="remove-sneaker" onclick="removeFromTrade(${index})">√ó</button>
          </div>
        `;
      }).join('');

      updateTradeComparison();
    }

    function removeFromTrade(index) {
      selectedTradeItems = selectedTradeItems.filter(i => i !== index);
      updateSelectedSneakers();
      renderTradeDropdown();
      generateAITradeOffer();
    }

    function updateTradeComparison() {
      if (selectedTradeItems.length === 0) {
        document.querySelector('#your-offer .offer-details').innerHTML = "<em>Select sneakers to trade</em>";
        document.querySelector('#ai-offer .offer-details').innerHTML = "";
        return;
      }

      const yourSneakers = selectedTradeItems.map(index => inventory[index]);
      const yourTotalValue = yourSneakers.reduce((sum, s) => {
        const value = (typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue;
        return sum + value;
      }, 0);

      const aiTotalValue = aiTradeOffer.reduce((sum, s) => {
        const value = (typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue;
        return sum + value;
      }, 0);

      const valueDiff = aiTotalValue - yourTotalValue;
      let valueClass = 'equal-value';
      if (valueDiff > 50) valueClass = 'better-value';
      if (valueDiff < -50) valueClass = 'worse-value';

      document.querySelector('#your-offer .offer-details').innerHTML = `
        ${yourSneakers.map(s => `
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class="rarity-${s.rarity}">[${s.rarity.toUpperCase()}]</span><br>
        `).join('<br>')}
        <div class="value-comparison">Total Value: ${formatCurrency(Math.floor(yourTotalValue))} coins</div>
      `;

      document.querySelector('#ai-offer .offer-details').innerHTML = `
        ${aiTradeOffer.map(s => `
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class="rarity-${s.rarity}">[${s.rarity.toUpperCase()}]</span><br>
        `).join('<br>')}
        <div class="value-comparison ${valueClass}">
          Total Value: ${formatCurrency(Math.floor(aiTotalValue))} coins
          ${valueDiff !== 0 ? `(${valueDiff > 0 ? '+' : ''}${formatCurrency(Math.floor(valueDiff))})` : ''}
        </div>
      `;
    }

    function generateAITradeOffer(adjustment = 1.0) {
      if (!currentTrader || selectedTradeItems.length === 0) {
        updateTradeComparison();
        return;
      }

      const yourSneakers = selectedTradeItems.map(index => inventory[index]);
      const yourTotalValue = yourSneakers.reduce((sum, s) => {
        return sum + ((typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue);
      }, 0);

      // Calculate preference score for the offered sneakers
      let preferenceBonus = 0;
      yourSneakers.forEach(sneaker => {
        // Brand preference check
        if (currentTrader.preferences.some(pref => 
          sneaker.brand.includes(pref) || 
          sneaker.model.includes(pref)
        )) {
          preferenceBonus += 0.15; // 15% bonus per preferred brand/model
        }
        
        // Rarity preference check
        if (currentTrader.preferences.some(pref => 
          sneaker.rarity.toLowerCase() === pref.toLowerCase()
        )) {
          preferenceBonus += 0.2; // 20% bonus for preferred rarity
        }
        
        // Style match check
        if ((currentTrader.style === 'hype' && (sneaker.rarity === 'legendary' || sneaker.rarity === 'epic')) ||
            (currentTrader.style === 'budget' && (sneaker.rarity === 'common' || sneaker.rarity === 'rare')) ||
            (currentTrader.style === 'luxury' && sneaker.rarity === 'legendary') ||
            (currentTrader.style === 'classic' && (sneaker.brand === 'Nike' || sneaker.brand === 'Jordan' || sneaker.brand === 'Converse'))) {
          preferenceBonus += 0.1; // 10% bonus for style match
        }
      });

      // Calculate target value based on trader preferences
      let targetTotalValue = yourTotalValue * adjustment;
      
      // Apply preference bonus
      targetTotalValue *= (1 + preferenceBonus);
      
      // Apply trader value preference
      switch(currentTrader.valuePreference) {
        case 'low':
          targetTotalValue *= 0.8;
          break;
        case 'medium':
          targetTotalValue *= 1.0;
          break;
        case 'high':
          targetTotalValue *= 1.2;
          break;
        case 'ultra':
          targetTotalValue *= 1.5;
          break;
      }
      
      // Check for specific negotiation messages in the chat
      const chatMsgs = document.querySelectorAll('.trade-chat-msg.player-msg');
      let chatBonus = 0;
      
      chatMsgs.forEach(msgElement => {
        const msgText = msgElement.textContent.toLowerCase();
        
        // Negotiations that improve the offer
        if (msgText.includes('rare') || msgText.includes('legendary') || msgText.includes('limited')) {
          if (currentTrader.style === 'hype' || currentTrader.style === 'luxury') {
            chatBonus += 0.05;
          }
        }
        
        if (msgText.includes('classic') || msgText.includes('vintage') || msgText.includes('retro')) {
          if (currentTrader.style === 'classic') {
            chatBonus += 0.07;
          }
        }
        
        if (msgText.includes('deal') || msgText.includes('fair')) {
          chatBonus += 0.03;
        }
        
        // Negotiations that may reduce the offer
        if (msgText.includes('cheap') || msgText.includes('low')) {
          if (currentTrader.style === 'luxury') {
            chatBonus -= 0.1;
          } else if (currentTrader.style === 'budget') {
            chatBonus += 0.05;
          }
        }
      });
      
      // Apply chat negotiation bonus
      targetTotalValue *= (1 + chatBonus);

      // Generate AI offer
      aiTradeOffer = [];
      
      // Create a pool of preferred sneakers that match trader's style and preferences
      const preferredSneakers = sneakersDatabase.filter(s => {
        // Check brand & model preferences
        const matchesPreference = currentTrader.preferences.some(pref => 
          s.brand.includes(pref) || 
          s.model.includes(pref) ||
          s.rarity.toLowerCase() === pref.toLowerCase()
        );
        
        // Style matching
        const matchesStyle = (
          (currentTrader.style === 'hype' && (s.rarity === 'legendary' || s.rarity === 'epic')) ||
          (currentTrader.style === 'budget' && (s.rarity === 'common' || s.rarity === 'rare')) ||
          (currentTrader.style === 'luxury' && s.rarity === 'legendary') ||
          (currentTrader.style === 'classic' && (s.brand === 'Nike' || s.brand === 'Jordan' || s.brand === 'Converse'))
        );
        
        return matchesPreference || matchesStyle;
      });
      
      // Sort the preferred sneakers by how well they match the trader's preferences
      preferredSneakers.sort((a, b) => {
        const scoreA = getPreferenceScore(a);
        const scoreB = getPreferenceScore(b);
        return scoreB - scoreA;  // Higher score first
      });

      // Try to offer preferred sneakers first (heavily favoring preferences)
      while (aiTradeOffer.length < 3 && preferredSneakers.length > 0 && targetTotalValue > 0) {
        // Take sneakers from the front of the sorted array (highest preference)
        const sneaker = preferredSneakers.shift();
        
        if (sneaker.baseValue <= targetTotalValue * 1.5) { // Allow slightly higher values for preferred items
          aiTradeOffer.push({...sneaker, id: Date.now() + Math.random()});
          targetTotalValue -= sneaker.baseValue;
        }
      }

      // Fill remaining slots with affordable sneakers that somewhat match preferences
      if (aiTradeOffer.length < 3 && targetTotalValue > 0) {
        const remainingSneakers = sneakersDatabase.filter(s => 
          !aiTradeOffer.some(offered => 
            offered.brand === s.brand && offered.model === s.model && offered.rarity === s.rarity
          ) && s.baseValue <= targetTotalValue
        );
        
        // Sort by preference but to a lesser degree
        remainingSneakers.sort((a, b) => {
          const scoreA = getPreferenceScore(a) / 2; // Lower weight on preference
          const scoreB = getPreferenceScore(b) / 2;
          return scoreB - scoreA;
        });
        
        // Add remaining sneakers
        for (let i = 0; i < remainingSneakers.length && aiTradeOffer.length < 3 && targetTotalValue > 0; i++) {
          const sneaker = remainingSneakers[i];
          if (sneaker.baseValue <= targetTotalValue) {
            aiTradeOffer.push({...sneaker, id: Date.now() + Math.random()});
            targetTotalValue -= sneaker.baseValue;
          }
        }
      }
      
      // If we still don't have 3 items, add some lower value items
      if (aiTradeOffer.length < 3) {
        const budgetSneakers = sneakersDatabase.filter(s => 
          !aiTradeOffer.some(offered => 
            offered.brand === s.brand && offered.model === s.model && offered.rarity === s.rarity
          ) && s.rarity === 'common'
        ).sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < budgetSneakers.length && aiTradeOffer.length < 3; i++) {
          aiTradeOffer.push({...budgetSneakers[i], id: Date.now() + Math.random()});
        }
      }

      updateTradeComparison();
      updateNegotiationOptions();
      
      // Add accept trade button if there's an offer
      const tradeOffer = document.getElementById("trade-offer");
      if (tradeOffer) {
        if (aiTradeOffer.length > 0) {
          tradeOffer.innerHTML = '<button class="pack-button" onclick="acceptTrade()">Accept Trade</button>';
        } else {
          tradeOffer.innerHTML = '<em>No suitable trade found</em>';
        }
      }
    }

    function getPreferenceScore(sneaker) {
      if (!currentTrader) return 0;
      
      let score = 0;
      
      // Brand & model preference
      currentTrader.preferences.forEach(pref => {
        if (sneaker.brand.includes(pref) || sneaker.model.includes(pref)) {
          score += 3;
        }
      });
      
      // Rarity preference
      currentTrader.preferences.forEach(pref => {
        if (sneaker.rarity.toLowerCase() === pref.toLowerCase()) {
          score += 2;
        }
      });
      
      // Style match
      if (currentTrader.style === 'hype' && (sneaker.rarity === 'legendary' || sneaker.rarity === 'epic')) {
        score += 3;
      } else if (currentTrader.style === 'budget' && (sneaker.rarity === 'common' || sneaker.rarity === 'rare')) {
        score += 3;
      } else if (currentTrader.style === 'luxury' && sneaker.rarity === 'legendary') {
        score += 4;
      } else if (currentTrader.style === 'classic' && 
                (sneaker.brand === 'Nike' || sneaker.brand === 'Jordan' || sneaker.brand === 'Converse')) {
        score += 3;
      }
      
      return score;
    }

    function acceptTrade() {
      if (!currentTrader || selectedTradeItems.length === 0 || aiTradeOffer.length === 0) {
        showPurchaseNotification("Invalid trade!", "error");
        return;
      }

      // Remove traded sneakers from inventory (in reverse order to maintain correct indices)
      const tradedIndices = [...selectedTradeItems].sort((a, b) => b - a);
      tradedIndices.forEach(index => {
        if (index >= 0 && index < inventory.length) {
          inventory.splice(index, 1);
        }
      });

      // Add AI's sneakers to inventory with unique IDs
      aiTradeOffer.forEach(s => {
        const newSneaker = {
          ...s,
          id: Date.now() + Math.random(),
          dynamicValue: s.baseValue
        };
        inventory.push(newSneaker);
      });

      updateInventory();
      showPurchaseNotification("Trade completed successfully!");
      
      // Reset trade state
      selectedTradeItems = [];
      aiTradeOffer = [];
      currentTrader = null;
      
      // Close trade modal
      closeTradeUI();
      appendTradeChatMessage('ai', 'Deal! Pleasure trading with you.');
    }

    // Load purchase history from localStorage
    function loadPurchaseHistory() {
      const savedHistory = localStorage.getItem('purchaseHistory');
      if (savedHistory) {
        purchaseHistory = JSON.parse(savedHistory);
      }
    }

    // Save purchase history to localStorage
    function savePurchaseHistory() {
      saveGameState();
    }

    // Add purchase to history
    function addPurchaseToHistory(type, cost, items) {
      const purchase = {
        type: type,
        cost: cost,
        items: items,
        timestamp: new Date().toISOString()
      };
      purchaseHistory.unshift(purchase);
      if (purchaseHistory.length > 50) { // Keep only last 50 purchases
        purchaseHistory.pop();
      }
      savePurchaseHistory();
      updatePurchaseHistory();
    }

    // Update purchase history display
    function updatePurchaseHistory() {
      const historyDiv = document.getElementById('purchase-history');
      historyDiv.innerHTML = '';
      
      purchaseHistory.forEach(purchase => {
        const date = new Date(purchase.timestamp);
        const formattedDate = date.toLocaleString();
        const itemsList = purchase.items.map(item => 
          `${item.brand} ${item.model} (${item.rarity})`
        ).join(', ');
        
        historyDiv.innerHTML += `
          <div class="purchase-item">
            <div><strong>${purchase.type}</strong> - ${formatCurrency(purchase.cost)} coins</div>
            <div>Items: ${itemsList}</div>
            <div class="purchase-time">${formattedDate}</div>
          </div>
        `;
      });
    }

    function openHistory() {
      document.getElementById('history-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
      updatePurchaseHistory();
    }

    function closeHistory() {
      document.getElementById('history-modal').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
    }

    function openSettings() {
      document.getElementById('settings-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
    }

    function closeAllModals() {
      const modals = ['history-modal', 'settings-modal', 'pack-modal', 'trade-modal'];
      modals.forEach(modalId => {
        document.getElementById(modalId).classList.remove('show');
      });
      document.getElementById('modal-overlay').classList.remove('show');
    }

    // Add event listener for escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeAllModals();
      }
    });

    function generateLimitedOffers() {
      const maxOffers = 3;
      limitedOffers.clear();
      let offerBonus = 1;
      // Apply networker staff bonus
      const networker = hiredStaff.find(s => s.id === 'networker');
      if (networker) {
        offerBonus -= networker.baseBonus + (networker.level - 1) * networker.bonusPerLevel;
      }
      while (limitedOffers.size < maxOffers) {
        const sneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        if (!limitedOffers.has(sneaker.id)) {
          const duration = 300000 + Math.random() * 300000;
          const discount = (0.6 + Math.random() * 0.2) * offerBonus;
          limitedOffers.set(sneaker.id, {
            sneaker,
            discountedPrice: Math.floor(sneaker.baseValue * discount),
            endTime: Date.now() + duration,
            startTime: Date.now()
          });
        }
      }
      updateLimitedOffers();
    }

    function updateLimitedOffers() {
      const container = document.getElementById('limited-offers');
      if (!container) return;
      
      container.innerHTML = '';
      const now = Date.now();
      let needsNewOffers = false;

      limitedOffers.forEach((offer, id) => {
        const timeLeft = offer.endTime - now;
        if (timeLeft <= 0) {
          limitedOffers.delete(id);
          needsNewOffers = true;
          return;
        }

        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        const savings = offer.sneaker.baseValue - offer.discountedPrice;

        container.innerHTML += `
          <div class="limited-offer">
            <div class="offer-timer">${timeString}</div>
            <div class="offer-sneaker">
              <img src="${offer.sneaker.image}" alt="${offer.sneaker.brand} ${offer.sneaker.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
              <strong>${offer.sneaker.brand} ${offer.sneaker.model}</strong>
              <div>${offer.sneaker.colorway}</div>
              <div class="rarity-${offer.sneaker.rarity}">[${offer.sneaker.rarity.toUpperCase()}]</div>
              <div style="margin: 10px 0;">
                <span style="text-decoration: line-through;">${formatCurrency(offer.sneaker.baseValue)} coins</span>
                <br>
                <strong style="color: #2ecc71; font-size: 1.2em;">
                  ${formatCurrency(offer.discountedPrice)} coins
                </strong>
                <br>
                <span style="color: #e74c3c;">Save ${formatCurrency(savings)} coins!</span>
              </div>
              <button class="pack-button" onclick="purchaseOffer('${id}')">Purchase</button>
            </div>
        </div>
      `;
      });

      if (needsNewOffers || limitedOffers.size < 3) {
        generateLimitedOffers();
      }
    }

    // Update limited offers every second
    setInterval(updateLimitedOffers, 1000);

    // Generate news events every minute
    setInterval(generateNewsEvent, 60000);

    // Initialize on load
    window.addEventListener('load', () => {
      loadSettings();
      loadPurchaseHistory();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      
      // Start news event generation immediately
      generateNewsEvent();

      // Add unique IDs to existing inventory
      inventory.forEach(s => {
        if (!s.id) s.id = Date.now() + Math.random();
      });
    });

    function purchaseOffer(id) {
      const offer = limitedOffers.get(id);
      if (!offer) {
        showNotification("This offer has expired!");
        return;
      }

      if (coins < offer.discountedPrice) {
        showNotification("Not enough coins!");
        return;
      }

      coins -= offer.discountedPrice;
      inventory.push({
        ...offer.sneaker,
        dynamicValue: offer.sneaker.baseValue
      });

      limitedOffers.delete(id);
      updateLimitedOffers();
      updateCoins();
      updateInventory();
      showPurchaseNotification("Limited offer purchased successfully!");
      saveGameState();
    }

    function showPurchaseNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = 'purchase-notification';
      notification.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
        <span>${message}</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    function updateResellAgentDisplay() {
      const levelDiv = document.getElementById('agent-level');
      const bonusDiv = document.getElementById('agent-bonus');
      const upgradeBtn = document.getElementById('upgrade-agent-btn');
      
      if (levelDiv) {
        levelDiv.innerHTML = Array(resellAgent.level)
          .fill('‚≠ê')
          .concat(Array(resellAgent.maxLevel - resellAgent.level).fill('‚òÜ'))
          .join('');
      }
      
      if (bonusDiv) {
        const bonus = (resellAgent.level * resellAgent.bonusPerLevel * 100).toFixed(0);
        bonusDiv.textContent = `Current Bonus: +${bonus}% sale value`;
      }
      
      if (upgradeBtn) {
        if (resellAgent.level >= resellAgent.maxLevel) {
          upgradeBtn.textContent = 'Max Level Reached!';
          upgradeBtn.disabled = true;
        } else {
          const nextCost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
          upgradeBtn.textContent = `Upgrade Agent (${formatCurrency(nextCost)} coins)`;
          upgradeBtn.disabled = false;
        }
      }
    }

    function updateMarketBuyerDisplay() {
      // Dummy function: Market Buyer UI not implemented yet
    }

    // Negotiation messages based on trader personality
    const negotiationOptions = {
      standard: [
        "How about we adjust the trade a bit?",
        "Can you add something more?",
        "I'm interested, but the value seems off",
        "This is a good start, but...",
      ],
      counter: [
        "Let me offer something different",
        "What if we modified the trade?",
        "I can adjust my offer",
        "Perhaps we can find middle ground"
      ]
    };

    function updateNegotiationOptions(showCounter = true) {
      const container = document.getElementById('negotiation-options');
      container.innerHTML = '';
      
      if (showCounter) {
        negotiationOptions.standard.forEach(msg => {
          const btn = document.createElement('button');
          btn.className = 'negotiation-btn';
          btn.textContent = msg;
          btn.onclick = () => negotiate(msg);
          container.appendChild(btn);
        });
      }
    }

    function negotiate(message) {
      const response = document.getElementById('ai-response');
      if (!currentTrader || !response) return;

      const yourValue = selectedTradeItems.reduce((sum, idx) => {
        const sneaker = inventory[idx];
        return sum + (sneaker.dynamicValue || sneaker.baseValue);
      }, 0);
      
      const aiValue = aiTradeOffer.reduce((sum, s) => sum + s.baseValue, 0);
      const valueDiff = Math.abs(yourValue - aiValue);
      const valueRatio = Math.min(yourValue, aiValue) / Math.max(yourValue, aiValue);

      let responseText;
      let willing = false;
      let adjustment = 1.0;

      // Check message keywords
      const msgLower = message.toLowerCase();
      let preferenceMatched = false;
      
      // Check if message mentions any of the trader's preferences
      currentTrader.preferences.forEach(pref => {
        if (msgLower.includes(pref.toLowerCase())) {
          preferenceMatched = true;
        }
      });
      
      // Personality-based responses
      if (preferenceMatched) {
        // More likely to adjust if you mention their preferences
        willing = Math.random() < 0.8;
        adjustment = 1.05; // Better offer when you mention their preferences
        
        if (currentTrader.style === 'hype') {
          responseText = "You know what I like! Let me see what I can offer.";
        } else if (currentTrader.style === 'luxury') {
          responseText = "I see you understand quality. I might have something special for you.";
        } else if (currentTrader.style === 'classic') {
          responseText = "A fellow enthusiast! I'll reconsider my offer.";
        } else {
          responseText = "That's exactly what I'm looking for! Let me adjust my offer.";
        }
      } else if (msgLower.includes("deal") || msgLower.includes("fair")) {
        // Checking for deal-closing terms
        if (valueRatio > 0.9) {
          willing = true;
          responseText = "You're right, this is a fair deal. Let's do it!";
        } else {
          willing = false;
          responseText = "I don't think we're quite there yet. The values don't match up.";
        }
      } else if (msgLower.includes("add") || msgLower.includes("more") || msgLower.includes("better")) {
        // Asking for more
        willing = Math.random() < 0.6;
        adjustment = 1.1; // Offer more
        responseText = willing ? 
          "I can sweeten the deal a bit. Check this out." : 
          "I'm already offering the best I can right now.";
      } else {
        // Standard value-based response
        if (valueRatio > 0.9) {
          willing = Math.random() < 0.8;
          adjustment = 1.0;
          responseText = willing ? 
            "I think we're close to a deal." : 
            "I think this is already a fair offer.";
        } else if (valueRatio > 0.7) {
          willing = Math.random() < 0.6;
          adjustment = 0.95;
          responseText = willing ? 
            "Let me adjust my offer a bit." : 
            "The value gap is a bit too wide for me.";
        } else {
          willing = Math.random() < 0.3;
          adjustment = 0.9;
          responseText = "I'm not sure about this trade value.";
        }
      }

      response.innerHTML = `${currentTrader.emoji} ${currentTrader.name}: "${responseText}"`;

      if (willing) {
        generateAITradeOffer(adjustment);
      }

      appendTradeChatMessage('player', message);
      appendTradeChatMessage('ai', responseText);
    }

    function updateNegotiationOptions() {
      const container = document.getElementById('negotiation-options');
      if (!container || !currentTrader) return;

      const options = [
        { text: "How about we adjust the trade a bit?", style: "standard" },
        { text: `Can you add something more ${currentTrader.style === 'luxury' ? 'exclusive' : 'valuable'}?`, style: "request" },
        { text: "Would you consider a different combination?", style: "counter" },
        { text: `I have some ${currentTrader.preferences[0]} items you might like...`, style: "specific" }
      ];

      container.innerHTML = options.map(opt => `
        <button class="negotiation-btn" onclick="negotiate('${opt.text}')">
          ${opt.text}
        </button>
      `).join('');
    }

    function generateNewsEvent() {
      if (Math.random() > 0.3) return; // 30% chance of news event

      const eventTypes = ["celebrity", "market", "trend"];
      const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];

      // Select random sneaker from inventory or database
      const sneaker = inventory.length > 0 && Math.random() > 0.5 
        ? inventory[Math.floor(Math.random() * inventory.length)]
        : sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
      
      let effect, percentage, direction, message;
      if (eventType === "celebrity" || eventType === "trend") {
        // Always positive effect
        effect = Math.random() * 0.5 + 0.1;
        percentage = Math.abs(Math.round(effect * 100));
        direction = "increased";
      if (eventType === "celebrity") {
        const celebrity = celebrities[Math.floor(Math.random() * celebrities.length)];
        const action = celebrityActions[Math.floor(Math.random() * celebrityActions.length)];
          message = `üî• ${celebrity} ${action} ${sneaker.brand} ${sneaker.model}! Value increased by ${percentage}%!`;
        } else {
          const reason = trendReasons[Math.floor(Math.random() * trendReasons.length)];
          message = `üåü ${sneaker.brand} ${sneaker.model} is trending ${reason}! Value increased by ${percentage}%!`;
        }
      } else if (eventType === "market") {
        // 50% chance for positive or negative market event
        const isPositive = Math.random() > 0.5;
        effect = (isPositive ? 1 : -1) * (Math.random() * 0.5 + 0.1);
        percentage = Math.abs(Math.round(effect * 100));
        direction = isPositive ? "increased" : "decreased";
        const reason = marketReasons[isPositive ? "increase" : "decrease"][Math.floor(Math.random() * marketReasons[isPositive ? "increase" : "decrease"].length)];
        message = `üìà Market Alert: ${sneaker.brand} ${sneaker.model} value has ${direction} by ${percentage}% ${reason}!`;
      }

      // Apply effect to matching sneakers
      const eventId = Date.now();
      activeEvents.set(eventId, {
        sneaker: `${sneaker.brand} ${sneaker.model}`,
        effect: effect,
        endTime: Date.now() + 300000 // 5 minutes
      });

      showBreakingNews(message);
      updateInventoryValues();

      setTimeout(() => {
        activeEvents.delete(eventId);
        updateInventoryValues();
      }, 300000);
    }

    function showBreakingNews(message, duration = 5000) {
      const newsElement = document.getElementById('breaking-news');
      if (!newsElement) return;

      // If called from test button, generate a test event
      if (message === true) {
        const testSneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        // Always positive effect for test
        const effect = Math.random() * 0.5 + 0.1;
        const percentage = Math.abs(Math.round(effect * 100));
        const direction = "increased";
        const reason = marketReasons.increase[Math.floor(Math.random() * marketReasons.increase.length)];
        message = `üìà Market Alert: ${testSneaker.brand} ${testSneaker.model} value has ${direction} by ${percentage}% ${reason}`;
        // Apply test effect
        const eventId = Date.now();
        activeEvents.set(eventId, {
          sneaker: `${testSneaker.brand} ${testSneaker.model}`,
          effect: effect,
          endTime: Date.now() + 300000 // 5 minutes
        });
        updateInventoryValues();
        setTimeout(() => {
          activeEvents.delete(eventId);
          updateInventoryValues();
        }, 300000);
      }

      // Clear any existing timeouts
      if (newsElement.timeout) {
        clearTimeout(newsElement.timeout);
      }

      newsElement.textContent = message;
      newsElement.style.display = 'block';
      
      // Force a reflow to restart animation
      void newsElement.offsetWidth;
      newsElement.style.animation = 'none';
      requestAnimationFrame(() => {
        newsElement.style.animation = 'slideDown 0.5s ease-out, glow 2s infinite';
      });

      newsElement.timeout = setTimeout(() => {
        newsElement.style.animation = 'none';
        newsElement.style.display = 'none';
      }, duration);
    }

    function updateInventoryValues() {
      inventory.forEach(sneaker => {
        let totalEffect = 1;
        activeEvents.forEach(event => {
          if (event.sneaker === `${sneaker.brand} ${sneaker.model}`) {
            totalEffect *= (1 + event.effect);
          }
        });
        sneaker.dynamicValue = Math.round(sneaker.baseValue * totalEffect);
      });
      updateInventory();
      updateTradeComparison(); // Update trade values if in a trade
    }

    // Start news generation immediately and run every minute
    generateNewsEvent(); // Initial news
    setInterval(generateNewsEvent, 60000); // Every minute

    // Add event listener for test button
    document.querySelector('.test-button').addEventListener('click', () => {
      console.log("Test button clicked"); // Debug log
      showBreakingNews(true);
    });

    let resellAgent = {
      level: 0, // Start at level 0
      maxLevel: 5,
      baseUpgradeCost: 500,
      bonusPerLevel: 0.2
    };

    let storageUpgrades = 0;
    let storageCost = 300;
    let limitedOffers = new Map();

    function upgradeResellAgent() {
      const cost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
      
      if (coins >= cost && resellAgent.level < resellAgent.maxLevel) {
        coins -= cost;
        resellAgent.level++;
        updateResellAgentDisplay();
        updateCoins();
        showPurchaseNotification(`Resell Agent upgraded to Level ${resellAgent.level}!`);
        
        // Update the upgrade button text with new cost
        const nextCost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
        const upgradeBtn = document.getElementById('upgrade-agent-btn');
        if (upgradeBtn) {
          upgradeBtn.textContent = resellAgent.level < resellAgent.maxLevel ? 
            `Upgrade Agent (${formatCurrency(nextCost)} coins)` : 
            'Max Level Reached!';
        }
      } else if (resellAgent.level >= resellAgent.maxLevel) {
        showPurchaseNotification('Already at maximum level!', 'error');
      } else {
        showPurchaseNotification('Not enough coins!', 'error');
      }
    }

    // Breaking News System
    const marketReasons = {
      increase: [
        "due to limited stock availability",
        "after successful collaboration announcement",
        "following positive reviews",
        "due to seasonal demand",
        "after viral social media coverage",
        "due to collector interest",
        "following successful restock",
        "after design award recognition"
      ],
      decrease: [
        "due to increased market supply",
        "following new competitor release",
        "due to changing trends",
        "after negative publicity",
        "due to overstock situation",
        "following retail price adjustments",
        "due to newer model announcement",
        "after market saturation"
      ]
    };

    const celebrityActions = [
      "spotted wearing",
      "featured on Instagram with",
      "performed wearing",
      "endorsed",
      "showcased in new video wearing",
      "spotted shopping for",
      "praised in interview about",
      "wore to major event"
    ];

    const trendReasons = [
      "after going viral on TikTok",
      "due to streetwear influence",
      "following fashion week appearance",
      "after celebrity collaboration announcement",
      "due to retro style comeback",
      "following cultural moment",
      "after music video feature",
      "due to movie appearance"
    ];

    // Staff System
    const staffTypes = [
      {
        id: 'buyer',
        name: 'Market Buyer',
        description: 'Finds rare sneakers at better prices',
        baseCost: 1000,
        baseBonus: 0.10,
        bonusPerLevel: 0.05,
        maxLevel: 5,
        icon: 'üîç',
        getBonusText: (level) => `Reduces pack costs by ${Math.round((level * 0.05 + 0.10) * 100)}%`
      },
      {
        id: 'authenticator',
        name: 'Authenticator',
        description: 'Increases chance of rare finds',
        baseCost: 1500,
        baseBonus: 0.15,
        bonusPerLevel: 0.05,
        maxLevel: 5,
        icon: '‚ú®',
        getBonusText: (level) => `Increases rare sneaker odds by ${Math.round((level * 0.05 + 0.15) * 100)}%`
      },
      {
        id: 'autoBuyer',
        name: 'Auto Buyer',
        description: 'Automatically buys packs and trades to clients every minute. Gets smarter and makes better trades when upgraded.',
        baseCost: 2000,
        baseBonus: 1,
        bonusPerLevel: 1,
        maxLevel: 5,
        icon: 'ü§ñ',
        getBonusText: (level) => `Buys and trades ${level + 1} pack${level > 0 ? 's' : ''} per minute with improved trade value`
      },
      {
        id: 'autoClicker',
        name: 'Auto Clicker',
        description: 'Automatically clicks for coins. Upgradable for faster coin gain.',
        baseCost: 1200,
        baseBonus: 1, // 1 click per second
        bonusPerLevel: 1, // +1 click per second per level
        maxLevel: 5,
        icon: 'üñ±Ô∏è',
        getBonusText: (level) => `Clicks ${level} time${level === 1 ? '' : 's'} per second for coins`
      }
    ];


    function showBreakingNews(message, duration = 5000) {
      const newsElement = document.getElementById('breaking-news');
      if (!newsElement) return;

      // If called from test button, generate a test event
      if (message === true) {
        const testSneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        // Always positive effect for test
        const effect = Math.random() * 0.5 + 0.1;
        const percentage = Math.abs(Math.round(effect * 100));
        const direction = "increased";
        const reason = marketReasons.increase[Math.floor(Math.random() * marketReasons.increase.length)];
        message = `üìà Market Alert: ${testSneaker.brand} ${testSneaker.model} value has ${direction} by ${percentage}% ${reason}`;
        // Apply test effect
        const eventId = Date.now();
        activeEvents.set(eventId, {
          sneaker: `${testSneaker.brand} ${testSneaker.model}`,
          effect: effect,
          endTime: Date.now() + 300000 // 5 minutes
        });
        updateInventoryValues();
        setTimeout(() => {
          activeEvents.delete(eventId);
          updateInventoryValues();
        }, 300000);
      }

      // Clear any existing timeouts and animations
      if (newsElement.timeout) {
        clearTimeout(newsElement.timeout);
      }
      newsElement.style.animation = 'none';

      // Update content and show
    .news-timer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.8);
      transform-origin: left;
    }
    .news-timer.animate::after {
      animation: newsTimer 5s linear forwards;
    }
    @keyframes newsTimer {
      0% { transform: scaleX(1); }
      100% { transform: scaleX(0); }
    }
    .trader-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .trader-card {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      text-align: left;
    }
    .trader-card:hover {
      transform: translateY(-5px);
    }
    .trader-card.selected {
      border: 2px solid #3498db;
    }
    .trader-avatar {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .trader-info {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .limited-offers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .limited-offer {
      position: relative;
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .offer-timer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9em;
    }

    .staff-hire-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .staff-hire-modal.show {
      display: block;
    }
    .staff-hire-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .staff-hire-item {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .staff-hire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .staff-hire-cost {
      color: #f1c40f;
      font-weight: bold;
    }
    .test-buttons {
      position: fixed;
      left: -9999px;
      visibility: hidden;
    }
    .test-button {
      background: #8e44ad;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .test-button:hover {
      background: #9b59b6;
    }
    
    /* New styles for clicker, used market, and cleaning game */
    .clicker-button {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.1s;
      margin: 20px auto;
      display: block;
    }
    
    .clicker-button:active {
      transform: scale(0.95);
    }
    
    .used-market {
      margin: 20px 0;
    }
    
    .used-sneaker {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      transition: width 0.3s;
    }
    
    .cleaning-game {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      width: 90%;
      max-width: 500px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .cleaning-game.show {
      display: block;
    }
    
    .cleaning-info {
      margin: 15px 0;
      padding: 10px;
      background: #34495e;
      border-radius: 8px;
    }
    
    .sneaker-canvas {
      background: #34495e;
      border-radius: 8px;
      margin: 10px auto;
      cursor: pointer;
      display: block;
      max-width: 100%;
      height: auto;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      width: 0;
      transition: width 0.3s;
    }
    
    #used-market-modal {
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #34495e;
      border-radius: 8px 8px 0 0;
      margin: -20px -20px 20px -20px;
    }
    
    .modal-header h2 {
      margin: 0;
      color: white;
    }
    
    .click-count {
      font-size: 18px;
      color: #3498db;
      margin: 10px 0;
    }
    
    .used-market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
      max-height: 70vh;
      overflow-y: auto;
      padding: 15px;
    }

    /* Comprehensive light mode styles */
    .light-mode {
      background-color: #f5f6fa;
      color: #2c3e50;
    }
    
    .light-mode .sneaker-card,
    .light-mode .modal,
    .light-mode .settings-item,
    .light-mode .trade-side,
    .light-mode .ai-trader-info,
    .light-mode .ai-response,
    .light-mode .selected-sneaker,
    .light-mode .purchase-item {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .light-mode .modal-overlay {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .light-mode .pack-button,
    .light-mode .negotiation-btn,
    .light-mode .close-btn {
      background-color: #3498db;
      color: white;
    }
    
    .light-mode .pack-button:hover,
    .light-mode .negotiation-btn:hover {
      background-color: #2980b9;
    }
    
    .light-mode .modal-header {
      background-color: #f8f9fa;
      color: #2c3e50;
    }
    
    .light-mode select {
      background-color: #ffffff;
      color: #2c3e50;
      border-color: #bdc3c7;
    }

    /* Fix sneaker positioning in popups */
    .card {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
    }

    .roll-item {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
      width: 180px;
      height: 130px;
    }

    /* Update animations */
    @keyframes rollAndReveal {
      0% { transform: translate(-50%, -150%) rotate(-180deg); opacity: 0; }
      70% { transform: translate(-50%, -30%) rotate(20deg); opacity: 0.7; }
      90% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
    }

    /* Rarity-specific reveal animations */
    .reveal-common {
      animation: rollAndReveal 0.8s ease-out, fadeIn 0.3s ease-out 0.8s !important;
    }
    
    .reveal-uncommon {
      animation: rollAndReveal 0.8s ease-out, glowGreen 0.3s ease-out 0.8s !important;
    }
    
    .reveal-rare {
      animation: rollAndReveal 0.8s ease-out, glowBlue 0.3s ease-out 0.8s !important;
    }
    
    .reveal-epic {
      animation: rollAndReveal 0.8s ease-out, glowPurple 0.3s ease-out 0.8s !important;
    }
    
    .reveal-legendary {
      animation: rollAndReveal 0.8s ease-out, explodeGold 0.3s ease-out 0.8s !important;
    }

    @keyframes glowGreen {
      0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(46, 204, 113, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
    }

    @keyframes glowBlue {
      0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(52, 152, 219, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
    }

    @keyframes glowPurple {
      0% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(155, 89, 182, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
    }

    @keyframes explodeGold {
      0% { transform: translate(-50%, -50%) scale(0.8); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); }
      50% { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 30px 15px rgba(241, 196, 15, 0.4); }
      100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
    }

    /* Additional light mode styles */
    .light-mode .cleaning-game {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .light-mode .cleaning-game .modal-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .light-mode .cleaning-game .modal-header h2 {
      color: #2c3e50;
    }

    .light-mode .limited-offer {
      background: linear-gradient(45deg, #3498db, #9b59b6);
      color: white;
    }

    .light-mode .offer-sneaker {
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50;
    }

    .light-mode .rarity-common { color: #7f8c8d; }
    .light-mode .rarity-uncommon { color: #27ae60; }
    .light-mode .rarity-rare { color: #2980b9; }
    .light-mode .rarity-epic { color: #8e44ad; }
    .light-mode .rarity-legendary { color: #f39c12; }

    .light-mode .better-value { color: #27ae60; }
    .light-mode .worse-value { color: #e74c3c; }
    .light-mode .equal-value { color: #f1c40f; }

    .light-mode .purchase-notification {
      background: #27ae60;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Market buyer upgrade system */
    .market-buyers-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }

    .market-buyer-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #34495e;
      border-radius: 5px;
      gap: 10px;
    }

    .market-buyer-option.active {
      background: #2ecc71;
    }

    .light-mode .market-buyer-option {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
    }

    .light-mode .market-buyer-option.active {
      background: #d4edda;
      border-color: #c3e6cb;
    }

    /* Chat area styles */
    .trade-chat { max-height: 180px; overflow-y: auto; background: #222; border-radius: 6px; padding: 8px; margin-bottom: 10px; text-align: left; }
    .trade-chat-msg { margin: 4px 0; padding: 4px 8px; border-radius: 4px; }
    .trade-chat-msg.ai-msg { background: #34495e; color: #f1c40f; }
    .trade-chat-msg.player-msg { background: #2980b9; color: #fff; text-align: right; }
    /* Trade chat: hacker font */
    .trade-chat, .trade-chat-msg { font-family: 'Fira Mono', 'Consolas', 'monospace'; letter-spacing: 0.5px; }

    /* Prestige system styles */
    .prestige-button {
      background: linear-gradient(45deg, #f39c12, #e74c3c);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .prestige-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.3);
    }
    
    .prestige-button:disabled {
      background: linear-gradient(45deg, #95a5a6, #7f8c8d);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .prestige-info {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    
    .prestige-level {
      font-size: 24px;
      color: #f39c12;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .prestige-bonus {
      font-size: 16px;
      color: #3498db;
      margin: 5px 0;
    }
    
    .prestige-progress {
      background: #2c3e50;
      height: 20px;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .prestige-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #f39c12);
      width: 0%;
      transition: width 0.5s;
    }
    
    .prestige-modal {
      text-align: center;
    }
    
    .prestige-benefits {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }
    
    .prestige-modal h3 {
      color: #f39c12;
      margin: 10px 0;
    }
    
    .prestige-confirm-btn {
      background: #e74c3c;
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
    }
    
    .prestige-stars {
      font-size: 28px;
      color: #f39c12;
      letter-spacing: 5px;
      margin: 10px 0;
    }

    .prestige-milestone {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .prestige-milestone.achieved {
      background: rgba(46, 204, 113, 0.2);
    }
    
    .prestige-milestone.next {
      background: rgba(52, 152, 219, 0.2);
      border: 1px dashed #3498db;
    }
    
    .milestone-level {
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    
    .milestone-emoji {
      font-size: 20px;
      min-width: 30px;
      text-align: center;
    }
    
    .prestige-milestone-summary {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }

    /* Save code system styles */
    .save-code-container {
      margin: 15px 0;
      text-align: center;
    }
    
    .save-code-textarea {
      width: 90%;
      height: 80px;
      background: #2c3e50;
      border: 1px solid #34495e;
      border-radius: 5px;
      color: #ecf0f1;
      padding: 10px;
      margin: 10px 0;
      font-family: monospace;
      resize: none;
    }
    
    .save-code-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    .save-code-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
    }
    
    .save-code-btn:hover {
      background: #3498db;
    }
    
    .save-code-info {
      font-size: 0.9em;
      color: #95a5a6;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div id="breaking-news" class="breaking-news"></div>
  <div class="modal-overlay" id="modal-overlay" onclick="closeAllModals()"></div>
  <div class="top-right-buttons">
    <button class="history-btn" onclick="openHistory()" title="Purchase History">üìú</button>
    <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
  </div>
  <header>
    <h1>Sneaker Pack Tycoon</h1>
    <div class="coins">Coins: <span id="coin-count">0</span></div>
  </header>
  <div class="container">
    <button class="clicker-button" onclick="handleClick()">
      Click!
      <div class="click-count">Clicks: 0</div>
    </button>
    <div class="prestige-info">
      <div class="prestige-level">Prestige Level: <span id="prestige-level">0</span></div>
      <div class="prestige-bonus" id="prestige-bonuses"></div>
      <div class="prestige-progress">
        <div class="prestige-progress-fill" id="prestige-progress-fill"></div>
      </div>
      <button class="prestige-button" id="prestige-button" onclick="openPrestigeModal()">PRESTIGE</button>
    </div>
    <div>
      <select id="pack-type" class="pack-select">
        <option value="standard">Standard Pack (100 Coins)</option>
        <option value="premium">Premium Pack (300 Coins)</option>
        <option value="colorway">Colorway Pack (200 Coins)</option>
        <option value="rare">Rare Pack (400 Coins)</option>
        <option value="epic">Epic Pack (700 Coins)</option>
        <option value="legendary">Legendary Pack (2500 Coins)</option>
        <option value="mystery">Mystery Pack (500 Coins)</option>
        <option value="ultra">Ultra Pack (1200 Coins)</option>
        <option value="hype">Hype Pack (900 Coins)</option>
        <option value="classic">Classic Pack (250 Coins)</option>
        <option value="collab">Collab Pack (1500 Coins)</option>
        <option value="seasonal">Seasonal Pack (600 Coins)</option>
      </select>
      <button class="pack-button" onclick="openPack()">Open Pack</button>
      <button class="pack-button" style="margin-left:8px;" onclick="previewPack()">Pack Preview</button>
    </div>
    <div class="daily">
      <h2>Daily Rewards</h2>
      <button class="pack-button" onclick="claimDaily()">Claim Daily Coins</button>
    </div>
    <div class="upgrades">
      <h2>Store Upgrades</h2>
      <button class="pack-button" onclick="openUsedMarket()">Browse Used Sneakers</button>
      <div class="resell-agent">
        <h3>Resell Agents</h3>
        <div class="agent-types" id="agent-types">
          <!-- Agent types will be inserted here -->
        </div>
        <div class="agent-level">
          Level: <div class="level-indicator" id="agent-level"></div>
        </div>
        <div class="agent-bonus" id="agent-bonus"></div>
        <button class="pack-button" id="upgrade-agent-btn" onclick="upgradeResellAgent()">Upgrade Agent</button>
      </div>
      <div class="staff-section">
        <h3>Automated Staff</h3>
        <button class="pack-button" onclick="openHireStaff()">Hire Staff</button>
        <div class="staff-grid" id="staff-grid">
          <!-- Staff members will be inserted here -->
        </div>
      </div>
    </div>
    <div class="inventory">
      <h2>Your Inventory</h2>
      <div id="inventory-list" class="inventory-list-flex"></div>
    </div>
    <div class="trading">
      <h2>AI Trading System (Sneaker-for-Sneaker)</h2>
      <button class="pack-button" onclick="openTradeUI()">Enter Trade</button>
    </div>
  <div class="modal" id="used-market-modal">
    <div class="modal-header">
      <h2>Used Sneaker Market</h2>
      <button class="close-btn" onclick="closeUsedMarket()">Close</button>
    </div>
    <div class="used-market-grid" id="used-market-grid">
      <!-- Used sneakers will be inserted here -->
    </div>
  </div>
  <div class="cleaning-game" id="cleaning-game">
    <div class="modal-header">
      <h2>Clean Your New Sneaker</h2>
      <button class="close-btn" onclick="finishCleaning()">‚úï</button>
    </div>
    <div class="cleaning-info">
      <p>Click on the dirt spots to clean them!</p>
      <div class="condition-bar">
        <div class="condition-fill" id="cleaning-progress"></div>
      </div>
    </div>
    <canvas id="sneaker-canvas" class="sneaker-canvas" width="400" height="300"></canvas>
    <button class="pack-button" onclick="finishCleaning()">Finish Cleaning</button>
  </div>
  <div class="modal" id="pack-modal">
    <div id="modal-content">
      <h2>Opening Pack...</h2>
      <div id="card-container" class="card-container"></div>
      <button id="next-sneaker-btn" onclick="revealNextSneaker()">Next Sneaker</button>
    </div>
  </div>
  <div class="modal" id="trade-modal">
    <div>
      <h2>Select Trader</h2>
      <div class="trader-selection" id="trader-selection">
        <!-- Trader cards will be inserted here -->
      </div>
      <div id="ai-trader" class="ai-trader-info" style="display: none;">
        <!-- AI trader info will be inserted here -->
      </div>
      <div class="trade-selection">
        <div><b>Select sneakers to offer:</b></div>
      <select id="trade-dropdown"></select>
        <button class="pack-button" onclick="addToTrade()">Add to Trade</button>
        <div id="selected-sneakers" class="selected-sneakers"></div>
      </div>
      <div class="trade-comparison">
        <div class="trade-side" id="your-offer">
          <h3>Your Offer</h3>
          <div class="offer-details"></div>
        </div>
        <div class="trade-arrow">‚ÜîÔ∏è</div>
        <div class="trade-side" id="ai-offer">
          <h3>AI's Offer</h3>
          <div class="offer-details"></div>
        </div>
      </div>
      <div id="ai-response" class="ai-response"></div>
      <div class="negotiation-options" id="negotiation-options"></div>
      <div id="trade-offer" class="trade-offer"></div>
      <div id="trade-chat" class="trade-chat"></div>
      <button class="close-btn" onclick="closeTradeUI()">Close</button>
    </div>
  </div>
  <div class="modal" id="settings-modal">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="close-btn" onclick="closeSettings()">Close</button>
    </div>
    <div class="settings-grid">
      <div class="settings-item">
        <label>
          <input type="checkbox" id="animation-toggle" onclick="toggleAnimation()">
          Show Animations
        </label>
      </div>
      <div class="settings-item">
        <label>
          <input type="checkbox" id="notification-toggle" onclick="toggleNotifications()">
          Show Notifications
        </label>
      </div>
      <div class="settings-item">
        <label for="display-mode">Display Mode</label>
        <select id="display-mode" onchange="updateDisplayMode()">
          <option value="grid">Grid View</option>
          <option value="list">List View</option>
          <option value="compact">Compact View</option>
        </select>
      </div>
      <div class="settings-item">
        <label for="currency-display">Currency Display</label>
        <select id="currency-display" onchange="updateCurrencyDisplay()">
          <option value="coins">Coins</option>
          <option value="k">K Format (1K, 2K)</option>
          <option value="full">Full Number</option>
        </select>
      </div>
      <div class="settings-item">
        <label for="sort-inventory">Default Sort</label>
        <select id="sort-inventory" onchange="updateDefaultSort()">
          <option value="rarity">By Rarity</option>
          <option value="value">By Value</option>
          <option value="brand">By Brand</option>
          <option value="newest">Newest First</option>
        </select>
      </div>
      <div class="settings-item">
        <label>
          <input type="checkbox" id="light-mode-toggle" onclick="toggleLightMode()">
          Light Mode
        </label>
      </div>
      <div class="settings-item">
        <label><input type="checkbox" id="skip-animation-toggle" onclick="toggleSkipAnimation()"> Skip Pack Animation</label>
      </div>
    </div>
    
    <div class="save-code-container">
      <!-- Save import/export removed -->
    </div>
  </div>
  <div class="modal" id="history-modal">
    <div class="modal-header">
      <h2>Purchase History</h2>
      <button class="close-btn" onclick="closeHistory()">Close</button>
    </div>
    <div class="purchase-history" id="purchase-history">
      <!-- Purchase history items will be added here -->
    </div>
  </div>
  <div class="staff-hire-modal" id="staff-hire-modal">
    <div class="modal-header">
      <h2>Hire Staff</h2>
      <button class="close-btn" onclick="closeHireStaff()">Close</button>
    </div>
    <div class="staff-hire-list" id="staff-hire-list">
      <!-- Staff hire options will be inserted here -->
    </div>
  </div>
  <div class="test-buttons">
    <button class="test-button" onclick="showBreakingNews(true)">Test Breaking News</button>
  </div>
  <div class="modal" id="prestige-modal">
    <div class="modal-header">
      <h2>Prestige System</h2>
      <button class="close-btn" onclick="closePrestigeModal()">Close</button>
    </div>
    <div class="prestige-modal">
      <div class="prestige-stars" id="prestige-stars">‚òÖ</div>
      <p>You've reached <span id="prestige-coins-display">100,000</span> coins!</p>
      <p>Are you ready to prestige and reset your progress for permanent bonuses?</p>
      
      <div class="prestige-benefits">
        <h3>Benefits of Prestige Level <span id="next-prestige-level">1</span>:</h3>
        <ul id="prestige-benefits-list">
          <li>Reduced base pack costs (90 coins)</li>
          <li>Increased click value (1 coin per click)</li>
          <li>Keep your prestige bonuses forever</li>
        </ul>
      </div>
      
      <h3>Prestige Milestones:</h3>
      <div id="prestige-milestones">
        <!-- Milestone list will be added here -->
      </div>
      
      <p><strong>Warning:</strong> You will lose all your coins, inventory items, and staff!</p>
      
      <button class="pack-button prestige-confirm-btn" onclick="confirmPrestige()">PRESTIGE NOW</button>
    </div>
  </div>
  <script>
    // Initialize game state
    let gameState = {
      coins: 0,
      inventory: [],
      purchaseHistory: [],
      prestigeLevel: 0,
      clickValue: 1, // 1 coin per click at base (modified by prestige)
      clicksNeeded: 2, // Number of clicks needed for 1 coin (modified by prestige)
      clickCounter: 0, // Counter for current clicks
      inventoryCapacityBonus: 0, // Additional inventory slots from prestige
      rarityMultiplier: 1, // Multiplier for rarity chances
      extraSneakerChance: 0, // Chance for extra sneaker in packs
      passiveIncomeRate: 0, // Passive income per second
      passiveIncomeInterval: null, // Interval for passive income
      autoSellCommon: false, // Auto-sell common items
      freePackChance: 0, // Chance for free packs
      legendaryBoost: 0, // Boost to legendary chances
      doubleSaleChance: 0, // Chance for double sale value
      settings: {
        soundEnabled: true,
        musicEnabled: true,
        soundVolume: 0.5,
        musicVolume: 0.3,
        notifications: true,
        animations: true,
        autoSell: false,
        currencyDisplay: 'full',
        displayMode: 'grid',
        defaultSort: 'rarity',
        rollAnimation: true,
        volume: 50,
        lightMode: false,
        skipPackAnimation: false
      },
      hiredStaff: [],
      resellAgent: {
        level: 0
      },
      storageUpgrades: 0,
      storageCost: 300,
      limitedOffers: new Map()
    };

    // Initialize game state from save or defaults
    function initializeGame() {
      const savedState = localStorage.getItem('sneakerHustleGameState');
      
      if (savedState) {
        try {
          const gameState = JSON.parse(savedState);
          
          // Restore basic values
          gameState.coins = gameState.coins ?? 10000;
          gameState.inventory = gameState.inventory || [];
          gameState.purchaseHistory = gameState.purchaseHistory || [];
          
          // Restore prestige level
          gameState.prestigeLevel = gameState.prestigeLevel || 0;
          
          // Apply prestige bonuses
          applyPrestigeBonuses();
          
          // Restore settings
          if (gameState.settings) {
            gameState.settings = {...gameState.settings, ...gameState.settings};
          }
          
          // Restore market buyer
          if (gameState.currentMarketBuyer) {
            gameState.currentMarketBuyer = gameState.currentMarketBuyer;
          }
          
          // Restore limited offers
          if (gameState.limitedOffers) {
            gameState.limitedOffers = new Map(gameState.limitedOffers);
          }
          
          // Restore multipliers
          if (gameState.activeMultipliers) {
            window.globalMultiplier = gameState.activeMultipliers.global;
            window.brandMultipliers = gameState.activeMultipliers.brand;
            window.coinMultiplier = gameState.activeMultipliers.coin;
          }
          
          // Restore trader state
          if (gameState.currentTrader) {
            window.currentTrader = gameState.currentTrader;
            window.lastTraderResponse = gameState.lastTraderResponse;
          }
          if (gameState.hiredStaff) {
            gameState.hiredStaff = gameState.hiredStaff;
          }
          if (gameState.resellAgentLevel !== undefined) {
            gameState.resellAgent.level = gameState.resellAgentLevel;
          }
          if (gameState.storageUpgrades !== undefined) {
            gameState.storageUpgrades = gameState.storageUpgrades;
          }
          if (gameState.storageCost !== undefined) {
            gameState.storageCost = gameState.storageCost;
          }
        } catch (error) {
          console.error('Error loading game state:', error);
          setDefaultState();
        }
        } else {
        setDefaultState();
      }
      
      // Update all UI elements
      updateAllDisplays();
      updateStorageDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Set default state for new games
    function setDefaultState() {
      gameState.coins = 1000;
      gameState.inventory = [];
      gameState.purchaseHistory = [];
      gameState.prestigeLevel = 0;
      gameState.clickValue = 0.5; // Default click value
      gameState.settings = {
        soundEnabled: true,
        musicEnabled: true,
        soundVolume: 0.5,
        musicVolume: 0.3,
        notifications: true,
        animations: true,
        autoSell: false,
        currencyDisplay: 'full',
        displayMode: 'grid',
        defaultSort: 'rarity',
        rollAnimation: true,
        volume: 50,
        lightMode: false,
        skipPackAnimation: false
      };
      gameState.hiredStaff = [];
      gameState.resellAgent.level = 0;
      gameState.storageUpgrades = 0;
      gameState.storageCost = 300;
      if (document.getElementById('storage-cost')) document.getElementById('storage-cost').textContent = gameState.storageCost;
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Update all UI displays
    function updateAllDisplays() {
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      updateLimitedOffers();
      updateMarketBuyerDisplay();
      updatePrestigeDisplay();
      applySettings();
    }

    // Save game state
    function saveGameState() {
      localStorage.setItem('sneakerHustleGameState', JSON.stringify(gameState));
    }

    // Initialize when the page loads
    window.addEventListener('load', () => {
      initializeGame();
      generateNewsEvent();
    });

    // Save before unloading
    window.addEventListener('beforeunload', saveGameState);

    // Initialize game variables
    let upgrades = { betterOdds: false, storageExpand: false };
    let totalProfit = 0;
    let currentSneakers = [];
    let currentSneakerIndex = 0;
    let currentOffer = null;
    let offerInterval = null;
    let selectedTradeItems = [];
    let activeEvents = new Map();
    let clickCount = 0;
    let currentCleaningSneaker = null;
    let dirtSpots = [];
    let cleaningInProgress = false;

    // News Events Data
    const newsEvents = [
      {
        type: "celebrity",
        templates: [
          "{celebrity} spotted wearing {sneaker}! Prices {direction}!",
          "Breaking: {celebrity} signs deal with {sneaker} brand!",
          "{celebrity}'s {sneaker} collection causing market frenzy!"
        ],
        valueEffect: [0.2, 0.5], // 20-50% increase
        duration: 300000 // 5 minutes
      },
      {
        type: "market",
        templates: [
          "Market Alert: {sneaker} prices {direction} rapidly!",
          "Unexpected demand surge for {sneaker}!",
          "Rare {sneaker} batch discovered! Market adjusting!"
        ],
        valueEffect: [-0.3, 0.3], // -30% to +30%
        duration: 600000 // 10 minutes
      },
      {
        type: "trend",
        templates: [
          "TikTok trend featuring {sneaker} goes viral!",
          "Fashion influencers can't get enough of {sneaker}!",
          "Street style: {sneaker} becomes must-have item!"
        ],
        valueEffect: [0.1, 0.4], // 10-40% increase
        duration: 450000 // 7.5 minutes
      }
    ];

    // Add more celebrities and events
    const celebrities = [
      // Musicians
      "Drake", "Travis Scott", "Kanye West", "Bad Bunny", "The Weeknd",
      "Taylor Swift", "Billie Eilish", "Post Malone", "J Balvin", "BTS",
      "Rihanna", "Jay-Z", "Eminem", "Lil Baby", "Tyler, The Creator",
      
      // Athletes
      "LeBron James", "Cristiano Ronaldo", "Lionel Messi", "Kevin Durant",
      "Stephen Curry", "Neymar Jr", "Kylian Mbapp√©", "Giannis Antetokounmpo",
      "Zion Williamson", "Ja Morant", "Erling Haaland", "Luka Donƒçiƒá",
      
      // Entertainers
      "Zendaya", "Tom Holland", "Michael B. Jordan", "Ryan Reynolds",
      "Donald Glover", "Kevin Hart", "Margot Robbie", "Timoth√©e Chalamet",
      
      // Fashion/Social
      "Kylie Jenner", "Bella Hadid", "A$AP Rocky", "Virgil Abloh",
      "Kim Kardashian", "Kendall Jenner", "Pharrell Williams", "Jerry Lorenzo"
    ];

    // Special Events with Coin Multipliers
    const specialEvents = [
      {
        type: "market_surge",
        templates: [
          "üåü MARKET SURGE: All sales give {multiplier}x coins for {duration} minutes!",
          "üí´ GOLDEN HOUR: {multiplier}x coins from all transactions for {duration} minutes!",
          "üéØ HOT MARKET: Earn {multiplier}x coins from sales for {duration} minutes!"
        ],
        rarity: 0.05, // 5% chance
        multipliers: [2, 3, 5, 10],
        durations: [2, 3, 5] // minutes
      },
      {
        type: "lucky_find",
        templates: [
          "üçÄ LUCKY FIND: Next pack has {multiplier}x better odds!",
          "‚ú® BLESSED PACK: Your next opening has {multiplier}x rarity chance!",
          "üé≤ FORTUNE FAVORS: {multiplier}x rarity boost on your next pack!"
        ],
        rarity: 0.08, // 8% chance
        multipliers: [2, 3, 5]
      },
      {
        type: "market_crash",
        templates: [
          "üìâ MARKET CRASH: All sneakers {direction} in value by {percentage}%!",
          "üí• ECONOMIC SHOCK: Global sneaker values {direction} {percentage}%!",
          "üå™ MARKET CHAOS: Sudden {percentage}% {direction} in all values!"
        ],
        rarity: 0.03, // 3% chance
        effects: [-0.5, -0.3, 0.3, 0.5]
      }
    ];

    // Card reveal effects based on rarity
    const cardEffects = {
      common: {
        animation: "fade",
        color: "#7f8c8d",
        sound: "whoosh"
      },
      rare: {
        animation: "flip",
        color: "#2980b9",
        particles: "sparkle"
      },
      epic: {
        animation: "spin",
        color: "#8e44ad",
        particles: "burst"
      },
      legendary: {
        animation: "explosion",
        color: "#f39c12",
        particles: "fireworks"
      }
    };

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function finishPackOpening() {
      gameState.inventory.push(...currentSneakers);
      updateInventory();
      
      // Close the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.remove('show');
      modalOverlay.classList.remove('show');
      
      // Reset state
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      currentSneakerIndex = 0;
      currentSneakers = [];
      
      // Re-enable all buttons
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = false;
      });
      saveGameState();
    }

    // --- 100+ Sneaker Database ---
    const brands = [
      "Nike", "Adidas", "Jordan", "Puma", "Reebok", "New Balance", "Asics", 
      "Converse", "Vans", "Saucony", "Under Armour", "Yeezy", "Off-White",
      "Balenciaga", "Gucci", "Louis Vuitton", "Alexander McQueen", "Dior"
    ];
    
    const models = [
      // Nike Models
      "Air Max 90", "Dunk Low", "Air Force 1", "SB Dunk", "Air Max 95", 
      "Air Max 97", "Air Max 1", "Air Jordan 1", "Air Jordan 4", "Air Jordan 11",
      "Air Presto", "React Element", "Blazer Mid", "Cortez", "Waffle One",
      
      // Adidas Models
      "Yeezy Boost 350", "Superstar", "Ultra Boost", "NMD R1", "Forum Low",
      "Stan Smith", "Samba", "ZX 750", "Ozweego", "Campus",
      
      // Jordan Models
      "Retro 1", "Retro 3", "Retro 4", "Retro 5", "Retro 6",
      "Retro 11", "Retro 12", "Retro 13", "Legacy 312", "XXXV",
      
      // Luxury Models
      "Triple S", "Speed Trainer", "Rhyton", "Ace", "Run Away",
      "B23 High", "Chain Reaction", "Oversized", "Wave", "Track",
      
      // Classic Models
      "Chuck Taylor", "Old Skool", "Sk8-Hi", "Era", "Authentic",
      "Club C 85", "Classic Leather", "Workout Plus", "550", "992",
      
      // Running/Athletic
      "Gel Lyte III", "Kayano 5", "Jazz Original", "Triumph", "HOVR",
      "Fresh Foam", "Kinvara", "Endorphin", "Zoom Fly", "Pegasus"
    ];
    
    const colorways = [
      // Basic Colors
      "White/Black", "Black/White", "Triple Black", "Triple White", "Navy/White",
      "Red/White", "Green/White", "Blue/White", "Grey/White", "Cream/White",
      
      // Popular Nicknames
      "Bred", "Chicago", "Royal", "Shadow", "Mocha",
      "University Blue", "Volt", "Infrared", "Cement", "Pine Green",
      
      // Special Editions
      "Travis Scott", "Off-White", "Fragment", "Union LA", "A Ma Maniere",
      "Sean Wotherspoon", "Virgil Abloh", "Sacai", "Cactus Jack", "Fear of God",
      
      // Patterns
      "Zebra", "Tiger Stripe", "Safari Print", "Snake Skin", "Tie Dye",
      "Splatter", "Gradient", "Camo", "Animal Print", "Paisley",
      
      // Materials
      "Patent Leather", "Suede", "Canvas", "Mesh", "Knit",
      "Premium Leather", "Nubuck", "Corduroy", "Denim", "Velvet",
      
      // Seasonal
      "Summer Pack", "Winter Camo", "Fall Tones", "Spring Pastels", "Holiday",
      "Valentine's Day", "Halloween", "Christmas", "Easter", "New Year",
      
      // Collaborations
      "Supreme", "Undefeated", "Concepts", "Atmos", "Patta",
      "Stussy", "Diamond Supply", "Kith", "Bodega", "SNS",
      
      // Limited Editions
      "Friends & Family", "Sample", "Prototype", "Region Exclusive", "Store Exclusive",
      "Anniversary", "Retro+", "OG", "Vintage", "Player Exclusive"
    ];

    const rarities = [
      { rarity: "common", weight: 60, value: [20, 50] },
      { rarity: "rare", weight: 25, value: [60, 150] },
      { rarity: "epic", weight: 12, value: [200, 400] },
      { rarity: "legendary", weight: 3, value: [500, 2000] }
    ];

    // Instead of generating a fixed database, generate a random sneaker on demand
    function getRandomSneaker(rarity) {
      const brand = brands[Math.floor(Math.random() * brands.length)];
      const model = models[Math.floor(Math.random() * models.length)];
      const colorway = colorways[Math.floor(Math.random() * colorways.length)];
      let baseValue = 50;
      for (let r of rarities) {
        if (r.rarity === rarity) {
          baseValue = Math.floor(r.value[0] + Math.random() * (r.value[1] - r.value[0]));
          break;
        }
      }
      return {
        id: Date.now() + Math.random(),
        brand,
        model,
        colorway,
        rarity,
        baseValue,
        image: `https://robohash.org/${encodeURIComponent(brand + '-' + model + '-' + colorway)}.png?set=set4`
      };
    }

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sneaker Pack Tycoon</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #2c3e50; color: white; text-align: center; }
    h1 { margin-top: 20px; }
    .container { margin: 20px; }
    .coins { font-size: 24px; margin-bottom: 20px; }
    .pack-select, .pack-button { padding: 10px 20px; font-size: 18px; margin: 10px; }
    .pack-button { cursor: pointer; background-color: #2980b9; color: white; border: none; border-radius: 5px; }
    .inventory, .market, .settings, .daily, .trading { margin-top: 20px; }
    .inventory div, .market div, .trading div { background: #34495e; margin: 10px; padding: 10px; border-radius: 8px; }
    .sneaker-card { margin-bottom: 10px; }
    .rarity-common { color: #7f8c8d; }
    .rarity-rare { color: #2980b9; }
    .rarity-epic { color: #8e44ad; }
    .rarity-legendary { color: #f39c12; font-weight: bold; }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      background: #222;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
      z-index: 1000;
      pointer-events: none;
    }
    .modal.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 999;
      pointer-events: none;
    }
    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .card-container {
      margin: 20px auto;
      display: flex;
      flex-direction: row;
      align-items: center;
      position: relative;
      height: 200px;
      width: 600px;
      overflow: hidden;
      background: #222;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .casino-roll-track {
      display: flex;
      flex-direction: row;
      align-items: center;
      transition: transform 2s cubic-bezier(0.23, 1, 0.32, 1);
      will-change: transform;
      height: 100%;
    }
    .casino-roll-card {
      background-color: #34495e;
      color: white;
      padding: 20px;
      border-radius: 8px;
      width: 180px;
      height: 150px;
      margin: 0 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 1em;
      transition: box-shadow 0.2s, transform 0.2s;
      }
    .casino-roll-card.selected {
      /* No border, no color change, no highlight */
      /* Just use normal card style */
    }
    select.pack-select { background: #34495e; color: white; border: 1px solid #2980b9; border-radius: 5px; }
    .inventory-list-flex {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .sneaker-card {
      background: #34495e;
      margin: 5px;
      padding: 8px;
      border-radius: 8px;
      min-width: 100px;
      max-width: 140px;
      flex: 1 1 120px;
      font-size: 14px;
      transition: font-size 0.2s, min-width 0.2s, max-width 0.2s;
      width: calc(100% / 5 - 16px);
    }
    @media (max-width: 700px) {
      .inventory-list-flex .sneaker-card {
        width: calc(100% / 2 - 16px);
      }
    }
    @media (max-width: 500px) {
      .inventory-list-flex .sneaker-card {
        width: 100%;
      }
    }
    #trade-dropdown {
      margin: 10px 0;
      padding: 6px 12px;
      font-size: 16px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
      width: 90%;
      max-width: 300px;
    }
    .trade-offer { margin-top: 15px; }
    .close-btn { background: #c0392b; color: white; border: none; border-radius: 5px; padding: 6px 14px; cursor: pointer; margin-top: 10px;}
    .settings {
      margin-top: 20px;
      background: #34495e;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      text-align: left;
      margin-top: 15px;
    }
    .settings-item {
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
    }
    .settings-item label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .settings input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }
    .settings select {
      width: 100%;
      padding: 5px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
    }
    .volume-value {
      font-size: 14px;
      color: #bdc3c7;
    }
    .no-animations * {
      animation: none !important;
      transition: none !important;
    }
    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .inventory-list .sneaker-card { max-width: 100%; width: 100%; }
    .inventory-compact .sneaker-card { font-size: 12px; padding: 5px; }
    .top-right-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .history-btn, .settings-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: transform 0.2s, background-color 0.2s;
    }
    .history-btn:hover, .settings-btn:hover {
      background: #3498db;
      transform: scale(1.1);
    }
    .purchase-history {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .purchase-item {
      background: #2c3e50;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
    }
    .purchase-time {
      color: #7f8c8d;
      font-size: 0.9em;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
    }
    .limited-offer {
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 20px;
      border-radius: 8px;
      margin: 15px auto;
      max-width: 600px;
      position: relative;
      overflow: hidden;
    }
    .limited-offer::before {
      content: "Limited Time!";
      position: absolute;
      top: 10px;
      right: -30px;
      background: #e74c3c;
      color: white;
      padding: 5px 40px;
      transform: rotate(45deg);
      font-size: 12px;
    }
    .offer-timer {
      color: #ecf0f1;
      font-size: 1.2em;
      margin: 10px 0;
    }
    .offer-content {
      display: flex;
      align-items: center;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .offer-sneaker {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
    }
    .roll-animation {
      animation: rollEffect 1s ease-out;
    }
    @keyframes rollEffect {
      0% { transform: translateY(-100px) rotate(-180deg); opacity: 0; }
      70% { transform: translateY(20px) rotate(20deg); opacity: 0.7; }
      100% { transform: translateY(0) rotate(0deg); opacity: 1; }
    }
    .roll-container {
      position: relative;
      height: 150px;
      width: 200px;
      overflow: hidden;
      background: #2c3e50;
      border-radius: 8px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .roll-item {
      position: absolute;
      width: 180px;
      height: 130px;
      padding: 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #34495e;
      box-sizing: border-box;
      border-radius: 5px;
      transition: all 0.05s;
      opacity: 0;
      transform: scale(0.9);
      left: 50%;
      margin-left: -90px;
    }
    .roll-item.active {
      opacity: 1;
      transform: scale(1);
    }
    .roll-item.final {
      animation: popIn 0.3s ease-out forwards !important;
      opacity: 1;
    }
    @keyframes popIn {
      0% { transform: scale(0.8); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .roll-flash {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 2;
    }
    .roll-item strong {
      display: block;
      margin-bottom: 5px;
    }
    .roll-item span {
      display: block;
      margin: 2px 0;
    }
    @keyframes flashEffect {
      0% { opacity: 0; }
      50% { opacity: 0.5; }
      100% { opacity: 0; }
    }
    .trade-comparison {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 20px 0;
      gap: 20px;
    }
    .trade-side {
      flex: 1;
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      max-width: 300px;
    }
    .trade-arrow {
      font-size: 24px;
      color: #3498db;
    }
    .value-comparison {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      font-size: 0.9em;
    }
    .better-value { color: #2ecc71; }
    .worse-value { color: #e74c3c; }
    .equal-value { color: #f1c40f; }
    .trade-selection {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .selected-sneakers {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .selected-sneaker {
      background: #2c3e50;
      padding: 8px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .remove-sneaker {
      background: #c0392b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .ai-trader-info {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .ai-avatar {
      width: 50px;
      height: 50px;
      background: #34495e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .ai-details {
      flex-grow: 1;
    }
    .ai-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    .ai-preference {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .negotiation-options {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .negotiation-btn {
      background: #34495e;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .negotiation-btn:hover {
      background: #2c3e50;
    }
    .ai-response {
      margin: 10px 0;
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
      font-style: italic;
    }
    .purchase-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .resell-agent {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .agent-level {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .level-indicator {
      display: flex;
      gap: 3px;
    }
    .level-star {
      color: #f1c40f;
    }
    .agent-bonus {
      color: #2ecc71;
    }
    .staff-section {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .staff-member {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .staff-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .staff-status {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .staff-stats {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 0.9em;
    }
    .staff-cost {
      color: #f1c40f;
    }
    .agent-types {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .agent-card {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      min-width: 200px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .agent-card:hover {
      transform: translateY(-5px);
    }
    .agent-card.selected {
      border: 2px solid #3498db;
    }
    .breaking-news {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      animation: slideDown 0.5s ease-out, glow 2s infinite;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      text-align: center;
      min-width: 300px;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
      100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
    }
    .news-header {
      font-size: 1.5em;
      margin-bottom: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .news-content {
      font-size: 1.2em;
      line-height: 1.4;
      margin: 10px 0;
    }
    .news-timer {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
      width: 100%;
    }
    .news-timer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.8);
      transform-origin: left;
    }
    .news-timer.animate::after {
      animation: newsTimer 5s linear forwards;
    }
    @keyframes newsTimer {
      0% { transform: scaleX(1); }
      100% { transform: scaleX(0); }
    }
    .trader-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .trader-card {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      text-align: left;
    }
    .trader-card:hover {
      transform: translateY(-5px);
    }
    .trader-card.selected {
      border: 2px solid #3498db;
    }
    .trader-avatar {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .trader-info {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .limited-offers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .limited-offer {
      position: relative;
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .offer-timer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9em;
    }

    .staff-hire-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .staff-hire-modal.show {
      display: block;
    }
    .staff-hire-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .staff-hire-item {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .staff-hire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .staff-hire-cost {
      color: #f1c40f;
      font-weight: bold;
    }
    .test-buttons {
      position: fixed;
      left: -9999px;
      visibility: hidden;
    }
    .test-button {
      background: #8e44ad;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .test-button:hover {
      background: #9b59b6;
    }
    
    /* New styles for clicker, used market, and cleaning game */
    .clicker-button {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.1s;
      margin: 20px auto;
      display: block;
    }
    
    .clicker-button:active {
      transform: scale(0.95);
    }
    
    .used-market {
      margin: 20px 0;
    }
    
    .used-sneaker {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sneaker Pack Tycoon</title>
  <style>
    body { font-family: Arial, sans-serif; background-color: #2c3e50; color: white; text-align: center; }
    h1 { margin-top: 20px; }
    .container { margin: 20px; }
    .coins { font-size: 24px; margin-bottom: 20px; }
    .pack-select, .pack-button { padding: 10px 20px; font-size: 18px; margin: 10px; }
    .pack-button { cursor: pointer; background-color: #2980b9; color: white; border: none; border-radius: 5px; }
    .inventory, .market, .settings, .daily, .trading { margin-top: 20px; }
    .inventory div, .market div, .trading div { background: #34495e; margin: 10px; padding: 10px; border-radius: 8px; }
    .sneaker-card { margin-bottom: 10px; }
    .rarity-common { color: #7f8c8d; }
    .rarity-rare { color: #2980b9; }
    .rarity-epic { color: #8e44ad; }
    .rarity-legendary { color: #f39c12; font-weight: bold; }
    .modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      background: #222;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
      z-index: 1000;
      pointer-events: none;
    }
    .modal.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      visibility: hidden;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 999;
      pointer-events: none;
    }
    .modal-overlay.show {
      visibility: visible;
      opacity: 1;
      pointer-events: all;
    }
    .card-container {
      margin: 20px auto;
      display: flex;
      flex-direction: row;
      align-items: center;
      position: relative;
      height: 200px;
      width: 600px;
      overflow: hidden;
      background: #222;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
    }
    .casino-roll-track {
      display: flex;
      flex-direction: row;
      align-items: center;
      transition: transform 2s cubic-bezier(0.23, 1, 0.32, 1);
      will-change: transform;
      height: 100%;
    }
    .casino-roll-card {
      background-color: #34495e;
      color: white;
      padding: 20px;
      border-radius: 8px;
      width: 180px;
      height: 150px;
      margin: 0 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
      font-size: 1em;
      transition: box-shadow 0.2s, transform 0.2s;
      }
    .casino-roll-card.selected {
      /* No border, no color change, no highlight */
      /* Just use normal card style */
    }
    select.pack-select { background: #34495e; color: white; border: 1px solid #2980b9; border-radius: 5px; }
    .inventory-list-flex {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
    }
    .sneaker-card {
      background: #34495e;
      margin: 5px;
      padding: 8px;
      border-radius: 8px;
      min-width: 100px;
      max-width: 140px;
      flex: 1 1 120px;
      font-size: 14px;
      transition: font-size 0.2s, min-width 0.2s, max-width 0.2s;
      width: calc(100% / 5 - 16px);
    }
    @media (max-width: 700px) {
      .inventory-list-flex .sneaker-card {
        width: calc(100% / 2 - 16px);
      }
    }
    @media (max-width: 500px) {
      .inventory-list-flex .sneaker-card {
        width: 100%;
      }
    }
    #trade-dropdown {
      margin: 10px 0;
      padding: 6px 12px;
      font-size: 16px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
      width: 90%;
      max-width: 300px;
    }
    .trade-offer { margin-top: 15px; }
    .close-btn { background: #c0392b; color: white; border: none; border-radius: 5px; padding: 6px 14px; cursor: pointer; margin-top: 10px;}
    .settings {
      margin-top: 20px;
      background: #34495e;
      padding: 20px;
      border-radius: 8px;
      max-width: 600px;
      margin-left: auto;
      margin-right: auto;
    }
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      text-align: left;
      margin-top: 15px;
    }
    .settings-item {
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
    }
    .settings-item label {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .settings input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }
    .settings input[type="range"] {
      width: 100%;
      margin: 10px 0;
    }
    .settings select {
      width: 100%;
      padding: 5px;
      background: #34495e;
      color: white;
      border: 1px solid #2980b9;
      border-radius: 5px;
    }
    .volume-value {
      font-size: 14px;
      color: #bdc3c7;
    }
    .no-animations * {
      animation: none !important;
      transition: none !important;
    }
    .inventory-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 10px; }
    .inventory-list .sneaker-card { max-width: 100%; width: 100%; }
    .inventory-compact .sneaker-card { font-size: 12px; padding: 5px; }
    .top-right-buttons {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      gap: 10px;
      z-index: 100;
    }
    .history-btn, .settings-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: transform 0.2s, background-color 0.2s;
    }
    .history-btn:hover, .settings-btn:hover {
      background: #3498db;
      transform: scale(1.1);
    }
    .purchase-history {
      max-height: 400px;
      overflow-y: auto;
      margin-top: 20px;
    }
    .purchase-item {
      background: #2c3e50;
      margin: 10px 0;
      padding: 10px;
      border-radius: 5px;
      text-align: left;
    }
    .purchase-time {
      color: #7f8c8d;
      font-size: 0.9em;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    .modal-header h2 {
      margin: 0;
    }
    .limited-offer {
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 20px;
      border-radius: 8px;
      margin: 15px auto;
      max-width: 600px;
      position: relative;
      overflow: hidden;
    }
    .limited-offer::before {
      content: "Limited Time!";
      position: absolute;
      top: 10px;
      right: -30px;
      background: #e74c3c;
      color: white;
      padding: 5px 40px;
      transform: rotate(45deg);
      font-size: 12px;
    }
    .offer-timer {
      color: #ecf0f1;
      font-size: 1.2em;
      margin: 10px 0;
    }
    .offer-content {
      display: flex;
      align-items: center;
      justify-content: space-around;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    .offer-sneaker {
      background: rgba(0, 0, 0, 0.2);
      padding: 15px;
      border-radius: 8px;
      min-width: 200px;
    }
    .roll-animation {
      animation: rollEffect 1s ease-out;
    }
    @keyframes rollEffect {
      0% { transform: translateY(-100px) rotate(-180deg); opacity: 0; }
      70% { transform: translateY(20px) rotate(20deg); opacity: 0.7; }
      100% { transform: translateY(0) rotate(0deg); opacity: 1; }
    }
    .roll-container {
      position: relative;
      height: 150px;
      width: 200px;
      overflow: hidden;
      background: #2c3e50;
      border-radius: 8px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .roll-item {
      position: absolute;
      width: 180px;
      height: 130px;
      padding: 10px;
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #34495e;
      box-sizing: border-box;
      border-radius: 5px;
      transition: all 0.05s;
      opacity: 0;
      transform: scale(0.9);
      left: 50%;
      margin-left: -90px;
    }
    .roll-item.active {
      opacity: 1;
      transform: scale(1);
    }
    .roll-item.final {
      animation: popIn 0.3s ease-out forwards !important;
      opacity: 1;
    }
    @keyframes popIn {
      0% { transform: scale(0.8); }
      50% { transform: scale(1.1); }
      100% { transform: scale(1); }
    }
    .roll-flash {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      opacity: 0;
      pointer-events: none;
      z-index: 2;
    }
    .roll-item strong {
      display: block;
      margin-bottom: 5px;
    }
    .roll-item span {
      display: block;
      margin: 2px 0;
    }
    @keyframes flashEffect {
      0% { opacity: 0; }
      50% { opacity: 0.5; }
      100% { opacity: 0; }
    }
    .trade-comparison {
      display: flex;
      justify-content: space-around;
      align-items: center;
      margin: 20px 0;
      gap: 20px;
    }
    .trade-side {
      flex: 1;
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      max-width: 300px;
    }
    .trade-arrow {
      font-size: 24px;
      color: #3498db;
    }
    .value-comparison {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      font-size: 0.9em;
    }
    .better-value { color: #2ecc71; }
    .worse-value { color: #e74c3c; }
    .equal-value { color: #f1c40f; }
    .trade-selection {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
    }
    .selected-sneakers {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 10px 0;
    }
    .selected-sneaker {
      background: #2c3e50;
      padding: 8px;
      border-radius: 5px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .remove-sneaker {
      background: #c0392b;
      color: white;
      border: none;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .ai-trader-info {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 15px;
    }
    .ai-avatar {
      width: 50px;
      height: 50px;
      background: #34495e;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    .ai-details {
      flex-grow: 1;
    }
    .ai-name {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
    .ai-preference {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .negotiation-options {
      display: flex;
      gap: 10px;
      margin: 15px 0;
      flex-wrap: wrap;
      justify-content: center;
    }
    .negotiation-btn {
      background: #34495e;
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .negotiation-btn:hover {
      background: #2c3e50;
    }
    .ai-response {
      margin: 10px 0;
      padding: 10px;
      background: #2c3e50;
      border-radius: 5px;
      font-style: italic;
    }
    .purchase-notification {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #27ae60;
      color: white;
      padding: 15px 20px;
      border-radius: 5px;
      animation: slideIn 0.3s ease-out;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    .resell-agent {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .agent-level {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0;
    }
    .level-indicator {
      display: flex;
      gap: 3px;
    }
    .level-star {
      color: #f1c40f;
    }
    .agent-bonus {
      color: #2ecc71;
    }
    .staff-section {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .staff-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    .staff-member {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .staff-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .staff-status {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .staff-stats {
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 0.9em;
    }
    .staff-cost {
      color: #f1c40f;
    }
    .agent-types {
      display: flex;
      gap: 15px;
      margin-bottom: 15px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .agent-card {
      background: #34495e;
      padding: 15px;
      border-radius: 5px;
      min-width: 200px;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .agent-card:hover {
      transform: translateY(-5px);
    }
    .agent-card.selected {
      border: 2px solid #3498db;
    }
    .breaking-news {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255, 0, 0, 0.9);
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      font-weight: bold;
      z-index: 1000;
      display: none;
      animation: slideDown 0.5s ease-out, glow 2s infinite;
      box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
      text-align: center;
      min-width: 300px;
    }

    @keyframes slideDown {
      from {
        transform: translateX(-50%) translateY(-100%);
        opacity: 0;
      }
      to {
        transform: translateX(-50%) translateY(0);
        opacity: 1;
      }
    }

    @keyframes glow {
      0% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
      50% { box-shadow: 0 0 20px rgba(255, 0, 0, 0.8); }
      100% { box-shadow: 0 0 10px rgba(255, 0, 0, 0.5); }
    }
    .news-header {
      font-size: 1.5em;
      margin-bottom: 10px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
    }
    .news-content {
      font-size: 1.2em;
      line-height: 1.4;
      margin: 10px 0;
    }
    .news-timer {
      position: absolute;
      bottom: 0;
      left: 0;
      height: 4px;
      background: rgba(255,255,255,0.3);
      width: 100%;
    }
    .news-timer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.8);
      transform-origin: left;
    }
    .news-timer.animate::after {
      animation: newsTimer 5s linear forwards;
    }
    @keyframes newsTimer {
      0% { transform: scaleX(1); }
      100% { transform: scaleX(0); }
    }
    .trader-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .trader-card {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      text-align: left;
    }
    .trader-card:hover {
      transform: translateY(-5px);
    }
    .trader-card.selected {
      border: 2px solid #3498db;
    }
    .trader-avatar {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .trader-info {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .limited-offers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .limited-offer {
      position: relative;
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .offer-timer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9em;
    }

    .staff-hire-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .staff-hire-modal.show {
      display: block;
    }
    .staff-hire-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .staff-hire-item {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .staff-hire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .staff-hire-cost {
      color: #f1c40f;
      font-weight: bold;
    }
    .test-buttons {
      position: fixed;
      left: -9999px;
      visibility: hidden;
    }
    .test-button {
      background: #8e44ad;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .test-button:hover {
      background: #9b59b6;
    }
    
    /* New styles for clicker, used market, and cleaning game */
    .clicker-button {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.1s;
      margin: 20px auto;
      display: block;
    }
    
    .clicker-button:active {
      transform: scale(0.95);
    }
    
    .used-market {
      margin: 20px 0;
    }
    
    .used-sneaker {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      transition: width 0.3s;
    }
    
    .cleaning-game {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      width: 90%;
      max-width: 500px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .cleaning-game.show {
      display: block;
    }
    
    .cleaning-info {
      margin: 15px 0;
      padding: 10px;
      background: #34495e;
      border-radius: 8px;
    }
    
    .sneaker-canvas {
      background: #34495e;
      border-radius: 8px;
      margin: 10px auto;
      cursor: pointer;
      display: block;
      max-width: 100%;
      height: auto;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      width: 0;
      transition: width 0.3s;
    }
    
    #used-market-modal {
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #34495e;
      border-radius: 8px 8px 0 0;
      margin: -20px -20px 20px -20px;
    }
    
    .modal-header h2 {
      margin: 0;
      color: white;
    }
    
    .click-count {
      font-size: 18px;
      color: #3498db;
      margin: 10px 0;
    }
    
    .used-market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
      max-height: 70vh;
      overflow-y: auto;
      padding: 15px;
    }

    /* Comprehensive light mode styles */
    .light-mode {
      background-color: #f5f6fa;
      color: #2c3e50;
    }
    
    .light-mode .sneaker-card,
    .light-mode .modal,
    .light-mode .settings-item,
    .light-mode .trade-side,
    .light-mode .ai-trader-info,
    .light-mode .ai-response,
    .light-mode .selected-sneaker,
    .light-mode .purchase-item {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .light-mode .modal-overlay {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .light-mode .pack-button,
    .light-mode .negotiation-btn,
    .light-mode .close-btn {
      background-color: #3498db;
      color: white;
    }
    
    .light-mode .pack-button:hover,
    .light-mode .negotiation-btn:hover {
      background-color: #2980b9;
    }
    
    .light-mode .modal-header {
      background-color: #f8f9fa;
      color: #2c3e50;
    }
    
    .light-mode select {
      background-color: #ffffff;
      color: #2c3e50;
      border-color: #bdc3c7;
    }

    /* Fix sneaker positioning in popups */
    .card {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
    }

    .roll-item {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
      width: 180px;
      height: 130px;
    }

    /* Update animations */
    @keyframes rollAndReveal {
      0% { transform: translate(-50%, -150%) rotate(-180deg); opacity: 0; }
      70% { transform: translate(-50%, -30%) rotate(20deg); opacity: 0.7; }
      90% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
    }

    /* Rarity-specific reveal animations */
    .reveal-common {
      animation: rollAndReveal 0.8s ease-out, fadeIn 0.3s ease-out 0.8s !important;
    }
    
    .reveal-uncommon {
      animation: rollAndReveal 0.8s ease-out, glowGreen 0.3s ease-out 0.8s !important;
    }
    
    .reveal-rare {
      animation: rollAndReveal 0.8s ease-out, glowBlue 0.3s ease-out 0.8s !important;
    }
    
    .reveal-epic {
      animation: rollAndReveal 0.8s ease-out, glowPurple 0.3s ease-out 0.8s !important;
    }
    
    .reveal-legendary {
      animation: rollAndReveal 0.8s ease-out, explodeGold 0.3s ease-out 0.8s !important;
    }

    @keyframes glowGreen {
      0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(46, 204, 113, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
    }

    @keyframes glowBlue {
      0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(52, 152, 219, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
    }

    @keyframes glowPurple {
      0% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(155, 89, 182, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
    }

    @keyframes explodeGold {
      0% { transform: translate(-50%, -50%) scale(0.8); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); }
      50% { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 30px 15px rgba(241, 196, 15, 0.4); }
      100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
    }

    /* Additional light mode styles */
    .light-mode .cleaning-game {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .light-mode .cleaning-game .modal-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .light-mode .cleaning-game .modal-header h2 {
      color: #2c3e50;
    }

    .light-mode .limited-offer {
      background: linear-gradient(45deg, #3498db, #9b59b6);
      color: white;
    }

    .light-mode .offer-sneaker {
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50;
    }

    .light-mode .rarity-common { color: #7f8c8d; }
    .light-mode .rarity-uncommon { color: #27ae60; }
    .light-mode .rarity-rare { color: #2980b9; }
    .light-mode .rarity-epic { color: #8e44ad; }
    .light-mode .rarity-legendary { color: #f39c12; }

    .light-mode .better-value { color: #27ae60; }
    .light-mode .worse-value { color: #e74c3c; }
    .light-mode .equal-value { color: #f1c40f; }

    .light-mode .purchase-notification {
      background: #27ae60;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Market buyer upgrade system */
    .market-buyers-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }

    .market-buyer-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #34495e;
      border-radius: 5px;
      gap: 10px;
    }

    .market-buyer-option.active {
      background: #2ecc71;
    }

    .light-mode .market-buyer-option {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
    }

    .light-mode .market-buyer-option.active {
      background: #d4edda;
      border-color: #c3e6cb;
    }

    /* Chat area styles */
    .trade-chat { max-height: 180px; overflow-y: auto; background: #222; border-radius: 6px; padding: 8px; margin-bottom: 10px; text-align: left; }
    .trade-chat-msg { margin: 4px 0; padding: 4px 8px; border-radius: 4px; }
    .trade-chat-msg.ai-msg { background: #34495e; color: #f1c40f; }
    .trade-chat-msg.player-msg { background: #2980b9; color: #fff; text-align: right; }
    /* Trade chat: hacker font */
    .trade-chat, .trade-chat-msg { font-family: 'Fira Mono', 'Consolas', 'monospace'; letter-spacing: 0.5px; }

    /* Prestige system styles */
    .prestige-button {
      background: linear-gradient(45deg, #f39c12, #e74c3c);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .prestige-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.3);
    }
    
    .prestige-button:disabled {
      background: linear-gradient(45deg, #95a5a6, #7f8c8d);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .prestige-info {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    
    .prestige-level {
      font-size: 24px;
      color: #f39c12;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .prestige-bonus {
      font-size: 16px;
      color: #3498db;
      margin: 5px 0;
    }
    
    .prestige-progress {
      background: #2c3e50;
      height: 20px;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .prestige-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #f39c12);
      width: 0%;
      transition: width 0.5s;
    }
    
    .prestige-modal {
      text-align: center;
    }
    
    .prestige-benefits {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }
    
    .prestige-modal h3 {
      color: #f39c12;
      margin: 10px 0;
    }
    
    .prestige-confirm-btn {
      background: #e74c3c;
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
    }
    
    .prestige-stars {
      font-size: 28px;
      color: #f39c12;
      letter-spacing: 5px;
      margin: 10px 0;
    }

    .prestige-milestone {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .prestige-milestone.achieved {
      background: rgba(46, 204, 113, 0.2);
    }
    
    .prestige-milestone.next {
      background: rgba(52, 152, 219, 0.2);
      border: 1px dashed #3498db;
    }
    
    .milestone-level {
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    
    .milestone-emoji {
      font-size: 20px;
      min-width: 30px;
      text-align: center;
    }
    
    .prestige-milestone-summary {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }

    /* Save code system styles */
    .save-code-container {
      margin: 15px 0;
      text-align: center;
    }
    
    .save-code-textarea {
      width: 90%;
      height: 80px;
      background: #2c3e50;
      border: 1px solid #34495e;
      border-radius: 5px;
      color: #ecf0f1;
      padding: 10px;
      margin: 10px 0;
      font-family: monospace;
      resize: none;
    }
    
    .save-code-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    .save-code-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
    }
    
    .save-code-btn:hover {
      background: #3498db;
    }
    
    .save-code-info {
      font-size: 0.9em;
      color: #95a5a6;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div id="breaking-news" class="breaking-news"></div>
  <div class="modal-overlay" id="modal-overlay" onclick="closeAllModals()"></div>
  <div class="top-right-buttons">
    <button class="history-btn" onclick="openHistory()" title="Purchase History">üìú</button>
    <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
  </div>
  <header>
    <h1>Sneaker Pack Tycoon</h1>
    <div class="coins">Coins: <span id="coin-count">0</span></div>
  </header>
  <div class="container">
    <button class="clicker-button" onclick="handleClick()">
      Click!
      <div class="click-count">Clicks: 0</div>
    </button>
    <div class="prestige-info">
      <div class="prestige-level">Prestige Level: <span id="prestige-level">0</span></div>
      <div class="prestige-bonus" id="prestige-bonuses"></div>
      <div class="prestige-progress">
        <div class="prestige-progress-fill" id="prestige-progress-fill"></div>
      </div>
      <button class="prestige-button" id="prestige-button" onclick="openPrestigeModal()">PRESTIGE</button>
    </div>
    <div>
      <select id="pack-type" class="pack-select">
        <option value="standard">Standard Pack (100 Coins)</option>
        <option value="premium">Premium Pack (300 Coins)</option>
        <option value="colorway">Colorway Pack (200 Coins)</option>
        <option value="rare">Rare Pack (400 Coins)</option>
        <option value="epic">Epic Pack (700 Coins)</option>
        <option value="legendary">Legendary Pack (2500 Coins)</option>
        <option value="mystery">Mystery Pack (500 Coins)</option>
        <option value="ultra">Ultra Pack (1200 Coins)</option>
        <option value="hype">Hype Pack (900 Coins)</option>
        <option value="classic">Classic Pack (250 Coins)</option>
        <option value="collab">Collab Pack (1500 Coins)</option>
        <option value="seasonal">Seasonal Pack (600 Coins)</option>
      </select>
      <button class="pack-button" onclick="openPack()">Open Pack</button>
      <button class="pack-button" style="margin-left:8px;" onclick="previewPack()">Pack Preview</button>
    </div>
    <div class="daily">
      <h2>Daily Rewards</h2>
      <button class="pack-button" onclick="claimDaily()">Claim Daily Coins</button>
    </div>
    <div class="upgrades">
      <h2>Store Upgrades</h2>
      <button class="pack-button" onclick="openUsedMarket()">Browse Used Sneakers</button>
      <div class="resell-agent">
        <h3>Resell Agents</h3>
        <div class="agent-types" id="agent-types">
          <!-- Agent types will be inserted here -->
        </div>
        <div class="agent-level">
          Level: <div class="level-indicator" id="agent-level"></div>
        </div>
        <div class="agent-bonus" id="agent-bonus"></div>
        <button class="pack-button" id="upgrade-agent-btn" onclick="upgradeResellAgent()">Upgrade Agent</button>
      </div>
      <div class="staff-section">
        <h3>Automated Staff</h3>
        <button class="pack-button" onclick="openHireStaff()">Hire Staff</button>
        <div class="staff-grid" id="staff-grid">
          <!-- Staff members will be inserted here -->
        </div>
      </div>
    </div>
    <div class="inventory">
      <h2>Your Inventory</h2>
      <div id="inventory-list" class="inventory-list-flex"></div>
    </div>
    <div class="trading">
      <h2>AI Trading System (Sneaker-for-Sneaker)</h2>
      <button class="pack-button" onclick="openTradeUI()">Enter Trade</button>
    </div>
  <div class="modal" id="used-market-modal">
    <div class="modal-header">
      <h2>Used Sneaker Market</h2>
      <button class="close-btn" onclick="closeUsedMarket()">Close</button>
    </div>
    <div class="used-market-grid" id="used-market-grid">
      <!-- Used sneakers will be inserted here -->
    </div>
  </div>
  <div class="cleaning-game" id="cleaning-game">
    <div class="modal-header">
      <h2>Clean Your New Sneaker</h2>
      <button class="close-btn" onclick="finishCleaning()">‚úï</button>
    </div>
    <div class="cleaning-info">
      <p>Click on the dirt spots to clean them!</p>
      <div class="condition-bar">
        <div class="condition-fill" id="cleaning-progress"></div>
      </div>
    </div>
    <canvas id="sneaker-canvas" class="sneaker-canvas" width="400" height="300"></canvas>
    <button class="pack-button" onclick="finishCleaning()">Finish Cleaning</button>
  </div>
  <div class="modal" id="pack-modal">
    <div id="modal-content">
      <h2>Opening Pack...</h2>
      <div id="card-container" class="card-container"></div>
      <button id="next-sneaker-btn" onclick="revealNextSneaker()">Next Sneaker</button>
    </div>
  </div>
  <div class="modal" id="trade-modal">
    <div>
      <h2>Select Trader</h2>
      <div class="trader-selection" id="trader-selection">
        <!-- Trader cards will be inserted here -->
      </div>
      <div id="ai-trader" class="ai-trader-info" style="display: none;">
        <!-- AI trader info will be inserted here -->
      </div>
      <div class="trade-selection">
        <div><b>Select sneakers to offer:</b></div>
      <select id="trade-dropdown"></select>
        <button class="pack-button" onclick="addToTrade()">Add to Trade</button>
        <div id="selected-sneakers" class="selected-sneakers"></div>
      </div>
      <div class="trade-comparison">
        <div class="trade-side" id="your-offer">
          <h3>Your Offer</h3>
          <div class="offer-details"></div>
        </div>
        <div class="trade-arrow">‚ÜîÔ∏è</div>
        <div class="trade-side" id="ai-offer">
          <h3>AI's Offer</h3>
          <div class="offer-details"></div>
        </div>
      </div>
      <div id="ai-response" class="ai-response"></div>
      <div class="negotiation-options" id="negotiation-options"></div>
      <div id="trade-offer" class="trade-offer"></div>
      <div id="trade-chat" class="trade-chat"></div>
      <button class="close-btn" onclick="closeTradeUI()">Close</button>
    </div>
  </div>
  <div class="modal" id="settings-modal">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="close-btn" onclick="closeSettings()">Close</button>
    </div>
    <div class="settings-grid">
      <div class="settings-item">
        <label>
          <input type="checkbox" id="animation-toggle" onclick="toggleAnimation()">
          Show Animations
        </label>
      </div>
      <div class="settings-item">
        <label>
          <input type="checkbox" id="notification-toggle" onclick="toggleNotifications()">
          Show Notifications
        </label>
      </div>
      <div class="settings-item">
        <label for="display-mode">Display Mode</label>
        <select id="display-mode" onchange="updateDisplayMode()">
          <option value="grid">Grid View</option>
          <option value="list">List View</option>
          <option value="compact">Compact View</option>
        </select>
      </div>
      <div class="settings-item">
        <label for="currency-display">Currency Display</label>
        <select id="currency-display" onchange="updateCurrencyDisplay()">
          <option value="coins">Coins</option>
          <option value="k">K Format (1K, 2K)</option>
          <option value="full">Full Number</option>
        </select>
      </div>
      <div class="settings-item">
        <label for="sort-inventory">Default Sort</label>
        <select id="sort-inventory" onchange="updateDefaultSort()">
          <option value="rarity">By Rarity</option>
          <option value="value">By Value</option>
          <option value="brand">By Brand</option>
          <option value="newest">Newest First</option>
        </select>
      </div>
      <div class="settings-item">
        <label>
          <input type="checkbox" id="light-mode-toggle" onclick="toggleLightMode()">
          Light Mode
        </label>
      </div>
      <div class="settings-item">
        <label><input type="checkbox" id="skip-animation-toggle" onclick="toggleSkipAnimation()"> Skip Pack Animation</label>
      </div>
    </div>
    
    <div class="save-code-container">
      <!-- Save import/export removed -->
    </div>
  </div>
  <div class="modal" id="history-modal">
    <div class="modal-header">
      <h2>Purchase History</h2>
      <button class="close-btn" onclick="closeHistory()">Close</button>
    </div>
    <div class="purchase-history" id="purchase-history">
      <!-- Purchase history items will be added here -->
    </div>
  </div>
  <div class="staff-hire-modal" id="staff-hire-modal">
    <div class="modal-header">
      <h2>Hire Staff</h2>
      <button class="close-btn" onclick="closeHireStaff()">Close</button>
    </div>
    <div class="staff-hire-list" id="staff-hire-list">
      <!-- Staff hire options will be inserted here -->
    </div>
  </div>
  <div class="test-buttons">
    <button class="test-button" onclick="showBreakingNews(true)">Test Breaking News</button>
  </div>
  <div class="modal" id="prestige-modal">
    <div class="modal-header">
      <h2>Prestige System</h2>
      <button class="close-btn" onclick="closePrestigeModal()">Close</button>
    </div>
    <div class="prestige-modal">
      <div class="prestige-stars" id="prestige-stars">‚òÖ</div>
      <p>You've reached <span id="prestige-coins-display">100,000</span> coins!</p>
      <p>Are you ready to prestige and reset your progress for permanent bonuses?</p>
      
      <div class="prestige-benefits">
        <h3>Benefits of Prestige Level <span id="next-prestige-level">1</span>:</h3>
        <ul id="prestige-benefits-list">
          <li>Reduced base pack costs (90 coins)</li>
          <li>Increased click value (1 coin per click)</li>
          <li>Keep your prestige bonuses forever</li>
        </ul>
      </div>
      
      <h3>Prestige Milestones:</h3>
      <div id="prestige-milestones">
        <!-- Milestone list will be added here -->
      </div>
      
      <p><strong>Warning:</strong> You will lose all your coins, inventory items, and staff!</p>
      
      <button class="pack-button prestige-confirm-btn" onclick="confirmPrestige()">PRESTIGE NOW</button>
    </div>
  </div>
  <script>
    // Initialize game state
    let coins = 0;
    let inventory = [];
    let purchaseHistory = [];
    let prestigeLevel = 0;
    let clickValue = 1; // 1 coin per click at base (modified by prestige)
    let clicksNeeded = 2; // Number of clicks needed for 1 coin (modified by prestige)
    let clickCounter = 0; // Counter for current clicks
    let inventoryCapacityBonus = 0; // Additional inventory slots from prestige
    let rarityMultiplier = 1; // Multiplier for rarity chances
    let extraSneakerChance = 0; // Chance for extra sneaker in packs
    let passiveIncomeRate = 0; // Passive income per second
    let passiveIncomeInterval = null; // Interval for passive income
    let autoSellCommon = false; // Auto-sell common items
    let freePackChance = 0; // Chance for free packs
    let legendaryBoost = 0; // Boost to legendary chances
    let doubleSaleChance = 0; // Chance for double sale value
    let settings = {
      soundEnabled: true,
      musicEnabled: true,
      soundVolume: 0.5,
      musicVolume: 0.3,
      notifications: true,
      animations: true,
      autoSell: false,
      currencyDisplay: 'full',
      displayMode: 'grid',
      defaultSort: 'rarity',
      rollAnimation: true,
      volume: 50,
      lightMode: false,
      skipPackAnimation: false
    };

    // Initialize game state from save or defaults
    function initializeGame() {
      const savedState = localStorage.getItem('sneakerHustleGameState');
      
      if (savedState) {
        try {
          const gameState = JSON.parse(savedState);
          
          // Restore basic values
          coins = gameState.coins ?? 10000;
          inventory = gameState.inventory || [];
          purchaseHistory = gameState.purchaseHistory || [];
          
          // Restore prestige level
          prestigeLevel = gameState.prestigeLevel || 0;
          
          // Apply prestige bonuses
          applyPrestigeBonuses();
          
          // Restore settings
          if (gameState.settings) {
            settings = {...settings, ...gameState.settings};
          }
          
          // Restore market buyer
          if (gameState.currentMarketBuyer) {
            currentMarketBuyer = gameState.currentMarketBuyer;
          }
          
          // Restore limited offers
          if (gameState.limitedOffers) {
            limitedOffers = new Map(gameState.limitedOffers);
        }
          
          // Restore multipliers
          if (gameState.activeMultipliers) {
            window.globalMultiplier = gameState.activeMultipliers.global;
            window.brandMultipliers = gameState.activeMultipliers.brand;
            window.coinMultiplier = gameState.activeMultipliers.coin;
          }
          
          // Restore trader state
          if (gameState.currentTrader) {
            window.currentTrader = gameState.currentTrader;
            window.lastTraderResponse = gameState.lastTraderResponse;
          }
          if (gameState.hiredStaff) {
            hiredStaff = gameState.hiredStaff;
          }
          if (gameState.resellAgentLevel !== undefined) {
            resellAgent.level = gameState.resellAgentLevel;
          }
          if (gameState.storageUpgrades !== undefined) {
            storageUpgrades = gameState.storageUpgrades;
          }
          if (gameState.storageCost !== undefined) {
            storageCost = gameState.storageCost;
          }
        } catch (error) {
          console.error('Error loading game state:', error);
          setDefaultState();
        }
        } else {
        setDefaultState();
      }
      
      // Update all UI elements
      updateAllDisplays();
      updateStorageDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Set default state for new games
    function setDefaultState() {
      coins = 1000;
      inventory = [];
      purchaseHistory = [];
      prestigeLevel = 0;
      clickValue = 0.5; // Default click value
      settings = {
        soundEnabled: true,
        musicEnabled: true,
        soundVolume: 0.5,
        musicVolume: 0.3,
        notifications: true,
        animations: true,
        autoSell: false,
        currencyDisplay: 'full',
        displayMode: 'grid',
        defaultSort: 'rarity',
        rollAnimation: true,
        volume: 50,
        lightMode: false,
        skipPackAnimation: false
      };
      hiredStaff = [];
      resellAgent.level = 0;
      storageUpgrades = 0;
      storageCost = 300;
      if (document.getElementById('storage-cost')) document.getElementById('storage-cost').textContent = storageCost;
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Update all UI displays
    function updateAllDisplays() {
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      updateLimitedOffers();
      updateMarketBuyerDisplay();
      updatePrestigeDisplay();
      applySettings();
    }

    // Save game state
    function saveGameState() {
      const gameState = {
        coins,
        inventory,
        purchaseHistory,
        settings,
        currentMarketBuyer,
        limitedOffers: Array.from(limitedOffers.entries()),
        activeMultipliers: {
          global: window.globalMultiplier || 1,
          brand: window.brandMultipliers || {},
          coin: window.coinMultiplier || 1
        },
        currentTrader: window.currentTrader,
        lastTraderResponse: window.lastTraderResponse,
        hiredStaff,
        resellAgentLevel: resellAgent.level,
        storageUpgrades,
        storageCost,
        prestigeLevel
      };
      
      localStorage.setItem('sneakerHustleGameState', JSON.stringify(gameState));
    }

    // Initialize when the page loads
    window.addEventListener('load', () => {
      initializeGame();
      generateNewsEvent();
      
      // Set up auto-save
      setInterval(saveGameState, 300000); // Every 5 minutes
    });

    // Save before unloading
    window.addEventListener('beforeunload', saveGameState);

    // Initialize game variables
    let upgrades = { betterOdds: false, storageExpand: false };
    let totalProfit = 0;
    let currentSneakers = [];
    let currentSneakerIndex = 0;
    let currentOffer = null;
    let offerInterval = null;
    let selectedTradeItems = [];
    let activeEvents = new Map();
    let clickCount = 0;
    let currentCleaningSneaker = null;
    let dirtSpots = [];
    let cleaningInProgress = false;

    // News Events Data
    const newsEvents = [
      {
        type: "celebrity",
        templates: [
          "{celebrity} spotted wearing {sneaker}! Prices {direction}!",
          "Breaking: {celebrity} signs deal with {sneaker} brand!",
          "{celebrity}'s {sneaker} collection causing market frenzy!"
        ],
        valueEffect: [0.2, 0.5], // 20-50% increase
        duration: 300000 // 5 minutes
      },
      {
        type: "market",
        templates: [
          "Market Alert: {sneaker} prices {direction} rapidly!",
          "Unexpected demand surge for {sneaker}!",
          "Rare {sneaker} batch discovered! Market adjusting!"
        ],
        valueEffect: [-0.3, 0.3], // -30% to +30%
        duration: 600000 // 10 minutes
      },
      {
        type: "trend",
        templates: [
          "TikTok trend featuring {sneaker} goes viral!",
          "Fashion influencers can't get enough of {sneaker}!",
          "Street style: {sneaker} becomes must-have item!"
        ],
        valueEffect: [0.1, 0.4], // 10-40% increase
        duration: 450000 // 7.5 minutes
      }
    ];

    // Add more celebrities and events
    const celebrities = [
      // Musicians
      "Drake", "Travis Scott", "Kanye West", "Bad Bunny", "The Weeknd",
      "Taylor Swift", "Billie Eilish", "Post Malone", "J Balvin", "BTS",
      "Rihanna", "Jay-Z", "Eminem", "Lil Baby", "Tyler, The Creator",
      
      // Athletes
      "LeBron James", "Cristiano Ronaldo", "Lionel Messi", "Kevin Durant",
      "Stephen Curry", "Neymar Jr", "Kylian Mbapp√©", "Giannis Antetokounmpo",
      "Zion Williamson", "Ja Morant", "Erling Haaland", "Luka Donƒçiƒá",
      
      // Entertainers
      "Zendaya", "Tom Holland", "Michael B. Jordan", "Ryan Reynolds",
      "Donald Glover", "Kevin Hart", "Margot Robbie", "Timoth√©e Chalamet",
      
      // Fashion/Social
      "Kylie Jenner", "Bella Hadid", "A$AP Rocky", "Virgil Abloh",
      "Kim Kardashian", "Kendall Jenner", "Pharrell Williams", "Jerry Lorenzo"
    ];

    // Special Events with Coin Multipliers
    const specialEvents = [
      {
        type: "market_surge",
        templates: [
          "üåü MARKET SURGE: All sales give {multiplier}x coins for {duration} minutes!",
          "üí´ GOLDEN HOUR: {multiplier}x coins from all transactions for {duration} minutes!",
          "üéØ HOT MARKET: Earn {multiplier}x coins from sales for {duration} minutes!"
        ],
        rarity: 0.05, // 5% chance
        multipliers: [2, 3, 5, 10],
        durations: [2, 3, 5] // minutes
      },
      {
        type: "lucky_find",
        templates: [
          "üçÄ LUCKY FIND: Next pack has {multiplier}x better odds!",
          "‚ú® BLESSED PACK: Your next opening has {multiplier}x rarity chance!",
          "üé≤ FORTUNE FAVORS: {multiplier}x rarity boost on your next pack!"
        ],
        rarity: 0.08, // 8% chance
        multipliers: [2, 3, 5]
      },
      {
        type: "market_crash",
        templates: [
          "üìâ MARKET CRASH: All sneakers {direction} in value by {percentage}%!",
          "üí• ECONOMIC SHOCK: Global sneaker values {direction} {percentage}%!",
          "üå™ MARKET CHAOS: Sudden {percentage}% {direction} in all values!"
        ],
        rarity: 0.03, // 3% chance
        effects: [-0.5, -0.3, 0.3, 0.5]
      }
    ];

    // Card reveal effects based on rarity
    const cardEffects = {
      common: {
        animation: "fade",
        color: "#7f8c8d",
        sound: "whoosh"
      },
      rare: {
        animation: "flip",
        color: "#2980b9",
        particles: "sparkle"
      },
      epic: {
        animation: "spin",
        color: "#8e44ad",
        particles: "burst"
      },
      legendary: {
        animation: "explosion",
        color: "#f39c12",
        particles: "fireworks"
      }
    };

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function finishPackOpening() {
      inventory.push(...currentSneakers);
      updateInventory();
      
      // Close the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.remove('show');
      modalOverlay.classList.remove('show');
      
      // Reset state
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      currentSneakerIndex = 0;
      currentSneakers = [];
      
      // Re-enable all buttons
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = false;
      });
      saveGameState();
    }

    // --- 100+ Sneaker Database ---
    const brands = [
      "Nike", "Adidas", "Jordan", "Puma", "Reebok", "New Balance", "Asics", 
      "Converse", "Vans", "Saucony", "Under Armour", "Yeezy", "Off-White",
      "Balenciaga", "Gucci", "Louis Vuitton", "Alexander McQueen", "Dior"
    ];
    
    const models = [
      // Nike Models
      "Air Max 90", "Dunk Low", "Air Force 1", "SB Dunk", "Air Max 95", 
      "Air Max 97", "Air Max 1", "Air Jordan 1", "Air Jordan 4", "Air Jordan 11",
      "Air Presto", "React Element", "Blazer Mid", "Cortez", "Waffle One",
      
      // Adidas Models
      "Yeezy Boost 350", "Superstar", "Ultra Boost", "NMD R1", "Forum Low",
      "Stan Smith", "Samba", "ZX 750", "Ozweego", "Campus",
      
      // Jordan Models
      "Retro 1", "Retro 3", "Retro 4", "Retro 5", "Retro 6",
      "Retro 11", "Retro 12", "Retro 13", "Legacy 312", "XXXV",
      
      // Luxury Models
      "Triple S", "Speed Trainer", "Rhyton", "Ace", "Run Away",
      "B23 High", "Chain Reaction", "Oversized", "Wave", "Track",
      
      // Classic Models
      "Chuck Taylor", "Old Skool", "Sk8-Hi", "Era", "Authentic",
      "Club C 85", "Classic Leather", "Workout Plus", "550", "992",
      
      // Running/Athletic
      "Gel Lyte III", "Kayano 5", "Jazz Original", "Triumph", "HOVR",
      "Fresh Foam", "Kinvara", "Endorphin", "Zoom Fly", "Pegasus"
    ];
    
    const colorways = [
      // Basic Colors
      "White/Black", "Black/White", "Triple Black", "Triple White", "Navy/White",
      "Red/White", "Green/White", "Blue/White", "Grey/White", "Cream/White",
      
      // Popular Nicknames
      "Bred", "Chicago", "Royal", "Shadow", "Mocha",
      "University Blue", "Volt", "Infrared", "Cement", "Pine Green",
      
      // Special Editions
      "Travis Scott", "Off-White", "Fragment", "Union LA", "A Ma Maniere",
      "Sean Wotherspoon", "Virgil Abloh", "Sacai", "Cactus Jack", "Fear of God",
      
      // Patterns
      "Zebra", "Tiger Stripe", "Safari Print", "Snake Skin", "Tie Dye",
      "Splatter", "Gradient", "Camo", "Animal Print", "Paisley",
      
      // Materials
      "Patent Leather", "Suede", "Canvas", "Mesh", "Knit",
      "Premium Leather", "Nubuck", "Corduroy", "Denim", "Velvet",
      
      // Seasonal
      "Summer Pack", "Winter Camo", "Fall Tones", "Spring Pastels", "Holiday",
      "Valentine's Day", "Halloween", "Christmas", "Easter", "New Year",
      
      // Collaborations
      "Supreme", "Undefeated", "Concepts", "Atmos", "Patta",
      "Stussy", "Diamond Supply", "Kith", "Bodega", "SNS",
      
      // Limited Editions
      "Friends & Family", "Sample", "Prototype", "Region Exclusive", "Store Exclusive",
      "Anniversary", "Retro+", "OG", "Vintage", "Player Exclusive"
    ];

    const rarities = [
      { rarity: "common", weight: 60, value: [20, 50] },
      { rarity: "rare", weight: 25, value: [60, 150] },
      { rarity: "epic", weight: 12, value: [200, 400] },
      { rarity: "legendary", weight: 3, value: [500, 2000] }
    ];

    // Instead of generating a fixed database, generate a random sneaker on demand
    function getRandomSneaker(rarity) {
      const brand = brands[Math.floor(Math.random() * brands.length)];
      const model = models[Math.floor(Math.random() * models.length)];
      const colorway = colorways[Math.floor(Math.random() * colorways.length)];
      let baseValue = 50;
      for (let r of rarities) {
        if (r.rarity === rarity) {
          baseValue = Math.floor(r.value[0] + Math.random() * (r.value[1] - r.value[0]));
          break;
        }
      }
      return {
        id: Date.now() + Math.random(),
        brand,
        model,
        colorway,
        rarity,
        baseValue,
        image: `https://robohash.org/${encodeURIComponent(brand + '-' + model + '-' + colorway)}.png?set=set4`
      };
    }

    // --- Pack Definitions ---
    const packTypes = {
      standard: { 
        cost: 100,
        odds: { common: 0.75, rare: 0.20, epic: 0.04, legendary: 0.01 },
        bg: '#222'
      },
      premium: { 
        cost: 300,
        odds: { common: 0.45, rare: 0.35, epic: 0.15, legendary: 0.05 },
        bg: '#2980b9'
      },
      colorway: { 
        cost: 200,
        odds: { common: 0.55, rare: 0.30, epic: 0.12, legendary: 0.03 }, 
        colorway: true,
        bg: '#8e44ad'
      },
      rare: { 
        cost: 400,
        odds: { rare: 0.70, epic: 0.25, legendary: 0.05 },
        bg: '#16a085'
      },
      epic: { 
        cost: 700,
        odds: { rare: 0.25, epic: 0.60, legendary: 0.15 },
        bg: '#8e44ad'
      },
      legendary: { 
        cost: 2500,
        odds: { epic: 0.70, legendary: 0.10 },
        bg: '#f39c12'
      },
      mystery: { 
        cost: 500,
        odds: { common: 0.25, rare: 0.35, epic: 0.30, legendary: 0.10 },
        bg: '#34495e'
      },
      ultra: { 
        cost: 1200,
        odds: { rare: 0.10, epic: 0.60, legendary: 0.30 },
        bg: '#e74c3c'
      },
      hype: { 
        cost: 900,
        odds: { common: 0.10, rare: 0.30, epic: 0.40, legendary: 0.20 },
        bg: '#27ae60'
      },
      classic: { 
        cost: 250,
        odds: { common: 0.60, rare: 0.30, epic: 0.08, legendary: 0.02 },
        bg: '#bdc3c7'
      },
      collab: { 
        cost: 1500,
        odds: { rare: 0.20, epic: 0.40, legendary: 0.40 },
        colorway: true,
        bg: '#9b59b6'
      },
      seasonal: { 
        cost: 600,
        odds: { common: 0.30, rare: 0.40, epic: 0.25, legendary: 0.05 },
        bg: '#f1c40f'
      }
    };

    function showNotification(message) {
      if (!settings.notificationsEnabled) return;
      alert(message);
    }

    function updateInventory() {
      const inventoryDiv = document.getElementById("inventory-list");
      inventoryDiv.innerHTML = '';
      if (inventory.length === 0) {
        inventoryDiv.innerHTML = "<em>No sneakers in inventory.</em>";
        return;
      }

      // Sort inventory based on settings
      const sortedInventory = [...inventory].sort((a, b) => {
        switch (settings.defaultSort) {
          case 'rarity':
            return rarities.findIndex(r => r.rarity === b.rarity) - 
                   rarities.findIndex(r => r.rarity === a.rarity);
          case 'value':
            return (b.dynamicValue || b.baseValue) - (a.dynamicValue || a.baseValue);
          case 'brand':
            return a.brand.localeCompare(b.brand);
          case 'newest':
            return inventory.indexOf(b) - inventory.indexOf(a);
          default:
            return 0;
        }
      });

      sortedInventory.forEach((sneaker, index) => {
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) 
          ? sneaker.dynamicValue 
          : sneaker.baseValue;
        
        const event = activeEvents.get(sneaker.id);
        const valueChangeClass = event ? 
          (event.effect > 0 ? 'value-increase' : 'value-decrease') : '';

        inventoryDiv.innerHTML += `
          <div class="sneaker-card" data-sneaker-id="${sneaker.id}">
            <img src="${sneaker.image}" alt="${sneaker.brand} ${sneaker.model}" style="width:80px;height:80px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
            <strong>${sneaker.brand} ${sneaker.model}</strong>
            <span>${sneaker.colorway}</span>
            <span class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</span><br>
            <span class="sneaker-value ${valueChangeClass}">
              Value: ${formatCurrency(Math.floor(value))} coins
            </span>
            <br><button onclick="sellSneakerById('${sneaker.id}')" style="margin-top:8px;padding:5px 10px;">Sell</button>
          </div>
        `;
      });

      // Update trade dropdown if it exists
      if (document.getElementById("trade-dropdown")) {
        renderTradeDropdown();
      }
    }
    function updateCoins() {
      const coinDisplay = document.getElementById('coin-count');
      if (coinDisplay) {
        let displayValue = coins;
        if (settings.currencyDisplay === 'k') {
          displayValue = coins >= 1000 ? (coins/1000).toFixed(1) + 'K' : coins;
        }
        coinDisplay.textContent = formatCurrency(displayValue);
      }
    }

    function formatCurrency(amount) {
      if (settings.currencyDisplay === 'k' && amount >= 1000) {
        return (amount/1000).toFixed(1) + 'K';
      } else if (settings.currencyDisplay === 'full') {
        return amount.toLocaleString();
      }
      return amount.toString();
    }

    function loadSettings() {
      const savedSettings = localStorage.getItem('gameSettings');
      if (savedSettings) {
        settings = JSON.parse(savedSettings);
        document.getElementById('auto-sell-toggle').checked = settings.autoSell;
        document.getElementById('sound-toggle').checked = settings.soundEnabled;
        document.getElementById('animation-toggle').checked = settings.animationEnabled;
        document.getElementById('notification-toggle').checked = settings.notificationsEnabled;
        document.getElementById('volume-control').value = settings.volume;
        document.getElementById('volume-value').textContent = settings.volume + '%';
        document.getElementById('display-mode').value = settings.displayMode;
        document.getElementById('currency-display').value = settings.currencyDisplay;
        document.getElementById('sort-inventory').value = settings.defaultSort;
        document.getElementById('roll-animation-toggle').checked = settings.rollAnimation;
        document.getElementById('light-mode-toggle').checked = settings.lightMode;
        document.getElementById('skip-animation-toggle').checked = settings.skipPackAnimation;
        if (settings.lightMode) {
          document.body.classList.add('light-mode');
        } else {
          document.body.classList.remove('light-mode');
        }
        if (!settings.animationEnabled) {
          document.body.classList.add('no-animations');
        }
        updateInventory();
        updateCoins();
      }
    }

    function saveSettings() {
      localStorage.setItem('gameSettings', JSON.stringify(settings));
    }

    function applySettings() {
      // Apply settings to UI and game state
      document.body.classList.toggle('light-mode', !!settings.lightMode);
      document.body.classList.toggle('no-animations', settings.animationEnabled === false);

      // Update toggles if they exist
      if (document.getElementById('animation-toggle')) {
        document.getElementById('animation-toggle').checked = !!settings.animationEnabled;
      }
      if (document.getElementById('notification-toggle')) {
        document.getElementById('notification-toggle').checked = !!settings.notificationsEnabled;
      }
      if (document.getElementById('light-mode-toggle')) {
        document.getElementById('light-mode-toggle').checked = !!settings.lightMode;
      }
      if (document.getElementById('skip-animation-toggle')) {
        document.getElementById('skip-animation-toggle').checked = !!settings.skipPackAnimation;
      }
      if (document.getElementById('display-mode')) {
        document.getElementById('display-mode').value = settings.displayMode;
      }
      if (document.getElementById('currency-display')) {
        document.getElementById('currency-display').value = settings.currencyDisplay;
      }
      if (document.getElementById('sort-inventory')) {
        document.getElementById('sort-inventory').value = settings.defaultSort;
      }
      // Update inventory and coins display
      updateInventory();
      updateCoins();
    }

    function toggleAutoSell() {
      settings.autoSell = document.getElementById('auto-sell-toggle').checked;
      saveSettings();
    }

    function toggleSound() {
      settings.soundEnabled = document.getElementById('sound-toggle').checked;
      saveSettings();
    }

    function toggleAnimation() {
      settings.animationEnabled = document.getElementById('animation-toggle').checked;
      document.body.classList.toggle('no-animations', !settings.animationEnabled);
      saveSettings();
    }

    function toggleNotifications() {
      settings.notificationsEnabled = document.getElementById('notification-toggle').checked;
      saveSettings();
    }

    function updateVolume() {
      settings.volume = document.getElementById('volume-control').value;
      document.getElementById('volume-value').textContent = settings.volume + '%';
      saveSettings();
    }

    function updateDisplayMode() {
      settings.displayMode = document.getElementById('display-mode').value;
      const inventoryList = document.getElementById('inventory-list');
      inventoryList.className = 'inventory-' + settings.displayMode;
      saveSettings();
      updateInventory();
    }

    function updateCurrencyDisplay() {
      settings.currencyDisplay = document.getElementById('currency-display').value;
      saveSettings();
      updateCoins();
      updateInventory();
    }

    function updateDefaultSort() {
      settings.defaultSort = document.getElementById('sort-inventory').value;
      saveSettings();
      updateInventory();
    }

    function toggleRollAnimation() {
      settings.rollAnimation = document.getElementById('roll-animation-toggle').checked;
      saveSettings();
    }

    function openPack() {
      const type = document.getElementById("pack-type").value;
      let pack = {...packTypes[type]};
      
      // --- Always apply staff bonuses before opening pack ---
      applyStaffBonuses();
      
      // Check for free pack chance from prestige
      let isFree = false;
      if (freePackChance > 0 && Math.random() < freePackChance) {
        isFree = true;
        showPurchaseNotification("üéÅ Free pack from prestige bonus!", "success");
      }
      
      // Apply prestige effect on pack cost if applicable
      if (prestigeLevel > 0) {
        pack.cost = Math.max(90, Math.floor(pack.cost * Math.pow(0.9, prestigeLevel)));
      }
      
      // Apply buyer staff discount
      if (type !== 'legendary' && packPriceMultiplier < 1) {
        pack.cost = Math.floor(pack.cost * packPriceMultiplier);
      }
      
      if (!isFree && coins < pack.cost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      
      // Only deduct coins if not a free pack
      if (!isFree) {
        coins -= pack.cost;
        updateCoins();
      }

      // Disable buttons during pack opening
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = true;
      });

      // Show the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.add('show');
      modalOverlay.classList.add('show');

      // Generate sneakers
      currentSneakers = [];
      
      // Determine how many sneakers - check for extra sneaker chance
      let sneakerCount = 3;
      if (extraSneakerChance > 0 && Math.random() < extraSneakerChance) {
        sneakerCount = 4;
        showPurchaseNotification("üéÅ Extra sneaker from prestige bonus!", "success");
      }
      
      for (let i = 0; i < sneakerCount; i++) {
        let sneaker = rollSneaker(type);
        currentSneakers.push(sneaker);
      }

      // Record the purchase
      addPurchaseToHistory('Pack Opening', isFree ? 0 : pack.cost, currentSneakers);
      
      // Reset state and start reveal
      currentSneakerIndex = 0;
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      revealNextSneaker();

      // Apply authenticator staff bonus to odds
      let odds = {...pack.odds};
      if (rarityBonus > 0) {
        if (odds.rare) odds.rare += rarityBonus;
        if (odds.epic) odds.epic += rarityBonus;
        if (odds.legendary) odds.legendary += rarityBonus;
        // Normalize odds if they exceed 1
        let total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      saveGameState();
    }

    // Patch rollSneaker to use getRandomSneaker and allow all brands
    function rollSneaker(type) {
      // --- Always apply staff bonuses before rolling sneaker ---
      applyStaffBonuses();
      const pack = packTypes[type];
      let roll = Math.random();
      
      // Apply prestige rarity multiplier
      if (rarityMultiplier > 1) {
        // Shift the roll toward better rarities
        roll = Math.pow(roll, 1 / rarityMultiplier);
      }
      
      // Apply legendary boost if applicable
      let odds = {...pack.odds};
      if (legendaryBoost > 0 && odds.legendary) {
        // Increase legendary odds
        odds.legendary += legendaryBoost;
        
        // Normalize odds
        const total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      
      if (upgrades.betterOdds) roll += 0.05;
      // --- Apply authenticator staff bonus to odds ---
      if (rarityBonus > 0) {
        if (odds.rare) odds.rare += rarityBonus;
        if (odds.epic) odds.epic += rarityBonus;
        if (odds.legendary) odds.legendary += rarityBonus;
        // Normalize odds if they exceed 1
        let total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      let rarity = "common";
      let sum = 0;
      for (let key of ["common", "rare", "epic", "legendary"]) {
        if (odds[key]) {
          sum += odds[key];
          if (roll < sum) {
            rarity = key;
            break;
          }
        }
      }
      // If colorway pack, just use random colorway
      return getRandomSneaker(rarity);
    }

    function createRollItem(sneaker) {
      return `
        <strong>${sneaker.brand} ${sneaker.model}</strong>
        <span>${sneaker.colorway}</span>
        <span class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</span>
      `;
    }

    function sellSneaker(index) {
      if (index < 0 || index >= inventory.length) return;
      
      let sneaker = inventory[index];
      let value = sneaker.baseValue;
      
      // Apply any active event effects
      activeEvents.forEach(event => {
        if (event.sneaker === `${sneaker.brand} ${sneaker.model}`) {
          value *= (1 + event.effect);
        }
      });
      
      // Apply resell agent bonus
      const bonus = 1 + (resellAgent.level * resellAgent.bonusPerLevel);
      value = Math.floor(value * bonus);
      
      // Apply double sale chance from prestige
      let isDoubleSale = false;
      if (doubleSaleChance > 0 && Math.random() < doubleSaleChance) {
        value *= 2;
        isDoubleSale = true;
      }
      
      coins += value;
      inventory.splice(index, 1); // Remove the sneaker from inventory
      updateCoins();
      updateInventory();
      
      // Show different notification based on if it was a double sale
      if (isDoubleSale) {
        showPurchaseNotification(`üí∞ DOUBLE SALE! Sold ${sneaker.brand} ${sneaker.model} for ${formatCurrency(value)} coins!`);
      } else {
        showPurchaseNotification(`Sold ${sneaker.brand} ${sneaker.model} for ${formatCurrency(value)} coins!`);
      }
      saveGameState();
    }

    function claimDaily() {
      const lastClaim = localStorage.getItem('dailyReward');
      const now = Date.now();
      if (!lastClaim || now - lastClaim > 86400000) {
        coins += 300;
        localStorage.setItem('dailyReward', now);
        updateCoins();
        showNotification("Daily reward claimed!");
      } else {
        showNotification("Already claimed today!");
      }
      saveGameState();
    }

    function buyUpgrade(type) {
      if (type === 'storageExpand') {
        if (storageUpgrades >= 10) {
          showPurchaseNotification('Maximum storage reached!', 'error');
          return;
        }
        if (coins >= storageCost) {
          coins -= storageCost;
          storageUpgrades++;
          storageCost = Math.floor(storageCost * 1.5); // 50% increase each time
          document.getElementById('storage-cost').textContent = storageCost;
          showPurchaseNotification('Storage expanded!');
          updateCoins();
        } else {
          showPurchaseNotification('Not enough coins!', 'error');
        }
      }
      saveGameState();
    }

    // --- TRADE UI ---
    let aiTradeOffer = [];

    // AI Trader System
    const aiTraders = [
      { name: "Sneaker Steve", emoji: "üëü", preferences: ["Nike", "Jordan", "Yeezy", "Adidas", "SB Dunk", "Ultra Boost"], style: "hype", valuePreference: "high", traits: ["Loves limited editions", "Prefers hyped releases"] },
      { name: "Vintage Vicky", emoji: "üë†", preferences: ["Converse", "Vans", "Chuck Taylor", "Old Skool", "Classic Leather", "Retro+"], style: "classic", valuePreference: "low", traits: ["Collects retro models", "Values original colorways"] },
      { name: "Luxury Larry", emoji: "üíé", preferences: ["Balenciaga", "Gucci", "Louis Vuitton", "Dior", "legendary", "epic"], style: "luxury", valuePreference: "ultra", traits: ["Only wants premium items", "Focuses on rare finds"] },
      { name: "Budget Bob", emoji: "üí∞", preferences: ["common", "rare", "Puma", "Reebok", "Saucony", "Under Armour"], style: "budget", valuePreference: "low", traits: ["Looks for deals", "Prefers common models"] },
      { name: "Collector Charlie", emoji: "üèÜ", preferences: ["rare", "epic", "550", "992", "Sample", "OG"], style: "collector", valuePreference: "medium", traits: ["Completes sets", "Values condition"] },
      { name: "Reseller Rachel", emoji: "üìà", preferences: ["Jordan", "Yeezy", "SB Dunk", "Ultra Boost", "Forum Low"], style: "hype", valuePreference: "high", traits: ["Watches market trends", "Knows resale values"] },
      { name: "Designer Dan", emoji: "‚ú®", preferences: ["Off-White", "Travis Scott", "Fragment", "Union LA", "limited", "colorway"], style: "luxury", valuePreference: "high", traits: ["Loves unique designs", "Prefers collaborations"] },
      { name: "Athletic Amy", emoji: "üèÉ‚Äç‚ôÄÔ∏è", preferences: ["Nike", "Asics", "Gel Lyte III", "Kayano 5", "Zoom Fly", "Pegasus"], style: "classic", valuePreference: "medium", traits: ["Values performance", "Likes durability"] },
      { name: "Trendy Tom", emoji: "üåü", preferences: ["New Balance", "Adidas", "Fresh Foam", "Stan Smith", "Campus", "Samba"], style: "hype", valuePreference: "medium", traits: ["Follows social media", "Loves new releases"] },
      { name: "Casual Casey", emoji: "üòä", preferences: ["Vans", "Converse", "Era", "Authentic", "Club C 85", "Workout Plus"], style: "budget", valuePreference: "low", traits: ["Practical choices", "Daily wear focus"] }
    ];

    const aiPersonalities = [
      "Always looking for the best deal",
      "Loves rare colorways",
      "Interested in limited editions only",
      "Collects specific brands",
      "Values condition over brand",
      "Prefers matching sets",
      "Focuses on resale value",
      "Interested in vintage models",
      "Loves exclusive releases",
      "Only trades for premium items"
    ];

    let currentTrader = null;

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function generateRandomTrader() {
      const baseTrader = aiTraders[Math.floor(Math.random() * aiTraders.length)];
      const personality = aiPersonalities[Math.floor(Math.random() * aiPersonalities.length)];
      
      // Add some randomization to preferences
      const randomBrands = [...brands].sort(() => Math.random() - 0.5).slice(0, 2);
      const randomRarities = ["common", "rare", "epic", "legendary"].sort(() => Math.random() - 0.5).slice(0, 2);
      
      return {
        ...baseTrader,
        personality,
        additionalPreferences: {
          brands: randomBrands,
          rarities: randomRarities,
          minValue: Math.floor(Math.random() * 300) + 100,
          maxValue: Math.floor(Math.random() * 1000) + 500,
          prefersSets: Math.random() > 0.5,
          prefersColorways: Math.random() > 0.5
        }
      };
    }

    function updateAITraderDisplay() {
      const traderDiv = document.getElementById('ai-trader');
      if (!traderDiv) return;

      const styleDisplay = currentTrader.style.charAt(0).toUpperCase() + currentTrader.style.slice(1);
      const valueDisplay = currentTrader.valuePreference.charAt(0).toUpperCase() + currentTrader.valuePreference.slice(1);
      
      traderDiv.innerHTML = `
        <div class="ai-avatar">${currentTrader.emoji}</div>
        <div class="ai-details">
          <div class="ai-name">${currentTrader.name}</div>
          <div class="ai-preference">Style: ${styleDisplay}</div>
          <div class="ai-preference">Value: ${valueDisplay}</div>
          <div class="ai-preference">Prefers: ${currentTrader.preferences.join(', ')}</div>
          <div class="ai-preference">Traits: ${currentTrader.traits.join(', ')}</div>
        </div>
      `;
    }

    function openTradeUI() {
      selectedTradeItems = [];
      aiTradeOffer = [];
      currentTrader = null;
      
      const tradeModal = document.getElementById("trade-modal");
      const overlay = document.getElementById("modal-overlay");
      const aiTrader = document.getElementById("ai-trader");
      const traderSelection = document.getElementById("trader-selection");
      
      tradeModal.classList.add("show");
      overlay.classList.add("show");
      
      aiTrader.style.display = "none";
      traderSelection.style.display = "block";
      
      document.getElementById("selected-sneakers").innerHTML = "";
      document.getElementById("trade-offer").innerHTML = "";
      document.querySelector('#your-offer .offer-details').innerHTML = "";
      document.querySelector('#ai-offer .offer-details').innerHTML = "";
      document.getElementById('trade-chat').innerHTML = '';
      
      renderTraderSelection();
    }

    function closeTradeUI() {
      document.getElementById("trade-modal").classList.remove("show");
    }

    function renderTraderSelection() {
      const container = document.getElementById("trader-selection");
      container.innerHTML = aiTraders.map(trader => `
        <div class="trader-card" onclick="selectTrader('${trader.name}')">
          <div class="trader-avatar">${trader.emoji}</div>
          <div class="trader-name">${trader.name}</div>
          <div class="trader-info">
            <div>Style: ${trader.style.charAt(0).toUpperCase() + trader.style.slice(1)}</div>
            <div>Prefers: ${trader.preferences.join(', ')}</div>
            <div>Value: ${trader.valuePreference.charAt(0).toUpperCase() + trader.valuePreference.slice(1)}</div>
          </div>
        </div>
      `).join('');
    }

    function selectTrader(name) {
      currentTrader = aiTraders.find(t => t.name === name);
      if (!currentTrader) return;

      document.getElementById("trader-selection").style.display = "none";
      document.getElementById("ai-trader").style.display = "block";
      updateAITraderDisplay();
      renderTradeDropdown();
    }

    function renderTradeDropdown() {
      const dropdown = document.getElementById("trade-dropdown");
      dropdown.innerHTML = "";
      if (inventory.length === 0) {
        dropdown.innerHTML = "<option>No sneakers to trade</option>";
        dropdown.disabled = true;
        return;
      }
      dropdown.disabled = false;
      
      // Only show sneakers that aren't already selected
      const availableSneakers = inventory.filter((_, idx) => !selectedTradeItems.includes(idx));
      
      if (availableSneakers.length === 0) {
        dropdown.innerHTML = "<option>No more sneakers available</option>";
        dropdown.disabled = true;
        return;
      }

      availableSneakers.forEach((sneaker, idx) => {
        const originalIndex = inventory.indexOf(sneaker);
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) ? 
          sneaker.dynamicValue : sneaker.baseValue;
        let text = `${sneaker.brand} ${sneaker.model} (${sneaker.colorway}) [${sneaker.rarity.toUpperCase()}] - ${formatCurrency(Math.floor(value))}c`;
        let option = document.createElement("option");
        option.value = originalIndex;
        option.textContent = text;
        dropdown.appendChild(option);
      });
    }

    function addToTrade() {
      const dropdown = document.getElementById("trade-dropdown");
      const selectedIndex = parseInt(dropdown.value);
      
      if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= inventory.length) {
        showPurchaseNotification("Invalid selection!", "error");
        return;
      }

      if (selectedTradeItems.includes(selectedIndex)) {
        showPurchaseNotification("This sneaker is already in the trade!", "error");
        return;
      }

      selectedTradeItems.push(selectedIndex);
      updateSelectedSneakers();
      renderTradeDropdown();
        generateAITradeOffer();
      appendTradeChatMessage('player', `Let me see... You're offering ${selectedTradeItems.map(index => inventory[index].brand+' '+inventory[index].model).join(', ')}. Here's what I think...`);
    }

    function updateSelectedSneakers() {
      const container = document.getElementById("selected-sneakers");
      if (!container) return;

      container.innerHTML = selectedTradeItems.map(index => {
        if (index < 0 || index >= inventory.length) return '';
        
        const sneaker = inventory[index];
        return `
          <div class="selected-sneaker">
            <span>${sneaker.brand} ${sneaker.model} [${sneaker.rarity.toUpperCase()}]</span>
            <button class="remove-sneaker" onclick="removeFromTrade(${index})">√ó</button>
          </div>
        `;
      }).join('');

      updateTradeComparison();
    }

    function removeFromTrade(index) {
      selectedTradeItems = selectedTradeItems.filter(i => i !== index);
      updateSelectedSneakers();
      renderTradeDropdown();
      generateAITradeOffer();
    }

    function updateTradeComparison() {
      if (selectedTradeItems.length === 0) {
        document.querySelector('#your-offer .offer-details').innerHTML = "<em>Select sneakers to trade</em>";
        document.querySelector('#ai-offer .offer-details').innerHTML = "";
        return;
      }

      const yourSneakers = selectedTradeItems.map(index => inventory[index]);
      const yourTotalValue = yourSneakers.reduce((sum, s) => {
        const value = (typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue;
        return sum + value;
      }, 0);

      const aiTotalValue = aiTradeOffer.reduce((sum, s) => {
        const value = (typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue;
        return sum + value;
      }, 0);

      const valueDiff = aiTotalValue - yourTotalValue;
      let valueClass = 'equal-value';
      if (valueDiff > 50) valueClass = 'better-value';
      if (valueDiff < -50) valueClass = 'worse-value';

      document.querySelector('#your-offer .offer-details').innerHTML = `
        ${yourSneakers.map(s => `
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class="rarity-${s.rarity}">[${s.rarity.toUpperCase()}]</span><br>
        `).join('<br>')}
        <div class="value-comparison">Total Value: ${formatCurrency(Math.floor(yourTotalValue))} coins</div>
      `;

      document.querySelector('#ai-offer .offer-details').innerHTML = `
        ${aiTradeOffer.map(s => `
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class="rarity-${s.rarity}">[${s.rarity.toUpperCase()}]</span><br>
        `).join('<br>')}
        <div class="value-comparison ${valueClass}">
          Total Value: ${formatCurrency(Math.floor(aiTotalValue))} coins
          ${valueDiff !== 0 ? `(${valueDiff > 0 ? '+' : ''}${formatCurrency(Math.floor(valueDiff))})` : ''}
        </div>
      `;
    }

    function generateAITradeOffer(adjustment = 1.0) {
      if (!currentTrader || selectedTradeItems.length === 0) {
        updateTradeComparison();
        return;
      }

      const yourSneakers = selectedTradeItems.map(index => inventory[index]);
      const yourTotalValue = yourSneakers.reduce((sum, s) => {
        return sum + ((typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue);
      }, 0);

      // Calculate preference score for the offered sneakers
      let preferenceBonus = 0;
      yourSneakers.forEach(sneaker => {
        // Brand preference check
        if (currentTrader.preferences.some(pref => 
          sneaker.brand.includes(pref) || 
          sneaker.model.includes(pref)
        )) {
          preferenceBonus += 0.15; // 15% bonus per preferred brand/model
        }
        
        // Rarity preference check
        if (currentTrader.preferences.some(pref => 
          sneaker.rarity.toLowerCase() === pref.toLowerCase()
        )) {
          preferenceBonus += 0.2; // 20% bonus for preferred rarity
        }
        
        // Style match check
        if ((currentTrader.style === 'hype' && (sneaker.rarity === 'legendary' || sneaker.rarity === 'epic')) ||
            (currentTrader.style === 'budget' && (sneaker.rarity === 'common' || sneaker.rarity === 'rare')) ||
            (currentTrader.style === 'luxury' && sneaker.rarity === 'legendary') ||
            (currentTrader.style === 'classic' && (sneaker.brand === 'Nike' || sneaker.brand === 'Jordan' || sneaker.brand === 'Converse'))) {
          preferenceBonus += 0.1; // 10% bonus for style match
        }
      });

      // Calculate target value based on trader preferences
      let targetTotalValue = yourTotalValue * adjustment;
      
      // Apply preference bonus
      targetTotalValue *= (1 + preferenceBonus);
      
      // Apply trader value preference
      switch(currentTrader.valuePreference) {
        case 'low':
          targetTotalValue *= 0.8;
          break;
        case 'medium':
          targetTotalValue *= 1.0;
          break;
        case 'high':
          targetTotalValue *= 1.2;
          break;
        case 'ultra':
          targetTotalValue *= 1.5;
          break;
      }
      
      // Check for specific negotiation messages in the chat
      const chatMsgs = document.querySelectorAll('.trade-chat-msg.player-msg');
      let chatBonus = 0;
      
      chatMsgs.forEach(msgElement => {
        const msgText = msgElement.textContent.toLowerCase();
        
        // Negotiations that improve the offer
        if (msgText.includes('rare') || msgText.includes('legendary') || msgText.includes('limited')) {
          if (currentTrader.style === 'hype' || currentTrader.style === 'luxury') {
            chatBonus += 0.05;
          }
        }
        
        if (msgText.includes('classic') || msgText.includes('vintage') || msgText.includes('retro')) {
          if (currentTrader.style === 'classic') {
            chatBonus += 0.07;
          }
        }
        
        if (msgText.includes('deal') || msgText.includes('fair')) {
          chatBonus += 0.03;
        }
        
        // Negotiations that may reduce the offer
        if (msgText.includes('cheap') || msgText.includes('low')) {
          if (currentTrader.style === 'luxury') {
            chatBonus -= 0.1;
          } else if (currentTrader.style === 'budget') {
            chatBonus += 0.05;
          }
        }
      });
      
      // Apply chat negotiation bonus
      targetTotalValue *= (1 + chatBonus);

      // Generate AI offer
      aiTradeOffer = [];
      
      // Create a pool of preferred sneakers that match trader's style and preferences
      const preferredSneakers = sneakersDatabase.filter(s => {
        // Check brand & model preferences
        const matchesPreference = currentTrader.preferences.some(pref => 
          s.brand.includes(pref) || 
          s.model.includes(pref) ||
          s.rarity.toLowerCase() === pref.toLowerCase()
        );
        
        // Style matching
        const matchesStyle = (
          (currentTrader.style === 'hype' && (s.rarity === 'legendary' || s.rarity === 'epic')) ||
          (currentTrader.style === 'budget' && (s.rarity === 'common' || s.rarity === 'rare')) ||
          (currentTrader.style === 'luxury' && s.rarity === 'legendary') ||
          (currentTrader.style === 'classic' && (s.brand === 'Nike' || s.brand === 'Jordan' || s.brand === 'Converse'))
        );
        
        return matchesPreference || matchesStyle;
      });
      
      // Sort the preferred sneakers by how well they match the trader's preferences
      preferredSneakers.sort((a, b) => {
        const scoreA = getPreferenceScore(a);
        const scoreB = getPreferenceScore(b);
        return scoreB - scoreA;  // Higher score first
      });

      // Try to offer preferred sneakers first (heavily favoring preferences)
      while (aiTradeOffer.length < 3 && preferredSneakers.length > 0 && targetTotalValue > 0) {
        // Take sneakers from the front of the sorted array (highest preference)
        const sneaker = preferredSneakers.shift();
        
        if (sneaker.baseValue <= targetTotalValue * 1.5) { // Allow slightly higher values for preferred items
          aiTradeOffer.push({...sneaker, id: Date.now() + Math.random()});
          targetTotalValue -= sneaker.baseValue;
        }
      }

      // Fill remaining slots with affordable sneakers that somewhat match preferences
      if (aiTradeOffer.length < 3 && targetTotalValue > 0) {
        const remainingSneakers = sneakersDatabase.filter(s => 
          !aiTradeOffer.some(offered => 
            offered.brand === s.brand && offered.model === s.model && offered.rarity === s.rarity
          ) && s.baseValue <= targetTotalValue
        );
        
        // Sort by preference but to a lesser degree
        remainingSneakers.sort((a, b) => {
          const scoreA = getPreferenceScore(a) / 2; // Lower weight on preference
          const scoreB = getPreferenceScore(b) / 2;
          return scoreB - scoreA;
        });
        
        // Add remaining sneakers
        for (let i = 0; i < remainingSneakers.length && aiTradeOffer.length < 3 && targetTotalValue > 0; i++) {
          const sneaker = remainingSneakers[i];
          if (sneaker.baseValue <= targetTotalValue) {
            aiTradeOffer.push({...sneaker, id: Date.now() + Math.random()});
            targetTotalValue -= sneaker.baseValue;
          }
        }
      }
      
      // If we still don't have 3 items, add some lower value items
      if (aiTradeOffer.length < 3) {
        const budgetSneakers = sneakersDatabase.filter(s => 
          !aiTradeOffer.some(offered => 
            offered.brand === s.brand && offered.model === s.model && offered.rarity === s.rarity
          ) && s.rarity === 'common'
        ).sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < budgetSneakers.length && aiTradeOffer.length < 3; i++) {
          aiTradeOffer.push({...budgetSneakers[i], id: Date.now() + Math.random()});
        }
      }

      updateTradeComparison();
      updateNegotiationOptions();
      
      // Add accept trade button if there's an offer
      const tradeOffer = document.getElementById("trade-offer");
      if (tradeOffer) {
        if (aiTradeOffer.length > 0) {
          tradeOffer.innerHTML = '<button class="pack-button" onclick="acceptTrade()">Accept Trade</button>';
        } else {
          tradeOffer.innerHTML = '<em>No suitable trade found</em>';
        }
      }
    }

    function getPreferenceScore(sneaker) {
      if (!currentTrader) return 0;
      
      let score = 0;
      
      // Brand & model preference
      currentTrader.preferences.forEach(pref => {
        if (sneaker.brand.includes(pref) || sneaker.model.includes(pref)) {
          score += 3;
        }
      });
      
      // Rarity preference
      currentTrader.preferences.forEach(pref => {
        if (sneaker.rarity.toLowerCase() === pref.toLowerCase()) {
          score += 2;
        }
      });
      
      // Style match
      if (currentTrader.style === 'hype' && (sneaker.rarity === 'legendary' || sneaker.rarity === 'epic')) {
        score += 3;
      } else if (currentTrader.style === 'budget' && (sneaker.rarity === 'common' || sneaker.rarity === 'rare')) {
        score += 3;
      } else if (currentTrader.style === 'luxury' && sneaker.rarity === 'legendary') {
        score += 4;
      } else if (currentTrader.style === 'classic' && 
                (sneaker.brand === 'Nike' || sneaker.brand === 'Jordan' || sneaker.brand === 'Converse')) {
        score += 3;
      }
      
      return score;
    }

    function acceptTrade() {
      if (!currentTrader || selectedTradeItems.length === 0 || aiTradeOffer.length === 0) {
        showPurchaseNotification("Invalid trade!", "error");
        return;
      }

      // Remove traded sneakers from inventory (in reverse order to maintain correct indices)
      const tradedIndices = [...selectedTradeItems].sort((a, b) => b - a);
      tradedIndices.forEach(index => {
        if (index >= 0 && index < inventory.length) {
          inventory.splice(index, 1);
        }
      });

      // Add AI's sneakers to inventory with unique IDs
      aiTradeOffer.forEach(s => {
        const newSneaker = {
          ...s,
          id: Date.now() + Math.random(),
          dynamicValue: s.baseValue
        };
        inventory.push(newSneaker);
      });

      updateInventory();
      showPurchaseNotification("Trade completed successfully!");
      
      // Reset trade state
      selectedTradeItems = [];
      aiTradeOffer = [];
      currentTrader = null;
      
      // Close trade modal
      closeTradeUI();
      appendTradeChatMessage('ai', 'Deal! Pleasure trading with you.');
    }

    // Load purchase history from localStorage
    function loadPurchaseHistory() {
      const savedHistory = localStorage.getItem('purchaseHistory');
      if (savedHistory) {
        purchaseHistory = JSON.parse(savedHistory);
      }
    }

    // Save purchase history to localStorage
    function savePurchaseHistory() {
      saveGameState();
    }

    // Add purchase to history
    function addPurchaseToHistory(type, cost, items) {
      const purchase = {
        type: type,
        cost: cost,
        items: items,
        timestamp: new Date().toISOString()
      };
      purchaseHistory.unshift(purchase);
      if (purchaseHistory.length > 50) { // Keep only last 50 purchases
        purchaseHistory.pop();
      }
      savePurchaseHistory();
      updatePurchaseHistory();
    }

    // Update purchase history display
    function updatePurchaseHistory() {
      const historyDiv = document.getElementById('purchase-history');
      historyDiv.innerHTML = '';
      
      purchaseHistory.forEach(purchase => {
        const date = new Date(purchase.timestamp);
        const formattedDate = date.toLocaleString();
        const itemsList = purchase.items.map(item => 
          `${item.brand} ${item.model} (${item.rarity})`
        ).join(', ');
        
        historyDiv.innerHTML += `
          <div class="purchase-item">
            <div><strong>${purchase.type}</strong> - ${formatCurrency(purchase.cost)} coins</div>
            <div>Items: ${itemsList}</div>
            <div class="purchase-time">${formattedDate}</div>
          </div>
        `;
      });
    }

    function openHistory() {
      document.getElementById('history-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
      updatePurchaseHistory();
    }

    function closeHistory() {
      document.getElementById('history-modal').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
    }

    function openSettings() {
      document.getElementById('settings-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
    }

    function closeAllModals() {
      const modals = ['history-modal', 'settings-modal', 'pack-modal', 'trade-modal'];
      modals.forEach(modalId => {
        document.getElementById(modalId).classList.remove('show');
      });
      document.getElementById('modal-overlay').classList.remove('show');
    }

    // Add event listener for escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeAllModals();
      }
    });

    function generateLimitedOffers() {
      const maxOffers = 3;
      limitedOffers.clear();
      let offerBonus = 1;
      // Apply networker staff bonus
      const networker = hiredStaff.find(s => s.id === 'networker');
      if (networker) {
        offerBonus -= networker.baseBonus + (networker.level - 1) * networker.bonusPerLevel;
      }
      while (limitedOffers.size < maxOffers) {
        const sneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        if (!limitedOffers.has(sneaker.id)) {
          const duration = 300000 + Math.random() * 300000;
          const discount = (0.6 + Math.random() * 0.2) * offerBonus;
          limitedOffers.set(sneaker.id, {
            sneaker,
            discountedPrice: Math.floor(sneaker.baseValue * discount),
            endTime: Date.now() + duration,
            startTime: Date.now()
          });
        }
      }
      updateLimitedOffers();
    }

    function updateLimitedOffers() {
      const container = document.getElementById('limited-offers');
      if (!container) return;
      
      container.innerHTML = '';
      const now = Date.now();
      let needsNewOffers = false;

      limitedOffers.forEach((offer, id) => {
        const timeLeft = offer.endTime - now;
        if (timeLeft <= 0) {
          limitedOffers.delete(id);
          needsNewOffers = true;
          return;
        }

        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        const savings = offer.sneaker.baseValue - offer.discountedPrice;

        container.innerHTML += `
          <div class="limited-offer">
            <div class="offer-timer">${timeString}</div>
            <div class="offer-sneaker">
              <img src="${offer.sneaker.image}" alt="${offer.sneaker.brand} ${offer.sneaker.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
              <strong>${offer.sneaker.brand} ${offer.sneaker.model}</strong>
              <div>${offer.sneaker.colorway}</div>
              <div class="rarity-${offer.sneaker.rarity}">[${offer.sneaker.rarity.toUpperCase()}]</div>
              <div style="margin: 10px 0;">
                <span style="text-decoration: line-through;">${formatCurrency(offer.sneaker.baseValue)} coins</span>
                <br>
                <strong style="color: #2ecc71; font-size: 1.2em;">
                  ${formatCurrency(offer.discountedPrice)} coins
                </strong>
                <br>
                <span style="color: #e74c3c;">Save ${formatCurrency(savings)} coins!</span>
              </div>
              <button class="pack-button" onclick="purchaseOffer('${id}')">Purchase</button>
            </div>
        </div>
      `;
      });

      if (needsNewOffers || limitedOffers.size < 3) {
        generateLimitedOffers();
      }
    }

    // Update limited offers every second
    setInterval(updateLimitedOffers, 1000);

    // Generate news events every minute
    setInterval(generateNewsEvent, 60000);

    // Initialize on load
    window.addEventListener('load', () => {
      loadSettings();
      loadPurchaseHistory();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      
      // Start news event generation immediately
      generateNewsEvent();

      // Add unique IDs to existing inventory
      inventory.forEach(s => {
        if (!s.id) s.id = Date.now() + Math.random();
      });
    });

    function purchaseOffer(id) {
      const offer = limitedOffers.get(id);
      if (!offer) {
        showNotification("This offer has expired!");
        return;
      }

      if (coins < offer.discountedPrice) {
        showNotification("Not enough coins!");
        return;
      }

      coins -= offer.discountedPrice;
      inventory.push({
        ...offer.sneaker,
        dynamicValue: offer.sneaker.baseValue
      });

      limitedOffers.delete(id);
      updateLimitedOffers();
      updateCoins();
      updateInventory();
      showPurchaseNotification("Limited offer purchased successfully!");
      saveGameState();
    }

    function showPurchaseNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = 'purchase-notification';
      notification.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
        <span>${message}</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    function updateResellAgentDisplay() {
      const levelDiv = document.getElementById('agent-level');
      const bonusDiv = document.getElementById('agent-bonus');
      const upgradeBtn = document.getElementById('upgrade-agent-btn');
      
      if (levelDiv) {
        levelDiv.innerHTML = Array(resellAgent.level)
          .fill('‚≠ê')
          .concat(Array(resellAgent.maxLevel - resellAgent.level).fill('‚òÜ'))
          .join('');
      }
      
      if (bonusDiv) {
        const bonus = (resellAgent.level * resellAgent.bonusPerLevel * 100).toFixed(0);
        bonusDiv.textContent = `Current Bonus: +${bonus}% sale value`;
      }
      
      if (upgradeBtn) {
        if (resellAgent.level >= resellAgent.maxLevel) {
          upgradeBtn.textContent = 'Max Level Reached!';
          upgradeBtn.disabled = true;
        } else {
          const nextCost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
          upgradeBtn.textContent = `Upgrade Agent (${formatCurrency(nextCost)} coins)`;
          upgradeBtn.disabled = false;
        }
      }
    }

    function updateMarketBuyerDisplay() {
      // Dummy function: Market Buyer UI not implemented yet
    }

    // Negotiation messages based on trader personality
    const negotiationOptions = {
      standard: [
        "How about we adjust the trade a bit?",
        "Can you add something more?",
        "I'm interested, but the value seems off",
        "This is a good start, but...",
      ],
      counter: [
        "Let me offer something different",
        "What if we modified the trade?",
        "I can adjust my offer",
        "Perhaps we can find middle ground"
      ]
    };

    function updateNegotiationOptions(showCounter = true) {
      const container = document.getElementById('negotiation-options');
      container.innerHTML = '';
      
      if (showCounter) {
        negotiationOptions.standard.forEach(msg => {
          const btn = document.createElement('button');
          btn.className = 'negotiation-btn';
          btn.textContent = msg;
          btn.onclick = () => negotiate(msg);
          container.appendChild(btn);
        });
      }
    }

    function negotiate(message) {
      const response = document.getElementById('ai-response');
      if (!currentTrader || !response) return;

      const yourValue = selectedTradeItems.reduce((sum, idx) => {
        const sneaker = inventory[idx];
        return sum + (sneaker.dynamicValue || sneaker.baseValue);
      }, 0);
      
      const aiValue = aiTradeOffer.reduce((sum, s) => sum + s.baseValue, 0);
      const valueDiff = Math.abs(yourValue - aiValue);
      const valueRatio = Math.min(yourValue, aiValue) / Math.max(yourValue, aiValue);

      let responseText;
      let willing = false;
      let adjustment = 1.0;

      // Check message keywords
      const msgLower = message.toLowerCase();
      let preferenceMatched = false;
      
      // Check if message mentions any of the trader's preferences
      currentTrader.preferences.forEach(pref => {
        if (msgLower.includes(pref.toLowerCase())) {
          preferenceMatched = true;
        }
      });
      
      // Personality-based responses
      if (preferenceMatched) {
        // More likely to adjust if you mention their preferences
        willing = Math.random() < 0.8;
        adjustment = 1.05; // Better offer when you mention their preferences
        
        if (currentTrader.style === 'hype') {
          responseText = "You know what I like! Let me see what I can offer.";
        } else if (currentTrader.style === 'luxury') {
          responseText = "I see you understand quality. I might have something special for you.";
        } else if (currentTrader.style === 'classic') {
          responseText = "A fellow enthusiast! I'll reconsider my offer.";
        } else {
          responseText = "That's exactly what I'm looking for! Let me adjust my offer.";
        }
      } else if (msgLower.includes("deal") || msgLower.includes("fair")) {
        // Checking for deal-closing terms
        if (valueRatio > 0.9) {
          willing = true;
          responseText = "You're right, this is a fair deal. Let's do it!";
        } else {
          willing = false;
          responseText = "I don't think we're quite there yet. The values don't match up.";
        }
      } else if (msgLower.includes("add") || msgLower.includes("more") || msgLower.includes("better")) {
        // Asking for more
        willing = Math.random() < 0.6;
        adjustment = 1.1; // Offer more
        responseText = willing ? 
          "I can sweeten the deal a bit. Check this out." : 
          "I'm already offering the best I can right now.";
      } else {
        // Standard value-based response
        if (valueRatio > 0.9) {
          willing = Math.random() < 0.8;
          adjustment = 1.0;
          responseText = willing ? 
            "I think we're close to a deal." : 
            "I think this is already a fair offer.";
        } else if (valueRatio > 0.7) {
          willing = Math.random() < 0.6;
          adjustment = 0.95;
          responseText = willing ? 
            "Let me adjust my offer a bit." : 
            "The value gap is a bit too wide for me.";
        } else {
          willing = Math.random() < 0.3;
          adjustment = 0.9;
          responseText = "I'm not sure about this trade value.";
        }
      }

      response.innerHTML = `${currentTrader.emoji} ${currentTrader.name}: "${responseText}"`;

      if (willing) {
        generateAITradeOffer(adjustment);
      }

      appendTradeChatMessage('player', message);
      appendTradeChatMessage('ai', responseText);
    }

    function updateNegotiationOptions() {
      const container = document.getElementById('negotiation-options');
      if (!container || !currentTrader) return;

      const options = [
        { text: "How about we adjust the trade a bit?", style: "standard" },
        { text: `Can you add something more ${currentTrader.style === 'luxury' ? 'exclusive' : 'valuable'}?`, style: "request" },
        { text: "Would you consider a different combination?", style: "counter" },
        { text: `I have some ${currentTrader.preferences[0]} items you might like...`, style: "specific" }
      ];

      container.innerHTML = options.map(opt => `
        <button class="negotiation-btn" onclick="negotiate('${opt.text}')">
          ${opt.text}
        </button>
      `).join('');
    }

    function generateNewsEvent() {
      if (Math.random() > 0.3) return; // 30% chance of news event

      const eventTypes = ["celebrity", "market", "trend"];
      const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];

      // Select random sneaker from inventory or database
      const sneaker = inventory.length > 0 && Math.random() > 0.5 
        ? inventory[Math.floor(Math.random() * inventory.length)]
        : sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
      
      let effect, percentage, direction, message;
      if (eventType === "celebrity" || eventType === "trend") {
        // Always positive effect
        effect = Math.random() * 0.5 + 0.1;
        percentage = Math.abs(Math.round(effect * 100));
        direction = "increased";
      if (eventType === "celebrity") {
        const celebrity = celebrities[Math.floor(Math.random() * celebrities.length)];
        const action = celebrityActions[Math.floor(Math.random() * celebrityActions.length)];
          message = `üî• ${celebrity} ${action} ${sneaker.brand} ${sneaker.model}! Value increased by ${percentage}%!`;
        } else {
          const reason = trendReasons[Math.floor(Math.random() * trendReasons.length)];
          message = `üåü ${sneaker.brand} ${sneaker.model} is trending ${reason}! Value increased by ${percentage}%!`;
        }
      } else if (eventType === "market") {
        // 50% chance for positive or negative market event
        const isPositive = Math.random() > 0.5;
        effect = (isPositive ? 1 : -1) * (Math.random() * 0.5 + 0.1);
        percentage = Math.abs(Math.round(effect * 100));
        direction = isPositive ? "increased" : "decreased";
        const reason = marketReasons[isPositive ? "increase" : "decrease"][Math.floor(Math.random() * marketReasons[isPositive ? "increase" : "decrease"].length)];
        message = `üìà Market Alert: ${sneaker.brand} ${sneaker.model} value has ${direction} by ${percentage}% ${reason}!`;
      }

      // Apply effect to matching sneakers
      const eventId = Date.now();
      activeEvents.set(eventId, {
        sneaker: `${sneaker.brand} ${sneaker.model}`,
        effect: effect,
        endTime: Date.now() + 300000 // 5 minutes
      });

      showBreakingNews(message);
      updateInventoryValues();

      setTimeout(() => {
        activeEvents.delete(eventId);
        updateInventoryValues();
      }, 300000);
    }

    function showBreakingNews(message, duration = 5000) {
      const newsElement = document.getElementById('breaking-news');
      if (!newsElement) return;

      // If called from test button, generate a test event
      if (message === true) {
        const testSneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        // Always positive effect for test
        const effect = Math.random() * 0.5 + 0.1;
        const percentage = Math.abs(Math.round(effect * 100));
        const direction = "increased";
        const reason = marketReasons.increase[Math.floor(Math.random() * marketReasons.increase.length)];
        message = `üìà Market Alert: ${testSneaker.brand} ${testSneaker.model} value has ${direction} by ${percentage}% ${reason}`;
        // Apply test effect
        const eventId = Date.now();
        activeEvents.set(eventId, {
          sneaker: `${testSneaker.brand} ${testSneaker.model}`,
          effect: effect,
          endTime: Date.now() + 300000 // 5 minutes
        });
        updateInventoryValues();
        setTimeout(() => {
          activeEvents.delete(eventId);
          updateInventoryValues();
        }, 300000);
      }

      // Clear any existing timeouts
      if (newsElement.timeout) {
        clearTimeout(newsElement.timeout);
      }

      newsElement.textContent = message;
      newsElement.style.display = 'block';
      
      // Force a reflow to restart animation
      void newsElement.offsetWidth;
      newsElement.style.animation = 'none';
      requestAnimationFrame(() => {
        newsElement.style.animation = 'slideDown 0.5s ease-out, glow 2s infinite';
      });

      newsElement.timeout = setTimeout(() => {
        newsElement.style.animation = 'none';
        newsElement.style.display = 'none';
      }, duration);
    }

    function updateInventoryValues() {
      inventory.forEach(sneaker => {
        let totalEffect = 1;
        activeEvents.forEach(event => {
          if (event.sneaker === `${sneaker.brand} ${sneaker.model}`) {
            totalEffect *= (1 + event.effect);
          }
        });
        sneaker.dynamicValue = Math.round(sneaker.baseValue * totalEffect);
      });
      updateInventory();
      updateTradeComparison(); // Update trade values if in a trade
    }

    // Start news generation immediately and run every minute
    generateNewsEvent(); // Initial news
    setInterval(generateNewsEvent, 60000); // Every minute

    // Add event listener for test button
    document.querySelector('.test-button').addEventListener('click', () => {
      console.log("Test button clicked"); // Debug log
      showBreakingNews(true);
    });

    let resellAgent = {
      level: 0, // Start at level 0
      maxLevel: 5,
      baseUpgradeCost: 500,
      bonusPerLevel: 0.2
    };

    let storageUpgrades = 0;
    let storageCost = 300;
    let limitedOffers = new Map();

    function upgradeResellAgent() {
      const cost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
      
      if (coins >= cost && resellAgent.level < resellAgent.maxLevel) {
        coins -= cost;
        resellAgent.level++;
        updateResellAgentDisplay();
        updateCoins();
        showPurchaseNotification(`Resell Agent upgraded to Level ${resellAgent.level}!`);
        
        // Update the upgrade button text with new cost
        const nextCost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
        const upgradeBtn = document.getElementById('upgrade-agent-btn');
        if (upgradeBtn) {
          upgradeBtn.textContent = resellAgent.level < resellAgent.maxLevel ? 
            `Upgrade Agent (${formatCurrency(nextCost)} coins)` : 
            'Max Level Reached!';
        }
      } else if (resellAgent.level >= resellAgent.maxLevel) {
        showPurchaseNotification('Already at maximum level!', 'error');
      } else {
        showPurchaseNotification('Not enough coins!', 'error');
      }
    }

    // Breaking News System
    const marketReasons = {
      increase: [
        "due to limited stock availability",
        "after successful collaboration announcement",
        "following positive reviews",
        "due to seasonal demand",
        "after viral social media coverage",
        "due to collector interest",
        "following successful restock",
        "after design award recognition"
      ],
      decrease: [
        "due to increased market supply",
        "following new competitor release",
        "due to changing trends",
        "after negative publicity",
        "due to overstock situation",
        "following retail price adjustments",
        "due to newer model announcement",
        "after market saturation"
      ]
    };

    const celebrityActions = [
      "spotted wearing",
      "featured on Instagram with",
      "performed wearing",
      "endorsed",
      "showcased in new video wearing",
      "spotted shopping for",
      "praised in interview about",
      "wore to major event"
    ];

    const trendReasons = [
      "after going viral on TikTok",
      "due to streetwear influence",
      "following fashion week appearance",
      "after celebrity collaboration announcement",
      "due to retro style comeback",
      "following cultural moment",
      "after music video feature",
      "due to movie appearance"
    ];

    // Staff System
    const staffTypes = [
      {
        id: 'buyer',
        name: 'Market Buyer',
        description: 'Finds rare sneakers at better prices',
        baseCost: 1000,
        baseBonus: 0.10,
        bonusPerLevel: 0.05,
        maxLevel: 5,
        icon: 'üîç',
        getBonusText: (level) => `Reduces pack costs by ${Math.round((level * 0.05 + 0.10) * 100)}%`
      },
      {
        id: 'authenticator',
        name: 'Authenticator',
        description: 'Increases chance of rare finds',
        baseCost: 1500,
        baseBonus: 0.15,
        bonusPerLevel: 0.05,
        maxLevel: 5,
        icon: '‚ú®',
        getBonusText: (level) => `Increases rare sneaker odds by ${Math.round((level * 0.05 + 0.15) * 100)}%`
      },
      {
        id: 'autoBuyer',
        name: 'Auto Buyer',
        description: 'Automatically buys packs and trades to clients every minute. Gets smarter and makes better trades when upgraded.',
        baseCost: 2000,
        baseBonus: 1,
        bonusPerLevel: 1,
        maxLevel: 5,
        icon: 'ü§ñ',
        getBonusText: (level) => `Buys and trades ${level + 1} pack${level > 0 ? 's' : ''} per minute with improved trade value`
      },
      {
        id: 'autoClicker',
        name: 'Auto Clicker',
        description: 'Automatically clicks for coins. Upgradable for faster coin gain.',
        baseCost: 1200,
        baseBonus: 1, // 1 click per second
        bonusPerLevel: 1, // +1 click per second per level
        maxLevel: 5,
        icon: 'üñ±Ô∏è',
        getBonusText: (level) => `Clicks ${level} time${level === 1 ? '' : 's'} per second for coins`
      }
    ];


    function showBreakingNews(message, duration = 5000) {
      const newsElement = document.getElementById('breaking-news');
      if (!newsElement) return;

      // If called from test button, generate a test event
      if (message === true) {
        const testSneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        // Always positive effect for test
        const effect = Math.random() * 0.5 + 0.1;
        const percentage = Math.abs(Math.round(effect * 100));
        const direction = "increased";
        const reason = marketReasons.increase[Math.floor(Math.random() * marketReasons.increase.length)];
        message = `üìà Market Alert: ${testSneaker.brand} ${testSneaker.model} value has ${direction} by ${percentage}% ${reason}`;
        // Apply test effect
        const eventId = Date.now();
        activeEvents.set(eventId, {
          sneaker: `${testSneaker.brand} ${testSneaker.model}`,
          effect: effect,
          endTime: Date.now() + 300000 // 5 minutes
        });
        updateInventoryValues();
        setTimeout(() => {
          activeEvents.delete(eventId);
          updateInventoryValues();
        }, 300000);
      }

      // Clear any existing timeouts and animations
      if (newsElement.timeout) {
        clearTimeout(newsElement.timeout);
      }
      newsElement.style.animation = 'none';

      // Update content and show
    .news-timer::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      height: 100%;
      width: 100%;
      background: rgba(255,255,255,0.8);
      transform-origin: left;
    }
    .news-timer.animate::after {
      animation: newsTimer 5s linear forwards;
    }
    @keyframes newsTimer {
      0% { transform: scaleX(1); }
      100% { transform: scaleX(0); }
    }
    .trader-selection {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    .trader-card {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: transform 0.2s;
      text-align: left;
    }
    .trader-card:hover {
      transform: translateY(-5px);
    }
    .trader-card.selected {
      border: 2px solid #3498db;
    }
    .trader-avatar {
      font-size: 2em;
      margin-bottom: 10px;
    }
    .trader-info {
      font-size: 0.9em;
      color: #95a5a6;
    }
    .limited-offers {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .limited-offer {
      position: relative;
      background: linear-gradient(45deg, #2980b9, #8e44ad);
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .offer-timer {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(0,0,0,0.3);
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.9em;
    }

    .staff-hire-modal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .staff-hire-modal.show {
      display: block;
    }
    .staff-hire-list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
    }
    .staff-hire-item {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      text-align: left;
    }
    .staff-hire-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }
    .staff-hire-cost {
      color: #f1c40f;
      font-weight: bold;
    }
    .test-buttons {
      position: fixed;
      left: -9999px;
      visibility: hidden;
    }
    .test-button {
      background: #8e44ad;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .test-button:hover {
      background: #9b59b6;
    }
    
    /* New styles for clicker, used market, and cleaning game */
    .clicker-button {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 50%;
      width: 100px;
      height: 100px;
      font-size: 24px;
      cursor: pointer;
      transition: transform 0.1s;
      margin: 20px auto;
      display: block;
    }
    
    .clicker-button:active {
      transform: scale(0.95);
    }
    
    .used-market {
      margin: 20px 0;
    }
    
    .used-sneaker {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
      position: relative;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      transition: width 0.3s;
    }
    
    .cleaning-game {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #2c3e50;
      padding: 20px;
      border-radius: 10px;
      z-index: 2000;
      display: none;
      width: 90%;
      max-width: 500px;
      text-align: center;
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .cleaning-game.show {
      display: block;
    }
    
    .cleaning-info {
      margin: 15px 0;
      padding: 10px;
      background: #34495e;
      border-radius: 8px;
    }
    
    .sneaker-canvas {
      background: #34495e;
      border-radius: 8px;
      margin: 10px auto;
      cursor: pointer;
      display: block;
      max-width: 100%;
      height: auto;
    }
    
    .condition-bar {
      height: 10px;
      background: #2c3e50;
      border-radius: 5px;
      margin: 10px 0;
      overflow: hidden;
    }
    
    .condition-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c 0%, #f1c40f 50%, #2ecc71 100%);
      width: 0;
      transition: width 0.3s;
    }
    
    #used-market-modal {
      max-height: 90vh;
      overflow-y: auto;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: #34495e;
      border-radius: 8px 8px 0 0;
      margin: -20px -20px 20px -20px;
    }
    
    .modal-header h2 {
      margin: 0;
      color: white;
    }
    
    .click-count {
      font-size: 18px;
      color: #3498db;
      margin: 10px 0;
    }
    
    .used-market-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin: 15px 0;
      max-height: 70vh;
      overflow-y: auto;
      padding: 15px;
    }

    /* Comprehensive light mode styles */
    .light-mode {
      background-color: #f5f6fa;
      color: #2c3e50;
    }
    
    .light-mode .sneaker-card,
    .light-mode .modal,
    .light-mode .settings-item,
    .light-mode .trade-side,
    .light-mode .ai-trader-info,
    .light-mode .ai-response,
    .light-mode .selected-sneaker,
    .light-mode .purchase-item {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .light-mode .modal-overlay {
      background: rgba(0, 0, 0, 0.2);
    }
    
    .light-mode .pack-button,
    .light-mode .negotiation-btn,
    .light-mode .close-btn {
      background-color: #3498db;
      color: white;
    }
    
    .light-mode .pack-button:hover,
    .light-mode .negotiation-btn:hover {
      background-color: #2980b9;
    }
    
    .light-mode .modal-header {
      background-color: #f8f9fa;
      color: #2c3e50;
    }
    
    .light-mode select {
      background-color: #ffffff;
      color: #2c3e50;
      border-color: #bdc3c7;
    }

    /* Fix sneaker positioning in popups */
    .card {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
    }

    .roll-item {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) !important;
      margin: 0 !important;
      width: 180px;
      height: 130px;
    }

    /* Update animations */
    @keyframes rollAndReveal {
      0% { transform: translate(-50%, -150%) rotate(-180deg); opacity: 0; }
      70% { transform: translate(-50%, -30%) rotate(20deg); opacity: 0.7; }
      90% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
      100% { transform: translate(-50%, -50%) rotate(0deg); opacity: 1; }
    }

    /* Rarity-specific reveal animations */
    .reveal-common {
      animation: rollAndReveal 0.8s ease-out, fadeIn 0.3s ease-out 0.8s !important;
    }
    
    .reveal-uncommon {
      animation: rollAndReveal 0.8s ease-out, glowGreen 0.3s ease-out 0.8s !important;
    }
    
    .reveal-rare {
      animation: rollAndReveal 0.8s ease-out, glowBlue 0.3s ease-out 0.8s !important;
    }
    
    .reveal-epic {
      animation: rollAndReveal 0.8s ease-out, glowPurple 0.3s ease-out 0.8s !important;
    }
    
    .reveal-legendary {
      animation: rollAndReveal 0.8s ease-out, explodeGold 0.3s ease-out 0.8s !important;
    }

    @keyframes glowGreen {
      0% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(46, 204, 113, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(46, 204, 113, 0); }
    }

    @keyframes glowBlue {
      0% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(52, 152, 219, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(52, 152, 219, 0); }
    }

    @keyframes glowPurple {
      0% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0.4); }
      50% { box-shadow: 0 0 20px 10px rgba(155, 89, 182, 0.4); }
      100% { box-shadow: 0 0 0 0 rgba(155, 89, 182, 0); }
    }

    @keyframes explodeGold {
      0% { transform: translate(-50%, -50%) scale(0.8); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); }
      50% { transform: translate(-50%, -50%) scale(1.2); box-shadow: 0 0 30px 15px rgba(241, 196, 15, 0.4); }
      100% { transform: translate(-50%, -50%) scale(1); box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
    }

    /* Additional light mode styles */
    .light-mode .cleaning-game {
      background-color: #ffffff;
      color: #2c3e50;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .light-mode .cleaning-game .modal-header {
      background-color: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }

    .light-mode .cleaning-game .modal-header h2 {
      color: #2c3e50;
    }

    .light-mode .limited-offer {
      background: linear-gradient(45deg, #3498db, #9b59b6);
      color: white;
    }

    .light-mode .offer-sneaker {
      background: rgba(255, 255, 255, 0.9);
      color: #2c3e50;
    }

    .light-mode .rarity-common { color: #7f8c8d; }
    .light-mode .rarity-uncommon { color: #27ae60; }
    .light-mode .rarity-rare { color: #2980b9; }
    .light-mode .rarity-epic { color: #8e44ad; }
    .light-mode .rarity-legendary { color: #f39c12; }

    .light-mode .better-value { color: #27ae60; }
    .light-mode .worse-value { color: #e74c3c; }
    .light-mode .equal-value { color: #f1c40f; }

    .light-mode .purchase-notification {
      background: #27ae60;
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    /* Market buyer upgrade system */
    .market-buyers-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin: 15px 0;
    }

    .market-buyer-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background: #34495e;
      border-radius: 5px;
      gap: 10px;
    }

    .market-buyer-option.active {
      background: #2ecc71;
    }

    .light-mode .market-buyer-option {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
    }

    .light-mode .market-buyer-option.active {
      background: #d4edda;
      border-color: #c3e6cb;
    }

    /* Chat area styles */
    .trade-chat { max-height: 180px; overflow-y: auto; background: #222; border-radius: 6px; padding: 8px; margin-bottom: 10px; text-align: left; }
    .trade-chat-msg { margin: 4px 0; padding: 4px 8px; border-radius: 4px; }
    .trade-chat-msg.ai-msg { background: #34495e; color: #f1c40f; }
    .trade-chat-msg.player-msg { background: #2980b9; color: #fff; text-align: right; }
    /* Trade chat: hacker font */
    .trade-chat, .trade-chat-msg { font-family: 'Fira Mono', 'Consolas', 'monospace'; letter-spacing: 0.5px; }

    /* Prestige system styles */
    .prestige-button {
      background: linear-gradient(45deg, #f39c12, #e74c3c);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 10px 20px;
      font-size: 18px;
      margin: 10px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 4px 6px rgba(0,0,0,0.2);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .prestige-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 8px rgba(0,0,0,0.3);
    }
    
    .prestige-button:disabled {
      background: linear-gradient(45deg, #95a5a6, #7f8c8d);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .prestige-info {
      background: #34495e;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: center;
    }
    
    .prestige-level {
      font-size: 24px;
      color: #f39c12;
      margin-bottom: 10px;
      font-weight: bold;
    }
    
    .prestige-bonus {
      font-size: 16px;
      color: #3498db;
      margin: 5px 0;
    }
    
    .prestige-progress {
      background: #2c3e50;
      height: 20px;
      border-radius: 10px;
      margin: 15px 0;
      overflow: hidden;
    }
    
    .prestige-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #e74c3c, #f39c12);
      width: 0%;
      transition: width 0.5s;
    }
    
    .prestige-modal {
      text-align: center;
    }
    
    .prestige-benefits {
      background: #2c3e50;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      text-align: left;
    }
    
    .prestige-modal h3 {
      color: #f39c12;
      margin: 10px 0;
    }
    
    .prestige-confirm-btn {
      background: #e74c3c;
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
    }
    
    .prestige-stars {
      font-size: 28px;
      color: #f39c12;
      letter-spacing: 5px;
      margin: 10px 0;
    }

    .prestige-milestone {
      background: rgba(255, 255, 255, 0.1);
      padding: 8px;
      margin: 5px 0;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .prestige-milestone.achieved {
      background: rgba(46, 204, 113, 0.2);
    }
    
    .prestige-milestone.next {
      background: rgba(52, 152, 219, 0.2);
      border: 1px dashed #3498db;
    }
    
    .milestone-level {
      font-weight: bold;
      min-width: 30px;
      text-align: center;
    }
    
    .milestone-emoji {
      font-size: 20px;
      min-width: 30px;
      text-align: center;
    }
    
    .prestige-milestone-summary {
      margin-top: 10px;
      padding: 10px;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
    }

    /* Save code system styles */
    .save-code-container {
      margin: 15px 0;
      text-align: center;
    }
    
    .save-code-textarea {
      width: 90%;
      height: 80px;
      background: #2c3e50;
      border: 1px solid #34495e;
      border-radius: 5px;
      color: #ecf0f1;
      padding: 10px;
      margin: 10px 0;
      font-family: monospace;
      resize: none;
    }
    
    .save-code-buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 10px 0;
    }
    
    .save-code-btn {
      background: #2980b9;
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      cursor: pointer;
    }
    
    .save-code-btn:hover {
      background: #3498db;
    }
    
    .save-code-info {
      font-size: 0.9em;
      color: #95a5a6;
      margin: 5px 0;
    }
  </style>
</head>
<body>
  <div id="breaking-news" class="breaking-news"></div>
  <div class="modal-overlay" id="modal-overlay" onclick="closeAllModals()"></div>
  <div class="top-right-buttons">
    <button class="history-btn" onclick="openHistory()" title="Purchase History">üìú</button>
    <button class="settings-btn" onclick="openSettings()" title="Settings">‚öôÔ∏è</button>
  </div>
  <header>
    <h1>Sneaker Pack Tycoon</h1>
    <div class="coins">Coins: <span id="coin-count">0</span></div>
  </header>
  <div class="container">
    <button class="clicker-button" onclick="handleClick()">
      Click!
      <div class="click-count">Clicks: 0</div>
    </button>
    <div class="prestige-info">
      <div class="prestige-level">Prestige Level: <span id="prestige-level">0</span></div>
      <div class="prestige-bonus" id="prestige-bonuses"></div>
      <div class="prestige-progress">
        <div class="prestige-progress-fill" id="prestige-progress-fill"></div>
      </div>
      <button class="prestige-button" id="prestige-button" onclick="openPrestigeModal()">PRESTIGE</button>
    </div>
    <div>
      <select id="pack-type" class="pack-select">
        <option value="standard">Standard Pack (100 Coins)</option>
        <option value="premium">Premium Pack (300 Coins)</option>
        <option value="colorway">Colorway Pack (200 Coins)</option>
        <option value="rare">Rare Pack (400 Coins)</option>
        <option value="epic">Epic Pack (700 Coins)</option>
        <option value="legendary">Legendary Pack (2500 Coins)</option>
        <option value="mystery">Mystery Pack (500 Coins)</option>
        <option value="ultra">Ultra Pack (1200 Coins)</option>
        <option value="hype">Hype Pack (900 Coins)</option>
        <option value="classic">Classic Pack (250 Coins)</option>
        <option value="collab">Collab Pack (1500 Coins)</option>
        <option value="seasonal">Seasonal Pack (600 Coins)</option>
      </select>
      <button class="pack-button" onclick="openPack()">Open Pack</button>
      <button class="pack-button" style="margin-left:8px;" onclick="previewPack()">Pack Preview</button>
    </div>
    <div class="daily">
      <h2>Daily Rewards</h2>
      <button class="pack-button" onclick="claimDaily()">Claim Daily Coins</button>
    </div>
    <div class="upgrades">
      <h2>Store Upgrades</h2>
      <button class="pack-button" onclick="openUsedMarket()">Browse Used Sneakers</button>
      <div class="resell-agent">
        <h3>Resell Agents</h3>
        <div class="agent-types" id="agent-types">
          <!-- Agent types will be inserted here -->
        </div>
        <div class="agent-level">
          Level: <div class="level-indicator" id="agent-level"></div>
        </div>
        <div class="agent-bonus" id="agent-bonus"></div>
        <button class="pack-button" id="upgrade-agent-btn" onclick="upgradeResellAgent()">Upgrade Agent</button>
      </div>
      <div class="staff-section">
        <h3>Automated Staff</h3>
        <button class="pack-button" onclick="openHireStaff()">Hire Staff</button>
        <div class="staff-grid" id="staff-grid">
          <!-- Staff members will be inserted here -->
        </div>
      </div>
    </div>
    <div class="inventory">
      <h2>Your Inventory</h2>
      <div id="inventory-list" class="inventory-list-flex"></div>
    </div>
    <div class="trading">
      <h2>AI Trading System (Sneaker-for-Sneaker)</h2>
      <button class="pack-button" onclick="openTradeUI()">Enter Trade</button>
    </div>
  <div class="modal" id="used-market-modal">
    <div class="modal-header">
      <h2>Used Sneaker Market</h2>
      <button class="close-btn" onclick="closeUsedMarket()">Close</button>
    </div>
    <div class="used-market-grid" id="used-market-grid">
      <!-- Used sneakers will be inserted here -->
    </div>
  </div>
  <div class="cleaning-game" id="cleaning-game">
    <div class="modal-header">
      <h2>Clean Your New Sneaker</h2>
      <button class="close-btn" onclick="finishCleaning()">‚úï</button>
    </div>
    <div class="cleaning-info">
      <p>Click on the dirt spots to clean them!</p>
      <div class="condition-bar">
        <div class="condition-fill" id="cleaning-progress"></div>
      </div>
    </div>
    <canvas id="sneaker-canvas" class="sneaker-canvas" width="400" height="300"></canvas>
    <button class="pack-button" onclick="finishCleaning()">Finish Cleaning</button>
  </div>
  <div class="modal" id="pack-modal">
    <div id="modal-content">
      <h2>Opening Pack...</h2>
      <div id="card-container" class="card-container"></div>
      <button id="next-sneaker-btn" onclick="revealNextSneaker()">Next Sneaker</button>
    </div>
  </div>
  <div class="modal" id="trade-modal">
    <div>
      <h2>Select Trader</h2>
      <div class="trader-selection" id="trader-selection">
        <!-- Trader cards will be inserted here -->
      </div>
      <div id="ai-trader" class="ai-trader-info" style="display: none;">
        <!-- AI trader info will be inserted here -->
      </div>
      <div class="trade-selection">
        <div><b>Select sneakers to offer:</b></div>
      <select id="trade-dropdown"></select>
        <button class="pack-button" onclick="addToTrade()">Add to Trade</button>
        <div id="selected-sneakers" class="selected-sneakers"></div>
      </div>
      <div class="trade-comparison">
        <div class="trade-side" id="your-offer">
          <h3>Your Offer</h3>
          <div class="offer-details"></div>
        </div>
        <div class="trade-arrow">‚ÜîÔ∏è</div>
        <div class="trade-side" id="ai-offer">
          <h3>AI's Offer</h3>
          <div class="offer-details"></div>
        </div>
      </div>
      <div id="ai-response" class="ai-response"></div>
      <div class="negotiation-options" id="negotiation-options"></div>
      <div id="trade-offer" class="trade-offer"></div>
      <div id="trade-chat" class="trade-chat"></div>
      <button class="close-btn" onclick="closeTradeUI()">Close</button>
    </div>
  </div>
  <div class="modal" id="settings-modal">
    <div class="modal-header">
      <h2>Settings</h2>
      <button class="close-btn" onclick="closeSettings()">Close</button>
    </div>
    <div class="settings-grid">
      <div class="settings-item">
        <label>
          <input type="checkbox" id="animation-toggle" onclick="toggleAnimation()">
          Show Animations
        </label>
      </div>
      <div class="settings-item">
        <label>
          <input type="checkbox" id="notification-toggle" onclick="toggleNotifications()">
          Show Notifications
        </label>
      </div>
      <div class="settings-item">
        <label for="display-mode">Display Mode</label>
        <select id="display-mode" onchange="updateDisplayMode()">
          <option value="grid">Grid View</option>
          <option value="list">List View</option>
          <option value="compact">Compact View</option>
        </select>
      </div>
      <div class="settings-item">
        <label for="currency-display">Currency Display</label>
        <select id="currency-display" onchange="updateCurrencyDisplay()">
          <option value="coins">Coins</option>
          <option value="k">K Format (1K, 2K)</option>
          <option value="full">Full Number</option>
        </select>
      </div>
      <div class="settings-item">
        <label for="sort-inventory">Default Sort</label>
        <select id="sort-inventory" onchange="updateDefaultSort()">
          <option value="rarity">By Rarity</option>
          <option value="value">By Value</option>
          <option value="brand">By Brand</option>
          <option value="newest">Newest First</option>
        </select>
      </div>
      <div class="settings-item">
        <label>
          <input type="checkbox" id="light-mode-toggle" onclick="toggleLightMode()">
          Light Mode
        </label>
      </div>
      <div class="settings-item">
        <label><input type="checkbox" id="skip-animation-toggle" onclick="toggleSkipAnimation()"> Skip Pack Animation</label>
      </div>
    </div>
    
    <div class="save-code-container">
      <!-- Save import/export removed -->
    </div>
  </div>
  <div class="modal" id="history-modal">
    <div class="modal-header">
      <h2>Purchase History</h2>
      <button class="close-btn" onclick="closeHistory()">Close</button>
    </div>
    <div class="purchase-history" id="purchase-history">
      <!-- Purchase history items will be added here -->
    </div>
  </div>
  <div class="staff-hire-modal" id="staff-hire-modal">
    <div class="modal-header">
      <h2>Hire Staff</h2>
      <button class="close-btn" onclick="closeHireStaff()">Close</button>
    </div>
    <div class="staff-hire-list" id="staff-hire-list">
      <!-- Staff hire options will be inserted here -->
    </div>
  </div>
  <div class="test-buttons">
    <button class="test-button" onclick="showBreakingNews(true)">Test Breaking News</button>
  </div>
  <div class="modal" id="prestige-modal">
    <div class="modal-header">
      <h2>Prestige System</h2>
      <button class="close-btn" onclick="closePrestigeModal()">Close</button>
    </div>
    <div class="prestige-modal">
      <div class="prestige-stars" id="prestige-stars">‚òÖ</div>
      <p>You've reached <span id="prestige-coins-display">100,000</span> coins!</p>
      <p>Are you ready to prestige and reset your progress for permanent bonuses?</p>
      
      <div class="prestige-benefits">
        <h3>Benefits of Prestige Level <span id="next-prestige-level">1</span>:</h3>
        <ul id="prestige-benefits-list">
          <li>Reduced base pack costs (90 coins)</li>
          <li>Increased click value (1 coin per click)</li>
          <li>Keep your prestige bonuses forever</li>
        </ul>
      </div>
      
      <h3>Prestige Milestones:</h3>
      <div id="prestige-milestones">
        <!-- Milestone list will be added here -->
      </div>
      
      <p><strong>Warning:</strong> You will lose all your coins, inventory items, and staff!</p>
      
      <button class="pack-button prestige-confirm-btn" onclick="confirmPrestige()">PRESTIGE NOW</button>
    </div>
  </div>
  <script>
    // Initialize game state
    let coins = 0;
    let inventory = [];
    let purchaseHistory = [];
    let prestigeLevel = 0;
    let clickValue = 1; // 1 coin per click at base (modified by prestige)
    let clicksNeeded = 2; // Number of clicks needed for 1 coin (modified by prestige)
    let clickCounter = 0; // Counter for current clicks
    let inventoryCapacityBonus = 0; // Additional inventory slots from prestige
    let rarityMultiplier = 1; // Multiplier for rarity chances
    let extraSneakerChance = 0; // Chance for extra sneaker in packs
    let passiveIncomeRate = 0; // Passive income per second
    let passiveIncomeInterval = null; // Interval for passive income
    let autoSellCommon = false; // Auto-sell common items
    let freePackChance = 0; // Chance for free packs
    let legendaryBoost = 0; // Boost to legendary chances
    let doubleSaleChance = 0; // Chance for double sale value
    let settings = {
      soundEnabled: true,
      musicEnabled: true,
      soundVolume: 0.5,
      musicVolume: 0.3,
      notifications: true,
      animations: true,
      autoSell: false,
      currencyDisplay: 'full',
      displayMode: 'grid',
      defaultSort: 'rarity',
      rollAnimation: true,
      volume: 50,
      lightMode: false,
      skipPackAnimation: false
    };

    // Initialize game state from save or defaults
    function initializeGame() {
      const savedState = localStorage.getItem('sneakerHustleGameState');
      
      if (savedState) {
        try {
          const gameState = JSON.parse(savedState);
          
          // Restore basic values
          coins = gameState.coins ?? 10000;
          inventory = gameState.inventory || [];
          purchaseHistory = gameState.purchaseHistory || [];
          
          // Restore prestige level
          prestigeLevel = gameState.prestigeLevel || 0;
          
          // Apply prestige bonuses
          applyPrestigeBonuses();
          
          // Restore settings
          if (gameState.settings) {
            settings = {...settings, ...gameState.settings};
          }
          
          // Restore market buyer
          if (gameState.currentMarketBuyer) {
            currentMarketBuyer = gameState.currentMarketBuyer;
          }
          
          // Restore limited offers
          if (gameState.limitedOffers) {
            limitedOffers = new Map(gameState.limitedOffers);
        }
          
          // Restore multipliers
          if (gameState.activeMultipliers) {
            window.globalMultiplier = gameState.activeMultipliers.global;
            window.brandMultipliers = gameState.activeMultipliers.brand;
            window.coinMultiplier = gameState.activeMultipliers.coin;
          }
          
          // Restore trader state
          if (gameState.currentTrader) {
            window.currentTrader = gameState.currentTrader;
            window.lastTraderResponse = gameState.lastTraderResponse;
          }
          if (gameState.hiredStaff) {
            hiredStaff = gameState.hiredStaff;
          }
          if (gameState.resellAgentLevel !== undefined) {
            resellAgent.level = gameState.resellAgentLevel;
          }
          if (gameState.storageUpgrades !== undefined) {
            storageUpgrades = gameState.storageUpgrades;
          }
          if (gameState.storageCost !== undefined) {
            storageCost = gameState.storageCost;
          }
        } catch (error) {
          console.error('Error loading game state:', error);
          setDefaultState();
        }
        } else {
        setDefaultState();
      }
      
      // Update all UI elements
      updateAllDisplays();
      updateStorageDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Set default state for new games
    function setDefaultState() {
      coins = 1000;
      inventory = [];
      purchaseHistory = [];
      prestigeLevel = 0;
      clickValue = 0.5; // Default click value
      settings = {
        soundEnabled: true,
        musicEnabled: true,
        soundVolume: 0.5,
        musicVolume: 0.3,
        notifications: true,
        animations: true,
        autoSell: false,
        currencyDisplay: 'full',
        displayMode: 'grid',
        defaultSort: 'rarity',
        rollAnimation: true,
        volume: 50,
        lightMode: false,
        skipPackAnimation: false
      };
      hiredStaff = [];
      resellAgent.level = 0;
      storageUpgrades = 0;
      storageCost = 300;
      if (document.getElementById('storage-cost')) document.getElementById('storage-cost').textContent = storageCost;
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Update all UI displays
    function updateAllDisplays() {
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      updateLimitedOffers();
      updateMarketBuyerDisplay();
      updatePrestigeDisplay();
      applySettings();
    }

    // Save game state
    function saveGameState() {
      const gameState = {
        coins,
        inventory,
        purchaseHistory,
        settings,
        currentMarketBuyer,
        limitedOffers: Array.from(limitedOffers.entries()),
        activeMultipliers: {
          global: window.globalMultiplier || 1,
          brand: window.brandMultipliers || {},
          coin: window.coinMultiplier || 1
        },
        currentTrader: window.currentTrader,
        lastTraderResponse: window.lastTraderResponse,
        hiredStaff,
        resellAgentLevel: resellAgent.level,
        storageUpgrades,
        storageCost,
        prestigeLevel
      };
      
      localStorage.setItem('sneakerHustleGameState', JSON.stringify(gameState));
    }

    // Initialize when the page loads
    window.addEventListener('load', () => {
      initializeGame();
      generateNewsEvent();
      
      // Set up auto-save
      setInterval(saveGameState, 300000); // Every 5 minutes
    });

    // Save before unloading
    window.addEventListener('beforeunload', saveGameState);

    // Initialize game variables
    let upgrades = { betterOdds: false, storageExpand: false };
    let totalProfit = 0;
    let currentSneakers = [];
    let currentSneakerIndex = 0;
    let currentOffer = null;
    let offerInterval = null;
    let selectedTradeItems = [];
    let activeEvents = new Map();
    let clickCount = 0;
    let currentCleaningSneaker = null;
    let dirtSpots = [];
    let cleaningInProgress = false;

    // News Events Data
    const newsEvents = [
      {
        type: "celebrity",
        templates: [
          "{celebrity} spotted wearing {sneaker}! Prices {direction}!",
          "Breaking: {celebrity} signs deal with {sneaker} brand!",
          "{celebrity}'s {sneaker} collection causing market frenzy!"
        ],
        valueEffect: [0.2, 0.5], // 20-50% increase
        duration: 300000 // 5 minutes
      },
      {
        type: "market",
        templates: [
          "Market Alert: {sneaker} prices {direction} rapidly!",
          "Unexpected demand surge for {sneaker}!",
          "Rare {sneaker} batch discovered! Market adjusting!"
        ],
        valueEffect: [-0.3, 0.3], // -30% to +30%
        duration: 600000 // 10 minutes
      },
      {
        type: "trend",
        templates: [
          "TikTok trend featuring {sneaker} goes viral!",
          "Fashion influencers can't get enough of {sneaker}!",
          "Street style: {sneaker} becomes must-have item!"
        ],
        valueEffect: [0.1, 0.4], // 10-40% increase
        duration: 450000 // 7.5 minutes
      }
    ];

    // Add more celebrities and events
    const celebrities = [
      // Musicians
      "Drake", "Travis Scott", "Kanye West", "Bad Bunny", "The Weeknd",
      "Taylor Swift", "Billie Eilish", "Post Malone", "J Balvin", "BTS",
      "Rihanna", "Jay-Z", "Eminem", "Lil Baby", "Tyler, The Creator",
      
      // Athletes
      "LeBron James", "Cristiano Ronaldo", "Lionel Messi", "Kevin Durant",
      "Stephen Curry", "Neymar Jr", "Kylian Mbapp√©", "Giannis Antetokounmpo",
      "Zion Williamson", "Ja Morant", "Erling Haaland", "Luka Donƒçiƒá",
      
      // Entertainers
      "Zendaya", "Tom Holland", "Michael B. Jordan", "Ryan Reynolds",
      "Donald Glover", "Kevin Hart", "Margot Robbie", "Timoth√©e Chalamet",
      
      // Fashion/Social
      "Kylie Jenner", "Bella Hadid", "A$AP Rocky", "Virgil Abloh",
      "Kim Kardashian", "Kendall Jenner", "Pharrell Williams", "Jerry Lorenzo"
    ];

    // Special Events with Coin Multipliers
    const specialEvents = [
      {
        type: "market_surge",
        templates: [
          "üåü MARKET SURGE: All sales give {multiplier}x coins for {duration} minutes!",
          "üí´ GOLDEN HOUR: {multiplier}x coins from all transactions for {duration} minutes!",
          "üéØ HOT MARKET: Earn {multiplier}x coins from sales for {duration} minutes!"
        ],
        rarity: 0.05, // 5% chance
        multipliers: [2, 3, 5, 10],
        durations: [2, 3, 5] // minutes
      },
      {
        type: "lucky_find",
        templates: [
          "üçÄ LUCKY FIND: Next pack has {multiplier}x better odds!",
          "‚ú® BLESSED PACK: Your next opening has {multiplier}x rarity chance!",
          "üé≤ FORTUNE FAVORS: {multiplier}x rarity boost on your next pack!"
        ],
        rarity: 0.08, // 8% chance
        multipliers: [2, 3, 5]
      },
      {
        type: "market_crash",
        templates: [
          "üìâ MARKET CRASH: All sneakers {direction} in value by {percentage}%!",
          "üí• ECONOMIC SHOCK: Global sneaker values {direction} {percentage}%!",
          "üå™ MARKET CHAOS: Sudden {percentage}% {direction} in all values!"
        ],
        rarity: 0.03, // 3% chance
        effects: [-0.5, -0.3, 0.3, 0.5]
      }
    ];

    // Card reveal effects based on rarity
    const cardEffects = {
      common: {
        animation: "fade",
        color: "#7f8c8d",
        sound: "whoosh"
      },
      rare: {
        animation: "flip",
        color: "#2980b9",
        particles: "sparkle"
      },
      epic: {
        animation: "spin",
        color: "#8e44ad",
        particles: "burst"
      },
      legendary: {
        animation: "explosion",
        color: "#f39c12",
        particles: "fireworks"
      }
    };

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function finishPackOpening() {
      inventory.push(...currentSneakers);
      updateInventory();
      
      // Close the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.remove('show');
      modalOverlay.classList.remove('show');
      
      // Reset state
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      currentSneakerIndex = 0;
      currentSneakers = [];
      
      // Re-enable all buttons
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = false;
      });
      saveGameState();
    }

    // --- 100+ Sneaker Database ---
    const brands = [
      "Nike", "Adidas", "Jordan", "Puma", "Reebok", "New Balance", "Asics", 
      "Converse", "Vans", "Saucony", "Under Armour", "Yeezy", "Off-White",
      "Balenciaga", "Gucci", "Louis Vuitton", "Alexander McQueen", "Dior"
    ];
    
    const models = [
      // Nike Models
      "Air Max 90", "Dunk Low", "Air Force 1", "SB Dunk", "Air Max 95", 
      "Air Max 97", "Air Max 1", "Air Jordan 1", "Air Jordan 4", "Air Jordan 11",
      "Air Presto", "React Element", "Blazer Mid", "Cortez", "Waffle One",
      
      // Adidas Models
      "Yeezy Boost 350", "Superstar", "Ultra Boost", "NMD R1", "Forum Low",
      "Stan Smith", "Samba", "ZX 750", "Ozweego", "Campus",
      
      // Jordan Models
      "Retro 1", "Retro 3", "Retro 4", "Retro 5", "Retro 6",
      "Retro 11", "Retro 12", "Retro 13", "Legacy 312", "XXXV",
      
      // Luxury Models
      "Triple S", "Speed Trainer", "Rhyton", "Ace", "Run Away",
      "B23 High", "Chain Reaction", "Oversized", "Wave", "Track",
      
      // Classic Models
      "Chuck Taylor", "Old Skool", "Sk8-Hi", "Era", "Authentic",
      "Club C 85", "Classic Leather", "Workout Plus", "550", "992",
      
      // Running/Athletic
      "Gel Lyte III", "Kayano 5", "Jazz Original", "Triumph", "HOVR",
      "Fresh Foam", "Kinvara", "Endorphin", "Zoom Fly", "Pegasus"
    ];
    
    const colorways = [
      // Basic Colors
      "White/Black", "Black/White", "Triple Black", "Triple White", "Navy/White",
      "Red/White", "Green/White", "Blue/White", "Grey/White", "Cream/White",
      
      // Popular Nicknames
      "Bred", "Chicago", "Royal", "Shadow", "Mocha",
      "University Blue", "Volt", "Infrared", "Cement", "Pine Green",
      
      // Special Editions
      "Travis Scott", "Off-White", "Fragment", "Union LA", "A Ma Maniere",
      "Sean Wotherspoon", "Virgil Abloh", "Sacai", "Cactus Jack", "Fear of God",
      
      // Patterns
      "Zebra", "Tiger Stripe", "Safari Print", "Snake Skin", "Tie Dye",
      "Splatter", "Gradient", "Camo", "Animal Print", "Paisley",
      
      // Materials
      "Patent Leather", "Suede", "Canvas", "Mesh", "Knit",
      "Premium Leather", "Nubuck", "Corduroy", "Denim", "Velvet",
      
      // Seasonal
      "Summer Pack", "Winter Camo", "Fall Tones", "Spring Pastels", "Holiday",
      "Valentine's Day", "Halloween", "Christmas", "Easter", "New Year",
      
      // Collaborations
      "Supreme", "Undefeated", "Concepts", "Atmos", "Patta",
      "Stussy", "Diamond Supply", "Kith", "Bodega", "SNS",
      
      // Limited Editions
      "Friends & Family", "Sample", "Prototype", "Region Exclusive", "Store Exclusive",
      "Anniversary", "Retro+", "OG", "Vintage", "Player Exclusive"
    ];

    const rarities = [
      { rarity: "common", weight: 60, value: [20, 50] },
      { rarity: "rare", weight: 25, value: [60, 150] },
      { rarity: "epic", weight: 12, value: [200, 400] },
      { rarity: "legendary", weight: 3, value: [500, 2000] }
    ];

    // Instead of generating a fixed database, generate a random sneaker on demand
    function getRandomSneaker(rarity) {
      const brand = brands[Math.floor(Math.random() * brands.length)];
      const model = models[Math.floor(Math.random() * models.length)];
      const colorway = colorways[Math.floor(Math.random() * colorways.length)];
      let baseValue = 50;
      for (let r of rarities) {
        if (r.rarity === rarity) {
          baseValue = Math.floor(r.value[0] + Math.random() * (r.value[1] - r.value[0]));
          break;
        }
      }
      return {
        id: Date.now() + Math.random(),
        brand,
        model,
        colorway,
        rarity,
        baseValue,
        image: `https://robohash.org/${encodeURIComponent(brand + '-' + model + '-' + colorway)}.png?set=set4`
      };
    }

    // --- Pack Definitions ---
    const packTypes = {
      standard: { 
        cost: 100,
        odds: { common: 0.75, rare: 0.20, epic: 0.04, legendary: 0.01 },
        bg: '#222'
      },
      premium: { 
        cost: 300,
        odds: { common: 0.45, rare: 0.35, epic: 0.15, legendary: 0.05 },
        bg: '#2980b9'
      },
      colorway: { 
        cost: 200,
        odds: { common: 0.55, rare: 0.30, epic: 0.12, legendary: 0.03 }, 
        colorway: true,
        bg: '#8e44ad'
      },
      rare: { 
        cost: 400,
        odds: { rare: 0.70, epic: 0.25, legendary: 0.05 },
        bg: '#16a085'
      },
      epic: { 
        cost: 700,
        odds: { rare: 0.25, epic: 0.60, legendary: 0.15 },
        bg: '#8e44ad'
      },
      legendary: { 
        cost: 2500,
        odds: { epic: 0.70, legendary: 0.10 },
        bg: '#f39c12'
      },
      mystery: { 
        cost: 500,
        odds: { common: 0.25, rare: 0.35, epic: 0.30, legendary: 0.10 },
        bg: '#34495e'
      },
      ultra: { 
        cost: 1200,
        odds: { rare: 0.10, epic: 0.60, legendary: 0.30 },
        bg: '#e74c3c'
      },
      hype: { 
        cost: 900,
        odds: { common: 0.10, rare: 0.30, epic: 0.40, legendary: 0.20 },
        bg: '#27ae60'
      },
      classic: { 
        cost: 250,
        odds: { common: 0.60, rare: 0.30, epic: 0.08, legendary: 0.02 },
        bg: '#bdc3c7'
      },
      collab: { 
        cost: 1500,
        odds: { rare: 0.20, epic: 0.40, legendary: 0.40 },
        colorway: true,
        bg: '#9b59b6'
      },
      seasonal: { 
        cost: 600,
        odds: { common: 0.30, rare: 0.40, epic: 0.25, legendary: 0.05 },
        bg: '#f1c40f'
      }
    };

    function showNotification(message) {
      if (!settings.notificationsEnabled) return;
      alert(message);
    }

    function updateInventory() {
      const inventoryDiv = document.getElementById("inventory-list");
      inventoryDiv.innerHTML = '';
      if (inventory.length === 0) {
        inventoryDiv.innerHTML = "<em>No sneakers in inventory.</em>";
        return;
      }

      // Sort inventory based on settings
      const sortedInventory = [...inventory].sort((a, b) => {
        switch (settings.defaultSort) {
          case 'rarity':
            return rarities.findIndex(r => r.rarity === b.rarity) - 
                   rarities.findIndex(r => r.rarity === a.rarity);
          case 'value':
            return (b.dynamicValue || b.baseValue) - (a.dynamicValue || a.baseValue);
          case 'brand':
            return a.brand.localeCompare(b.brand);
          case 'newest':
            return inventory.indexOf(b) - inventory.indexOf(a);
          default:
            return 0;
        }
      });

      sortedInventory.forEach((sneaker, index) => {
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) 
          ? sneaker.dynamicValue 
          : sneaker.baseValue;
        
        const event = activeEvents.get(sneaker.id);
        const valueChangeClass = event ? 
          (event.effect > 0 ? 'value-increase' : 'value-decrease') : '';

        inventoryDiv.innerHTML += `
          <div class="sneaker-card" data-sneaker-id="${sneaker.id}">
            <img src="${sneaker.image}" alt="${sneaker.brand} ${sneaker.model}" style="width:80px;height:80px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
            <strong>${sneaker.brand} ${sneaker.model}</strong>
            <span>${sneaker.colorway}</span>
            <span class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</span><br>
            <span class="sneaker-value ${valueChangeClass}">
              Value: ${formatCurrency(Math.floor(value))} coins
            </span>
            <br><button onclick="sellSneakerById('${sneaker.id}')" style="margin-top:8px;padding:5px 10px;">Sell</button>
          </div>
        `;
      });

      // Update trade dropdown if it exists
      if (document.getElementById("trade-dropdown")) {
        renderTradeDropdown();
      }
    }
    function updateCoins() {
      const coinDisplay = document.getElementById('coin-count');
      if (coinDisplay) {
        let displayValue = coins;
        if (settings.currencyDisplay === 'k') {
          displayValue = coins >= 1000 ? (coins/1000).toFixed(1) + 'K' : coins;
        }
        coinDisplay.textContent = formatCurrency(displayValue);
      }
    }

    function formatCurrency(amount) {
      if (settings.currencyDisplay === 'k' && amount >= 1000) {
        return (amount/1000).toFixed(1) + 'K';
      } else if (settings.currencyDisplay === 'full') {
        return amount.toLocaleString();
      }
      return amount.toString();
    }

    function loadSettings() {
      const savedSettings = localStorage.getItem('gameSettings');
      if (savedSettings) {
        settings = JSON.parse(savedSettings);
        document.getElementById('auto-sell-toggle').checked = settings.autoSell;
        document.getElementById('sound-toggle').checked = settings.soundEnabled;
        document.getElementById('animation-toggle').checked = settings.animationEnabled;
        document.getElementById('notification-toggle').checked = settings.notificationsEnabled;
        document.getElementById('volume-control').value = settings.volume;
        document.getElementById('volume-value').textContent = settings.volume + '%';
        document.getElementById('display-mode').value = settings.displayMode;
        document.getElementById('currency-display').value = settings.currencyDisplay;
        document.getElementById('sort-inventory').value = settings.defaultSort;
        document.getElementById('roll-animation-toggle').checked = settings.rollAnimation;
        document.getElementById('light-mode-toggle').checked = settings.lightMode;
        document.getElementById('skip-animation-toggle').checked = settings.skipPackAnimation;
        if (settings.lightMode) {
          document.body.classList.add('light-mode');
        } else {
          document.body.classList.remove('light-mode');
        }
        if (!settings.animationEnabled) {
          document.body.classList.add('no-animations');
        }
        updateInventory();
        updateCoins();
      }
    }

    function saveSettings() {
      localStorage.setItem('gameSettings', JSON.stringify(settings));
    }

    function applySettings() {
      // Apply settings to UI and game state
      document.body.classList.toggle('light-mode', !!settings.lightMode);
      document.body.classList.toggle('no-animations', settings.animationEnabled === false);

      // Update toggles if they exist
      if (document.getElementById('animation-toggle')) {
        document.getElementById('animation-toggle').checked = !!settings.animationEnabled;
      }
      if (document.getElementById('notification-toggle')) {
        document.getElementById('notification-toggle').checked = !!settings.notificationsEnabled;
      }
      if (document.getElementById('light-mode-toggle')) {
        document.getElementById('light-mode-toggle').checked = !!settings.lightMode;
      }
      if (document.getElementById('skip-animation-toggle')) {
        document.getElementById('skip-animation-toggle').checked = !!settings.skipPackAnimation;
      }
      if (document.getElementById('display-mode')) {
        document.getElementById('display-mode').value = settings.displayMode;
      }
      if (document.getElementById('currency-display')) {
        document.getElementById('currency-display').value = settings.currencyDisplay;
      }
      if (document.getElementById('sort-inventory')) {
        document.getElementById('sort-inventory').value = settings.defaultSort;
      }
      // Update inventory and coins display
      updateInventory();
      updateCoins();
    }

    function toggleAutoSell() {
      settings.autoSell = document.getElementById('auto-sell-toggle').checked;
      saveSettings();
    }

    function toggleSound() {
      settings.soundEnabled = document.getElementById('sound-toggle').checked;
      saveSettings();
    }

    function toggleAnimation() {
      settings.animationEnabled = document.getElementById('animation-toggle').checked;
      document.body.classList.toggle('no-animations', !settings.animationEnabled);
      saveSettings();
    }

    function toggleNotifications() {
      settings.notificationsEnabled = document.getElementById('notification-toggle').checked;
      saveSettings();
    }

    function updateVolume() {
      settings.volume = document.getElementById('volume-control').value;
      document.getElementById('volume-value').textContent = settings.volume + '%';
      saveSettings();
    }

    function updateDisplayMode() {
      settings.displayMode = document.getElementById('display-mode').value;
      const inventoryList = document.getElementById('inventory-list');
      inventoryList.className = 'inventory-' + settings.displayMode;
      saveSettings();
      updateInventory();
    }

    function updateCurrencyDisplay() {
      settings.currencyDisplay = document.getElementById('currency-display').value;
      saveSettings();
      updateCoins();
      updateInventory();
    }

    function updateDefaultSort() {
      settings.defaultSort = document.getElementById('sort-inventory').value;
      saveSettings();
      updateInventory();
    }

    function toggleRollAnimation() {
      settings.rollAnimation = document.getElementById('roll-animation-toggle').checked;
      saveSettings();
    }

    function openPack() {
      const type = document.getElementById("pack-type").value;
      let pack = {...packTypes[type]};
      
      // --- Always apply staff bonuses before opening pack ---
      applyStaffBonuses();
      
      // Check for free pack chance from prestige
      let isFree = false;
      if (freePackChance > 0 && Math.random() < freePackChance) {
        isFree = true;
        showPurchaseNotification("üéÅ Free pack from prestige bonus!", "success");
      }
      
      // Apply prestige effect on pack cost if applicable
      if (prestigeLevel > 0) {
        pack.cost = Math.max(90, Math.floor(pack.cost * Math.pow(0.9, prestigeLevel)));
      }
      
      // Apply buyer staff discount
      if (type !== 'legendary' && packPriceMultiplier < 1) {
        pack.cost = Math.floor(pack.cost * packPriceMultiplier);
      }
      
      if (!isFree && coins < pack.cost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      
      // Only deduct coins if not a free pack
      if (!isFree) {
        coins -= pack.cost;
        updateCoins();
      }

      // Disable buttons during pack opening
      document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
        btn.disabled = true;
      });

      // Show the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.add('show');
      modalOverlay.classList.add('show');

      // Generate sneakers
      currentSneakers = [];
      
      // Determine how many sneakers - check for extra sneaker chance
      let sneakerCount = 3;
      if (extraSneakerChance > 0 && Math.random() < extraSneakerChance) {
        sneakerCount = 4;
        showPurchaseNotification("üéÅ Extra sneaker from prestige bonus!", "success");
      }
      
      for (let i = 0; i < sneakerCount; i++) {
        let sneaker = rollSneaker(type);
        currentSneakers.push(sneaker);
      }

      // Record the purchase
      addPurchaseToHistory('Pack Opening', isFree ? 0 : pack.cost, currentSneakers);
      
      // Reset state and start reveal
      currentSneakerIndex = 0;
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      revealNextSneaker();

      // Apply authenticator staff bonus to odds
      let odds = {...pack.odds};
      if (rarityBonus > 0) {
        if (odds.rare) odds.rare += rarityBonus;
        if (odds.epic) odds.epic += rarityBonus;
        if (odds.legendary) odds.legendary += rarityBonus;
        // Normalize odds if they exceed 1
        let total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      saveGameState();
    }

    // Patch rollSneaker to use getRandomSneaker and allow all brands
    function rollSneaker(type) {
      // --- Always apply staff bonuses before rolling sneaker ---
      applyStaffBonuses();
      const pack = packTypes[type];
      let roll = Math.random();
      
      // Apply prestige rarity multiplier
      if (rarityMultiplier > 1) {
        // Shift the roll toward better rarities
        roll = Math.pow(roll, 1 / rarityMultiplier);
      }
      
      // Apply legendary boost if applicable
      let odds = {...pack.odds};
      if (legendaryBoost > 0 && odds.legendary) {
        // Increase legendary odds
        odds.legendary += legendaryBoost;
        
        // Normalize odds
        const total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      
      if (upgrades.betterOdds) roll += 0.05;
      // --- Apply authenticator staff bonus to odds ---
      if (rarityBonus > 0) {
        if (odds.rare) odds.rare += rarityBonus;
        if (odds.epic) odds.epic += rarityBonus;
        if (odds.legendary) odds.legendary += rarityBonus;
        // Normalize odds if they exceed 1
        let total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      let rarity = "common";
      let sum = 0;
      for (let key of ["common", "rare", "epic", "legendary"]) {
        if (odds[key]) {
          sum += odds[key];
          if (roll < sum) {
            rarity = key;
            break;
          }
        }
      }
      // If colorway pack, just use random colorway
      return getRandomSneaker(rarity);
    }

    function createRollItem(sneaker) {
      return `
        <strong>${sneaker.brand} ${sneaker.model}</strong>
        <span>${sneaker.colorway}</span>
        <span class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</span>
      `;
    }

    function sellSneaker(index) {
      if (index < 0 || index >= inventory.length) return;
      
      let sneaker = inventory[index];
      let value = sneaker.baseValue;
      
      // Apply any active event effects
      activeEvents.forEach(event => {
        if (event.sneaker === `${sneaker.brand} ${sneaker.model}`) {
          value *= (1 + event.effect);
        }
      });
      
      // Apply resell agent bonus
      const bonus = 1 + (resellAgent.level * resellAgent.bonusPerLevel);
      value = Math.floor(value * bonus);
      
      // Apply double sale chance from prestige
      let isDoubleSale = false;
      if (doubleSaleChance > 0 && Math.random() < doubleSaleChance) {
        value *= 2;
        isDoubleSale = true;
      }
      
      coins += value;
      inventory.splice(index, 1); // Remove the sneaker from inventory
      updateCoins();
      updateInventory();
      
      // Show different notification based on if it was a double sale
      if (isDoubleSale) {
        showPurchaseNotification(`üí∞ DOUBLE SALE! Sold ${sneaker.brand} ${sneaker.model} for ${formatCurrency(value)} coins!`);
      } else {
        showPurchaseNotification(`Sold ${sneaker.brand} ${sneaker.model} for ${formatCurrency(value)} coins!`);
      }
      saveGameState();
    }

    function claimDaily() {
      const lastClaim = localStorage.getItem('dailyReward');
      const now = Date.now();
      if (!lastClaim || now - lastClaim > 86400000) {
        coins += 300;
        localStorage.setItem('dailyReward', now);
        updateCoins();
        showNotification("Daily reward claimed!");
      } else {
        showNotification("Already claimed today!");
      }
      saveGameState();
    }

    function buyUpgrade(type) {
      if (type === 'storageExpand') {
        if (storageUpgrades >= 10) {
          showPurchaseNotification('Maximum storage reached!', 'error');
          return;
        }
        if (coins >= storageCost) {
          coins -= storageCost;
          storageUpgrades++;
          storageCost = Math.floor(storageCost * 1.5); // 50% increase each time
          document.getElementById('storage-cost').textContent = storageCost;
          showPurchaseNotification('Storage expanded!');
          updateCoins();
        } else {
          showPurchaseNotification('Not enough coins!', 'error');
        }
      }
      saveGameState();
    }

    // --- TRADE UI ---
    let aiTradeOffer = [];

    // AI Trader System
    const aiTraders = [
      { name: "Sneaker Steve", emoji: "üëü", preferences: ["Nike", "Jordan", "Yeezy", "Adidas", "SB Dunk", "Ultra Boost"], style: "hype", valuePreference: "high", traits: ["Loves limited editions", "Prefers hyped releases"] },
      { name: "Vintage Vicky", emoji: "üë†", preferences: ["Converse", "Vans", "Chuck Taylor", "Old Skool", "Classic Leather", "Retro+"], style: "classic", valuePreference: "low", traits: ["Collects retro models", "Values original colorways"] },
      { name: "Luxury Larry", emoji: "üíé", preferences: ["Balenciaga", "Gucci", "Louis Vuitton", "Dior", "legendary", "epic"], style: "luxury", valuePreference: "ultra", traits: ["Only wants premium items", "Focuses on rare finds"] },
      { name: "Budget Bob", emoji: "üí∞", preferences: ["common", "rare", "Puma", "Reebok", "Saucony", "Under Armour"], style: "budget", valuePreference: "low", traits: ["Looks for deals", "Prefers common models"] },
      { name: "Collector Charlie", emoji: "üèÜ", preferences: ["rare", "epic", "550", "992", "Sample", "OG"], style: "collector", valuePreference: "medium", traits: ["Completes sets", "Values condition"] },
      { name: "Reseller Rachel", emoji: "üìà", preferences: ["Jordan", "Yeezy", "SB Dunk", "Ultra Boost", "Forum Low"], style: "hype", valuePreference: "high", traits: ["Watches market trends", "Knows resale values"] },
      { name: "Designer Dan", emoji: "‚ú®", preferences: ["Off-White", "Travis Scott", "Fragment", "Union LA", "limited", "colorway"], style: "luxury", valuePreference: "high", traits: ["Loves unique designs", "Prefers collaborations"] },
      { name: "Athletic Amy", emoji: "üèÉ‚Äç‚ôÄÔ∏è", preferences: ["Nike", "Asics", "Gel Lyte III", "Kayano 5", "Zoom Fly", "Pegasus"], style: "classic", valuePreference: "medium", traits: ["Values performance", "Likes durability"] },
      { name: "Trendy Tom", emoji: "üåü", preferences: ["New Balance", "Adidas", "Fresh Foam", "Stan Smith", "Campus", "Samba"], style: "hype", valuePreference: "medium", traits: ["Follows social media", "Loves new releases"] },
      { name: "Casual Casey", emoji: "üòä", preferences: ["Vans", "Converse", "Era", "Authentic", "Club C 85", "Workout Plus"], style: "budget", valuePreference: "low", traits: ["Practical choices", "Daily wear focus"] }
    ];

    const aiPersonalities = [
      "Always looking for the best deal",
      "Loves rare colorways",
      "Interested in limited editions only",
      "Collects specific brands",
      "Values condition over brand",
      "Prefers matching sets",
      "Focuses on resale value",
      "Interested in vintage models",
      "Loves exclusive releases",
      "Only trades for premium items"
    ];

    let currentTrader = null;

    function revealNextSneaker() {
      const nextButton = document.getElementById("next-sneaker-btn");
      nextButton.disabled = true;
      
      if (currentSneakerIndex < currentSneakers.length) {
        const winningSneaker = currentSneakers[currentSneakerIndex];
        const cardContainer = document.getElementById("card-container");
        cardContainer.innerHTML = "";

        // Set background color based on pack type
        const type = document.getElementById("pack-type")?.value;
        if (type && packTypes[type] && packTypes[type].bg) {
          cardContainer.style.background = packTypes[type].bg;
        } else {
          cardContainer.style.background = '#222';
        }

        // Generate a pool of random sneakers for the roll (TRUE MIX OF RARITIES)
        const rollOptions = [];
        const rollCount = 20;
        const centerPos = Math.floor(rollCount / 2);
        for (let i = 0; i < rollCount; i++) {
          if (i === centerPos) {
            rollOptions.push(winningSneaker);
          } else {
            // Pick a random rarity for each roll (not just the winning rarity)
            const randomRarity = rarities[Math.floor(Math.random() * rarities.length)].rarity;
            rollOptions.push(getRandomSneaker(randomRarity));
          }
        }
        // Build the roll track
        const track = document.createElement("div");
        track.className = "casino-roll-track";
        track.style.width = `${rollCount * 200}px`;
        rollOptions.forEach((s, idx) => {
          const card = document.createElement("div");
          card.className = "casino-roll-card" + (idx === centerPos ? " selected" : "");
          card.innerHTML = `<img src="${s.image}" alt="${s.brand} ${s.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />` +
            `<strong>${s.brand} ${s.model}</strong><span>${s.colorway}</span><span class='rarity-${s.rarity}'>[${s.rarity.toUpperCase()}]</span>`;
          track.appendChild(card);
        });
        cardContainer.appendChild(track);
        setTimeout(() => {
          const cardWidth = 200;
          const containerWidth = cardContainer.offsetWidth;
          const offset = (centerPos * cardWidth) + (cardWidth / 2) - (containerWidth / 2);
          track.style.transform = `translateX(-${offset}px)`;
        }, 100);
        setTimeout(() => {
          currentSneakerIndex++;
          if (currentSneakerIndex < currentSneakers.length) {
            nextButton.disabled = false;
          } else {
            finishPackOpening();
          }
        }, 2200);
      }
    }

    function generateRandomTrader() {
      const baseTrader = aiTraders[Math.floor(Math.random() * aiTraders.length)];
      const personality = aiPersonalities[Math.floor(Math.random() * aiPersonalities.length)];
      
      // Add some randomization to preferences
      const randomBrands = [...brands].sort(() => Math.random() - 0.5).slice(0, 2);
      const randomRarities = ["common", "rare", "epic", "legendary"].sort(() => Math.random() - 0.5).slice(0, 2);
      
      return {
        ...baseTrader,
        personality,
        additionalPreferences: {
          brands: randomBrands,
          rarities: randomRarities,
          minValue: Math.floor(Math.random() * 300) + 100,
          maxValue: Math.floor(Math.random() * 1000) + 500,
          prefersSets: Math.random() > 0.5,
          prefersColorways: Math.random() > 0.5
        }
      };
    }

    function updateAITraderDisplay() {
      const traderDiv = document.getElementById('ai-trader');
      if (!traderDiv) return;

      const styleDisplay = currentTrader.style.charAt(0).toUpperCase() + currentTrader.style.slice(1);
      const valueDisplay = currentTrader.valuePreference.charAt(0).toUpperCase() + currentTrader.valuePreference.slice(1);
      
      traderDiv.innerHTML = `
        <div class="ai-avatar">${currentTrader.emoji}</div>
        <div class="ai-details">
          <div class="ai-name">${currentTrader.name}</div>
          <div class="ai-preference">Style: ${styleDisplay}</div>
          <div class="ai-preference">Value: ${valueDisplay}</div>
          <div class="ai-preference">Prefers: ${currentTrader.preferences.join(', ')}</div>
          <div class="ai-preference">Traits: ${currentTrader.traits.join(', ')}</div>
        </div>
      `;
    }

    function openTradeUI() {
      selectedTradeItems = [];
      aiTradeOffer = [];
      currentTrader = null;
      
      const tradeModal = document.getElementById("trade-modal");
      const overlay = document.getElementById("modal-overlay");
      const aiTrader = document.getElementById("ai-trader");
      const traderSelection = document.getElementById("trader-selection");
      
      tradeModal.classList.add("show");
      overlay.classList.add("show");
      
      aiTrader.style.display = "none";
      traderSelection.style.display = "block";
      
      document.getElementById("selected-sneakers").innerHTML = "";
      document.getElementById("trade-offer").innerHTML = "";
      document.querySelector('#your-offer .offer-details').innerHTML = "";
      document.querySelector('#ai-offer .offer-details').innerHTML = "";
      document.getElementById('trade-chat').innerHTML = '';
      
      renderTraderSelection();
    }

    function closeTradeUI() {
      document.getElementById("trade-modal").classList.remove("show");
    }

    function renderTraderSelection() {
      const container = document.getElementById("trader-selection");
      container.innerHTML = aiTraders.map(trader => `
        <div class="trader-card" onclick="selectTrader('${trader.name}')">
          <div class="trader-avatar">${trader.emoji}</div>
          <div class="trader-name">${trader.name}</div>
          <div class="trader-info">
            <div>Style: ${trader.style.charAt(0).toUpperCase() + trader.style.slice(1)}</div>
            <div>Prefers: ${trader.preferences.join(', ')}</div>
            <div>Value: ${trader.valuePreference.charAt(0).toUpperCase() + trader.valuePreference.slice(1)}</div>
          </div>
        </div>
      `).join('');
    }

    function selectTrader(name) {
      currentTrader = aiTraders.find(t => t.name === name);
      if (!currentTrader) return;

      document.getElementById("trader-selection").style.display = "none";
      document.getElementById("ai-trader").style.display = "block";
      updateAITraderDisplay();
      renderTradeDropdown();
    }

    function renderTradeDropdown() {
      const dropdown = document.getElementById("trade-dropdown");
      dropdown.innerHTML = "";
      if (inventory.length === 0) {
        dropdown.innerHTML = "<option>No sneakers to trade</option>";
        dropdown.disabled = true;
        return;
      }
      dropdown.disabled = false;
      
      // Only show sneakers that aren't already selected
      const availableSneakers = inventory.filter((_, idx) => !selectedTradeItems.includes(idx));
      
      if (availableSneakers.length === 0) {
        dropdown.innerHTML = "<option>No more sneakers available</option>";
        dropdown.disabled = true;
        return;
      }

      availableSneakers.forEach((sneaker, idx) => {
        const originalIndex = inventory.indexOf(sneaker);
        let value = (typeof sneaker.dynamicValue === "number" && !isNaN(sneaker.dynamicValue)) ? 
          sneaker.dynamicValue : sneaker.baseValue;
        let text = `${sneaker.brand} ${sneaker.model} (${sneaker.colorway}) [${sneaker.rarity.toUpperCase()}] - ${formatCurrency(Math.floor(value))}c`;
        let option = document.createElement("option");
        option.value = originalIndex;
        option.textContent = text;
        dropdown.appendChild(option);
      });
    }

    function addToTrade() {
      const dropdown = document.getElementById("trade-dropdown");
      const selectedIndex = parseInt(dropdown.value);
      
      if (isNaN(selectedIndex) || selectedIndex < 0 || selectedIndex >= inventory.length) {
        showPurchaseNotification("Invalid selection!", "error");
        return;
      }

      if (selectedTradeItems.includes(selectedIndex)) {
        showPurchaseNotification("This sneaker is already in the trade!", "error");
        return;
      }

      selectedTradeItems.push(selectedIndex);
      updateSelectedSneakers();
      renderTradeDropdown();
        generateAITradeOffer();
      appendTradeChatMessage('player', `Let me see... You're offering ${selectedTradeItems.map(index => inventory[index].brand+' '+inventory[index].model).join(', ')}. Here's what I think...`);
    }

    function updateSelectedSneakers() {
      const container = document.getElementById("selected-sneakers");
      if (!container) return;

      container.innerHTML = selectedTradeItems.map(index => {
        if (index < 0 || index >= inventory.length) return '';
        
        const sneaker = inventory[index];
        return `
          <div class="selected-sneaker">
            <span>${sneaker.brand} ${sneaker.model} [${sneaker.rarity.toUpperCase()}]</span>
            <button class="remove-sneaker" onclick="removeFromTrade(${index})">√ó</button>
          </div>
        `;
      }).join('');

      updateTradeComparison();
    }

    function removeFromTrade(index) {
      selectedTradeItems = selectedTradeItems.filter(i => i !== index);
      updateSelectedSneakers();
      renderTradeDropdown();
      generateAITradeOffer();
    }

    function updateTradeComparison() {
      if (selectedTradeItems.length === 0) {
        document.querySelector('#your-offer .offer-details').innerHTML = "<em>Select sneakers to trade</em>";
        document.querySelector('#ai-offer .offer-details').innerHTML = "";
        return;
      }

      const yourSneakers = selectedTradeItems.map(index => inventory[index]);
      const yourTotalValue = yourSneakers.reduce((sum, s) => {
        const value = (typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue;
        return sum + value;
      }, 0);

      const aiTotalValue = aiTradeOffer.reduce((sum, s) => {
        const value = (typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue;
        return sum + value;
      }, 0);

      const valueDiff = aiTotalValue - yourTotalValue;
      let valueClass = 'equal-value';
      if (valueDiff > 50) valueClass = 'better-value';
      if (valueDiff < -50) valueClass = 'worse-value';

      document.querySelector('#your-offer .offer-details').innerHTML = `
        ${yourSneakers.map(s => `
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class="rarity-${s.rarity}">[${s.rarity.toUpperCase()}]</span><br>
        `).join('<br>')}
        <div class="value-comparison">Total Value: ${formatCurrency(Math.floor(yourTotalValue))} coins</div>
      `;

      document.querySelector('#ai-offer .offer-details').innerHTML = `
        ${aiTradeOffer.map(s => `
          <strong>${s.brand} ${s.model}</strong><br>
          <span>${s.colorway}</span><br>
          <span class="rarity-${s.rarity}">[${s.rarity.toUpperCase()}]</span><br>
        `).join('<br>')}
        <div class="value-comparison ${valueClass}">
          Total Value: ${formatCurrency(Math.floor(aiTotalValue))} coins
          ${valueDiff !== 0 ? `(${valueDiff > 0 ? '+' : ''}${formatCurrency(Math.floor(valueDiff))})` : ''}
        </div>
      `;
    }

    function generateAITradeOffer(adjustment = 1.0) {
      if (!currentTrader || selectedTradeItems.length === 0) {
        updateTradeComparison();
        return;
      }

      const yourSneakers = selectedTradeItems.map(index => inventory[index]);
      const yourTotalValue = yourSneakers.reduce((sum, s) => {
        return sum + ((typeof s.dynamicValue === "number" && !isNaN(s.dynamicValue)) ? 
          s.dynamicValue : s.baseValue);
      }, 0);

      // Calculate preference score for the offered sneakers
      let preferenceBonus = 0;
      yourSneakers.forEach(sneaker => {
        // Brand preference check
        if (currentTrader.preferences.some(pref => 
          sneaker.brand.includes(pref) || 
          sneaker.model.includes(pref)
        )) {
          preferenceBonus += 0.15; // 15% bonus per preferred brand/model
        }
        
        // Rarity preference check
        if (currentTrader.preferences.some(pref => 
          sneaker.rarity.toLowerCase() === pref.toLowerCase()
        )) {
          preferenceBonus += 0.2; // 20% bonus for preferred rarity
        }
        
        // Style match check
        if ((currentTrader.style === 'hype' && (sneaker.rarity === 'legendary' || sneaker.rarity === 'epic')) ||
            (currentTrader.style === 'budget' && (sneaker.rarity === 'common' || sneaker.rarity === 'rare')) ||
            (currentTrader.style === 'luxury' && sneaker.rarity === 'legendary') ||
            (currentTrader.style === 'classic' && (sneaker.brand === 'Nike' || sneaker.brand === 'Jordan' || sneaker.brand === 'Converse'))) {
          preferenceBonus += 0.1; // 10% bonus for style match
        }
      });

      // Calculate target value based on trader preferences
      let targetTotalValue = yourTotalValue * adjustment;
      
      // Apply preference bonus
      targetTotalValue *= (1 + preferenceBonus);
      
      // Apply trader value preference
      switch(currentTrader.valuePreference) {
        case 'low':
          targetTotalValue *= 0.8;
          break;
        case 'medium':
          targetTotalValue *= 1.0;
          break;
        case 'high':
          targetTotalValue *= 1.2;
          break;
        case 'ultra':
          targetTotalValue *= 1.5;
          break;
      }
      
      // Check for specific negotiation messages in the chat
      const chatMsgs = document.querySelectorAll('.trade-chat-msg.player-msg');
      let chatBonus = 0;
      
      chatMsgs.forEach(msgElement => {
        const msgText = msgElement.textContent.toLowerCase();
        
        // Negotiations that improve the offer
        if (msgText.includes('rare') || msgText.includes('legendary') || msgText.includes('limited')) {
          if (currentTrader.style === 'hype' || currentTrader.style === 'luxury') {
            chatBonus += 0.05;
          }
        }
        
        if (msgText.includes('classic') || msgText.includes('vintage') || msgText.includes('retro')) {
          if (currentTrader.style === 'classic') {
            chatBonus += 0.07;
          }
        }
        
        if (msgText.includes('deal') || msgText.includes('fair')) {
          chatBonus += 0.03;
        }
        
        // Negotiations that may reduce the offer
        if (msgText.includes('cheap') || msgText.includes('low')) {
          if (currentTrader.style === 'luxury') {
            chatBonus -= 0.1;
          } else if (currentTrader.style === 'budget') {
            chatBonus += 0.05;
          }
        }
      });
      
      // Apply chat negotiation bonus
      targetTotalValue *= (1 + chatBonus);

      // Generate AI offer
      aiTradeOffer = [];
      
      // Create a pool of preferred sneakers that match trader's style and preferences
      const preferredSneakers = sneakersDatabase.filter(s => {
        // Check brand & model preferences
        const matchesPreference = currentTrader.preferences.some(pref => 
          s.brand.includes(pref) || 
          s.model.includes(pref) ||
          s.rarity.toLowerCase() === pref.toLowerCase()
        );
        
        // Style matching
        const matchesStyle = (
          (currentTrader.style === 'hype' && (s.rarity === 'legendary' || s.rarity === 'epic')) ||
          (currentTrader.style === 'budget' && (s.rarity === 'common' || s.rarity === 'rare')) ||
          (currentTrader.style === 'luxury' && s.rarity === 'legendary') ||
          (currentTrader.style === 'classic' && (s.brand === 'Nike' || s.brand === 'Jordan' || s.brand === 'Converse'))
        );
        
        return matchesPreference || matchesStyle;
      });
      
      // Sort the preferred sneakers by how well they match the trader's preferences
      preferredSneakers.sort((a, b) => {
        const scoreA = getPreferenceScore(a);
        const scoreB = getPreferenceScore(b);
        return scoreB - scoreA;  // Higher score first
      });

      // Try to offer preferred sneakers first (heavily favoring preferences)
      while (aiTradeOffer.length < 3 && preferredSneakers.length > 0 && targetTotalValue > 0) {
        // Take sneakers from the front of the sorted array (highest preference)
        const sneaker = preferredSneakers.shift();
        
        if (sneaker.baseValue <= targetTotalValue * 1.5) { // Allow slightly higher values for preferred items
          aiTradeOffer.push({...sneaker, id: Date.now() + Math.random()});
          targetTotalValue -= sneaker.baseValue;
        }
      }

      // Fill remaining slots with affordable sneakers that somewhat match preferences
      if (aiTradeOffer.length < 3 && targetTotalValue > 0) {
        const remainingSneakers = sneakersDatabase.filter(s => 
          !aiTradeOffer.some(offered => 
            offered.brand === s.brand && offered.model === s.model && offered.rarity === s.rarity
          ) && s.baseValue <= targetTotalValue
        );
        
        // Sort by preference but to a lesser degree
        remainingSneakers.sort((a, b) => {
          const scoreA = getPreferenceScore(a) / 2; // Lower weight on preference
          const scoreB = getPreferenceScore(b) / 2;
          return scoreB - scoreA;
        });
        
        // Add remaining sneakers
        for (let i = 0; i < remainingSneakers.length && aiTradeOffer.length < 3 && targetTotalValue > 0; i++) {
          const sneaker = remainingSneakers[i];
          if (sneaker.baseValue <= targetTotalValue) {
            aiTradeOffer.push({...sneaker, id: Date.now() + Math.random()});
            targetTotalValue -= sneaker.baseValue;
          }
        }
      }
      
      // If we still don't have 3 items, add some lower value items
      if (aiTradeOffer.length < 3) {
        const budgetSneakers = sneakersDatabase.filter(s => 
          !aiTradeOffer.some(offered => 
            offered.brand === s.brand && offered.model === s.model && offered.rarity === s.rarity
          ) && s.rarity === 'common'
        ).sort(() => Math.random() - 0.5);
        
        for (let i = 0; i < budgetSneakers.length && aiTradeOffer.length < 3; i++) {
          aiTradeOffer.push({...budgetSneakers[i], id: Date.now() + Math.random()});
        }
      }

      updateTradeComparison();
      updateNegotiationOptions();
      
      // Add accept trade button if there's an offer
      const tradeOffer = document.getElementById("trade-offer");
      if (tradeOffer) {
        if (aiTradeOffer.length > 0) {
          tradeOffer.innerHTML = '<button class="pack-button" onclick="acceptTrade()">Accept Trade</button>';
        } else {
          tradeOffer.innerHTML = '<em>No suitable trade found</em>';
        }
      }
    }

    function getPreferenceScore(sneaker) {
      if (!currentTrader) return 0;
      
      let score = 0;
      
      // Brand & model preference
      currentTrader.preferences.forEach(pref => {
        if (sneaker.brand.includes(pref) || sneaker.model.includes(pref)) {
          score += 3;
        }
      });
      
      // Rarity preference
      currentTrader.preferences.forEach(pref => {
        if (sneaker.rarity.toLowerCase() === pref.toLowerCase()) {
          score += 2;
        }
      });
      
      // Style match
      if (currentTrader.style === 'hype' && (sneaker.rarity === 'legendary' || sneaker.rarity === 'epic')) {
        score += 3;
      } else if (currentTrader.style === 'budget' && (sneaker.rarity === 'common' || sneaker.rarity === 'rare')) {
        score += 3;
      } else if (currentTrader.style === 'luxury' && sneaker.rarity === 'legendary') {
        score += 4;
      } else if (currentTrader.style === 'classic' && 
                (sneaker.brand === 'Nike' || sneaker.brand === 'Jordan' || sneaker.brand === 'Converse')) {
        score += 3;
      }
      
      return score;
    }

    function acceptTrade() {
      if (!currentTrader || selectedTradeItems.length === 0 || aiTradeOffer.length === 0) {
        showPurchaseNotification("Invalid trade!", "error");
        return;
      }

      // Remove traded sneakers from inventory (in reverse order to maintain correct indices)
      const tradedIndices = [...selectedTradeItems].sort((a, b) => b - a);
      tradedIndices.forEach(index => {
        if (index >= 0 && index < inventory.length) {
          inventory.splice(index, 1);
        }
      });

      // Add AI's sneakers to inventory with unique IDs
      aiTradeOffer.forEach(s => {
        const newSneaker = {
          ...s,
          id: Date.now() + Math.random(),
          dynamicValue: s.baseValue
        };
        inventory.push(newSneaker);
      });

      updateInventory();
      showPurchaseNotification("Trade completed successfully!");
      
      // Reset trade state
      selectedTradeItems = [];
      aiTradeOffer = [];
      currentTrader = null;
      
      // Close trade modal
      closeTradeUI();
      appendTradeChatMessage('ai', 'Deal! Pleasure trading with you.');
    }

    // Load purchase history from localStorage
    function loadPurchaseHistory() {
      const savedHistory = localStorage.getItem('purchaseHistory');
      if (savedHistory) {
        purchaseHistory = JSON.parse(savedHistory);
      }
    }

    // Save purchase history to localStorage
    function savePurchaseHistory() {
      saveGameState();
    }

    // Add purchase to history
    function addPurchaseToHistory(type, cost, items) {
      const purchase = {
        type: type,
        cost: cost,
        items: items,
        timestamp: new Date().toISOString()
      };
      purchaseHistory.unshift(purchase);
      if (purchaseHistory.length > 50) { // Keep only last 50 purchases
        purchaseHistory.pop();
      }
      savePurchaseHistory();
      updatePurchaseHistory();
    }

    // Update purchase history display
    function updatePurchaseHistory() {
      const historyDiv = document.getElementById('purchase-history');
      historyDiv.innerHTML = '';
      
      purchaseHistory.forEach(purchase => {
        const date = new Date(purchase.timestamp);
        const formattedDate = date.toLocaleString();
        const itemsList = purchase.items.map(item => 
          `${item.brand} ${item.model} (${item.rarity})`
        ).join(', ');
        
        historyDiv.innerHTML += `
          <div class="purchase-item">
            <div><strong>${purchase.type}</strong> - ${formatCurrency(purchase.cost)} coins</div>
            <div>Items: ${itemsList}</div>
            <div class="purchase-time">${formattedDate}</div>
          </div>
        `;
      });
    }

    function openHistory() {
      document.getElementById('history-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
      updatePurchaseHistory();
    }

    function closeHistory() {
      document.getElementById('history-modal').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
    }

    function openSettings() {
      document.getElementById('settings-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
    }

    function closeSettings() {
      document.getElementById('settings-modal').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
    }

    function closeAllModals() {
      const modals = ['history-modal', 'settings-modal', 'pack-modal', 'trade-modal'];
      modals.forEach(modalId => {
        document.getElementById(modalId).classList.remove('show');
      });
      document.getElementById('modal-overlay').classList.remove('show');
    }

    // Add event listener for escape key
    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape') {
        closeAllModals();
      }
    });

    function generateLimitedOffers() {
      const maxOffers = 3;
      limitedOffers.clear();
      let offerBonus = 1;
      // Apply networker staff bonus
      const networker = hiredStaff.find(s => s.id === 'networker');
      if (networker) {
        offerBonus -= networker.baseBonus + (networker.level - 1) * networker.bonusPerLevel;
      }
      while (limitedOffers.size < maxOffers) {
        const sneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        if (!limitedOffers.has(sneaker.id)) {
          const duration = 300000 + Math.random() * 300000;
          const discount = (0.6 + Math.random() * 0.2) * offerBonus;
          limitedOffers.set(sneaker.id, {
            sneaker,
            discountedPrice: Math.floor(sneaker.baseValue * discount),
            endTime: Date.now() + duration,
            startTime: Date.now()
          });
        }
      }
      updateLimitedOffers();
    }

    function updateLimitedOffers() {
      const container = document.getElementById('limited-offers');
      if (!container) return;
      
      container.innerHTML = '';
      const now = Date.now();
      let needsNewOffers = false;

      limitedOffers.forEach((offer, id) => {
        const timeLeft = offer.endTime - now;
        if (timeLeft <= 0) {
          limitedOffers.delete(id);
          needsNewOffers = true;
          return;
        }

        const minutes = Math.floor(timeLeft / 60000);
        const seconds = Math.floor((timeLeft % 60000) / 1000);
        const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        const savings = offer.sneaker.baseValue - offer.discountedPrice;

        container.innerHTML += `
          <div class="limited-offer">
            <div class="offer-timer">${timeString}</div>
            <div class="offer-sneaker">
              <img src="${offer.sneaker.image}" alt="${offer.sneaker.brand} ${offer.sneaker.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
              <strong>${offer.sneaker.brand} ${offer.sneaker.model}</strong>
              <div>${offer.sneaker.colorway}</div>
              <div class="rarity-${offer.sneaker.rarity}">[${offer.sneaker.rarity.toUpperCase()}]</div>
              <div style="margin: 10px 0;">
                <span style="text-decoration: line-through;">${formatCurrency(offer.sneaker.baseValue)} coins</span>
                <br>
                <strong style="color: #2ecc71; font-size: 1.2em;">
                  ${formatCurrency(offer.discountedPrice)} coins
                </strong>
                <br>
                <span style="color: #e74c3c;">Save ${formatCurrency(savings)} coins!</span>
              </div>
              <button class="pack-button" onclick="purchaseOffer('${id}')">Purchase</button>
            </div>
        </div>
      `;
      });

      if (needsNewOffers || limitedOffers.size < 3) {
        generateLimitedOffers();
      }
    }

    // Update limited offers every second
    setInterval(updateLimitedOffers, 1000);

    // Generate news events every minute
    setInterval(generateNewsEvent, 60000);

    // Initialize on load
    window.addEventListener('load', () => {
      loadSettings();
      loadPurchaseHistory();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      
      // Start news event generation immediately
      generateNewsEvent();

      // Add unique IDs to existing inventory
      inventory.forEach(s => {
        if (!s.id) s.id = Date.now() + Math.random();
      });
    });

    function purchaseOffer(id) {
      const offer = limitedOffers.get(id);
      if (!offer) {
        showNotification("This offer has expired!");
        return;
      }

      if (coins < offer.discountedPrice) {
        showNotification("Not enough coins!");
        return;
      }

      coins -= offer.discountedPrice;
      inventory.push({
        ...offer.sneaker,
        dynamicValue: offer.sneaker.baseValue
      });

      limitedOffers.delete(id);
      updateLimitedOffers();
      updateCoins();
      updateInventory();
      showPurchaseNotification("Limited offer purchased successfully!");
      saveGameState();
    }

    function showPurchaseNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = 'purchase-notification';
      notification.innerHTML = `
        <span>${type === 'success' ? '‚úÖ' : '‚ùå'}</span>
        <span>${message}</span>
      `;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideIn 0.3s ease-out reverse';
        setTimeout(() => notification.remove(), 300);
      }, 2000);
    }

    function updateResellAgentDisplay() {
      const levelDiv = document.getElementById('agent-level');
      const bonusDiv = document.getElementById('agent-bonus');
      const upgradeBtn = document.getElementById('upgrade-agent-btn');
      
      if (levelDiv) {
        levelDiv.innerHTML = Array(resellAgent.level)
          .fill('‚≠ê')
          .concat(Array(resellAgent.maxLevel - resellAgent.level).fill('‚òÜ'))
          .join('');
      }
      
      if (bonusDiv) {
        const bonus = (resellAgent.level * resellAgent.bonusPerLevel * 100).toFixed(0);
        bonusDiv.textContent = `Current Bonus: +${bonus}% sale value`;
      }
      
      if (upgradeBtn) {
        if (resellAgent.level >= resellAgent.maxLevel) {
          upgradeBtn.textContent = 'Max Level Reached!';
          upgradeBtn.disabled = true;
        } else {
          const nextCost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
          upgradeBtn.textContent = `Upgrade Agent (${formatCurrency(nextCost)} coins)`;
          upgradeBtn.disabled = false;
        }
      }
    }

    function updateMarketBuyerDisplay() {
      // Dummy function: Market Buyer UI not implemented yet
    }

    // Negotiation messages based on trader personality
    const negotiationOptions = {
      standard: [
        "How about we adjust the trade a bit?",
        "Can you add something more?",
        "I'm interested, but the value seems off",
        "This is a good start, but...",
      ],
      counter: [
        "Let me offer something different",
        "What if we modified the trade?",
        "I can adjust my offer",
        "Perhaps we can find middle ground"
      ]
    };

    function updateNegotiationOptions(showCounter = true) {
      const container = document.getElementById('negotiation-options');
      container.innerHTML = '';
      
      if (showCounter) {
        negotiationOptions.standard.forEach(msg => {
          const btn = document.createElement('button');
          btn.className = 'negotiation-btn';
          btn.textContent = msg;
          btn.onclick = () => negotiate(msg);
          container.appendChild(btn);
        });
      }
    }

    function negotiate(message) {
      const response = document.getElementById('ai-response');
      if (!currentTrader || !response) return;

      const yourValue = selectedTradeItems.reduce((sum, idx) => {
        const sneaker = inventory[idx];
        return sum + (sneaker.dynamicValue || sneaker.baseValue);
      }, 0);
      
      const aiValue = aiTradeOffer.reduce((sum, s) => sum + s.baseValue, 0);
      const valueDiff = Math.abs(yourValue - aiValue);
      const valueRatio = Math.min(yourValue, aiValue) / Math.max(yourValue, aiValue);

      let responseText;
      let willing = false;
      let adjustment = 1.0;

      // Check message keywords
      const msgLower = message.toLowerCase();
      let preferenceMatched = false;
      
      // Check if message mentions any of the trader's preferences
      currentTrader.preferences.forEach(pref => {
        if (msgLower.includes(pref.toLowerCase())) {
          preferenceMatched = true;
        }
      });
      
      // Personality-based responses
      if (preferenceMatched) {
        // More likely to adjust if you mention their preferences
        willing = Math.random() < 0.8;
        adjustment = 1.05; // Better offer when you mention their preferences
        
        if (currentTrader.style === 'hype') {
          responseText = "You know what I like! Let me see what I can offer.";
        } else if (currentTrader.style === 'luxury') {
          responseText = "I see you understand quality. I might have something special for you.";
        } else if (currentTrader.style === 'classic') {
          responseText = "A fellow enthusiast! I'll reconsider my offer.";
        } else {
          responseText = "That's exactly what I'm looking for! Let me adjust my offer.";
        }
      } else if (msgLower.includes("deal") || msgLower.includes("fair")) {
        // Checking for deal-closing terms
        if (valueRatio > 0.9) {
          willing = true;
          responseText = "You're right, this is a fair deal. Let's do it!";
        } else {
          willing = false;
          responseText = "I don't think we're quite there yet. The values don't match up.";
        }
      } else if (msgLower.includes("add") || msgLower.includes("more") || msgLower.includes("better")) {
        // Asking for more
        willing = Math.random() < 0.6;
        adjustment = 1.1; // Offer more
        responseText = willing ? 
          "I can sweeten the deal a bit. Check this out." : 
          "I'm already offering the best I can right now.";
      } else {
        // Standard value-based response
        if (valueRatio > 0.9) {
          willing = Math.random() < 0.8;
          adjustment = 1.0;
          responseText = willing ? 
            "I think we're close to a deal." : 
            "I think this is already a fair offer.";
        } else if (valueRatio > 0.7) {
          willing = Math.random() < 0.6;
          adjustment = 0.95;
          responseText = willing ? 
            "Let me adjust my offer a bit." : 
            "The value gap is a bit too wide for me.";
        } else {
          willing = Math.random() < 0.3;
          adjustment = 0.9;
          responseText = "I'm not sure about this trade value.";
        }
      }

      response.innerHTML = `${currentTrader.emoji} ${currentTrader.name}: "${responseText}"`;

      if (willing) {
        generateAITradeOffer(adjustment);
      }

      appendTradeChatMessage('player', message);
      appendTradeChatMessage('ai', responseText);
    }

    function updateNegotiationOptions() {
      const container = document.getElementById('negotiation-options');
      if (!container || !currentTrader) return;

      const options = [
        { text: "How about we adjust the trade a bit?", style: "standard" },
        { text: `Can you add something more ${currentTrader.style === 'luxury' ? 'exclusive' : 'valuable'}?`, style: "request" },
        { text: "Would you consider a different combination?", style: "counter" },
        { text: `I have some ${currentTrader.preferences[0]} items you might like...`, style: "specific" }
      ];

      container.innerHTML = options.map(opt => `
        <button class="negotiation-btn" onclick="negotiate('${opt.text}')">
          ${opt.text}
        </button>
      `).join('');
    }

    function generateNewsEvent() {
      if (Math.random() > 0.3) return; // 30% chance of news event

      const eventTypes = ["celebrity", "market", "trend"];
      const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];

      // Select random sneaker from inventory or database
      const sneaker = inventory.length > 0 && Math.random() > 0.5 
        ? inventory[Math.floor(Math.random() * inventory.length)]
        : sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
      
      let effect, percentage, direction, message;
      if (eventType === "celebrity" || eventType === "trend") {
        // Always positive effect
        effect = Math.random() * 0.5 + 0.1;
        percentage = Math.abs(Math.round(effect * 100));
        direction = "increased";
      if (eventType === "celebrity") {
        const celebrity = celebrities[Math.floor(Math.random() * celebrities.length)];
        const action = celebrityActions[Math.floor(Math.random() * celebrityActions.length)];
          message = `üî• ${celebrity} ${action} ${sneaker.brand} ${sneaker.model}! Value increased by ${percentage}%!`;
        } else {
          const reason = trendReasons[Math.floor(Math.random() * trendReasons.length)];
          message = `üåü ${sneaker.brand} ${sneaker.model} is trending ${reason}! Value increased by ${percentage}%!`;
        }
      } else if (eventType === "market") {
        // 50% chance for positive or negative market event
        const isPositive = Math.random() > 0.5;
        effect = (isPositive ? 1 : -1) * (Math.random() * 0.5 + 0.1);
        percentage = Math.abs(Math.round(effect * 100));
        direction = isPositive ? "increased" : "decreased";
        const reason = marketReasons[isPositive ? "increase" : "decrease"][Math.floor(Math.random() * marketReasons[isPositive ? "increase" : "decrease"].length)];
        message = `üìà Market Alert: ${sneaker.brand} ${sneaker.model} value has ${direction} by ${percentage}% ${reason}!`;
      }

      // Apply effect to matching sneakers
      const eventId = Date.now();
      activeEvents.set(eventId, {
        sneaker: `${sneaker.brand} ${sneaker.model}`,
        effect: effect,
        endTime: Date.now() + 300000 // 5 minutes
      });

      showBreakingNews(message);
      updateInventoryValues();

      setTimeout(() => {
        activeEvents.delete(eventId);
        updateInventoryValues();
      }, 300000);
    }

    function showBreakingNews(message, duration = 5000) {
      const newsElement = document.getElementById('breaking-news');
      if (!newsElement) return;

      // If called from test button, generate a test event
      if (message === true) {
        const testSneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        // Always positive effect for test
        const effect = Math.random() * 0.5 + 0.1;
        const percentage = Math.abs(Math.round(effect * 100));
        const direction = "increased";
        const reason = marketReasons.increase[Math.floor(Math.random() * marketReasons.increase.length)];
        message = `üìà Market Alert: ${testSneaker.brand} ${testSneaker.model} value has ${direction} by ${percentage}% ${reason}`;
        // Apply test effect
        const eventId = Date.now();
        activeEvents.set(eventId, {
          sneaker: `${testSneaker.brand} ${testSneaker.model}`,
          effect: effect,
          endTime: Date.now() + 300000 // 5 minutes
        });
        updateInventoryValues();
        setTimeout(() => {
          activeEvents.delete(eventId);
          updateInventoryValues();
        }, 300000);
      }

      // Clear any existing timeouts
      if (newsElement.timeout) {
        clearTimeout(newsElement.timeout);
      }

      newsElement.textContent = message;
      newsElement.style.display = 'block';
      
      // Force a reflow to restart animation
      void newsElement.offsetWidth;
      newsElement.style.animation = 'none';
      requestAnimationFrame(() => {
        newsElement.style.animation = 'slideDown 0.5s ease-out, glow 2s infinite';
      });

      newsElement.timeout = setTimeout(() => {
        newsElement.style.animation = 'none';
        newsElement.style.display = 'none';
      }, duration);
    }

    function updateInventoryValues() {
      inventory.forEach(sneaker => {
        let totalEffect = 1;
        activeEvents.forEach(event => {
          if (event.sneaker === `${sneaker.brand} ${sneaker.model}`) {
            totalEffect *= (1 + event.effect);
          }
        });
        sneaker.dynamicValue = Math.round(sneaker.baseValue * totalEffect);
      });
      updateInventory();
      updateTradeComparison(); // Update trade values if in a trade
    }

    // Start news generation immediately and run every minute
    generateNewsEvent(); // Initial news
    setInterval(generateNewsEvent, 60000); // Every minute

    // Add event listener for test button
    document.querySelector('.test-button').addEventListener('click', () => {
      console.log("Test button clicked"); // Debug log
      showBreakingNews(true);
    });

    let resellAgent = {
      level: 0, // Start at level 0
      maxLevel: 5,
      baseUpgradeCost: 500,
      bonusPerLevel: 0.2
    };

    let storageUpgrades = 0;
    let storageCost = 300;
    let limitedOffers = new Map();

    function upgradeResellAgent() {
      const cost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
      
      if (coins >= cost && resellAgent.level < resellAgent.maxLevel) {
        coins -= cost;
        resellAgent.level++;
        updateResellAgentDisplay();
        updateCoins();
        showPurchaseNotification(`Resell Agent upgraded to Level ${resellAgent.level}!`);
        
        // Update the upgrade button text with new cost
        const nextCost = resellAgent.baseUpgradeCost * Math.pow(2, resellAgent.level - 1);
        const upgradeBtn = document.getElementById('upgrade-agent-btn');
        if (upgradeBtn) {
          upgradeBtn.textContent = resellAgent.level < resellAgent.maxLevel ? 
            `Upgrade Agent (${formatCurrency(nextCost)} coins)` : 
            'Max Level Reached!';
        }
      } else if (resellAgent.level >= resellAgent.maxLevel) {
        showPurchaseNotification('Already at maximum level!', 'error');
      } else {
        showPurchaseNotification('Not enough coins!', 'error');
      }
    }

    // Breaking News System
    const marketReasons = {
      increase: [
        "due to limited stock availability",
        "after successful collaboration announcement",
        "following positive reviews",
        "due to seasonal demand",
        "after viral social media coverage",
        "due to collector interest",
        "following successful restock",
        "after design award recognition"
      ],
      decrease: [
        "due to increased market supply",
        "following new competitor release",
        "due to changing trends",
        "after negative publicity",
        "due to overstock situation",
        "following retail price adjustments",
        "due to newer model announcement",
        "after market saturation"
      ]
    };

    const celebrityActions = [
      "spotted wearing",
      "featured on Instagram with",
      "performed wearing",
      "endorsed",
      "showcased in new video wearing",
      "spotted shopping for",
      "praised in interview about",
      "wore to major event"
    ];

    const trendReasons = [
      "after going viral on TikTok",
      "due to streetwear influence",
      "following fashion week appearance",
      "after celebrity collaboration announcement",
      "due to retro style comeback",
      "following cultural moment",
      "after music video feature",
      "due to movie appearance"
    ];

    // Staff System
    const staffTypes = [
      {
        id: 'buyer',
        name: 'Market Buyer',
        description: 'Finds rare sneakers at better prices',
        baseCost: 1000,
        baseBonus: 0.10,
        bonusPerLevel: 0.05,
        maxLevel: 5,
        icon: 'üîç',
        getBonusText: (level) => `Reduces pack costs by ${Math.round((level * 0.05 + 0.10) * 100)}%`
      },
      {
        id: 'authenticator',
        name: 'Authenticator',
        description: 'Increases chance of rare finds',
        baseCost: 1500,
        baseBonus: 0.15,
        bonusPerLevel: 0.05,
        maxLevel: 5,
        icon: '‚ú®',
        getBonusText: (level) => `Increases rare sneaker odds by ${Math.round((level * 0.05 + 0.15) * 100)}%`
      },
      {
        id: 'autoBuyer',
        name: 'Auto Buyer',
        description: 'Automatically buys packs and trades to clients every minute. Gets smarter and makes better trades when upgraded.',
        baseCost: 2000,
        baseBonus: 1,
        bonusPerLevel: 1,
        maxLevel: 5,
        icon: 'ü§ñ',
        getBonusText: (level) => `Buys and trades ${level + 1} pack${level > 0 ? 's' : ''} per minute with improved trade value`
      },
      {
        id: 'autoClicker',
        name: 'Auto Clicker',
        description: 'Automatically clicks for coins. Upgradable for faster coin gain.',
        baseCost: 1200,
        baseBonus: 1, // 1 click per second
        bonusPerLevel: 1, // +1 click per second per level
        maxLevel: 5,
        icon: 'üñ±Ô∏è',
        getBonusText: (level) => `Clicks ${level} time${level === 1 ? '' : 's'} per second for coins`
      }
    ];


    function showBreakingNews(message, duration = 5000) {
      const newsElement = document.getElementById('breaking-news');
      if (!newsElement) return;

      // If called from test button, generate a test event
      if (message === true) {
        const testSneaker = sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
        // Always positive effect for test
        const effect = Math.random() * 0.5 + 0.1;
        const percentage = Math.abs(Math.round(effect * 100));
        const direction = "increased";
        const reason = marketReasons.increase[Math.floor(Math.random() * marketReasons.increase.length)];
        message = `üìà Market Alert: ${testSneaker.brand} ${testSneaker.model} value has ${direction} by ${percentage}% ${reason}`;
        // Apply test effect
        const eventId = Date.now();
        activeEvents.set(eventId, {
          sneaker: `${testSneaker.brand} ${testSneaker.model}`,
          effect: effect,
          endTime: Date.now() + 300000 // 5 minutes
        });
        updateInventoryValues();
        setTimeout(() => {
          activeEvents.delete(eventId);
          updateInventoryValues();
        }, 300000);
      }

      // Clear any existing timeouts and animations
      if (newsElement.timeout) {
        clearTimeout(newsElement.timeout);
      }
      newsElement.style.animation = 'none';

      // Update content and show
      newsElement.textContent = message;
      newsElement.style.display = 'block';
      
      // Force a reflow and restart animation
      void newsElement.offsetWidth;
      newsElement.style.animation = 'slideDown 0.5s ease-out, glow 2s infinite';

      // Set timeout to hide
      newsElement.timeout = setTimeout(() => {
        newsElement.style.animation = 'none';
        newsElement.style.display = 'none';
      }, duration);
    }

    function generateNewsEvent() {
      if (Math.random() > 0.3) return; // 30% chance of news event

      const eventTypes = ["celebrity", "market", "trend"];
      const eventType = eventTypes[Math.floor(Math.random() * eventTypes.length)];

      // Select random sneaker from inventory or database
      const sneaker = inventory.length > 0 && Math.random() > 0.5 
        ? inventory[Math.floor(Math.random() * inventory.length)]
        : sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)];
      
      // Generate effect and format percentage
      const effect = (Math.random() > 0.5 ? 1 : -1) * (Math.random() * 0.5 + 0.1);
      const percentage = Math.abs(Math.round(effect * 100));
      const direction = effect > 0 ? "increased" : "decreased";
      
      // Format message based on event type
      let message;
      if (eventType === "celebrity") {
        const celebrity = celebrities[Math.floor(Math.random() * celebrities.length)];
        const action = celebrityActions[Math.floor(Math.random() * celebrityActions.length)];
        message = `üî• ${celebrity} ${action} ${sneaker.brand} ${sneaker.model}! Value ${direction} by ${percentage}%!`;
      } else if (eventType === "market") {
        const reason = marketReasons[effect > 0 ? "increase" : "decrease"][Math.floor(Math.random() * marketReasons[effect > 0 ? "increase" : "decrease"].length)];
        message = `üìà Market Alert: ${sneaker.brand} ${sneaker.model} value has ${direction} by ${percentage}% ${reason}!`;
      } else { // trend
        const reason = trendReasons[Math.floor(Math.random() * trendReasons.length)];
        message = `üåü ${sneaker.brand} ${sneaker.model} is trending ${reason}! Value ${direction} by ${percentage}%!`;
      }

      // Apply effect to matching sneakers
      const eventId = Date.now();
      activeEvents.set(eventId, {
        sneaker: `${sneaker.brand} ${sneaker.model}`,
        effect: effect,
        endTime: Date.now() + 300000 // 5 minutes
      });

      showBreakingNews(message);
      updateInventoryValues();

      setTimeout(() => {
        activeEvents.delete(eventId);
        updateInventoryValues();
      }, 300000);
    }

    function openHireStaff() {
      const modal = document.getElementById('staff-hire-modal');
      const overlay = document.getElementById('modal-overlay');
      const staffList = document.getElementById('staff-hire-list');
      
      staffList.innerHTML = staffTypes.map(staff => {
        const hired = hiredStaff.find(h => h.id === staff.id);
        const level = hired ? hired.level : 0;
        const upgradeCost = hired ? Math.round(staff.baseCost * Math.pow(1.5, level)) : staff.baseCost;
        
        return `
          <div class="staff-hire-item">
            <div class="staff-hire-header">
              <span>${staff.icon} ${staff.name}</span>
              ${hired ? 
                `<div class="staff-level">
                  Level ${level}/${staff.maxLevel}
                  ${[...Array(level)].map(() => '‚≠ê').join('')}
                  ${[...Array(staff.maxLevel - level)].map(() => '‚òÜ').join('')}
                </div>` : 
                `<span class="staff-hire-cost">${formatCurrency(staff.baseCost)} coins</span>`
              }
            </div>
            <p>${staff.description}</p>
            <p><strong>Current Bonus:</strong> <span class="staff-bonus-value">${staff.getBonusText(level)}</span></p>
            ${hired ? 
              level < staff.maxLevel ?
                `<div class="staff-upgrade-cost">Upgrade Cost: ${formatCurrency(upgradeCost)} coins</div>
                 <button class="pack-button" onclick="upgradeStaff('${staff.id}')">Upgrade</button>` :
                '<button class="pack-button" disabled>Max Level</button>' :
              `<button class="pack-button" onclick="hireStaff('${staff.id}')">Hire</button>`
            }
          </div>
        `;
      }).join('');
      
      modal.classList.add('show');
      overlay.classList.add('show');
    }

    function closeHireStaff() {
      const modal = document.getElementById('staff-hire-modal');
      const overlay = document.getElementById('modal-overlay');
      if (modal) modal.classList.remove('show');
      if (overlay) overlay.classList.remove('show');
    }

    function hireStaff(staffId) {
      const staff = staffTypes.find(s => s.id === staffId);
      if (!staff) return;
      
      if (coins < staff.baseCost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      
      coins -= staff.baseCost;
      hiredStaff.push({
        ...staff,
        level: 1,
        lastTradeTime: Date.now() // for auto trader
      });
      updateCoins();
      
      // --- Always apply staff bonuses after hiring ---
      applyStaffBonuses();
      showPurchaseNotification(`Hired ${staff.name}!`);
      openHireStaff(); // Refresh the modal
      updateStaffDisplay();
      // --- Update pack select dropdown costs visually ---
      updatePackSelectCosts();
    }

    function upgradeStaff(staffId) {
      const staffIndex = hiredStaff.findIndex(s => s.id === staffId);
      if (staffIndex === -1) return;
      
      const staff = hiredStaff[staffIndex];
      const staffType = staffTypes.find(s => s.id === staffId);
      const upgradeCost = Math.round(staffType.baseCost * Math.pow(1.5, staff.level));
      
      if (coins < upgradeCost) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      
      if (staff.level >= staffType.maxLevel) {
        showPurchaseNotification("Already at max level!", "error");
        return;
      }
      
      coins -= upgradeCost;
      staff.level++;
      updateCoins();
      
      // --- Always apply staff bonuses after upgrade ---
      applyStaffBonuses();
      showPurchaseNotification(`Upgraded ${staff.name} to level ${staff.level}!`);
      openHireStaff(); // Refresh the modal
      updateStaffDisplay();
      // --- Update pack select dropdown costs visually ---
      updatePackSelectCosts();
    }

    function applyStaffBonuses() {
      packPriceMultiplier = 1;
      rarityBonus = 0;
      sellPriceMultiplier = 1;
      autoClickerRate = 0;
      
      // --- Apply staff bonuses based on current hired staff ---
      hiredStaff.forEach(staff => {
        const bonus = staff.baseBonus + (staff.level - 1) * staff.bonusPerLevel;
        switch(staff.id) {
          case 'buyer':
            packPriceMultiplier *= (1 - bonus);
            break;
          case 'authenticator':
            rarityBonus += bonus;
            break;
          case 'autoBuyer':
            // Handled by autoBuyerTick
            break;
          case 'autoClicker':
            autoClickerRate += staff.level; // clicks per second
            break;
        }
      });
      // --- Update UI after staff bonus changes ---
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
      // --- Update pack select dropdown costs visually ---
      updatePackSelectCosts();
    }

    function autoBuyerTick() {
      const autoBuyer = hiredStaff.find(s => s.id === 'autoBuyer');
      if (!autoBuyer) return;
      const now = Date.now();
      if (!autoBuyer.lastTradeTime || now - autoBuyer.lastTradeTime >= 60000) {
        const tradesPerMinute = autoBuyer.level + 1;
        for (let i = 0; i < tradesPerMinute; i++) {
          // Try to buy a pack if we have enough coins
          // --- Use same cost calculation as player (with all discounts) ---
          // Pick a random pack
          const packKeys = Object.keys(packTypes);
          const randomPack = packKeys[Math.floor(Math.random() * packKeys.length)];
          let pack = { ...packTypes[randomPack] };
          // Apply prestige effect on pack cost if applicable
          if (prestigeLevel > 0) {
            pack.cost = Math.max(90, Math.floor(pack.cost * Math.pow(0.9, prestigeLevel)));
          }
          // Apply buyer staff discount
          if (randomPack !== 'legendary' && typeof packPriceMultiplier === 'number' && packPriceMultiplier < 1) {
            pack.cost = Math.floor(pack.cost * packPriceMultiplier);
          }
          if (coins >= pack.cost) {
            coins -= pack.cost;
            // --- Use rollSneaker to get correct odds (with Authenticator etc) ---
            const sneaker = rollSneaker(randomPack);
            inventory.push(sneaker);
          }
        }
        // After buying, try to trade to a random AI trader for coins (simulate a trade)
        for (let i = 0; i < tradesPerMinute; i++) {
          if (inventory.length > 0) {
            const sneakerIdx = Math.floor(Math.random() * inventory.length);
            const sneaker = inventory[sneakerIdx];
            // Trade value improves with level
            let tradeValue = sneaker.baseValue * (1 + 0.1 * autoBuyer.level);
            coins += Math.floor(tradeValue);
            inventory.splice(sneakerIdx, 1);
          }
        }
        updateCoins();
        updateInventory();
        autoBuyer.lastTradeTime = now;
      }
    }
    setInterval(autoBuyerTick, 1000);

    // Update closeHireStaff to work properly
    function closeHireStaff() {
      const modal = document.getElementById('staff-hire-modal');
      const overlay = document.getElementById('modal-overlay');
      if (modal) modal.classList.remove('show');
      if (overlay) overlay.classList.remove('show');
    }

    function updateStaffDisplay() {
      const staffGrid = document.getElementById('staff-grid');
      if (!staffGrid) return;
      
      staffGrid.innerHTML = hiredStaff.map(staff => {
        const staffType = staffTypes.find(s => s.id === staff.id);
        if (!staffType) return ''; // Should not happen, but good practice

        const starRating = Array(staff.level).fill('‚≠ê')
          .concat(Array(staffType.maxLevel - staff.level).fill('‚òÜ'))
          .join('');
        
        return `
          <div class="staff-member">
            <div class="staff-header">
              <span>${staffType.icon} ${staffType.name}</span>
              <span class="staff-status">Level ${staff.level}/${staffType.maxLevel}</span>
            </div>
            <div class="staff-level">${starRating}</div>
            <div class="staff-stats">
              <div>Bonus: ${staffType.getBonusText(staff.level)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Initialize variables for staff bonuses
    let packPriceMultiplier = 1;
    let rarityBonus = 0;
    let sellPriceMultiplier = 1;
    let autoClickerRate = 0;

    // Add event listeners for breaking news test button
    document.addEventListener('DOMContentLoaded', function() {
      const testButton = document.querySelector('.test-button');
      if (testButton) {
        testButton.onclick = () => showBreakingNews(true);
      }
      
      // Start news generationa
      setInterval(generateNewsEvent, 60000);
      
      // Generate initial news event
      setTimeout(generateNewsEvent, 5000);
    });
    // Clicker functionality
    function handleClick() {
      clickCount++;
      document.querySelector('.click-count').textContent = `Clicks: ${clickCount}`;
      
      // For pre-prestige, we need 2 clicks per coin
      clickCounter++;
      
      // Apply prestige bonus to click value if applicable
      if (clickCounter >= clicksNeeded) {
        coins += 1;
        clickCounter = 0; // Reset counter
        updateCoins();
        
        if (clickCount % 10 === 0) {
          showPurchaseNotification(`+1 coin!`);
        }
      }
      
      // Update prestige progress
      updatePrestigeDisplay();
    }

    // Used Market functionality
    const conditions = ["Poor", "Fair", "Good", "Excellent"];
    const conditionValues = {
      "Poor": 0.15,    // 85% discount
      "Fair": 0.25,    // 75% discount
      "Good": 0.4,     // 60% discount
      "Excellent": 0.6 // 40% discount
    };

    function generateUsedSneakers() {
      const usedMarket = document.getElementById('used-market-grid');
      usedMarket.innerHTML = '';
      
      for (let i = 0; i < 6; i++) {
        const sneaker = {...sneakersDatabase[Math.floor(Math.random() * sneakersDatabase.length)]};
        const condition = conditions[Math.floor(Math.random() * conditions.length)];
        const conditionValue = conditionValues[condition];
        const price = Math.floor(sneaker.baseValue * conditionValue);
        
        usedMarket.innerHTML += `
          <div class="used-sneaker">
            <img src="${sneaker.image}" alt="${sneaker.brand} ${sneaker.model}" style="width:60px;height:60px;object-fit:contain;display:block;margin:0 auto 8px auto;" />
            <strong>${sneaker.brand} ${sneaker.model}</strong>
            <div>${sneaker.colorway}</div>
            <div class="rarity-${sneaker.rarity}">[${sneaker.rarity.toUpperCase()}]</div>
            <div>Condition: ${condition}</div>
            <div class="condition-bar">
              <div class="condition-fill" style="width: ${conditionValue * 100}%"></div>
            </div>
            <div>Price: ${formatCurrency(price)} coins</div>
            <button class="pack-button" onclick="buyUsedSneaker(${JSON.stringify(sneaker).replace(/"/g, '&quot;')}, '${condition}', ${price})">Buy & Clean</button>
          </div>
        `;
      }
    }

    function openUsedMarket() {
      const modal = document.getElementById('used-market-modal');
      const overlay = document.getElementById('modal-overlay');
      modal.classList.add('show');
      overlay.classList.add('show');
      generateUsedSneakers();
    }

    function closeUsedMarket() {
      const modal = document.getElementById('used-market-modal');
      const overlay = document.getElementById('modal-overlay');
      modal.classList.remove('show');
      overlay.classList.remove('show');
    }

    function buyUsedSneaker(sneaker, condition, price) {
      if (coins < price) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }
      
      coins -= price;
      updateCoins();
      
      const boughtSneaker = {
        ...sneaker,
        id: Date.now() + Math.random(),
        condition: condition,
        conditionValue: conditionValues[condition],
        baseValue: Math.floor(sneaker.baseValue * conditionValues[condition])
      };
      
      currentCleaningSneaker = boughtSneaker;
      closeUsedMarket();
      startCleaning();
    }

    function startCleaning() {
      if (!currentCleaningSneaker || cleaningInProgress) return;
      
      cleaningInProgress = true;
      const game = document.getElementById('cleaning-game');
      const overlay = document.getElementById('modal-overlay');
      game.classList.add('show');
      overlay.classList.add('show');
      
      // Draw sneaker outline
      const canvas = document.getElementById('sneaker-canvas');
      const ctx = canvas.getContext('2d');
      
      // Clear canvas and set background
      ctx.fillStyle = '#34495e';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      // Draw basic sneaker outline
      ctx.strokeStyle = '#fff';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(50, 200);
      ctx.bezierCurveTo(100, 100, 300, 100, 350, 200);
      ctx.bezierCurveTo(300, 250, 100, 250, 50, 200);
      ctx.stroke();
      
      // Generate dirt spots
      generateDirtSpots();
      updateCleaningProgress();
    }

    // Initialize
    window.addEventListener('load', () => {
      loadSettings();
      loadPurchaseHistory();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      
      // Add click handlers for modals
      document.getElementById('modal-overlay').addEventListener('click', function(e) {
        if (e.target === this) {
          closeAllModals();
        }
      });
    });

    function closeAllModals() {
      const modals = document.querySelectorAll('.modal, .cleaning-game');
      const overlay = document.getElementById('modal-overlay');
      modals.forEach(modal => modal.classList.remove('show'));
      overlay.classList.remove('show');
      
      if (cleaningInProgress) {
        finishCleaning(); // Auto-finish cleaning if in progress
      }
    }

    function generateDirtSpots() {
      const canvas = document.getElementById('sneaker-canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      dirtSpots = [];
      const numSpots = Math.floor(Math.random() * 10) + 10;
      
      for (let i = 0; i < numSpots; i++) {
        const spot = {
          x: Math.random() * (canvas.width - 40) + 20,
          y: Math.random() * (canvas.height - 40) + 20,
          radius: Math.random() * 10 + 10,
          cleaned: false
        };
        dirtSpots.push(spot);
        
        ctx.beginPath();
        ctx.arc(spot.x, spot.y, spot.radius, 0, Math.PI * 2);
        ctx.fillStyle = '#795548';
        ctx.fill();
      }
      
      // Add click handler for cleaning
      canvas.onclick = handleCleaningClick;
    }

    function handleCleaningClick(e) {
      const canvas = document.getElementById('sneaker-canvas');
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      dirtSpots.forEach(spot => {
        const distance = Math.sqrt(Math.pow(x - spot.x, 2) + Math.pow(y - spot.y, 2));
        if (distance < spot.radius + 10 && !spot.cleaned) {
          spot.cleaned = true;
          
          // Clear the spot
          const ctx = canvas.getContext('2d');
          ctx.clearRect(spot.x - spot.radius - 1, spot.y - spot.radius - 1, 
                       spot.radius * 2 + 2, spot.radius * 2 + 2);
        }
      });
      
      updateCleaningProgress();
    }

    function updateCleaningProgress() {
      const cleanedSpots = dirtSpots.filter(spot => spot.cleaned).length;
      const progress = (cleanedSpots / dirtSpots.length) * 100;
      document.getElementById('cleaning-progress').style.width = `${progress}%`;
    }

    function finishCleaning() {
      if (!currentCleaningSneaker || !cleaningInProgress) return;
      
      const cleanedSpots = dirtSpots.filter(spot => spot.cleaned).length;
      const totalSpots = dirtSpots.length;
      const cleaningQuality = cleanedSpots / totalSpots;
      
      // Require at least 80% of spots to be cleaned
      if (cleaningQuality < 0.8) {
        showPurchaseNotification("Clean more spots before finishing! (" + Math.floor(cleaningQuality * 100) + "% done)", "error");
        return;
      }
      
      // Improve condition based on cleaning quality
      let newCondition = currentCleaningSneaker.condition;
      if (cleaningQuality > 0.95) {
        const currentIndex = conditions.indexOf(currentCleaningSneaker.condition);
        if (currentIndex < conditions.length - 1) {
          newCondition = conditions[currentIndex + 1];
          showPurchaseNotification("Perfect cleaning! Condition improved!", "success");
        }
      }
      
      // Update sneaker with new condition and values
      currentCleaningSneaker.condition = newCondition;
      currentCleaningSneaker.conditionValue = conditionValues[newCondition];

      // Set value to what it's worth new (full base value for its model/rarity)
      const newSneaker = sneakersDatabase.find(s =>
        s.brand === currentCleaningSneaker.brand &&
        s.model === currentCleaningSneaker.model &&
        s.colorway === currentCleaningSneaker.colorway &&
        s.rarity === currentCleaningSneaker.rarity
      );
      if (newSneaker) {
        currentCleaningSneaker.baseValue = newSneaker.baseValue;
      }
      
      // Add to inventory
      inventory.push(currentCleaningSneaker);
      
      // Clean up
      cleaningInProgress = false;
      document.getElementById('cleaning-game').classList.remove('show');
      document.getElementById('modal-overlay').classList.remove('show');
      
      // Update display
      updateInventory();
      showPurchaseNotification(`${currentCleaningSneaker.brand} ${currentCleaningSneaker.model} added to inventory!`);
      
      // Reset cleaning game state
      currentCleaningSneaker = null;
      dirtSpots = [];
    }

    // Fix for limited time offers
    function purchaseOffer(id) {
      const offer = limitedOffers.get(id);
      if (!offer) {
        showPurchaseNotification("Offer has expired!", "error");
        generateLimitedOffers(); // Regenerate offers when one expires
        return;
      }

      if (coins < offer.discountedPrice) {
        showPurchaseNotification("Not enough coins!", "error");
        return;
      }

      coins -= offer.discountedPrice;
      inventory.push({
        ...offer.sneaker,
        id: Date.now() + Math.random(),
        dynamicValue: offer.sneaker.baseValue
      });

      limitedOffers.delete(id);
      updateLimitedOffers();
      updateCoins();
      updateInventory();
      showPurchaseNotification("Limited offer purchased successfully!");
    }

    // Initialize used market
    window.addEventListener('load', () => {
      const loaded = loadGameState();
      if (!loaded) {
        // If no saved state, initialize with defaults
      loadSettings();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      generateLimitedOffers();
        generateUsedSneakers();
      } else {
        // Update all displays with loaded state
        updateCoins();
        updateInventory();
        updateResellAgentDisplay();
        updateLimitedOffers();
        updateMarketBuyerDisplay();
    }

      // Start news event generation immediately
      generateNewsEvent();
    });

    // Add this new function to sell by sneaker id
    function sellSneakerById(sneakerId) {
      const idx = inventory.findIndex(s => String(s.id) === String(sneakerId));
      if (idx === -1) return;
      sellSneaker(idx);
    }

    function toggleLightMode() {
      settings.lightMode = document.getElementById('light-mode-toggle').checked;
      if (settings.lightMode) {
        document.body.classList.add('light-mode');
      } else {
        document.body.classList.remove('light-mode');
      }
      saveSettings();
    }

    // Implement auto clicker interval
    setInterval(() => {
      if (autoClickerRate > 0) {
        clickCount += autoClickerRate;
        coins += autoClickerRate;
        updateCoins();
        document.querySelector('.click-count').textContent = `Clicks: ${clickCount}`;
      }
    }, 1000);

    function appendTradeChatMessage(sender, message) {
      const chat = document.getElementById('trade-chat');
      if (!chat) return;
      const msgDiv = document.createElement('div');
      msgDiv.className = 'trade-chat-msg ' + (sender === 'ai' ? 'ai-msg' : 'player-msg');
      msgDiv.innerHTML = `<b>${sender === 'ai' ? currentTrader.emoji + ' ' + currentTrader.name : 'You'}:</b> ${message}`;
      chat.appendChild(msgDiv);
      chat.scrollTop = chat.scrollHeight;
    }

    function getAIResponse(playerMsg) {
      if (!currentTrader) return "Hello there!";
      
      const msg = playerMsg.toLowerCase();
      let response = "";
      
      // Check for preference matches in the message
      let mentionedPreference = false;
      currentTrader.preferences.forEach(pref => {
        if (msg.includes(pref.toLowerCase())) {
          mentionedPreference = true;
        }
      });
      
      if (mentionedPreference) {
        return [
          `You really know what I'm looking for! I love ${currentTrader.preferences[0]}.`,
          `Ah, a fellow ${currentTrader.preferences[0]} enthusiast! Let's talk.`,
          `You're speaking my language with that ${currentTrader.preferences[0]} mention!`
        ][Math.floor(Math.random()*3)];
      }
      
      // Style-specific responses to common message types
      if (msg.includes('hello') || msg.includes('hi') || msg.includes('hey')) {
        if (currentTrader.style === 'hype') {
          return "What's up! Ready to see some fire kicks?";
        } else if (currentTrader.style === 'luxury') {
          return "Greetings. I trust you've brought items of quality?";
        } else if (currentTrader.style === 'classic') {
          return "Hello there! Always good to meet another sneaker enthusiast.";
        } else { // budget
          return "Hey! Got any good deals for me today?";
        }
      }
      
      if (msg.includes('value') || msg.includes('worth')) {
        if (currentTrader.style === 'hype') {
          return "Value? It's all about the hype, friend!";
        } else if (currentTrader.style === 'luxury') {
          return "I only deal in premium items. Quality has its price.";
        } else if (currentTrader.style === 'classic') {
          return "True value is in the history and quality of a classic piece.";
        } else { // budget
          return "I'm looking for the best bang for my buck, you know?";
        }
      }
      
      if (msg.includes('deal') || msg.includes('accept')) {
        return [
          "Deal! Pleasure doing business.",
          "Accepted! Let's trade.",
          "You've got yourself a deal!"
        ][Math.floor(Math.random()*3)];
      }
      
      // Default responses based on trader style
      if (currentTrader.style === 'hype') {
        return [
          "That's fire! But is it enough?",
          "I'm all about the hype, show me something exclusive.",
          "Not bad, but I want the latest drops."
        ][Math.floor(Math.random()*3)];
      }
      if (currentTrader.style === 'classic') {
        return [
          "Classic taste! But let's see if it's worth it.",
          "I respect the classics, but I need more.",
          "Old school, but is it gold?"
        ][Math.floor(Math.random()*3)];
      }
      if (currentTrader.style === 'luxury') {
        return [
          "Luxury is my game. Impress me!",
          "Only the finest for me.",
          "Is that premium enough?"
        ][Math.floor(Math.random()*3)];
      }
      if (currentTrader.style === 'budget') {
        return [
          "I'm on a budget, but I like a good deal.",
          "Can you make it cheaper?",
          "Looking for bargains!"
        ][Math.floor(Math.random()*3)];
      }
      
      // Fallback generic response
      return [
        "Interesting offer!",
        "Let me think about that...",
        "Hmm, that's something to consider."
      ][Math.floor(Math.random()*3)];
    }

    // Sort pack select dropdown by ascending price on page load
    window.addEventListener('DOMContentLoaded', function() {
      const packSelect = document.getElementById('pack-type');
      if (packSelect) {
        // Get packTypes and sort by cost
        const packEntries = Object.entries(packTypes)
          .map(([key, val]) => ({ key, ...val }));
        packEntries.sort((a, b) => a.cost - b.cost);
        // Save current selection
        const currentValue = packSelect.value;
        // Clear and repopulate
        packSelect.innerHTML = '';
        packEntries.forEach(pack => {
          const label = pack.key.charAt(0).toUpperCase() + pack.key.slice(1) + ' Pack';
          const option = document.createElement('option');
          option.value = pack.key;
          option.textContent = `${label} (${pack.cost} Coins)`;
          packSelect.appendChild(option);
        });
        // Restore selection if possible
        if ([...packSelect.options].some(opt => opt.value === currentValue)) {
          packSelect.value = currentValue;
        }
      }
    });

    function sendTradeChatMessage() {
      const select = document.getElementById('trade-chat-preset');
      if (!select) return;
      const msg = select.value;
      if (!msg) return;
      appendTradeChatMessage('player', msg);
      appendTradeChatMessage('ai', getAIResponse(msg));
    }

    // 1. Update previewPack to block inventory addition after preview
    let isPreviewingPack = false;
    function previewPack() {
      isPreviewingPack = true;
      // Simulate pack opening but do not spend coins or add to inventory/history
      const type = document.getElementById("pack-type").value;
      let pack = {...packTypes[type]};
      // Generate sneakers
      currentSneakers = [];
      for (let i = 0; i < 3; i++) {
        let sneaker = rollSneaker(type);
        currentSneakers.push(sneaker);
      }
      // Reset state and start reveal
      currentSneakerIndex = 0;
      document.getElementById("card-container").innerHTML = "";
      document.getElementById("next-sneaker-btn").disabled = false;
      // Show the modal
      const packModal = document.getElementById("pack-modal");
      const modalOverlay = document.getElementById("modal-overlay");
      packModal.classList.add('show');
      modalOverlay.classList.add('show');
      revealNextSneaker();
    }
    // Patch finishPackOpening to block inventory addition if previewing
    const originalFinishPackOpening = finishPackOpening;
    finishPackOpening = function() {
      if (isPreviewingPack) {
        // Just close modal, do not add to inventory
        const packModal = document.getElementById("pack-modal");
        const modalOverlay = document.getElementById("modal-overlay");
        packModal.classList.remove('show');
        modalOverlay.classList.remove('show');
        document.getElementById("card-container").innerHTML = "";
        document.getElementById("next-sneaker-btn").disabled = false;
        currentSneakerIndex = 0;
        currentSneakers = [];
        isPreviewingPack = false;
        document.querySelectorAll('.pack-button, .pack-select').forEach(btn => {
          btn.disabled = false;
        });
        return;
      }
      originalFinishPackOpening();
    }

    // --- Sneakers Database for AI Trades and Market ---
    let sneakersDatabase = [];
    (function generateSneakersDatabase() {
      const rarityPool = [];
      rarities.forEach(r => {
        for (let i = 0; i < r.weight * 2; i++) rarityPool.push(r.rarity);
      });
      for (let i = 0; i < 200; i++) {
        const rarity = rarityPool[Math.floor(Math.random() * rarityPool.length)];
        sneakersDatabase.push(getRandomSneaker(rarity));
      }
    })();

    function updateStorageDisplay() {
      if (document.getElementById('storage-cost')) {
        document.getElementById('storage-cost').textContent = storageCost;
      }
    }

    // --- CONSOLIDATED INITIALIZATION ---
    function mainInit() {
      console.log('[mainInit] Starting initialization');
      initializeGame(); // Loads state or sets default
      loadSettings();
      loadPurchaseHistory();
      updateCoins();
      updateInventory();
      updateResellAgentDisplay();
      updateLimitedOffers();
      updateStorageDisplay();
      updatePrestigeDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
      // Add unique IDs to existing inventory
      inventory.forEach(s => { if (!s.id) s.id = Date.now() + Math.random(); });
      // Set up auto-save
      setInterval(saveGameState, 300000); // Every 5 minutes
      // Set up intervals
      setInterval(updateLimitedOffers, 1000);
      setInterval(generateNewsEvent, 60000);
      setInterval(autoBuyerTick, 1000);
      setInterval(() => {
        if (autoClickerRate > 0) {
          clickCount += autoClickerRate;
          coins += autoClickerRate;
          updateCoins();
          document.querySelector('.click-count').textContent = `Clicks: ${clickCount}`;
        }
      }, 1000);
      // Check for auto-sell common from prestige
      setInterval(() => {
        if (autoSellCommon && inventory.length > 0) {
          const commonItems = inventory.filter(item => item.rarity === 'common');
          let totalValue = 0;
          commonItems.forEach(item => {
            const idx = inventory.indexOf(item);
            if (idx !== -1) {
              totalValue += item.baseValue;
              inventory.splice(idx, 1);
            }
          });
          if (commonItems.length > 0) {
            coins += totalValue;
            updateCoins();
            updateInventory();
            showPurchaseNotification(`Auto-sold ${commonItems.length} common items for ${formatCurrency(totalValue)} coins!`);
          }
        }
      }, 30000); // Check every 30 seconds
      // Apply prestige bonuses and start passive income if needed
      applyPrestigeBonuses();
      // --- Ensure staff bonuses are always applied on load ---
      applyStaffBonuses();
      // Modal overlay click handler
      const overlay = document.getElementById('modal-overlay');
      if (overlay) {
        overlay.addEventListener('click', function(e) {
          if (e.target === this) closeAllModals();
        });
      }
      // Sort pack select dropdown by ascending price
      const packSelect = document.getElementById('pack-type');
      if (packSelect) {
        const packEntries = Object.entries(packTypes).map(([key, val]) => ({ key, ...val }));
        packEntries.sort((a, b) => a.cost - b.cost);
        const currentValue = packSelect.value;
        packSelect.innerHTML = '';
        packEntries.forEach(pack => {
          const label = pack.key.charAt(0).toUpperCase() + pack.key.slice(1) + ' Pack';
          const option = document.createElement('option');
          option.value = pack.key;
          option.textContent = `${label} (${pack.cost} Coins)`;
          packSelect.appendChild(option);
        });
        if ([...packSelect.options].some(opt => opt.value === currentValue)) {
          packSelect.value = currentValue;
        }
      }
      // Start news event generation immediately
      generateNewsEvent();
      setTimeout(generateNewsEvent, 5000);
      // --- Update pack select dropdown costs visually on load ---
      updatePackSelectCosts();
    }

    // Add debug logging to saveGameState and initializeGame
    function saveGameState() {
      const gameState = {
        coins,
        inventory,
        purchaseHistory,
        settings,
        currentMarketBuyer,
        limitedOffers: Array.from(limitedOffers.entries()),
        activeMultipliers: {
          global: window.globalMultiplier || 1,
          brand: window.brandMultipliers || {},
          coin: window.coinMultiplier || 1
        },
        currentTrader: window.currentTrader,
        lastTraderResponse: window.lastTraderResponse,
        hiredStaff,
        resellAgentLevel: resellAgent.level,
        storageUpgrades,
        storageCost,
        prestigeLevel
      };
      localStorage.setItem('sneakerHustleGameState', JSON.stringify(gameState));
      console.log('[saveGameState] Game state saved:', gameState);
    }

    function initializeGame() {
      const savedState = localStorage.getItem('sneakerHustleGameState');
      console.log('[initializeGame] Loaded state from localStorage:', savedState);
      if (savedState) {
        try {
          const gameState = JSON.parse(savedState);
          coins = gameState.coins ?? 10000;
          inventory = gameState.inventory || [];
          purchaseHistory = gameState.purchaseHistory || [];
          if (gameState.settings) settings = { ...settings, ...gameState.settings };
          if (gameState.currentMarketBuyer) currentMarketBuyer = gameState.currentMarketBuyer;
          if (gameState.limitedOffers) limitedOffers = new Map(gameState.limitedOffers);
          if (gameState.activeMultipliers) {
            window.globalMultiplier = gameState.activeMultipliers.global;
            window.brandMultipliers = gameState.activeMultipliers.brand;
            window.coinMultiplier = gameState.activeMultipliers.coin;
          }
          if (gameState.currentTrader) {
            window.currentTrader = gameState.currentTrader;
            window.lastTraderResponse = gameState.lastTraderResponse;
          }
          if (gameState.hiredStaff) hiredStaff = gameState.hiredStaff;
          if (gameState.resellAgentLevel !== undefined) resellAgent.level = gameState.resellAgentLevel;
          if (gameState.storageUpgrades !== undefined) storageUpgrades = gameState.storageUpgrades;
          if (gameState.storageCost !== undefined) storageCost = gameState.storageCost;
          if (gameState.prestigeLevel !== undefined) prestigeLevel = gameState.prestigeLevel;
        } catch (error) {
          console.error('[initializeGame] Error loading game state:', error);
          setDefaultState();
        }
      } else {
        setDefaultState();
      }
      updateAllDisplays();
      updateStorageDisplay();
      if (typeof updateStaffDisplay === 'function') updateStaffDisplay();
    }

    // Remove all other window.addEventListener('load', ...) blocks and replace with:
    window.addEventListener('load', mainInit);

    // --- Prestige System Functions ---
    function applyPrestigeBonuses() {
      // Base bonuses (from prestige level 1)
      // Set click value based on prestige level (1 click = 1 coin from level 1)
      if (prestigeLevel > 0) {
        clicksNeeded = 1; // 1 click = 1 coin
      } else {
        clicksNeeded = 2; // 2 clicks = 1 coin (default)
      }
      
      // Additional bonuses based on prestige level milestones
      
      // Inventory capacity bonus (more slots per prestige)
      inventoryCapacityBonus = prestigeLevel * 5; // +5 slots per prestige level
      
      // Rarity chance bonus (increases with prestige)
      rarityMultiplier = 1 + (prestigeLevel * 0.05); // +5% better odds per prestige
      
      // Special unlocks at specific prestige levels
      if (prestigeLevel >= 3) {
        // Prestige 3+: Chance for extra sneaker in packs
        extraSneakerChance = 0.15 + ((prestigeLevel - 3) * 0.05); // 15% + 5% per level above 3
        extraSneakerChance = Math.min(extraSneakerChance, 0.75); // Cap at 75%
      } else {
        extraSneakerChance = 0;
      }
      
      // Prestige 5+: Passive income
      if (prestigeLevel >= 5) {
        passiveIncomeRate = 1 + ((prestigeLevel - 5) * 1); // 1 coin/sec + 1 per level above 5
      } else {
        passiveIncomeRate = 0;
      }
      
      // Prestige 7+: Auto-sell common items
      autoSellCommon = prestigeLevel >= 7;
      
      // Prestige 10+: Chance for free packs
      if (prestigeLevel >= 10) {
        freePackChance = 0.05 + ((prestigeLevel - 10) * 0.02); // 5% + 2% per level above 10
        freePackChance = Math.min(freePackChance, 0.5); // Cap at 50%
      } else {
        freePackChance = 0;
      }
      
      // Prestige 15+: Legendary boost
      if (prestigeLevel >= 15) {
        legendaryBoost = 0.05 + ((prestigeLevel - 15) * 0.01); // +5% legendary chance + 1% per level above 15
        legendaryBoost = Math.min(legendaryBoost, 0.25); // Cap at 25% bonus
      } else {
        legendaryBoost = 0;
      }
      
      // Prestige 20+: Double value on sales 
      doubleSaleChance = prestigeLevel >= 20 ? 0.2 + ((prestigeLevel - 20) * 0.02) : 0;
      doubleSaleChance = Math.min(doubleSaleChance, 0.5); // Cap at 50%
      
      // Initialize passive income ticker if needed
      if (passiveIncomeRate > 0 && !passiveIncomeInterval) {
        startPassiveIncome();
      }
    }
    
    function updatePrestigeDisplay() {
      const levelDisplay = document.getElementById('prestige-level');
      const bonusesDisplay = document.getElementById('prestige-bonuses');
      const progressFill = document.getElementById('prestige-progress-fill');
      const prestigeButton = document.getElementById('prestige-button');
      
      if (levelDisplay) levelDisplay.textContent = prestigeLevel;
      
      if (bonusesDisplay) {
        let bonuses = [];
        if (prestigeLevel > 0) bonuses.push("+1 coin per click");
        if (prestigeLevel > 0) bonuses.push("Reduced pack costs");
        if (inventoryCapacityBonus > 0) bonuses.push(`+${inventoryCapacityBonus} inventory slots`);
        if (rarityMultiplier > 1) bonuses.push(`+${Math.round((rarityMultiplier-1)*100)}% rarity chance`);
        if (extraSneakerChance > 0) bonuses.push(`${Math.round(extraSneakerChance*100)}% extra sneaker chance`);
        if (passiveIncomeRate > 0) bonuses.push(`${passiveIncomeRate} coins/sec passive income`);
        if (autoSellCommon) bonuses.push("Auto-sell common items");
        if (freePackChance > 0) bonuses.push(`${Math.round(freePackChance*100)}% free pack chance`);
        if (legendaryBoost > 0) bonuses.push(`+${Math.round(legendaryBoost*100)}% legendary chance`);
        if (doubleSaleChance > 0) bonuses.push(`${Math.round(doubleSaleChance*100)}% double sale value chance`);
        
        bonusesDisplay.innerHTML = bonuses.length > 0 ? 
          bonuses.join(' ‚Ä¢ ') : 
          "Reach 100,000 coins to prestige";
      }
      
      if (progressFill) {
        const nextPrestigeThreshold = 100000 * Math.pow(2, prestigeLevel);
        const progress = Math.min(100, (coins / nextPrestigeThreshold) * 100);
        progressFill.style.width = `${progress}%`;
      }
      
      if (prestigeButton) {
        const nextPrestigeThreshold = 100000 * Math.pow(2, prestigeLevel);
        prestigeButton.disabled = coins < nextPrestigeThreshold;
        prestigeButton.textContent = `PRESTIGE (${formatCurrency(nextPrestigeThreshold)} coins)`;
      }
    }
    
    function openPrestigeModal() {
      const nextPrestigeThreshold = 100000 * Math.pow(2, prestigeLevel);
      if (coins < nextPrestigeThreshold) {
        showPurchaseNotification(`You need ${formatCurrency(nextPrestigeThreshold)} coins to prestige!`, "error");
        return;
      }
      
      // Set up modal display
      document.getElementById('prestige-coins-display').textContent = formatCurrency(nextPrestigeThreshold);
      document.getElementById('next-prestige-level').textContent = prestigeLevel + 1;
      document.getElementById('prestige-stars').textContent = '‚òÖ'.repeat(prestigeLevel + 1);
      
      // Update benefits list for next prestige level
      updatePrestigeBenefitsList(prestigeLevel + 1);
      
      // Update milestones display
      updatePrestigeMilestones();
      
      // Show modal
      document.getElementById('prestige-modal').classList.add('show');
      document.getElementById('modal-overlay').classList.add('show');
    }
    
    function updatePrestigeBenefitsList(nextLevel) {
      const list = document.getElementById('prestige-benefits-list');
      list.innerHTML = '';
      
      // Add base benefits
      list.innerHTML += `<li>Reduced base pack costs (90 coins)</li>`;
      list.innerHTML += `<li>Increased click value (1 coin per click)</li>`;
      list.innerHTML += `<li>+${nextLevel * 5} inventory slots</li>`;
      list.innerHTML += `<li>+${Math.round(nextLevel * 5)}% better rarity chances</li>`;
      
      // Add milestone benefits
      if (nextLevel >= 3 && prestigeLevel < 3) {
        list.innerHTML += `<li><strong>NEW!</strong> 15% chance for extra sneaker in packs</li>`;
      } else if (nextLevel >= 3) {
        const chance = Math.min(75, 15 + ((nextLevel - 3) * 5));
        list.innerHTML += `<li>${chance}% chance for extra sneaker in packs</li>`;
      }
      
      if (nextLevel >= 5 && prestigeLevel < 5) {
        list.innerHTML += `<li><strong>NEW!</strong> 1 coin/sec passive income</li>`;
      } else if (nextLevel >= 5) {
        const rate = 1 + ((nextLevel - 5));
        list.innerHTML += `<li>${rate} coins/sec passive income</li>`;
      }
      
      if (nextLevel >= 7 && prestigeLevel < 7) {
        list.innerHTML += `<li><strong>NEW!</strong> Auto-sell common items</li>`;
      } else if (nextLevel >= 7) {
        list.innerHTML += `<li>Auto-sell common items</li>`;
      }
      
      if (nextLevel >= 10 && prestigeLevel < 10) {
        list.innerHTML += `<li><strong>NEW!</strong> 5% chance for free packs</li>`;
      } else if (nextLevel >= 10) {
        const chance = Math.min(50, 5 + ((nextLevel - 10) * 2));
        list.innerHTML += `<li>${chance}% chance for free packs</li>`;
      }
      
      if (nextLevel >= 15 && prestigeLevel < 15) {
        list.innerHTML += `<li><strong>NEW!</strong> +5% legendary chance</li>`;
      } else if (nextLevel >= 15) {
        const boost = Math.min(25, 5 + ((nextLevel - 15)));
        list.innerHTML += `<li>+${boost}% legendary chance</li>`;
      }
      
      if (nextLevel >= 20 && prestigeLevel < 20) {
        list.innerHTML += `<li><strong>NEW!</strong> 20% chance for double sale value</li>`;
      } else if (nextLevel >= 20) {
        const chance = Math.min(50, 20 + ((nextLevel - 20) * 2));
        list.innerHTML += `<li>${chance}% chance for double sale value</li>`;
      }
    }
    
    function updatePrestigeMilestones() {
      const milestones = [
        { level: 1, emoji: "üéØ", desc: "Basic prestige bonuses" },
        { level: 3, emoji: "üéÅ", desc: "Chance for extra sneaker in packs" },
        { level: 5, emoji: "‚è±Ô∏è", desc: "Passive income" },
        { level: 7, emoji: "‚ôªÔ∏è", desc: "Auto-sell common items" },
        { level: 10, emoji: "üé´", desc: "Chance for free packs" },
        { level: 15, emoji: "üíé", desc: "Legendary chance boost" },
        { level: 20, emoji: "üí∞", desc: "Double sale value chance" },
        { level: 25, emoji: "üåü", desc: "Golden click boost" },
        { level: 30, emoji: "üîÆ", desc: "Mystery feature unlock" },
        { level: 50, emoji: "üëë", desc: "Prestige Master status" }
      ];
      
      const container = document.getElementById('prestige-milestones');
      if (!container) return;
      
      container.innerHTML = '';
      
      const nextLevel = prestigeLevel + 1;
      let nextMilestone = false;
      
      milestones.forEach(milestone => {
        const isAchieved = prestigeLevel >= milestone.level;
        const isNext = !isAchieved && nextLevel >= milestone.level;
        
        if (isAchieved || isNext || (!nextMilestone && milestone.level > nextLevel)) {
          if (!nextMilestone && milestone.level > nextLevel) nextMilestone = true;
          
          container.innerHTML += `
            <div class="prestige-milestone ${isAchieved ? 'achieved' : ''} ${isNext ? 'next' : ''}">
              <div class="milestone-level">P${milestone.level}</div>
              <div class="milestone-emoji">${milestone.emoji}</div>
              <div class="milestone-desc">${milestone.desc}</div>
            </div>
          `;
        }
      });
      
      // Add summary of current progress
      const achievedCount = milestones.filter(m => prestigeLevel >= m.level).length;
      const totalMilestones = milestones.length;
      
      container.innerHTML += `
        <div class="prestige-milestone-summary">
          Milestones Achieved: ${achievedCount}/${totalMilestones}
        </div>
      `;
    }
    
    function startPassiveIncome() {
      if (passiveIncomeInterval) clearInterval(passiveIncomeInterval);
      
      passiveIncomeInterval = setInterval(() => {
        if (passiveIncomeRate > 0) {
          coins += passiveIncomeRate;
          updateCoins();
          updatePrestigeDisplay();
        }
      }, 1000);
    }
    
    function confirmPrestige() {
      const nextPrestigeThreshold = 100000 * Math.pow(2, prestigeLevel);
      if (coins < nextPrestigeThreshold) {
        showPurchaseNotification(`Not enough coins to prestige!`, "error");
        closePrestigeModal();
        return;
      }
      
      // Increment prestige level
      prestigeLevel++;
      
      // Reset game progress but keep prestige level
      inventory = [];
      coins = 1000; // Starting coins
      hiredStaff = [];
      resellAgent.level = 0;
      storageUpgrades = 0;
      storageCost = 300;
      
      // Apply prestige bonuses
      applyPrestigeBonuses();
      
      // Update displays
      updateAllDisplays();
      saveGameState();
      
      // Close modal and show notification
      closePrestigeModal();
      showPurchaseNotification(`üåü Prestiged to Level ${prestigeLevel}! üåü`, "success");
    }

    // Save code system functions
    // function exportSaveCode() { ... }
    // function importSaveCode() { ... }
    // (Removed all code for import/export save)
    // ... existing code ...
    // Fix save code import/export with direct event listeners
    // document.addEventListener('DOMContentLoaded', function() { ... });
    // (Removed all event listeners for import/export save)
    // ... existing code ...
    // Simplified version of the export function with better error handling
    // function exportSaveCode() { ... }
    // function importSaveCode() { ... }
    // (Removed all code for import/export save)
    // ... existing code ...
    // Add this function to update the pack select dropdown with current costs
    function updatePackSelectCosts() {
      const packSelect = document.getElementById('pack-type');
      if (!packSelect) return;
      // Get packTypes and sort by cost (after discounts)
      const packEntries = Object.entries(packTypes).map(([key, val]) => {
        // Calculate discounted cost
        let cost = val.cost;
        // Apply prestige effect on pack cost if applicable
        if (prestigeLevel > 0) {
          cost = Math.max(90, Math.floor(cost * Math.pow(0.9, prestigeLevel)));
        }
        // Apply buyer staff discount
        if (key !== 'legendary' && typeof packPriceMultiplier === 'number' && packPriceMultiplier < 1) {
          cost = Math.floor(cost * packPriceMultiplier);
        }
        return { key, ...val, cost };
      });
      packEntries.sort((a, b) => a.cost - b.cost);
      // Save current selection
      const currentValue = packSelect.value;
      // Clear and repopulate
      packSelect.innerHTML = '';
      packEntries.forEach(pack => {
        const label = pack.key.charAt(0).toUpperCase() + pack.key.slice(1) + ' Pack';
        const option = document.createElement('option');
        option.value = pack.key;
        option.textContent = `${label} (${pack.cost} Coins)`;
        packSelect.appendChild(option);
      });
      // Restore selection if possible
      if ([...packSelect.options].some(opt => opt.value === currentValue)) {
        packSelect.value = currentValue;
      }
    }

    // (Optional) Show improved odds next to pack dropdown
    function updatePackOddsDisplay() {
      const oddsDivId = 'pack-odds-display';
      let oddsDiv = document.getElementById(oddsDivId);
      if (!oddsDiv) {
        // Insert after pack select
        const packSelect = document.getElementById('pack-type');
        if (packSelect && packSelect.parentNode) {
          oddsDiv = document.createElement('div');
          oddsDiv.id = oddsDivId;
          oddsDiv.style.fontSize = '13px';
          oddsDiv.style.marginTop = '4px';
          packSelect.parentNode.insertBefore(oddsDiv, packSelect.nextSibling);
        }
      }
      if (!oddsDiv) return;
      // Get selected pack
      const type = document.getElementById('pack-type')?.value;
      if (!type || !packTypes[type]) {
        oddsDiv.textContent = '';
        return;
      }
      // Calculate odds with bonuses
      let odds = { ...packTypes[type].odds };
      if (rarityBonus > 0) {
        if (odds.rare) odds.rare += rarityBonus;
        if (odds.epic) odds.epic += rarityBonus;
        if (odds.legendary) odds.legendary += rarityBonus;
        // Normalize odds if they exceed 1
        let total = Object.values(odds).reduce((a, b) => a + b, 0);
        if (total > 1) {
          Object.keys(odds).forEach(k => odds[k] /= total);
        }
      }
      // Format odds for display
      const display = [];
      for (const key of ['common', 'rare', 'epic', 'legendary']) {
        if (odds[key]) {
          display.push(`<span class='rarity-${key}'>${key.charAt(0).toUpperCase() + key.slice(1)}: ${(odds[key]*100).toFixed(1)}%</span>`);
        }
      }
      oddsDiv.innerHTML = 'Pack Odds: ' + display.join(' | ');
    }
    // Update odds display when pack select changes or staff bonuses change
    if (typeof updatePackSelectCosts === 'function') {
      const origUpdatePackSelectCosts = updatePackSelectCosts;
      updatePackSelectCosts = function() {
        origUpdatePackSelectCosts();
        updatePackOddsDisplay();
      }
    }
    // Also update odds display on pack select change
    const packSelectEl = document.getElementById('pack-type');
    if (packSelectEl) {
      packSelectEl.addEventListener('change', updatePackOddsDisplay);
    }
  </script>
</body>
</html>




